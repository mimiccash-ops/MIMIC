# =============================================================================
# MIMIC - AUTO DEPLOY TO LINUX VPS
# =============================================================================
# This workflow automatically deploys to your Linux server when you push to main
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                           SETUP INSTRUCTIONS                                 â”‚
# â”‚                                                                              â”‚
# â”‚  1. Go to your GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions     â”‚
# â”‚                                                                              â”‚
# â”‚  2. Add these Repository Secrets (click "New repository secret"):           â”‚
# â”‚                                                                              â”‚
# â”‚     VPS_HOST     = Your VPS IP address (e.g., 123.45.67.89)                 â”‚
# â”‚     VPS_USER     = SSH username (usually: root)                             â”‚
# â”‚     VPS_SSH_KEY  = Your private SSH key (entire content of ~/.ssh/id_rsa)   â”‚
# â”‚     VPS_PORT     = SSH port (usually: 22)                                   â”‚
# â”‚                                                                              â”‚
# â”‚  3. On your VPS, add your GitHub public key to authorized_keys:             â”‚
# â”‚     echo "your-public-key" >> ~/.ssh/authorized_keys                        â”‚
# â”‚                                                                              â”‚
# â”‚  4. Push to main branch - deployment will happen automatically!             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# =============================================================================

name: ğŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  APP_DIR: /var/www/mimic
  
jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT || 22 }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: ğŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.VPS_PORT || 22 }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  MIMIC Auto-Deploy - $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            APP_DIR="/var/www/mimic"
            cd "$APP_DIR"
            
            echo ""
            echo "ğŸ“¥ Step 1: Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
            
            echo ""
            echo "ğŸ“¦ Step 2: Installing/updating dependencies..."
            source venv/bin/activate
            pip install -r requirements.txt --quiet --no-warn-script-location
            
            echo ""
            echo "ğŸ”„ Step 3: Running database migrations..."
            python migrate_all.py 2>/dev/null || echo "  (No migrations needed)"
            
            echo ""
            echo "ğŸ”„ Step 4: Restarting application..."
            sudo systemctl restart mimic
            sudo systemctl restart mimic-worker 2>/dev/null || true
            
            echo ""
            echo "â³ Step 5: Waiting for service to start..."
            sleep 5
            
            echo ""
            echo "âœ… Step 6: Checking service status..."
            if systemctl is-active --quiet mimic; then
              echo "  âœ“ MIMIC service is running"
            else
              echo "  âœ— MIMIC service failed to start!"
              sudo journalctl -u mimic -n 20 --no-pager
              exit 1
            fi
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… DEPLOYMENT COMPLETE!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          DEPLOY_SCRIPT

      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment to ${{ secrets.VPS_HOST }} completed successfully!"
          echo "Time: $(date -u)"

      - name: âŒ Failure Notification  
        if: failure()
        run: |
          echo "ğŸ’¥ Deployment FAILED!"
          echo "Check the logs above for details."
          exit 1
