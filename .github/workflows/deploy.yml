# =============================================================================
# BRAIN CAPITAL - AUTO DEPLOY TO LINUX VPS
# =============================================================================
# This workflow automatically deploys to your Linux server when you push to main
#
# SETUP REQUIRED (one-time):
# 1. Go to GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions
# 2. Add these secrets:
#    - VPS_HOST: Your VPS IP address (e.g., 123.45.67.89)
#    - VPS_USER: SSH username (e.g., root or ubuntu)
#    - VPS_SSH_KEY: Your private SSH key (copy entire content of id_rsa)
#    - VPS_PORT: SSH port (usually 22)
# =============================================================================

name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT || 22 }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT || 22 }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            echo "ðŸ“ Navigating to project directory..."
            cd /var/www/mimic
            
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            echo "ðŸ“¦ Installing dependencies..."
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            
            echo "ðŸ”„ Restarting application..."
            sudo systemctl restart mimic
            
            echo "âœ… Deployment complete!"
          DEPLOY_SCRIPT

      - name: âœ… Deployment Status
        if: success()
        run: echo "ðŸŽ‰ Deployment successful!"

      - name: âŒ Deployment Failed
        if: failure()
        run: echo "ðŸ’¥ Deployment failed! Check the logs above."
