{% extends "base.html" %}
{% block title %}{{ _('Admin Panel') if _ else 'Admin Panel' }}{% endblock %}

{% block mobile_sections %}
<div class="mobile-divider"></div>
<a href="#" class="mobile-nav-item mobile-section-link active" data-section="overview" onclick="showSection('overview'); return false;">
    <i class="fas fa-crown"></i>
    <span data-i18n="section.overview">Overview</span>
</a>
<a href="#" class="mobile-nav-item mobile-section-link" data-section="trading" onclick="showSection('trading'); return false;">
    <i class="fas fa-chart-line"></i>
    <span data-i18n="section.trading">Trading</span>
</a>
<a href="#" class="mobile-nav-item mobile-section-link" data-section="exchange" onclick="showSection('exchange'); return false;">
    <i class="fas fa-cogs"></i>
    <span data-i18n="section.exchange">Exchange</span>
</a>
<a href="#" class="mobile-nav-item mobile-section-link" data-section="tasks" onclick="showSection('tasks'); return false;">
    <i class="fas fa-tasks"></i>
    <span data-i18n="section.tasks">Tasks</span>
</a>
<a href="#" class="mobile-nav-item mobile-section-link" data-section="settings" onclick="showSection('settings'); return false;">
    <i class="fas fa-sliders-h"></i>
    <span data-i18n="section.settings">Settings</span>
</a>
{% endblock %}

{% block extra_styles %}
<style>
    .command-terminal { background: linear-gradient(165deg, rgba(12, 12, 24, 0.98), rgba(8, 8, 16, 0.99)); border: 1px solid rgba(0, 245, 255, 0.15); }
    .terminal-header { background: linear-gradient(90deg, var(--neon-red), var(--neon-yellow), var(--neon-green)); height: 2px; }
    .log-entry { transition: all 0.15s ease; border-radius: 6px; margin: 3px 0; border-left: 2px solid transparent; }
    .log-entry:hover { background: rgba(0, 245, 255, 0.04); transform: translateX(3px); border-left-color: var(--neon-cyan); }
    .log-error { border-left-color: var(--neon-red); background: rgba(255, 0, 68, 0.04); }
    .log-info { border-left-color: var(--neon-cyan); background: rgba(0, 245, 255, 0.02); }
    .master-balance { font-size: clamp(1.2rem, 5vw, 1.6rem); font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 12px rgba(0, 245, 255, 0.25)); letter-spacing: -0.5px; line-height: 1; }
    .stat-number { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: clamp(0.85rem, 3vw, 1.2rem); letter-spacing: -0.3px; }
    .node-card { transition: all 0.15s ease; border-left: 2px solid transparent; }
    .node-card:hover { transform: translateX(3px); background: rgba(0, 245, 255, 0.02); border-left-color: var(--neon-cyan); }
    .control-btn { position: relative; overflow: hidden; transition: all 0.15s ease; }
    .control-btn:hover { transform: translateY(-1px); }
    .period-btn { padding: 3px 8px; font-size: 0.5rem; font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--text-muted); background: var(--bg-element); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; transition: all 0.15s ease; text-transform: uppercase; }
    .period-btn:hover { color: var(--neon-magenta); border-color: var(--neon-magenta); }
    .period-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-magenta), var(--neon-cyan)); border-color: transparent; }
    .stats-mode-btn { padding: 3px 8px; font-size: 0.5rem; color: var(--text-muted); background: transparent; border: none; border-radius: 4px; cursor: pointer; transition: all 0.15s ease; }
    .stats-mode-btn:hover { color: var(--neon-cyan); }
    .stats-mode-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); }
    #admin-exchange-dropdown-icon.rotate-180, #user-exchange-filter-icon.rotate-180 { transform: rotate(180deg); }
    .cyber-checkbox { width: 14px; height: 14px; accent-color: var(--neon-cyan); cursor: pointer; }
    .position-card { transition: all 0.15s ease; }
    .position-card:hover { transform: translateX(2px); }
    .trade-row:hover { background: rgba(0, 245, 255, 0.04); }
    
    /* Toggle Switch */
    .toggle-bg { position: relative; cursor: pointer; }
    .toggle-dot { transition: all 0.2s ease; }
    .translate-x-6 { transform: translateX(1.5rem); }
    
    /* Balance cell styles */
    .balance-cell { min-width: 90px; }
    .balance-cell .bg-green { background: var(--neon-green); box-shadow: 0 0 4px var(--neon-green); }
    .balance-cell .bg-yellow { background: var(--neon-yellow); box-shadow: 0 0 4px var(--neon-yellow); }
    .balance-cell .bg-red { background: var(--neon-red); box-shadow: 0 0 4px var(--neon-red); }
    
    /* Modal Overlay Styles */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface-2);
    }
    
    .modal-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 1rem;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-card {
        width: 100%;
        max-width: 500px;
        background: var(--color-surface-2, #15151e);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        animation: modalIn 0.3s ease;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 245, 255, 0.1);
    }
    
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.95) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    /* Select dropdown styling for modal */
    .modal-body select,
    .modal-body select.input {
        background: var(--color-surface-3, #1a1a25) !important;
        color: var(--text-primary);
        border: 2px solid var(--color-border);
        padding: 14px 44px 14px 18px;
        font-size: 0.9375rem;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f5ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 16px center !important;
    }
    
    .modal-body select:focus {
        outline: none;
        border-color: var(--neon-cyan);
        box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.15);
    }
    
    .modal-body select option {
        background: var(--color-surface-2, #15151e);
        color: var(--text-primary);
        padding: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="app-container">

    <!-- ==================== OVERVIEW SECTION ==================== -->
    <div class="section-content active" data-section="overview">
        <!-- Hero Card -->
        <div class="hero-card mb-6">
            <div class="hero-glow"></div>
            <div class="flex flex-col md:flex-row items-center gap-6" style="position: relative; z-index: 1;">
                <!-- Master Icon -->
                <div class="user-avatar-lg" style="flex-shrink: 0; background: linear-gradient(135deg, rgba(255, 0, 212, 0.2), rgba(0, 212, 255, 0.2)); border-color: var(--neon-magenta);">
                    <i class="fas fa-crown" style="font-size: 1.75rem; color: var(--neon-magenta);"></i>
            </div>
            
                <!-- Info -->
                <div class="flex-grow text-center md:text-left">
                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 mb-2">
                        <h1 class="font-display text-xl font-semibold" data-i18n="dash.master">MASTER</h1>
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span class="live-text" data-i18n="dash.live">LIVE</span>
                    </div>
                    </div>
                    <p id="master-balance" class="balance-amount">${{ master_balance }}</p>
                    <!-- Exchange Balances -->
                    <div id="exchange-balances-container" class="flex flex-wrap gap-2 mt-2">
                        {% if master_exchange_balances %}
                            {% for ex in master_exchange_balances %}
                            <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                                <span class="text-xs font-semibold text-muted">{{ ex.exchange }}</span>
                                <span class="font-mono text-sm {{ 'text-green' if ex.balance and ex.balance > 0 else 'text-muted' }} font-bold">
                                    {% if ex.balance is not none %}${{ "{:,.2f}".format(ex.balance) }}{% elif ex.error %}‚ö†Ô∏è{% else %}...{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted text-xs" data-i18n="admin.loadingExchangeBalances">Loading exchange balances...</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-4 mb-6">
            <div class="stat-card">
                <div class="stat-icon cyan"><i class="fas fa-network-wired"></i></div>
                <div class="stat-content">
                    <div class="stat-label" data-i18n="dash.nodes">Nodes</div>
                    <div class="stat-value text-cyan">{{ users|selectattr('is_paused', 'equalto', false)|selectattr('role', 'ne', 'admin')|list|length }}</div>
                    </div>
                </div>
            <div class="stat-card">
                <div class="stat-icon magenta"><i class="fas fa-exchange-alt"></i></div>
                <div class="stat-content">
                    <div class="stat-label" data-i18n="dash.trades">Trades</div>
                    <div class="stat-value text-magenta">{{ closed_trades|length }}</div>
                    </div>
                    </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fas fa-chart-line"></i></div>
                <div class="stat-content">
                    <div class="stat-label" data-i18n="dash.result">Result</div>
                    <div class="stat-value text-green" id="overview-result">+$0</div>
                    </div>
                    </div>
            <div class="stat-card">
                <div class="stat-icon yellow"><i class="fas fa-percentage"></i></div>
                <div class="stat-content">
                    <div class="stat-label" data-i18n="dash.winRate">Win Rate</div>
                    <div class="stat-value text-yellow" id="overview-winrate">0%</div>
                </div>
            </div>
        </div>

        <!-- Insurance Fund / Safety Pool Card -->
        <div class="card mb-6" style="background: linear-gradient(135deg, rgba(57, 255, 20, 0.03), rgba(0, 240, 255, 0.02)); border-color: rgba(57, 255, 20, 0.2);">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center" style="width: 48px; height: 48px; background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-shield-alt text-xl" style="color: #39ff14;"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-muted text-xs uppercase tracking-wider" data-i18n="admin.insuranceFund">Insurance Fund</span>
                            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 100px; font-size: 0.65rem; font-weight: 600; background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid rgba(57, 255, 20, 0.3);">
                                <i class="fas fa-check-circle"></i> <span data-i18n="admin.verified">Verified</span>
                            </span>
                        </div>
                        <div class="font-mono font-bold text-2xl" id="admin-safety-pool" style="color: #39ff14;">$10,000.00</div>
                    </div>
                </div>
                <div class="text-right hidden md:block">
                    <div class="text-muted text-xs mb-1" data-i18n="admin.safetyPool">Safety Pool</div>
                    <div class="text-xs" style="color: rgba(255,255,255,0.4);" data-i18n="admin.feesToFund">5% of fees ‚Üí fund</div>
                    <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);" title="Covers slippage in extreme markets">
                        <i class="fas fa-info-circle"></i> <span data-i18n="admin.slippageProtection">Slippage protection</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Quick Links -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Tournament Management -->
            <a href="{{ url_for('tournament_page') }}" class="card p-4 transition-all duration-300 hover:scale-[1.02]" 
               style="border-color: rgba(234, 179, 8, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-medal" style="color: #eab308;"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-sm" data-i18n="nav.tournaments">Tournaments</div>
                        <div class="text-xs text-muted" data-i18n="admin.createManage">Create & manage</div>
                    </div>
                </div>
            </a>
            
            <!-- Leaderboard -->
            <a href="{{ url_for('leaderboard') }}" class="card p-4 transition-all duration-300 hover:scale-[1.02]" 
               style="border-color: rgba(168, 85, 247, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-trophy" style="color: #a855f7;"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-sm" data-i18n="nav.leaderboard">Leaderboard</div>
                        <div class="text-xs text-muted" data-i18n="admin.topTraders">Top traders</div>
                    </div>
                </div>
            </a>
            
            <!-- Governance -->
            <a href="{{ url_for('governance_page') }}" class="card p-4 transition-all duration-300 hover:scale-[1.02]" 
               style="border-color: rgba(59, 130, 246, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-vote-yea" style="color: #3b82f6;"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-sm" data-i18n="nav.governance">Governance</div>
                        <div class="text-xs text-muted" data-i18n="admin.proposalsVotes">Proposals & votes</div>
                    </div>
                </div>
            </a>
            
            <!-- Payouts -->
            <a href="{{ url_for('admin_payouts') }}" class="card p-4 transition-all duration-300 hover:scale-[1.02]" 
               style="border-color: rgba(34, 197, 94, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-wallet" style="color: #22c55e;"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-sm" data-i18n="nav.payouts">Payouts</div>
                        <div class="text-xs text-muted" data-i18n="admin.referralPayouts">Referral payouts</div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Platform Stats Row -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="card p-4" style="border-color: rgba(251, 146, 60, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 36px; height: 36px; background: rgba(251, 146, 60, 0.1); border-radius: var(--radius-sm);">
                        <i class="fas fa-user-plus text-sm" style="color: #fb923c;"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted" data-i18n="admin.totalReferrals">Total Referrals</div>
                        <div class="font-mono font-bold text-lg" id="admin-total-referrals">--</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(139, 92, 246, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 36px; height: 36px; background: rgba(139, 92, 246, 0.1); border-radius: var(--radius-sm);">
                        <i class="fas fa-crown text-sm" style="color: #8b5cf6;"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted" data-i18n="admin.premiumUsers">Premium Users</div>
                        <div class="font-mono font-bold text-lg" id="admin-premium-users">--</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(6, 182, 212, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 36px; height: 36px; background: rgba(6, 182, 212, 0.1); border-radius: var(--radius-sm);">
                        <i class="fas fa-dollar-sign text-sm" style="color: #06b6d4;"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted" data-i18n="admin.pendingPayouts">Pending Payouts</div>
                        <div class="font-mono font-bold text-lg" id="admin-pending-payouts">$--</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(236, 72, 153, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 36px; height: 36px; background: rgba(236, 72, 153, 0.1); border-radius: var(--radius-sm);">
                        <i class="fas fa-fire text-sm" style="color: #ec4899;"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted" data-i18n="admin.activeTournament">Active Tournament</div>
                        <div class="font-semibold text-sm" id="admin-active-tournament">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-stream text-cyan"></i>
                    <span data-i18n="admin.liveLogs">Live Logs</span>
                    <span class="live-dot"></span>
                </h2>
                <button onclick="clearLogs()" class="action-btn" data-i18n-title="admin.clearLogs" title="Clear Logs">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div id="log-container" class="h-36 overflow-y-auto space-y-1 text-sm font-mono" style="background: var(--color-surface-2); padding: 12px; border-radius: var(--radius-sm);">
                <div class="p-2 bg-[var(--color-surface-3)] rounded log-entry log-info">
                    <span class="text-cyan">[SYSTEM]</span>
                    <span class="text-muted ml-2" data-i18n="admin.waitingSignals">Waiting for signals...</span>
    </div>
                    </div>
                </div>
            </div>
            
    <!-- ==================== TRADING (Stats + Positions + History) ==================== -->
    <div class="section-content" data-section="trading">
        <!-- Stats -->
        <div class="card mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-chart-line text-magenta"></i>
                    <span data-i18n="admin.growth">Growth</span>
                </h2>
                <div class="period-pills">
                    <button onclick="setChartPeriod('24h')" class="period-pill active" data-period="24h">24H</button>
                    <button onclick="setChartPeriod('week')" class="period-pill" data-period="week">Week</button>
                    <button onclick="setChartPeriod('month')" class="period-pill" data-period="month">Month</button>
                </div>
            </div>
            
            <div class="grid grid-4 mb-4">
                <div style="background: var(--color-surface-2); padding: 12px; border-radius: var(--radius-sm); text-align: center;">
                    <div class="text-muted text-sm mb-1" data-i18n="dash.result">Result</div>
                    <div id="stats-result" class="font-mono font-semibold text-lg text-green">+$0</div>
                </div>
                <div style="background: var(--color-surface-2); padding: 12px; border-radius: var(--radius-sm); text-align: center;">
                    <div class="text-muted text-sm mb-1" data-i18n="dash.trades">Trades</div>
                    <div id="stats-trades" class="font-mono font-semibold text-lg text-cyan">0</div>
                </div>
                <div style="background: var(--color-surface-2); padding: 12px; border-radius: var(--radius-sm); text-align: center;">
                    <div class="text-muted text-sm mb-1" data-i18n="dash.winRate">Win Rate</div>
                    <div id="stats-winrate" class="font-mono font-semibold text-lg text-magenta">0%</div>
                </div>
                <div style="background: var(--color-surface-2); padding: 12px; border-radius: var(--radius-sm); text-align: center;">
                    <div class="text-muted text-sm mb-1" data-i18n="dash.avgRoi">Avg ROI</div>
                    <div id="stats-avgroi" class="font-mono font-semibold text-lg text-yellow">0%</div>
                </div>
            </div>
            
            <div style="height: 200px; position: relative;">
                <canvas id="masterChart"></canvas>
            </div>
        </div>

        <!-- Master Positions -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-layer-group text-cyan"></i>
                    <span data-i18n="admin.masterPositions">Master Positions</span>
                    <span id="master-positions-count" class="badge badge-primary">{{ master_positions|length }}</span>
                </h2>
                <div class="flex items-center gap-2">
                    <span class="live-dot"></span>
                    <span class="text-sm text-muted" data-i18n="dash.live">Live</span>
                </div>
            </div>
            <div id="master-positions-container" class="flex flex-col gap-3">
                {% if master_positions %}
                    {% for pos in master_positions %}
                    <div class="position-item">
                        <div class="flex items-center gap-3">
                            <div class="position-icon {{ 'long' if pos.side == 'LONG' else 'short' }}">
                                <i class="fas fa-arrow-{{ 'trend-up' if pos.side == 'LONG' else 'trend-down' }}"></i>
                            </div>
                            <div>
                                <div class="font-display font-semibold">{{ pos.symbol }}</div>
                                <div class="text-sm text-muted">{{ pos.side }} ¬∑ x{{ pos.leverage }} ¬∑ <span class="text-cyan">{{ pos.exchange or 'Binance' }}</span></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-semibold {{ 'text-green' if pos.unrealized_pnl >= 0 else 'text-red' }}">
                                {{ '+' if pos.unrealized_pnl >= 0 else '' }}${{ "%.2f"|format(pos.unrealized_pnl) }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-inbox"></i>
                        <p data-i18n="dash.noOpenPositions">No open positions</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Trade History -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-history text-magenta"></i>
                    <span data-i18n="admin.closedTrades">Closed Trades</span>
                </h2>
                <span class="text-sm text-muted">{{ closed_trades|length }} <span data-i18n="dash.trades">trades</span></span>
            </div>
        
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="admin.tableTime">Time</th>
                            <th data-i18n="admin.tableNode">Node</th>
                            <th data-i18n="admin.tableSymbol">Symbol</th>
                            <th style="text-align: center;" data-i18n="admin.tableSide">Side</th>
                            <th style="text-align: right;" data-i18n="admin.tablePnl">PnL</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        {% for trade in closed_trades %}
                        <tr class="trade-row border-b border-[var(--border-color)] border-opacity-30">
                            <td class="py-2 px-2 text-muted">{{ trade.time }}</td>
                            <td class="py-2 px-2 font-bold text-bright">{{ trade.node }}</td>
                            <td class="py-2 px-2 font-mono text-bright">{{ trade.symbol }}</td>
                            <td class="py-2 px-1 text-center">
                                <span class="badge {{ 'badge-success' if trade.side == 'LONG' else 'badge-danger' }}">{{ trade.side }}</span>
                            </td>
                            <td class="py-2 px-2 text-right font-mono font-bold {{ 'text-green' if trade.pnl >= 0 else 'text-red' }}">
                                {{ '+' if trade.pnl >= 0 else '' }}{{ "%.2f"|format(trade.pnl) }}$
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== EXCHANGE ==================== -->
    <div class="section-content" data-section="exchange">
        <!-- Connect New Exchange -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-plug text-magenta"></i>
                    <span data-i18n="admin.exchangeConfig">Exchange Configuration</span>
                </h2>
                <button onclick="openAdminExchangeModal()" class="cyber-btn cyber-btn-sm">
                    <i class="fas fa-plus"></i>
                    <span data-i18n="btn.add">Add</span>
                </button>
                </div>
            <p class="text-sm text-muted mb-4" data-i18n="admin.connectExchangeHint">Connect exchanges with your admin API keys first. Then users can add their own keys.</p>
            <div id="all-exchanges-container" class="grid grid-4">
                <div class="empty-state col-span-full">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Verified Exchange Config -->
        <div class="card mb-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-cogs text-cyan"></i>
                    <span data-i18n="admin.exchangeConfig">Verified Exchanges</span>
                    <span id="verified-exchanges-count" class="badge badge-success">-</span>
                </h2>
                <button onclick="loadExchangeConfigs()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="exchange-configs-container" class="grid grid-4">
                <div class="empty-state col-span-full">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- User Exchanges -->
        <div class="card mb-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-users-cog text-green"></i>
                    <span data-i18n="admin.userExchanges">User Exchanges</span>
                    <span id="active-trading-count" class="badge badge-success">-</span>
                </h2>
                <button onclick="loadAllUserExchanges()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
                </div>
            <div id="user-exchanges-container" class="flex flex-col gap-3" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>
                
        <!-- Pending Exchanges -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-user-check text-yellow"></i>
                    <span data-i18n="admin.pendingExchanges">Pending Exchanges</span>
                    <span id="pending-exchanges-count" class="badge badge-warning">-</span>
                </h2>
                <button onclick="loadPendingExchanges()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="pending-exchanges-container" class="flex flex-col gap-3" style="max-height: 300px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Network Nodes (Users) -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-network-wired text-purple"></i>
                    <span data-i18n="admin.networkNodes">Network Nodes</span>
                </h2>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-muted">{{ users|length }} <span data-i18n="section.users">users</span></span>
                    <button onclick="refreshAllBalances()" class="cyber-btn cyber-btn-outline cyber-btn-icon" title="Refresh Balances" id="refresh-balances-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        
            <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="admin.tableUser">User</th>
                            <th style="text-align: center;">Email</th>
                            <th style="text-align: center;" data-i18n="admin.tableStatus">Status</th>
                            <th style="text-align: center;" data-i18n="admin.tableBalance">Balance</th>
                            <th style="text-align: center;">Registered</th>
                            <th style="text-align: right;" data-i18n="admin.tableActions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="nodes-body">
                        {% for user in users %}
                        {% if user.role != 'admin' %}
                        <tr class="node-card border-b border-[var(--border-color)] border-opacity-30 cursor-pointer hover:bg-[rgba(0,245,255,0.04)]" data-user-id="{{ user.id }}" onclick="openUserDetailsModal({{ user.id }})">
                            <td class="py-2 px-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-[rgba(0,245,255,0.15)] to-[rgba(255,0,255,0.15)] border border-[rgba(0,245,255,0.25)] rounded-lg flex items-center justify-center overflow-hidden">
                                        {% if user.avatar_type == 'image' and user.avatar %}
                                        <img src="{{ url_for('static', filename='avatars/' + user.avatar) }}" alt="Avatar" class="w-full h-full object-cover">
                                        {% else %}
                                        <span class="text-sm">{{ user.avatar or 'üßë‚Äçüíª' }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0">
                                        <p class="font-bold text-bright text-xs truncate">{{ user.first_name or user.username }}</p>
                                        <p class="text-xxs text-muted truncate">@{{ user.username }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center py-2 px-1 text-xs">
                                {% if user.email %}
                                <span class="text-cyan truncate" style="max-width: 100px; display: inline-block;" title="{{ user.email }}">{{ user.email[:15] }}{% if user.email|length > 15 %}...{% endif %}</span>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td class="text-center py-2 px-1">
                                {% if user.is_paused %}
                                <span class="badge badge-warning"><i class="fas fa-pause"></i></span>
                                {% elif user.is_active %}
                                <span class="badge badge-success"><span class="status-dot online" style="width: 4px; height: 4px;"></span></span>
                                {% else %}
                                <span class="badge badge-danger"><i class="fas fa-times"></i></span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-1 balance-cell">
                                {% if user_exchange_details and user_exchange_details.get(user.id) %}
                                <div class="flex flex-col gap-1">
                                    {% for ex in user_exchange_details.get(user.id, []) %}
                                    <div class="flex items-center gap-1 text-xs">
                                        <span class="w-2 h-2 rounded-full {{ 'bg-green' if ex.trading_enabled else 'bg-yellow' }}" title="{{ 'Trading enabled' if ex.trading_enabled else 'Trading disabled' }}"></span>
                                        <span class="text-muted truncate" style="max-width: 60px;" title="{{ ex.label }}">{{ ex.exchange_name[:3]|upper }}</span>
                                        {% if ex.balance is not none %}
                                        <span class="text-green font-bold font-mono">${{ "{:,.0f}".format(ex.balance) }}</span>
                                        {% elif ex.error %}
                                        <span class="text-red text-xs" title="{{ ex.error }}">‚ö†Ô∏è</span>
                                        {% elif ex.status == 'PENDING' %}
                                        <span class="text-yellow text-xs">‚è≥</span>
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% if user_exchange_details.get(user.id)|length > 1 %}
                                    <div class="border-t border-[var(--color-border)] pt-1 mt-1">
                                        <span class="text-cyan font-bold font-mono text-xs">Œ£ ${{ "{:,.0f}".format(user_balances.get(user.id, 0) or 0) }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% elif user_balances.get(user.id) is not none %}
                                <span class="text-green font-bold font-mono">${{ "{:,.0f}".format(user_balances[user.id]) }}</span>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td class="text-center py-2 px-1 text-xs text-muted">
                                {% if user.created_at %}
                                {{ user.created_at.strftime('%d.%m.%Y') }}
                                {% else %}
                                ‚Äî
                                {% endif %}
                            </td>
                            <td class="text-right py-2 px-2" onclick="event.stopPropagation();">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openUserDetailsModal({{ user.id }})" class="action-btn cyber-btn-icon" title="View Details">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% if user.is_paused %}
                                    <form method="POST" action="{{ url_for('approve_user', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="action-btn cyber-btn-success cyber-btn-icon" title="Activate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="POST" action="{{ url_for('disconnect_user', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="action-btn cyber-btn-gradient-yellow cyber-btn-icon" title="Pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== SETTINGS (Controls + Settings) ==================== -->
    <div class="section-content" data-section="settings">
        <!-- Control Terminal -->
        <div class="command-terminal rounded-xl overflow-hidden mb-6">
            <div class="terminal-header"></div>
            <div class="p-3">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-cyber text-xs tracking-widest text-bright">CONTROL TERMINAL</span>
                    <span class="badge badge-primary">LIVE</span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <form method="POST" action="{{ url_for('actions', action_type='resume') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-green py-4 flex-col gap-2">
                            <i class="fas fa-play text-xl"></i>
                            <span class="text-xs font-display font-semibold">START</span>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('actions', action_type='pause') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-yellow py-4 flex-col gap-2">
                            <i class="fas fa-pause text-xl"></i>
                            <span class="text-xs font-display font-semibold">PAUSE</span>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('actions', action_type='reload') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-blue py-4 flex-col gap-2">
                            <i class="fas fa-sync text-xl"></i>
                            <span class="text-xs font-display font-semibold">RELOAD</span>
                        </button>
                    </form>
                    <button onclick="confirmPanic()" class="cyber-btn cyber-btn-danger py-4 flex-col gap-2">
                        <i class="fas fa-radiation text-xl"></i>
                        <span class="text-xs font-display font-semibold">PANIC</span>
                    </button>
                </div>
                
                {% if engine_paused %}
                <div class="mt-3 p-2 bg-[rgba(255,240,0,0.08)] border border-[rgba(255,240,0,0.25)] rounded-xl flex items-center gap-2 animate-pulse">
                    <i class="fas fa-pause-circle text-lg text-yellow"></i>
                    <span class="text-yellow font-cyber text-xs tracking-wider">TRADING PAUSED</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Global Settings -->
        <div class="card mb-6">
            <h2 class="font-display font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-sliders-h text-magenta"></i>
                <span data-i18n="admin.globalSettings">Global Settings</span>
            </h2>
            <form method="POST" action="{{ url_for('admin_update_global_settings') }}" class="grid grid-cols-3 sm:grid-cols-7 gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-percentage text-cyan"></i> Risk%
                    </label>
                    <input type="number" name="global_risk" value="{{ global_settings.risk_perc }}" step="0.01" class="input" min="0.01" max="100">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-bolt text-magenta"></i> Lever
                    </label>
                    <input type="number" name="global_leverage" value="{{ global_settings.leverage }}" class="input" min="1" max="125">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-arrow-up text-green"></i> TP%
                    </label>
                    <input type="number" name="global_tp" value="{{ global_settings.tp_perc }}" step="0.1" min="0.1" max="100" class="input" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-arrow-down text-red"></i> SL%
                    </label>
                    <input type="number" name="global_sl" value="{{ global_settings.sl_perc }}" step="0.1" min="0.1" max="100" class="input" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-layer-group text-yellow"></i> Max
                    </label>
                    <input type="number" name="global_max_pos" value="{{ global_settings.max_positions }}" class="input" min="1" max="50">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-wallet text-purple"></i> Min$
                    </label>
                    <input type="number" name="global_min_balance" value="{{ global_settings.min_balance }}" step="0.01" class="input" min="0" max="100000" title="Minimum balance required to trade. Users with less balance cannot trade.">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="cyber-btn w-full">
                        <i class="fas fa-save"></i>
                        <span data-i18n="btn.save">Save</span>
                    </button>
                </div>
            </form>
            <p class="text-xxs text-muted mt-2"><i class="fas fa-info-circle text-cyan"></i> Min$: Users with balance below this cannot trade (default: $1)</p>
        </div>
        
        <!-- Strategies Management -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-chess-knight text-purple"></i>
                    <span>Trading Strategies</span>
                </h2>
                <button onclick="openCreateStrategyModal()" class="cyber-btn cyber-btn-sm">
                    <i class="fas fa-plus"></i>
                    <span>New Strategy</span>
                </button>
            </div>
            
            <div id="admin-strategies-container" class="space-y-3">
                <div class="flex items-center justify-center py-6">
                    <i class="fas fa-spinner fa-spin text-2xl text-muted"></i>
                </div>
            </div>
        </div>
        
        <!-- Chat Moderation -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-comments text-cyan"></i>
                    <span>Live Chat Moderation</span>
                </h2>
                <button onclick="refreshChatBans()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                    <i class="fas fa-sync"></i>
                    <span>Refresh</span>
                </button>
            </div>
            
            <!-- Chat Settings -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-3 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg">
                    <div class="flex items-center gap-2 text-xs text-muted mb-1">
                        <i class="fas fa-users text-cyan"></i>
                        <span>Chat Room</span>
                    </div>
                    <span class="text-lg font-display font-semibold text-bright">General Room</span>
                </div>
                <div class="p-3 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg">
                    <div class="flex items-center gap-2 text-xs text-muted mb-1">
                        <i class="fas fa-ban text-red"></i>
                        <span>Active Bans</span>
                    </div>
                    <span class="text-lg font-display font-semibold text-red" id="activeBansCount">0</span>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mb-4">
                <label class="text-xs text-muted mb-2 block">Quick Actions - Select a user to moderate:</label>
                <div class="flex gap-2">
                    <select id="chatModerateUser" class="input flex-1">
                        <option value="">-- Select User --</option>
                    </select>
                    <button onclick="muteSelectedUser(15)" class="cyber-btn cyber-btn-yellow cyber-btn-sm" title="Mute for 15 minutes">
                        <i class="fas fa-volume-mute"></i>
                        15m
                    </button>
                    <button onclick="muteSelectedUser(60)" class="cyber-btn cyber-btn-yellow cyber-btn-sm" title="Mute for 1 hour">
                        <i class="fas fa-volume-mute"></i>
                        1h
                    </button>
                    <button onclick="banSelectedUser()" class="cyber-btn cyber-btn-danger cyber-btn-sm" title="Permanent Ban">
                        <i class="fas fa-ban"></i>
                        Ban
                    </button>
                </div>
            </div>
            
            <!-- Active Bans List -->
            <div>
                <label class="text-xs text-muted mb-2 block">Currently Banned/Muted Users:</label>
                <div id="chatBansList" class="space-y-2 max-h-48 overflow-y-auto">
                    <div class="text-center py-4 text-muted text-sm">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== SERVICE CONFIGURATION ==================== -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-plug text-cyan"></i>
                    <span>Service Configuration</span>
                </h2>
                <button onclick="refreshServiceStatus()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                    <i class="fas fa-sync" id="service-refresh-icon"></i>
                    <span>Refresh</span>
                </button>
            </div>
            
            <!-- Service Status Overview -->
            <div id="services-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="flex items-center justify-center py-6">
                    <i class="fas fa-spinner fa-spin text-2xl text-muted"></i>
                </div>
            </div>
            
            <!-- Configure Button -->
            <div class="text-center pt-4 border-t border-[var(--color-border)]">
                <button onclick="openServiceConfigModal()" class="cyber-btn cyber-btn-gradient-blue">
                    <i class="fas fa-cogs"></i>
                    <span>Configure All Services</span>
                </button>
            </div>
        </div>
        
        <!-- ==================== SUBSCRIPTION MANAGEMENT ==================== -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-crown text-yellow"></i>
                    <span>Subscription Management</span>
                </h2>
                <button onclick="refreshSubscriptionSettings()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                    <i class="fas fa-sync" id="sub-refresh-icon"></i>
                    <span>Refresh</span>
                </button>
            </div>
            
            <!-- Subscription Toggle -->
            <div class="p-4 rounded-xl mb-4" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));">
                            <i class="fas fa-toggle-on text-yellow text-xl"></i>
                        </div>
                        <div>
                            <div class="font-display font-semibold text-bright">Subscription System</div>
                            <div class="text-xs text-muted">When OFF, all users have FREE access (no payment required)</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-muted" id="sub-toggle-label">OFF</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="subscription-enabled-toggle" class="sr-only peer" onchange="toggleSubscriptionSystem(this)">
                            <div class="w-14 h-8 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-yellow-500 peer-checked:to-orange-500"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="p-3 rounded-xl text-center" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1">Premium Users</div>
                    <div class="font-mono text-2xl font-bold text-cyan" id="admin-premium-users">0</div>
                </div>
                <div class="p-3 rounded-xl text-center" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1">Pending Payments</div>
                    <div class="font-mono text-2xl font-bold text-yellow" id="admin-pending-payments">0</div>
                </div>
                <div class="p-3 rounded-xl text-center" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1">Total Revenue</div>
                    <div class="font-mono text-2xl font-bold text-green" id="admin-total-revenue">$0</div>
                </div>
                <div class="p-3 rounded-xl text-center" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1">Insurance Fund</div>
                    <div class="font-mono text-2xl font-bold text-magenta" id="admin-insurance-fund">$0</div>
                </div>
            </div>
            
            <!-- Wallet Addresses Section -->
            <div class="p-4 rounded-xl mb-4" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <h3 class="font-display font-semibold flex items-center gap-2 mb-4">
                    <i class="fas fa-wallet text-purple"></i>
                    <span>Payment Wallet Addresses</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="wallet-addresses-grid">
                    <div class="flex items-center justify-center py-4">
                        <i class="fas fa-spinner fa-spin text-muted"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-[var(--color-border)]">
                    <button onclick="openWalletSettingsModal()" class="cyber-btn cyber-btn-gradient-purple w-full">
                        <i class="fas fa-edit"></i>
                        <span>Edit Wallet Addresses</span>
                    </button>
                </div>
            </div>
            
            <!-- Insurance Fund Settings -->
            <div class="p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <h3 class="font-display font-semibold flex items-center gap-2 mb-3">
                    <i class="fas fa-shield-alt text-purple"></i>
                    <span>Insurance Fund (Safety Pool)</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-muted mb-1 block">Fund Wallet Address</label>
                        <div class="font-mono text-sm text-purple break-all" id="insurance-wallet-display">Not configured</div>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block">Network</label>
                        <div class="font-semibold text-bright" id="insurance-network-display">-</div>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block">Contribution Rate</label>
                        <div class="font-semibold text-bright" id="insurance-rate-display">5%</div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Payments List -->
            <div class="p-4 rounded-xl" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <h3 class="font-display font-semibold flex items-center gap-2 mb-4">
                    <i class="fas fa-clock text-yellow"></i>
                    <span>Pending Payments</span>
                </h3>
                <div id="pending-payments-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center py-4 text-muted text-sm">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Profile -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-user-shield text-yellow"></i>
                    <span data-i18n="admin.adminSettings">Admin Settings</span>
                </h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="user-avatar-lg position-relative" style="background: linear-gradient(135deg, rgba(255, 208, 0, 0.2), rgba(255, 0, 212, 0.2)); border-color: var(--neon-yellow); cursor: pointer;" onclick="openAdminAvatarModal()">
                    {% if current_user.avatar_type == 'image' and current_user.avatar %}
                    <img src="{{ url_for('static', filename='avatars/' + current_user.avatar) }}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                    {% else %}
                    <span>{{ current_user.avatar or 'üëë' }}</span>
                    {% endif %}
                    <div class="avatar-edit" style="position: absolute; bottom: 0; right: 0; width: 22px; height: 22px; background: var(--gradient-primary); border: 2px solid var(--color-surface); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-camera" style="font-size: 0.5rem; color: #000;"></i>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="openAdminAvatarModal()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                        <i class="fas fa-user-circle"></i>
                        <span>Change Avatar</span>
                    </button>
                    <a href="{{ url_for('change_password') }}" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                        <i class="fas fa-key"></i>
                        <span data-i18n="dash.changePassword">Change Password</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TASKS MANAGEMENT SECTION ==================== -->
    <div class="section-content" data-section="tasks">
        <!-- Tasks Header -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="font-display text-xl font-semibold flex items-center gap-3">
                    <i class="fas fa-tasks text-cyan"></i>
                    <span data-i18n="admin.taskManagement">Task Management</span>
                </h1>
                <p class="text-muted text-sm mt-1">Create challenges and rewards for users to complete</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="refreshTasks()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                    <i class="fas fa-sync-alt" id="tasks-refresh-icon"></i>
                    <span>Refresh</span>
                </button>
                <button onclick="openCreateTaskModal()" class="cyber-btn cyber-btn-primary">
                    <i class="fas fa-plus"></i>
                    <span>Create Task</span>
                </button>
            </div>
        </div>

        <!-- Task Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="card p-4" style="border-color: rgba(0, 245, 255, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(0, 245, 255, 0.1); border-radius: var(--radius-md);">
                        <i class="fas fa-tasks text-cyan"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted">Active Tasks</div>
                        <div class="font-mono font-bold text-lg" id="admin-active-tasks">0</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(255, 193, 7, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(255, 193, 7, 0.1); border-radius: var(--radius-md);">
                        <i class="fas fa-clock text-yellow"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted">Pending Reviews</div>
                        <div class="font-mono font-bold text-lg" id="admin-pending-reviews">0</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(34, 197, 94, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.1); border-radius: var(--radius-md);">
                        <i class="fas fa-check-circle text-green"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted">Total Completions</div>
                        <div class="font-mono font-bold text-lg" id="admin-total-completions">0</div>
                    </div>
                </div>
            </div>
            <div class="card p-4" style="border-color: rgba(168, 85, 247, 0.2);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center" style="width: 40px; height: 40px; background: rgba(168, 85, 247, 0.1); border-radius: var(--radius-md);">
                        <i class="fas fa-gift text-purple"></i>
                    </div>
                    <div>
                        <div class="text-xs text-muted">Rewards Given</div>
                        <div class="font-mono font-bold text-lg" id="admin-rewards-given">$0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Reviews Section -->
        <div class="card mb-6" id="pending-reviews-section" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-clock text-yellow"></i>
                    <span>Pending Submissions</span>
                    <span class="badge badge-yellow" id="pending-reviews-badge">0</span>
                </h2>
            </div>
            <div id="pending-reviews-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Tasks List -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-list text-cyan"></i>
                    <span>All Tasks</span>
                </h2>
                <div class="flex items-center gap-2">
                    <select id="admin-task-status-filter" class="input" style="width: auto;" onchange="loadAdminTasks()">
                        <option value="all">All Status</option>
                        <option value="active" selected>Active</option>
                        <option value="draft">Draft</option>
                        <option value="paused">Paused</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>
            <div id="admin-tasks-list" class="space-y-3">
                <div class="text-center py-8 text-muted">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading tasks...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div id="createTaskModal" class="modal-overlay" onclick="if(event.target===this)closeCreateTaskModal()">
    <div class="modal-card" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-plus-circle text-cyan"></i>
                <span id="task-modal-title">Create New Task</span>
            </div>
            <button onclick="closeCreateTaskModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="task-edit-id" value="">
            
            <!-- Basic Info -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Title *</label>
                    <input type="text" id="task-title" class="input" placeholder="e.g., Follow us on Twitter" required>
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">Description</label>
                    <textarea id="task-description" class="input" rows="2" placeholder="Brief description of the task"></textarea>
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">Instructions (what users need to do)</label>
                    <textarea id="task-instructions" class="input" rows="3" placeholder="Step-by-step instructions for completing the task"></textarea>
                </div>
            </div>

            <!-- Type & Category -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Task Type</label>
                    <select id="task-type" class="input">
                        <option value="custom">Special</option>
                        <option value="social">Social Media</option>
                        <option value="trading">Trading</option>
                        <option value="referral">Referral</option>
                        <option value="community">Community</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">Category (optional)</label>
                    <input type="text" id="task-category" class="input" placeholder="e.g., Social, Weekly, etc.">
                </div>
            </div>

            <!-- Reward Settings -->
            <div class="p-4 rounded-xl mb-6" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                <h3 class="font-semibold text-sm flex items-center gap-2 mb-4">
                    <i class="fas fa-gift text-green"></i>
                    <span>Reward Settings</span>
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-muted mb-1 block">Reward Type</label>
                        <select id="task-reward-type" class="input" onchange="updateRewardAmountLabel()">
                            <option value="money">Cash ($)</option>
                            <option value="xp">XP Points</option>
                            <option value="subscription">Subscription Days</option>
                            <option value="goods">Goods/Prizes</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" id="reward-amount-label">Amount ($)</label>
                        <input type="number" id="task-reward-amount" class="input" value="0" min="0" step="0.01">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="text-xs text-muted mb-1 block">Reward Description</label>
                    <input type="text" id="task-reward-description" class="input" placeholder="e.g., $10 credited to your balance">
                </div>
            </div>

            <!-- Limits & Requirements -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Max Participants (empty = unlimited)</label>
                    <input type="number" id="task-max-participants" class="input" placeholder="Unlimited" min="1">
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">Max Completions Per User</label>
                    <input type="number" id="task-max-completions" class="input" value="1" min="1">
                </div>
            </div>

            <!-- Visual Settings -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Icon (FontAwesome)</label>
                    <input type="text" id="task-icon" class="input" value="fa-tasks" placeholder="fa-tasks">
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">Color</label>
                    <input type="color" id="task-color" class="input" value="#00f5ff" style="height: 42px; padding: 4px;">
                </div>
            </div>

            <!-- Status & Options -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Status</label>
                    <select id="task-status" class="input">
                        <option value="active">Active</option>
                        <option value="draft">Draft</option>
                        <option value="paused">Paused</option>
                    </select>
                </div>
                <div class="flex items-end gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="task-requires-approval" checked class="cyber-checkbox">
                        <span class="text-sm">Requires Approval</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="task-is-featured" class="cyber-checkbox">
                        <span class="text-sm">Featured</span>
                    </label>
                </div>
            </div>

            <!-- Dates (optional) -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-muted mb-1 block">Start Date (optional)</label>
                    <input type="datetime-local" id="task-start-date" class="input">
                </div>
                <div>
                    <label class="text-xs text-muted mb-1 block">End Date (optional)</label>
                    <input type="datetime-local" id="task-end-date" class="input">
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 pt-4 border-t border-[var(--color-border)]">
                <button onclick="closeCreateTaskModal()" class="cyber-btn cyber-btn-outline flex-1">
                    Cancel
                </button>
                <button onclick="saveTask()" class="cyber-btn cyber-btn-primary flex-1" id="save-task-btn">
                    <i class="fas fa-save"></i>
                    <span>Create Task</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Review Submission Modal -->
<div id="reviewSubmissionModal" class="modal-overlay" onclick="if(event.target===this)closeReviewModal()">
    <div class="modal-card" style="max-width: 550px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-clipboard-check text-yellow"></i>
                <span>Review Submission</span>
            </div>
            <button onclick="closeReviewModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="review-participation-id" value="">
            
            <div id="review-submission-details" class="space-y-4 mb-6">
                <!-- Populated by JS -->
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-muted mb-1 block">Admin Notes (optional)</label>
                <textarea id="review-notes" class="input" rows="2" placeholder="Notes for internal tracking"></textarea>
            </div>
            
            <div id="rejection-reason-field" class="mb-4" style="display: none;">
                <label class="text-xs text-muted mb-1 block">Rejection Reason</label>
                <input type="text" id="review-rejection-reason" class="input" placeholder="Why is this being rejected?">
            </div>
            
            <div class="flex gap-3 pt-4 border-t border-[var(--color-border)]">
                <button onclick="rejectSubmission()" class="cyber-btn cyber-btn-danger flex-1">
                    <i class="fas fa-times"></i>
                    <span>Reject</span>
                </button>
                <button onclick="approveSubmission()" class="cyber-btn cyber-btn-success flex-1">
                    <i class="fas fa-check"></i>
                    <span>Approve & Give Reward</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal-overlay" onclick="if(event.target===this)closeUserDetailsModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 520px; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-user text-cyan"></i>
                <span>User Details</span>
            </div>
            <button onclick="closeUserDetailsModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="userDetailsContent">
            <div class="empty-state">
                <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                <p>Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Avatar Modal -->
<div id="adminAvatarModal" class="modal-overlay" onclick="if(event.target===this)closeAdminAvatarModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 400px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-user-circle text-gradient"></i>
                <span>Change Avatar</span>
            </div>
            <button onclick="closeAdminAvatarModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="admin-avatar-form" action="{{ url_for('update_avatar') }}" method="POST" enctype="multipart/form-data">
                <!-- Emoji Selection -->
                <div class="mb-4">
                    <label class="text-sm text-muted mb-2 block">Choose Emoji</label>
                    <div id="emoji-grid" class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        {% for emoji in ['üßë‚Äçüíª', 'ü§ñ', 'üëΩ', 'ü•∑', 'ü¶∏', 'üßô', 'üëë', 'üöÄ', 'üî•', 'üíé', 'ü¶Å', 'üêØ', 'ü¶ä', 'üê∫', 'ü¶Ñ', 'üêâ', 'üé≠', 'üîÆ', 'üí∞', 'üèÜ'] %}
                        <button type="button" onclick="selectAdminEmoji('{{ emoji }}')" class="emoji-btn p-2 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg text-xl hover:border-[var(--neon-cyan)] transition-all" data-emoji="{{ emoji }}">
                            {{ emoji }}
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="emoji" id="selected-admin-emoji" value="{{ current_user.avatar or 'üëë' }}">
                    <input type="hidden" name="avatar_type" id="admin-avatar-type" value="emoji">
                </div>
                
                <!-- Or Upload Image -->
                <div class="mb-4">
                    <label class="text-sm text-muted mb-2 block">Or Upload Image</label>
                    <input type="file" name="avatar_file" accept="image/png,image/jpeg,image/gif,image/webp" class="input" onchange="setAdminAvatarType('image')">
                    <p class="text-xxs text-muted mt-1">Max 2MB. PNG, JPG, GIF, WEBP</p>
                </div>
                
                <button type="submit" class="cyber-btn w-full">
                    <i class="fas fa-save"></i>
                    <span>Save Avatar</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Service Configuration Modal -->
<div id="serviceConfigModal" class="modal-overlay" onclick="if(event.target===this)closeServiceConfigModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="position: sticky; top: 0; background: var(--color-surface-2); z-index: 10;">
            <div class="modal-title">
                <i class="fas fa-cogs text-cyan"></i>
                <span>Service Configuration</span>
            </div>
            <button onclick="closeServiceConfigModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="serviceConfigContent">
            <div class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-3xl text-muted"></i>
            </div>
        </div>
    </div>
</div>

<!-- Single Service Edit Modal -->
<div id="serviceEditModal" class="modal-overlay" onclick="if(event.target===this)closeServiceEditModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 550px; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header" style="position: sticky; top: 0; background: var(--color-surface-2); z-index: 10;">
            <div class="modal-title">
                <i id="service-edit-icon" class="fas fa-cog text-cyan"></i>
                <span id="service-edit-title">Configure Service</span>
            </div>
            <button onclick="closeServiceEditModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="serviceEditContent">
            <div class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-3xl text-muted"></i>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Settings Modal -->
<div id="walletSettingsModal" class="modal-overlay" onclick="if(event.target===this)closeWalletSettingsModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="position: sticky; top: 0; background: var(--color-surface-2); z-index: 10;">
            <div class="modal-title">
                <i class="fas fa-wallet text-purple"></i>
                <span>Wallet & Payment Settings</span>
            </div>
            <button onclick="closeWalletSettingsModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Payment Wallet Addresses -->
            <div class="mb-6">
                <h4 class="font-display font-semibold flex items-center gap-2 mb-4">
                    <i class="fas fa-coins text-yellow"></i>
                    <span>Payment Wallet Addresses</span>
                </h4>
                <p class="text-xs text-muted mb-4">Configure wallet addresses for each network. Only networks with configured addresses will be shown to users.</p>
                
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">USDT (TRC20)</label>
                        <input type="text" id="wallet-usdt-trc20" placeholder="TRON wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">USDT (ERC20)</label>
                        <input type="text" id="wallet-usdt-erc20" placeholder="Ethereum wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">USDT (BEP20)</label>
                        <input type="text" id="wallet-usdt-bep20" placeholder="BSC wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Bitcoin (BTC)</label>
                        <input type="text" id="wallet-btc" placeholder="Bitcoin wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Ethereum (ETH)</label>
                        <input type="text" id="wallet-eth" placeholder="Ethereum wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Litecoin (LTC)</label>
                        <input type="text" id="wallet-ltc" placeholder="Litecoin wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Solana (SOL)</label>
                        <input type="text" id="wallet-sol" placeholder="Solana wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                </div>
            </div>
            
            <!-- Insurance Fund Settings -->
            <div class="mb-6 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <h4 class="font-display font-semibold flex items-center gap-2 mb-4">
                    <i class="fas fa-shield-alt text-purple"></i>
                    <span>Insurance Fund Wallet</span>
                </h4>
                <p class="text-xs text-muted mb-4">Configure the wallet address for storing Insurance Fund (Safety Pool) funds.</p>
                
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Wallet Address</label>
                        <input type="text" id="insurance-wallet" placeholder="Insurance fund wallet address" class="input flex-1 font-mono text-sm">
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Network</label>
                        <select id="insurance-network" class="input flex-1">
                            <option value="USDT_TRC20">USDT (TRC20 - Tron)</option>
                            <option value="USDT_ERC20">USDT (ERC20 - Ethereum)</option>
                            <option value="USDT_BEP20">USDT (BEP20 - BSC)</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-muted w-28">Contribution %</label>
                        <input type="number" id="insurance-rate" value="5" min="0" max="100" step="0.5" class="input w-24">
                        <span class="text-xs text-muted">% of platform fees</span>
                    </div>
                </div>
            </div>
            
            <!-- Auto Confirm Setting -->
            <div class="mb-6 p-4 rounded-xl" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-display font-semibold flex items-center gap-2">
                            <i class="fas fa-magic text-cyan"></i>
                            <span>Auto-Confirm Payments</span>
                        </h4>
                        <p class="text-xs text-muted mt-1">‚ö†Ô∏è RISKY: Automatically activate subscription when user marks payment as sent</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-confirm-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan"></div>
                    </label>
                </div>
            </div>
            
            <!-- Save Button -->
            <div class="flex gap-3">
                <button onclick="saveWalletSettings()" class="cyber-btn cyber-btn-gradient-purple flex-1">
                    <i class="fas fa-save"></i>
                    <span>Save All Settings</span>
                </button>
                <button onclick="closeWalletSettingsModal()" class="cyber-btn cyber-btn-outline">
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let socket = null;
    let masterChart = null;
    let currentPeriod = '24h';
    let currentStatsMode = 'pnl';
    let currentEditingCategory = null;

    // Wait for Socket.io to load
    function initSocket() {
        if (typeof io === 'undefined') {
            setTimeout(initSocket, 100);
            return;
        }
        // Configure Socket.IO with reconnection throttling to prevent spam
        socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,      // Start with 1 second
            reconnectionDelayMax: 30000,  // Max 30 seconds between attempts
            randomizationFactor: 0.5,     // Add randomness
            timeout: 20000,
            transports: ['websocket', 'polling']
        });
        socket.on('connect', () => { console.log('Admin connected'); showToast('Connected', 'success', 2000); });
        socket.on('connect_error', (err) => { console.warn('Socket error:', err.message); });
        socket.on('disconnect', (reason) => { console.log('Disconnected:', reason); });
        socket.on('master_data', (data) => {
            document.getElementById('master-balance').textContent = '$' + data.balance;
            if (data.positions) renderMasterPositions(data.positions);
            if (data.exchange_balances) renderExchangeBalances(data.exchange_balances);
        });
        
        socket.on('new_log', (entry) => {
            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.className = `p-1.5 bg-[var(--bg-element)] rounded log-entry ${entry.is_error ? 'log-error' : 'log-info'}`;
            div.innerHTML = `<span class="text-muted">[${entry.time}]</span><span class="text-cyan ml-1">${entry.symbol}</span><span class="ml-1 text-bright">${entry.message}</span>`;
            container.insertBefore(div, container.firstChild);
            if (container.children.length > 30) container.removeChild(container.lastChild);
        });

        socket.on('trade_closed', (trade) => {
            const tbody = document.getElementById('trades-body');
            const tr = document.createElement('tr');
            tr.className = 'trade-row border-b border-[var(--border-color)] border-opacity-30';
            tr.innerHTML = `<td class="py-2 px-2 text-muted">${trade.time}</td><td class="py-2 px-2 font-bold text-bright">${trade.node}</td><td class="py-2 px-2 font-mono">${trade.symbol}</td><td class="py-2 px-1 text-center"><span class="badge ${trade.side === 'LONG' ? 'badge-success' : 'badge-danger'}">${trade.side}</span></td><td class="py-2 px-2 text-right font-mono font-bold ${trade.pnl >= 0 ? 'text-green' : 'text-red'}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}$</td>`;
            tbody.insertBefore(tr, tbody.firstChild);
            if (trade.pnl >= 0) { showToast(`+${trade.pnl.toFixed(2)}$ (${trade.symbol})`, 'success'); if (typeof celebrateSuccess === 'function') celebrateSuccess(); }
            else showToast(`${trade.pnl.toFixed(2)}$ (${trade.symbol})`, 'warning');
        });
        
        socket.on('new_message', (msg) => { if (!msg.is_from_admin) { showToast(`üì© New message from ${msg.sender_name}`, 'info'); loadUnreadCount(); } });
    }
    initSocket();
    
    function renderMasterPositions(positions) {
        const container = document.getElementById('master-positions-container');
        const countEl = document.getElementById('master-positions-count');
        if (countEl) countEl.textContent = positions?.length || 0;
        if (!positions || positions.length === 0) {
            container.innerHTML = `<div class="text-center py-6 text-muted"><i class="fas fa-inbox text-2xl mb-1 opacity-30"></i><p class="text-xs">No positions</p></div>`;
            return;
        }
        container.innerHTML = positions.map(pos => `
            <div class="position-card p-2 bg-[var(--bg-element)] rounded-lg" style="border-left: 2px solid ${pos.side === 'LONG' ? 'var(--neon-green)' : 'var(--neon-red)'};">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="badge text-xxs ${pos.side === 'LONG' ? 'badge-success' : 'badge-danger'}">${pos.side}</span>
                        <span class="font-mono font-bold text-xs text-bright">${pos.symbol}</span>
                        <span class="text-xxs text-cyan">${pos.exchange || 'Binance'}</span>
                    </div>
                    <span class="font-bold text-xs font-mono ${pos.unrealized_pnl >= 0 ? 'text-green' : 'text-red'}">${pos.unrealized_pnl >= 0 ? '+' : ''}$${parseFloat(pos.unrealized_pnl).toFixed(2)}</span>
                </div>
            </div>
        `).join('');
    }
    
    function renderExchangeBalances(balances) {
        const container = document.getElementById('exchange-balances-container');
        if (!container) return;
        
        if (!balances || balances.length === 0) {
            container.innerHTML = '<span class="text-muted text-xs">No exchanges connected</span>';
            return;
        }
        
        container.innerHTML = balances.map(ex => `
            <div class="flex items-center justify-between p-2 rounded" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <span class="text-xs font-semibold">${ex.exchange}</span>
                <span class="font-mono text-sm ${ex.balance > 0 ? 'text-green' : 'text-muted'} font-bold">
                    ${ex.balance !== null ? '$' + ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : (ex.error ? '‚ö†Ô∏è' : '...')}
                </span>
            </div>
        `).join('');
    }


    function confirmPanic() {
        if (confirm('‚ö†Ô∏è Close ALL positions on ALL accounts?\n\nThis is IRREVERSIBLE!')) {
            showToast('üö® Executing panic exit...', 'error');
            fetch('/api/admin/panic', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(r => r.json())
                .then(data => { if (data.success) { showToast(`Closed: Master=${data.master_closed}, Slaves=${data.slaves_closed}`, 'success'); setTimeout(() => location.reload(), 2000); } else showToast('Error: ' + (data.error || 'Unknown'), 'error'); })
                .catch(() => showToast('Network error!', 'error'));
        }
    }
    function clearLogs() { document.getElementById('log-container').innerHTML = `<div class="p-1.5 bg-[var(--bg-element)] rounded log-entry log-info"><span class="text-cyan">[SYSTEM]</span><span class="text-muted ml-1">Logs cleared</span></div>`; }
    function setChartPeriod(period) { currentPeriod = period; document.querySelectorAll('.period-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period)); loadMasterChart(); loadMasterStats(); }
    function loadMasterStats() {
        fetch(`/api/master_stats?period=${currentPeriod}`).then(r => r.json()).then(data => {
                    const pnl = data.total_pnl;
            document.getElementById('stats-result').textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(0)}`;
            document.getElementById('stats-result').className = `text-xs font-bold font-mono ${pnl >= 0 ? 'text-green' : 'text-red'}`;
            document.getElementById('stats-trades').textContent = data.total_trades;
            document.getElementById('stats-winrate').textContent = `${data.win_rate}%`;
            document.getElementById('stats-avgroi').textContent = `${data.avg_roi >= 0 ? '+' : ''}${data.avg_roi.toFixed(0)}%`;
        }).catch(console.error);
    }
    function loadMasterChart() {
        if (typeof Chart === 'undefined') {
            setTimeout(loadMasterChart, 200);
            return;
        }
        fetch(`/api/balance_history?user_id=master&period=${currentPeriod}`).then(r => r.json()).then(data => {
                const ctx = document.getElementById('masterChart');
                if (masterChart) masterChart.destroy();
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 130);
            gradient.addColorStop(0, 'rgba(255, 0, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(255, 0, 255, 0)');
            masterChart = new Chart(ctx, { type: 'line', data: { labels: data.map(d => d.time), datasets: [{ data: data.map(d => d.balance), borderColor: '#ff00ff', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true, grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#555', font: { size: 8 } } } }, animation: { duration: 500 } } });
        }).catch(console.error);
    }
    function loadUnreadCount() { fetch('/api/messages/unread').then(r => r.json()).then(data => { const stat = document.getElementById('unread-messages-stat'); if (stat) stat.querySelector('p').textContent = data.unread; }).catch(console.error); }

    // ==================== CHAT MODERATION ====================
    
    async function loadChatUsers() {
        try {
            const response = await fetch('/api/users/list');
            const users = await response.json();
            const select = document.getElementById('chatModerateUser');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Select User --</option>';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = `${u.username} (${u.name || u.username})`;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('Failed to load users:', err);
        }
    }
    
    async function refreshChatBans() {
        try {
            const response = await fetch('/api/admin/chat/bans?active_only=true');
            const data = await response.json();
            
            if (!data.success) {
                showToast(data.error || 'Failed to load bans', 'error');
                return;
            }
            
            const container = document.getElementById('chatBansList');
            const countEl = document.getElementById('activeBansCount');
            
            if (countEl) countEl.textContent = data.bans.length;
            
            if (!data.bans || data.bans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-green">
                        <i class="fas fa-check-circle"></i> No active bans
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.bans.map(ban => `
                <div class="flex items-center justify-between p-2 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="badge ${ban.ban_type === 'ban' ? 'badge-danger' : 'badge-warning'}">
                            ${ban.ban_type.toUpperCase()}
                        </span>
                        <span class="text-sm font-semibold">${ban.username}</span>
                        ${ban.reason ? `<span class="text-xs text-muted">- ${ban.reason}</span>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${ban.expires_at ? `<span class="text-xxs text-muted">Expires: ${new Date(ban.expires_at).toLocaleString()}</span>` : '<span class="text-xxs text-red">Permanent</span>'}
                        <button onclick="unbanUser(${ban.user_id})" class="cyber-btn cyber-btn-outline cyber-btn-sm" title="Remove ban">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
        } catch (err) {
            console.error('Failed to refresh bans:', err);
            showToast('Failed to load bans', 'error');
        }
    }
    
    async function muteSelectedUser(duration) {
        const userId = document.getElementById('chatModerateUser').value;
        if (!userId) {
            showToast('Please select a user first', 'warning');
            return;
        }
        
        const reason = prompt(`Mute reason (optional):`);
        
        try {
            const response = await fetch('/api/admin/chat/mute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: parseInt(userId),
                    duration: duration,
                    reason: reason || 'Chat rule violation'
                })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                refreshChatBans();
            } else {
                showToast(data.error || 'Failed to mute user', 'error');
            }
        } catch (err) {
            console.error('Mute error:', err);
            showToast('Failed to mute user', 'error');
        }
    }
    
    async function banSelectedUser() {
        const userId = document.getElementById('chatModerateUser').value;
        if (!userId) {
            showToast('Please select a user first', 'warning');
            return;
        }
        
        if (!confirm('Are you sure you want to PERMANENTLY ban this user from chat?')) {
            return;
        }
        
        const reason = prompt(`Ban reason:`);
        
        try {
            const response = await fetch('/api/admin/chat/ban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: parseInt(userId),
                    reason: reason || 'Chat rule violation'
                })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                refreshChatBans();
            } else {
                showToast(data.error || 'Failed to ban user', 'error');
            }
        } catch (err) {
            console.error('Ban error:', err);
            showToast('Failed to ban user', 'error');
        }
    }
    
    async function unbanUser(userId) {
        if (!confirm('Remove this ban/mute?')) return;
        
        try {
            const response = await fetch('/api/admin/chat/unban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                refreshChatBans();
            } else {
                showToast(data.error || 'Failed to unban user', 'error');
            }
        } catch (err) {
            console.error('Unban error:', err);
            showToast('Failed to unban user', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => { loadMasterChart(); loadMasterStats(); loadUnreadCount(); loadAllExchangeConfigs(); loadExchangeConfigs(); loadPendingExchanges(); loadAllUserExchanges(); loadAdminStrategies(); loadChatUsers(); refreshChatBans(); loadAdminSafetyPool(); loadAdminPlatformStats(); });
    
    // Safety Pool / Insurance Fund
    function loadAdminSafetyPool() {
        fetch('/api/insurance-fund')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.insurance_fund) {
                    const poolEl = document.getElementById('admin-safety-pool');
                    if (poolEl) {
                        poolEl.textContent = data.insurance_fund.formatted_balance;
                    }
                }
            })
            .catch(err => console.log('Admin Safety Pool fetch error:', err));
    }
    // Refresh Safety Pool every 5 minutes
    setInterval(loadAdminSafetyPool, 5 * 60 * 1000);
    
    // Admin Platform Stats
    function loadAdminPlatformStats() {
        // Load referral stats
        fetch('/api/admin/referral-stats')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const totalRefEl = document.getElementById('admin-total-referrals');
                    const pendingEl = document.getElementById('admin-pending-payouts');
                    if (totalRefEl) totalRefEl.textContent = data.total_referrals || 0;
                    if (pendingEl) pendingEl.textContent = '$' + (data.pending_payouts || 0).toFixed(2);
                }
            })
            .catch(() => {});
        
        // Load premium users count
        fetch('/api/admin/subscription-stats')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const premiumEl = document.getElementById('admin-premium-users');
                    if (premiumEl) premiumEl.textContent = data.premium_count || 0;
                }
            })
            .catch(() => {
                const premiumEl = document.getElementById('admin-premium-users');
                if (premiumEl) premiumEl.textContent = '0';
            });
        
        // Load subscription settings for admin panel
        loadSubscriptionSettings();
        loadPendingPayments();
        
        // Load active tournament
        fetch('/api/tournament/active')
            .then(r => r.json())
            .then(data => {
                const tournamentEl = document.getElementById('admin-active-tournament');
                if (tournamentEl) {
                    if (data.success && data.tournament) {
                        tournamentEl.textContent = data.tournament.name;
                        tournamentEl.style.color = '#eab308';
                    } else {
                        tournamentEl.textContent = 'None active';
                        tournamentEl.style.color = 'rgba(255,255,255,0.5)';
                    }
                }
            })
            .catch(() => {
                const tournamentEl = document.getElementById('admin-active-tournament');
                if (tournamentEl) tournamentEl.textContent = 'None';
            });
    }
    
    // Exchange Config - ALL exchanges (for connecting)
    let allExchangeConfigs = [];
    let isLoadingExchangeConfigs = false;
    let lastLoadTime = 0;
    
    function loadAllExchangeConfigs() {
        // Prevent rapid successive calls (debounce)
        const now = Date.now();
        if (isLoadingExchangeConfigs || (now - lastLoadTime < 500)) {
            return;
        }
        isLoadingExchangeConfigs = true;
        lastLoadTime = now;
        
        const container = document.getElementById('all-exchanges-container');
        const select = document.getElementById('admin-exchange-select');
        const modal = document.getElementById('adminExchangeModal');
        const isModalOpen = modal && modal.style.display === 'flex';
        
        // Preserve selected value if modal is open
        const selectedValue = select && isModalOpen ? select.value : null;
        
        fetch('/api/admin/exchange-configs').then(r => r.json()).then(configs => {
            allExchangeConfigs = configs;
            
            // Update select in modal only if modal is not open or if we need to refresh options
            if (select && (!isModalOpen || !selectedValue)) {
                select.innerHTML = '<option value="">-- Select Exchange --</option>' + configs.map(c => 
                    `<option value="${c.exchange_name}" data-verified="${c.is_verified}" data-passphrase="${c.requires_passphrase}">${c.display_name} ${c.is_verified ? '‚úì' : ''}</option>`
                ).join('');
                
                // Restore selected value if modal was open
                if (isModalOpen && selectedValue) {
                    select.value = selectedValue;
                    // Trigger change handler to show fields if needed
                    if (selectedValue) {
                        handleAdminExchangeChange(select);
                    }
                }
            }
            
            // Show all exchanges with their status
            if (!configs || configs.length === 0) { 
                container.innerHTML = `<div class="text-center py-3 text-muted col-span-full"><p class="text-xxs">No exchanges configured</p></div>`; 
                return; 
            }
            
            container.innerHTML = configs.map(c => {
                const statusClass = c.is_verified ? (c.is_enabled ? 'bg-[rgba(0,255,136,0.08)] border-[rgba(0,255,136,0.25)]' : 'bg-[rgba(0,245,255,0.08)] border-[rgba(0,245,255,0.25)]') : 'bg-[rgba(255,200,0,0.04)] border-[rgba(255,200,0,0.15)]';
                const iconClass = c.is_verified ? (c.is_enabled ? 'text-green' : 'text-cyan') : 'text-yellow';
                const statusText = c.is_verified ? (c.is_enabled ? 'Active' : 'Verified') : 'Not Connected';
                const statusBadge = c.is_verified ? 
                    `<span class="badge badge-success" style="font-size: 0.35rem;">‚úì</span>` : 
                    `<button onclick="selectExchangeForConnect('${c.exchange_name}')" class="cyber-btn cyber-btn-xs" style="font-size: 0.35rem; padding: 2px 4px;"><i class="fas fa-plug"></i></button>`;
                
                return `<div class="p-2 rounded-lg border ${statusClass} transition-all hover:scale-[1.02]">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 bg-[var(--bg-element)] rounded-lg flex items-center justify-center">
                            <i class="fas fa-building ${iconClass}" style="font-size: 0.6rem;"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-xxs text-bright truncate">${c.display_name}</p>
                            <p class="text-xxs text-muted">${statusText}</p>
                        </div>
                        ${statusBadge}
                    </div>
                </div>`;
            }).join('');
        }).catch(() => {
            container.innerHTML = `<div class="text-center py-3 text-red col-span-full"><p class="text-xxs">Error loading</p></div>`;
        }).finally(() => {
            isLoadingExchangeConfigs = false;
        });
    }
    
    function selectExchangeForConnect(exchangeName) {
        openAdminExchangeModal();
        setTimeout(() => {
            const select = document.getElementById('admin-exchange-select');
            if (select) {
                select.value = exchangeName;
                handleAdminExchangeChange(select);
            }
        }, 100);
    }
    
    // Exchange Config - Verified only (for enabling/disabling)
    let exchangeConfigs = [];
    function loadExchangeConfigs() {
        const container = document.getElementById('exchange-configs-container');
        fetch('/api/admin/exchange-configs').then(r => r.json()).then(configs => {
                exchangeConfigs = configs;
                const verified = configs.filter(c => c.is_verified).length;
            document.getElementById('verified-exchanges-count').textContent = `${verified}`;
            
            const verifiedConfigs = configs.filter(c => c.is_verified);
            if (verifiedConfigs.length === 0) { 
                container.innerHTML = `<div class="text-center py-3 text-muted col-span-full"><i class="fas fa-check-circle text-lg mb-1 opacity-30"></i><p class="text-xxs">No verified exchanges yet. Connect above first!</p></div>`; 
                    return;
                }
                
            container.innerHTML = verifiedConfigs.map(c => `<div class="p-2 rounded-lg border ${c.is_enabled ? 'bg-[rgba(0,255,136,0.08)] border-[rgba(0,255,136,0.25)]' : 'bg-[rgba(0,245,255,0.04)] border-[rgba(0,245,255,0.15)]'} transition-all">
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 ${c.is_enabled ? 'bg-[rgba(0,255,136,0.15)]' : 'bg-[rgba(0,245,255,0.15)]'} rounded-lg flex items-center justify-center">
                        <i class="fas fa-building ${c.is_enabled ? 'text-green' : 'text-cyan'}" style="font-size: 0.6rem;"></i>
                                    </div>
                                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-xxs text-bright truncate">${c.display_name}</p>
                        <p class="text-xxs text-muted">${c.is_enabled ? 'Enabled for users' : 'Disabled'}</p>
                                    </div>
                    <div class="flex items-center gap-1">
                        <label class="cursor-pointer" title="Enable for users">
                            <input type="checkbox" class="cyber-checkbox" ${c.is_enabled ? 'checked' : ''} onchange="toggleExchangeConfig('${c.exchange_name}', this.checked)">
                                    </label>
                        <button onclick="disconnectExchange('${c.exchange_name}')" class="w-5 h-5 rounded flex items-center justify-center text-red hover:bg-[rgba(255,0,68,0.08)]" title="Disconnect">
                            <i class="fas fa-unlink" style="font-size: 0.5rem;"></i>
                        </button>
                                </div>
                            </div>
            </div>`).join('');
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red col-span-full"><p class="text-xxs">Error loading</p></div>`);
    }
    
    function toggleExchangeConfig(name, isEnabled) { 
        fetch(`/api/admin/exchange-configs/${name}/toggle`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_enabled: isEnabled })
        }).then(r => r.json()).then(result => { 
            if (result.success) showToast(result.message, 'success'); 
            else showToast(result.error || 'Error', 'error'); 
                loadExchangeConfigs();
            loadAllExchangeConfigs();
        }).catch(() => { showToast('Network error', 'error'); loadExchangeConfigs(); }); 
    }
    
    function disconnectExchange(name) {
        if (!confirm(`Disconnect ${name.toUpperCase()}?\n\nThis will also disable it for all users.`)) return;
        fetch(`/api/admin/exchange-configs/${name}/disconnect`, { 
            method: 'POST' 
        }).then(r => r.json()).then(result => { 
            if (result.success) showToast(result.message || 'Disconnected!', 'success'); 
            else showToast(result.error || 'Error', 'error'); 
            loadExchangeConfigs();
            loadAllExchangeConfigs();
        }).catch(() => showToast('Network error', 'error')); 
    }
    
    // Admin Exchange Modal
    function openAdminExchangeModal() {
        let modal = document.getElementById('adminExchangeModal');
        
        if (!modal) {
            // Create modal HTML
            const modalHtml = `
                <div id="adminExchangeModal" class="modal-overlay" style="display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this)closeAdminExchangeModal()">
                    <div class="modal-card" style="max-width: 480px;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-plug text-gradient"></i>
                                <span>Add Exchange</span>
                            </div>
                            <button class="modal-close" onclick="closeAdminExchangeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p class="text-sm text-muted mb-4">Connect with YOUR admin API keys. Once verified, users can add their own keys to this exchange.</p>
                            
                            <form id="admin-exchange-form" onsubmit="submitAdminExchange(event)" class="flex flex-col gap-4">
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm text-muted">Exchange</label>
                                    <select id="admin-exchange-select" name="exchange_name" class="cyber-select" required onchange="handleAdminExchangeChange(this)">
                                        <option value="">Loading exchanges...</option>
                                    </select>
                                </div>
                                
                                <div id="admin-exchange-status" class="hidden p-3 rounded-lg border text-sm"></div>
                                
                                <div id="admin-exchange-fields" class="flex flex-col gap-4 hidden">
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm text-muted">Admin API Key</label>
                                        <input type="text" id="admin-api-key" name="api_key" class="input font-mono" placeholder="Your admin API Key" required minlength="10">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm text-muted">Admin API Secret</label>
                                        <input type="password" id="admin-api-secret" name="api_secret" class="input font-mono" placeholder="Your admin API Secret" required minlength="10">
                                    </div>
                                    <div id="admin-passphrase-field" class="flex flex-col gap-2 hidden">
                                        <label class="text-sm text-muted">Passphrase</label>
                                        <input type="password" id="admin-passphrase" name="passphrase" class="input font-mono" placeholder="Passphrase (required for this exchange)">
                                    </div>
                                    
                                    <button type="submit" class="cyber-btn w-full" id="admin-exchange-submit-btn">
                                        <i class="fas fa-plug"></i>
                                        <span>Verify & Connect</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modal = document.getElementById('adminExchangeModal');
        } else {
            modal.style.display = 'flex';
        }
        
        // Reset form
        const form = document.getElementById('admin-exchange-form');
        const fields = document.getElementById('admin-exchange-fields');
        const status = document.getElementById('admin-exchange-status');
        const select = document.getElementById('admin-exchange-select');
        
        if (form) form.reset();
        if (fields) fields.classList.add('hidden');
        if (status) status.classList.add('hidden');
        
        // Load exchanges into select
        fetch('/api/admin/exchange-configs')
            .then(r => {
                if (!r.ok) throw new Error('API error: ' + r.status);
                return r.json();
            })
            .then(configs => {
                console.log('Admin exchange configs loaded:', configs);
                if (select) {
                    // Clear existing options
                    select.innerHTML = '';
                    
                    if (!configs || configs.length === 0) {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'No exchanges available';
                        select.appendChild(opt);
                        showToast('No exchanges configured. Please check database.', 'warning');
                        return;
                    }
                    
                    // Add default option
                    const defaultOpt = document.createElement('option');
                    defaultOpt.value = '';
                    defaultOpt.textContent = '-- Select Exchange --';
                    select.appendChild(defaultOpt);
                    
                    // Add exchange options
                    configs.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.exchange_name;
                        opt.dataset.verified = c.is_verified;
                        opt.dataset.passphrase = c.requires_passphrase;
                        opt.textContent = c.display_name + (c.is_verified ? ' ‚úì' : '');
                        select.appendChild(opt);
                    });
                    
                    console.log('Select populated with', configs.length, 'exchanges');
                }
            })
            .catch(err => {
                console.error('Error loading exchanges:', err);
                if (select) {
                    select.innerHTML = '<option value="">Error loading exchanges</option>';
                }
                showToast('Error loading exchanges: ' + err.message, 'error');
            });
        
        document.body.style.overflow = 'hidden';
    }
    
    function closeAdminExchangeModal() {
        const modal = document.getElementById('adminExchangeModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    function handleAdminExchangeChange(select) {
        const exchangeName = select.value;
        const fieldsContainer = document.getElementById('admin-exchange-fields');
        const statusContainer = document.getElementById('admin-exchange-status');
        const passphraseField = document.getElementById('admin-passphrase-field');
        const passphraseInput = document.getElementById('admin-passphrase');
        
        if (!exchangeName) {
            fieldsContainer.classList.add('hidden');
            statusContainer.classList.add('hidden');
            return;
        }
        
        const option = select.options[select.selectedIndex];
        const isVerified = option.dataset.verified === 'true';
        const needsPassphrase = option.dataset.passphrase === 'true';
        
        if (isVerified) {
            statusContainer.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-check-circle text-green"></i><span class="text-green">Already verified!</span></div><p class="text-muted mt-1">You can re-verify with new API keys if needed.</p>`;
            statusContainer.className = 'p-2 rounded-lg border border-[rgba(0,255,136,0.25)] bg-[rgba(0,255,136,0.05)] text-xxs';
            statusContainer.classList.remove('hidden');
        } else {
            statusContainer.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-info-circle text-yellow"></i><span class="text-yellow">Not connected yet</span></div><p class="text-muted mt-1">Enter your admin API keys to verify this exchange.</p>`;
            statusContainer.className = 'p-2 rounded-lg border border-[rgba(255,200,0,0.25)] bg-[rgba(255,200,0,0.05)] text-xxs';
            statusContainer.classList.remove('hidden');
        }
        
        if (needsPassphrase) {
            passphraseField.classList.remove('hidden');
            passphraseInput.required = true;
        } else {
            passphraseField.classList.add('hidden');
            passphraseInput.required = false;
        }
        
        fieldsContainer.classList.remove('hidden');
    }
    
    function submitAdminExchange(event) {
        event.preventDefault();
        const form = document.getElementById('admin-exchange-form');
        const btn = document.getElementById('admin-exchange-submit-btn');
        const exchangeSelect = document.getElementById('admin-exchange-select');
        const apiKeyInput = document.getElementById('admin-api-key');
        const apiSecretInput = document.getElementById('admin-api-secret');
        const passphraseField = document.getElementById('admin-passphrase-field');
        const passphraseInput = document.getElementById('admin-passphrase');
        
        // Get form values properly
        const exchangeName = exchangeSelect ? exchangeSelect.value.trim() : '';
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
        const apiSecret = apiSecretInput ? apiSecretInput.value.trim() : '';
        
        // Check if passphrase field is visible (required)
        const isPassphraseVisible = passphraseField && !passphraseField.classList.contains('hidden');
        const passphrase = isPassphraseVisible && passphraseInput ? passphraseInput.value.trim() : null;
        
        if (!exchangeName) {
            showToast('Please select an exchange', 'error');
            return;
        }
        
        if (!apiKey || apiKey.length < 10) {
            showToast('Please enter a valid API Key (minimum 10 characters)', 'error');
            return;
        }
        
        if (!apiSecret || apiSecret.length < 10) {
            showToast('Please enter a valid API Secret (minimum 10 characters)', 'error');
            return;
        }
        
        // Validate passphrase if field is visible
        if (isPassphraseVisible && (!passphrase || passphrase.length === 0)) {
            showToast('Passphrase is required for this exchange', 'error');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        
        const requestBody = {
            api_key: apiKey,
            api_secret: apiSecret
        };
        
        // Add passphrase only if field is visible (even if empty, backend will validate)
        if (isPassphraseVisible) {
            requestBody.passphrase = passphrase || '';
        }
        
        // URL encode the exchange name to handle any special characters
        const encodedExchangeName = encodeURIComponent(exchangeName);
        
        fetch(`/api/admin/exchange-configs/${encodedExchangeName}/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => Promise.reject(err));
            }
            return r.json();
        })
        .then(result => {
            if (result.success) {
                showToast(result.message || 'Exchange verified!', 'success');
                closeAdminExchangeModal();
                // Delay reload to ensure modal is closed first
                setTimeout(() => {
                    loadExchangeConfigs();
                    loadAllExchangeConfigs();
                }, 500);
            } else {
                showToast(result.error || 'Verification failed', 'error');
            }
        })
        .catch((error) => {
            console.error('Error submitting exchange:', error);
            const errorMsg = error.error || error.message || 'Network error. Please try again.';
            showToast(errorMsg, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plug"></i> <span>Verify & Connect</span>';
        });
    }
    
    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape') { 
            closeAdminExchangeModal(); 
        } 
    });

    // User Exchanges
    let allUserExchanges = [];
    function loadAllUserExchanges() {
        const container = document.getElementById('user-exchanges-container');
        const countEl = document.getElementById('active-trading-count');
        fetch('/api/admin/exchanges/all').then(r => r.json()).then(exchanges => {
            allUserExchanges = exchanges;
            const tradingCount = exchanges.filter(ex => ex.trading_enabled && ex.status === 'APPROVED').length;
            countEl.textContent = tradingCount;
            if (!exchanges || exchanges.length === 0) { 
                container.innerHTML = `<div class="text-center py-4 text-muted"><p class="text-xxs">No user exchanges</p></div>`; 
                return; 
            }
            container.innerHTML = exchanges.map(ex => `
                <div class="p-2 bg-[var(--bg-element)] rounded-lg border border-[var(--border-color)]" id="admin-ex-${ex.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 min-w-0">
                            <div class="w-6 h-6 bg-[rgba(0,255,136,0.12)] border border-[rgba(0,255,136,0.25)] rounded-lg flex items-center justify-center">
                                <i class="fas fa-user text-xxs text-green"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-bold text-xxs text-bright truncate">${ex.username}</p>
                                <p class="text-xxs text-muted truncate">${ex.display_name}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="admin-ex-bal-${ex.id}" class="font-mono text-xs text-muted">...</span>
                            <span class="text-xxs ${ex.trading_enabled ? 'text-green' : 'text-yellow'}">${ex.trading_enabled ? 'üü¢' : 'üü°'}</span>
                            <input type="checkbox" class="cyber-checkbox" ${ex.trading_enabled ? 'checked' : ''} onchange="toggleUserExchangeTrading(${ex.id}, this.checked)">
                        </div>
                    </div>
                </div>
            `).join('');
            // Load balances for all users
            loadAllUserBalances();
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red"><p class="text-xxs">Error loading</p></div>`);
    }
    
    function loadAllUserBalances() {
        fetch('/api/admin/users/balances').then(r => r.json()).then(data => {
            if (data.success && data.users) {
                // Create a map of exchange balances
                const balanceMap = {};
                data.users.forEach(user => {
                    if (user.exchanges) {
                        user.exchanges.forEach(ex => {
                            balanceMap[ex.id] = ex;
                        });
                    }
                });
                // Update UI
                allUserExchanges.forEach(ex => {
                    const balanceEl = document.getElementById(`admin-ex-bal-${ex.id}`);
                    if (balanceEl && balanceMap[ex.id]) {
                        const b = balanceMap[ex.id];
                        if (b.balance !== null && b.balance !== undefined) {
                            balanceEl.className = 'font-mono text-xs font-bold text-green';
                            balanceEl.textContent = '$' + b.balance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                        } else if (b.error) {
                            balanceEl.className = 'text-xxs text-red';
                            balanceEl.textContent = '‚ö†Ô∏è';
                            balanceEl.title = b.error;
                        } else {
                            balanceEl.textContent = '‚Äî';
                        }
                    }
                });
            }
        }).catch(err => console.error('Error loading balances:', err));
    }
    function toggleUserExchangeTrading(id, enabled) { fetch(`/api/admin/exchanges/${id}/trading`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trading_enabled: enabled }) }).then(r => r.json()).then(result => { if (result.success) showToast(result.message, 'success'); else showToast(result.error, 'error'); loadAllUserExchanges(); }).catch(() => { showToast('Error', 'error'); loadAllUserExchanges(); }); }

    // Pending Exchanges
    function loadPendingExchanges() {
        const container = document.getElementById('pending-exchanges-container');
        const countEl = document.getElementById('pending-exchanges-count');
        fetch('/api/admin/exchanges/pending').then(r => r.json()).then(exchanges => {
                countEl.textContent = exchanges.length;
            if (!exchanges || exchanges.length === 0) { container.innerHTML = `<div class="text-center py-4 text-muted"><i class="fas fa-check-circle text-lg mb-1 text-green opacity-50"></i><p class="text-xxs">No pending</p></div>`; return; }
            container.innerHTML = exchanges.map(ex => `<div class="p-2 bg-[var(--bg-element)] rounded-lg border border-[rgba(255,200,0,0.25)]"><div class="flex items-center justify-between"><div class="flex items-center gap-2 min-w-0"><div class="min-w-0"><p class="font-bold text-xxs text-bright truncate">${ex.username}</p><p class="text-xxs text-muted truncate">${ex.display_name}</p></div></div><div class="flex items-center gap-1"><button onclick="approveExchange(${ex.id})" class="cyber-btn cyber-btn-xs cyber-btn-success"><i class="fas fa-check"></i></button><button onclick="rejectExchange(${ex.id})" class="cyber-btn cyber-btn-xs cyber-btn-danger"><i class="fas fa-times"></i></button></div></div></div>`).join('');
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red"><p class="text-xxs">Error</p></div>`);
    }
    function approveExchange(id) { fetch(`/api/admin/exchanges/${id}/approve`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) }).then(r => r.json()).then(result => { if (result.success) showToast('Approved!', 'success'); else showToast(result.error, 'error'); loadPendingExchanges(); loadAllUserExchanges(); }).catch(() => showToast('Error', 'error')); }
    function rejectExchange(id) { if (!confirm('Reject this exchange?')) return; fetch(`/api/admin/exchanges/${id}/reject`, { method: 'POST' }).then(r => r.json()).then(result => { if (result.success) showToast('Rejected', 'warning'); else showToast(result.error, 'error'); loadPendingExchanges(); }).catch(() => showToast('Error', 'error')); }

    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape') { 
            closeAdminExchangeModal(); 
            closeUserDetailsModal();
            closeAdminAvatarModal();
        } 
    });

    // User Details Modal Functions
    function openUserDetailsModal(userId) {
        const modal = document.getElementById('userDetailsModal');
        const content = document.getElementById('userDetailsContent');
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        content.innerHTML = `<div class="empty-state"><div class="loading-spinner" style="margin: 0 auto 16px;"></div><p>Loading...</p></div>`;
        
        fetch(`/api/admin/user/${userId}/details`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const u = data.user;
                    const avatarHtml = u.avatar_type === 'image' && u.avatar 
                        ? `<img src="/static/avatars/${u.avatar}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                        : `<span style="font-size: 2rem;">${u.avatar || 'üßë‚Äçüíª'}</span>`;
                    
                    // Format balance growth
                    const growthColor = u.balance_growth_30d >= 0 ? 'text-green' : 'text-red';
                    const growthSign = u.balance_growth_30d >= 0 ? '+' : '';
                    
                    content.innerHTML = `
                        <div class="flex items-center gap-4 mb-4">
                            <div class="user-avatar-lg" style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 212, 0.2)); border: 3px solid var(--neon-cyan); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer;" onclick="openUserAvatarUpload(${u.id})">
                                ${avatarHtml}
                                <div style="position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-camera" style="font-size: 0.45rem; color: #000;"></i>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-display font-semibold text-lg">${u.first_name || ''} ${u.last_name || ''}</h3>
                                <p class="text-sm text-muted">@${u.username}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="badge ${u.is_paused ? 'badge-warning' : (u.is_active ? 'badge-success' : 'badge-danger')}" style="font-size: 0.45rem;">
                                        ${u.is_paused ? '‚è∏Ô∏è Paused' : (u.is_active ? 'üü¢ Active' : 'üî¥ Inactive')}
                                    </span>
                                    ${u.telegram_enabled ? '<span class="badge badge-primary" style="font-size: 0.45rem;"><i class="fab fa-telegram"></i> TG</span>' : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Current Balance Card -->
                        <div class="p-3 mb-4 rounded-lg border" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 0, 212, 0.1)); border-color: rgba(0, 212, 255, 0.3);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xxs text-muted">Current Balance</div>
                                    <div class="text-xl font-mono font-bold text-cyan">$${u.current_balance?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xxs text-muted">30d Growth</div>
                                    <div class="text-sm font-bold ${growthColor}">${growthSign}${u.balance_growth_30d || 0}%</div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-[rgba(0,212,255,0.2)]">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-muted">Target:</span>
                                    <span class="text-cyan font-mono">$${u.target_balance?.toLocaleString() || '1,000'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contact Info -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-envelope text-purple"></i> Email</div>
                                <div class="text-sm font-mono truncate" title="${u.email || ''}">${u.email || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-phone text-cyan"></i> Phone</div>
                                <div class="text-sm font-mono">${u.phone || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-calendar text-green"></i> Registered</div>
                                <div class="text-sm">${u.created_at || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-clock text-yellow"></i> Days Active</div>
                                <div class="text-sm font-bold">${u.days_registered || 0} days</div>
                            </div>
                        </div>
                        
                        <!-- Trading Settings -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1">Risk</div>
                                <div class="text-sm font-bold">${u.custom_risk > 0 ? u.custom_risk + '%' : 'AUTO'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1">Leverage</div>
                                <div class="text-sm font-bold">${u.custom_leverage > 0 ? 'x' + u.custom_leverage : 'AUTO'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1">Max Pos</div>
                                <div class="text-sm font-bold">${u.max_positions}</div>
                            </div>
                        </div>
                        
                        <!-- Trading Stats -->
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <div class="p-2 bg-[rgba(0,245,255,0.08)] border border-[rgba(0,245,255,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-cyan">${u.total_trades}</div>
                                <div class="text-xxs text-muted">Trades</div>
                            </div>
                            <div class="p-2 bg-[rgba(0,255,136,0.08)] border border-[rgba(0,255,136,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-green">${u.winning_trades}</div>
                                <div class="text-xxs text-muted">Wins</div>
                            </div>
                            <div class="p-2 bg-[rgba(255,51,102,0.08)] border border-[rgba(255,51,102,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-red">${u.losing_trades || 0}</div>
                                <div class="text-xxs text-muted">Losses</div>
                            </div>
                            <div class="p-2 bg-[rgba(255,0,212,0.08)] border border-[rgba(255,0,212,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-magenta">${u.win_rate}%</div>
                                <div class="text-xxs text-muted">Win Rate</div>
                            </div>
                        </div>
                        
                        <!-- PnL & ROI -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 bg-[${u.total_pnl >= 0 ? 'rgba(0,255,136,0.08)' : 'rgba(255,51,102,0.08)'}] border border-[${u.total_pnl >= 0 ? 'rgba(0,255,136,0.2)' : 'rgba(255,51,102,0.2)'}] rounded-lg text-center">
                                <div class="text-xl font-bold font-mono ${u.total_pnl >= 0 ? 'text-green' : 'text-red'}">${u.total_pnl >= 0 ? '+' : ''}$${u.total_pnl?.toLocaleString() || '0'}</div>
                                <div class="text-xxs text-muted">Total PnL</div>
                            </div>
                            <div class="p-3 bg-[rgba(255,208,0,0.08)] border border-[rgba(255,208,0,0.2)] rounded-lg text-center">
                                <div class="text-xl font-bold font-mono text-yellow">${u.avg_roi >= 0 ? '+' : ''}${u.avg_roi || 0}%</div>
                                <div class="text-xxs text-muted">Avg ROI</div>
                            </div>
                        </div>
                        
                        <!-- Last Trade -->
                        ${u.last_trade ? `
                        <div class="p-3 mb-4 bg-[var(--color-surface-2)] rounded-lg">
                            <div class="text-xxs text-muted mb-2"><i class="fas fa-history"></i> Last Trade</div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="badge ${u.last_trade.side === 'LONG' ? 'badge-success' : 'badge-danger'}" style="font-size: 0.45rem;">${u.last_trade.side}</span>
                                    <span class="font-mono font-semibold">${u.last_trade.symbol}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-mono font-bold ${u.last_trade.pnl >= 0 ? 'text-green' : 'text-red'}">${u.last_trade.pnl >= 0 ? '+' : ''}$${u.last_trade.pnl}</span>
                                    <span class="text-xxs text-muted ml-2">${u.last_trade.time}</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${u.exchanges && u.exchanges.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-xs text-muted mb-2"><i class="fas fa-plug"></i> Connected Exchanges (${u.exchanges.length})</div>
                            <div class="flex flex-col gap-2">
                                ${u.exchanges.map(ex => `
                                    <div class="p-2 bg-[var(--color-surface-2)] rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-building text-yellow"></i>
                                                <div>
                                                    <span class="text-sm font-semibold">${ex.label || ex.display_name || ex.exchange_name}</span>
                                                    <div class="text-xxs text-muted">${ex.display_name || ex.exchange_name.toUpperCase()}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="badge ${ex.status === 'APPROVED' ? (ex.trading_enabled ? 'badge-success' : 'badge-primary') : 'badge-warning'}" style="font-size: 0.5rem;">
                                                    ${ex.trading_enabled ? 'üü¢ Trading' : ex.status}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-[var(--color-border)] flex items-center justify-between">
                                            <span class="text-xxs text-muted">Balance:</span>
                                            ${ex.balance !== null && ex.balance !== undefined 
                                                ? `<span class="font-mono font-bold ${ex.balance > 0 ? 'text-green' : 'text-muted'}">$${ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>` 
                                                : (ex.balance_error 
                                                    ? `<span class="text-red text-xs" title="${ex.balance_error}">‚ö†Ô∏è ${ex.balance_error.substring(0, 20)}</span>` 
                                                    : (ex.status === 'PENDING' 
                                                        ? '<span class="text-yellow text-xs">‚è≥ Pending approval</span>' 
                                                        : '<span class="text-muted">‚Äî</span>'))}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : '<div class="p-3 mb-4 bg-[rgba(255,200,0,0.08)] border border-[rgba(255,200,0,0.2)] rounded-lg text-center text-yellow text-sm"><i class="fas fa-exclamation-triangle"></i> No exchanges connected</div>'}
                        
                        <!-- Telegram Status -->
                        <div class="p-2 mb-4 bg-[var(--color-surface-2)] rounded-lg flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fab fa-telegram" style="color: ${u.telegram_enabled ? '#0088cc' : 'var(--text-muted)'}; font-size: 1.25rem;"></i>
                                <div>
                                    <div class="text-sm">Telegram Notifications</div>
                                    <div class="text-xxs text-muted">${u.telegram_chat_id ? 'ID: ' + u.telegram_chat_id : 'Not configured'}</div>
                                </div>
                            </div>
                            <span class="badge ${u.telegram_enabled ? 'badge-success' : 'badge-warning'}" style="font-size: 0.5rem;">
                                ${u.telegram_enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                        
                        <div class="pt-4 border-t border-[var(--color-border)] flex flex-col gap-2">
                            <input type="file" id="userAvatarUpload-${u.id}" accept="image/png,image/jpeg,image/gif,image/webp" style="display: none;" onchange="uploadUserAvatar(${u.id}, this)">
                            <button onclick="document.getElementById('userAvatarUpload-${u.id}').click()" class="cyber-btn cyber-btn-outline cyber-btn-sm w-full">
                                <i class="fas fa-camera"></i>
                                <span>Upload User Avatar</span>
                            </button>
                            <button onclick="confirmDeleteUser(${u.id}, '${u.username}')" class="cyber-btn cyber-btn-danger cyber-btn-sm w-full">
                                <i class="fas fa-trash"></i>
                                <span>Delete User</span>
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div class="text-center text-red py-4">Error: ${data.error}</div>`;
                }
            })
            .catch(err => {
                console.error(err);
                content.innerHTML = `<div class="text-center text-red py-4">Failed to load user details</div>`;
            });
    }
    
    function closeUserDetailsModal() {
        const modal = document.getElementById('userDetailsModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    function openUserAvatarUpload(userId) {
        document.getElementById(`userAvatarUpload-${userId}`).click();
    }
    
    function uploadUserAvatar(userId, input) {
        if (!input.files || !input.files[0]) return;
        
        const formData = new FormData();
        formData.append('avatar_file', input.files[0]);
        formData.append('avatar_type', 'image');
        
        showToast('Uploading avatar...', 'info');
        
        fetch(`/admin/update_user_avatar/${userId}`, {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showToast('Avatar updated!', 'success');
                // Refresh modal
                openUserDetailsModal(userId);
                // Refresh page after delay
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.error || 'Error', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast('Failed to upload', 'error');
        });
    }
    
    // Admin Avatar Modal Functions
    function openAdminAvatarModal() {
        const modal = document.getElementById('adminAvatarModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    function closeAdminAvatarModal() {
        const modal = document.getElementById('adminAvatarModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    function selectAdminEmoji(emoji) {
        document.getElementById('selected-admin-emoji').value = emoji;
        document.getElementById('admin-avatar-type').value = 'emoji';
        
        // Update visual selection
        document.querySelectorAll('#emoji-grid .emoji-btn').forEach(btn => {
            btn.classList.remove('border-[var(--neon-cyan)]', 'bg-[rgba(0,245,255,0.1)]');
            btn.classList.add('border-[var(--color-border)]');
        });
        event.target.closest('.emoji-btn').classList.remove('border-[var(--color-border)]');
        event.target.closest('.emoji-btn').classList.add('border-[var(--neon-cyan)]', 'bg-[rgba(0,245,255,0.1)]');
    }
    
    function setAdminAvatarType(type) {
        document.getElementById('admin-avatar-type').value = type;
    }

    // Refresh all user balances
    function refreshAllBalances() {
        const btn = document.getElementById('refresh-balances-btn');
        const icon = btn.querySelector('i');
        
        btn.disabled = true;
        icon.classList.add('fa-spin');
        
        fetch('/api/admin/users/balances')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.users) {
                    // Update balance cells in the table
                    data.users.forEach(user => {
                        const row = document.querySelector(`tr[data-user-id="${user.user_id}"]`);
                        if (!row) return;
                        
                        const balanceCell = row.querySelector('.balance-cell');
                        if (!balanceCell) return;
                        
                        if (user.exchanges && user.exchanges.length > 0) {
                            let html = '<div class="flex flex-col gap-1">';
                            user.exchanges.forEach(ex => {
                                const statusClass = ex.trading_enabled ? 'bg-green' : 'bg-yellow';
                                const statusTitle = ex.trading_enabled ? 'Trading enabled' : 'Trading disabled';
                                let balanceHtml = '';
                                
                                if (ex.balance !== null) {
                                    balanceHtml = `<span class="text-green font-bold font-mono">$${Math.round(ex.balance).toLocaleString()}</span>`;
                                } else if (ex.error) {
                                    balanceHtml = `<span class="text-red text-xs" title="${ex.error}">‚ö†Ô∏è</span>`;
                                } else if (ex.status === 'PENDING') {
                                    balanceHtml = '<span class="text-yellow text-xs">‚è≥</span>';
                                } else {
                                    balanceHtml = '<span class="text-muted">‚Äî</span>';
                                }
                                
                                html += `<div class="flex items-center gap-1 text-xs">
                                    <span class="w-2 h-2 rounded-full ${statusClass}" title="${statusTitle}"></span>
                                    <span class="text-muted truncate" style="max-width: 60px;" title="${ex.label}">${ex.exchange_name.substring(0, 3).toUpperCase()}</span>
                                    ${balanceHtml}
                                </div>`;
                            });
                            
                            if (user.exchanges.length > 1) {
                                html += `<div class="border-t border-[var(--color-border)] pt-1 mt-1">
                                    <span class="text-cyan font-bold font-mono text-xs">Œ£ $${Math.round(user.total_balance).toLocaleString()}</span>
                                </div>`;
                            }
                            html += '</div>';
                            balanceCell.innerHTML = html;
                        } else if (user.total_balance > 0) {
                            balanceCell.innerHTML = `<span class="text-green font-bold font-mono">$${Math.round(user.total_balance).toLocaleString()}</span>`;
                        } else {
                            balanceCell.innerHTML = '<span class="text-muted">‚Äî</span>';
                        }
                    });
                    
                    showToast('Balances refreshed!', 'success');
                } else {
                    showToast('Failed to refresh balances', 'error');
                }
            })
            .catch(err => {
                console.error('Error refreshing balances:', err);
                showToast('Network error', 'error');
            })
            .finally(() => {
                btn.disabled = false;
                icon.classList.remove('fa-spin');
            });
    }
    
    // Delete User Functions
    function confirmDeleteUser(userId, username) {
        if (!confirm(`‚ö†Ô∏è Are you sure you want to delete user "${username}"?\n\nThis will permanently delete:\n- All their trades history\n- All their balance history\n- All their exchange connections\n- All their messages\n\nThis action CANNOT be undone!`)) {
            return;
        }
        
        // Double confirmation for safety
        const confirmText = prompt(`Type "${username}" to confirm deletion:`);
        if (confirmText !== username) {
            showToast('Deletion cancelled - username did not match', 'warning');
            return;
        }
        
        deleteUser(userId, username);
    }
    
    function deleteUser(userId, username) {
        showToast('Deleting user...', 'info');
        
        fetch(`/api/admin/user/${userId}/delete`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showToast(result.message || `User ${username} deleted`, 'success');
                closeUserDetailsModal();
                // Remove user row from table
                const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                if (row) {
                    row.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => row.remove(), 300);
                }
            } else {
                showToast(result.error || 'Failed to delete user', 'error');
            }
        })
        .catch(err => {
            console.error('Error deleting user:', err);
            showToast('Network error while deleting user', 'error');
        });
    }

    // ==================== STRATEGY MANAGEMENT ====================
    let adminStrategies = [];
    
    function loadAdminStrategies() {
        const container = document.getElementById('admin-strategies-container');
        if (!container) return;
        
        fetch('/api/admin/strategies')
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load strategies');
                }
                
                adminStrategies = data.strategies;
                renderAdminStrategies();
            })
            .catch(err => {
                console.error('Error loading strategies:', err);
                container.innerHTML = `
                    <div class="text-center py-6 text-red">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load strategies</p>
                        <button onclick="loadAdminStrategies()" class="cyber-btn cyber-btn-sm mt-3">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>`;
            });
    }
    
    function renderAdminStrategies() {
        const container = document.getElementById('admin-strategies-container');
        if (!container) return;
        
        if (!adminStrategies.length) {
            container.innerHTML = `
                <div class="text-center py-6 text-muted">
                    <i class="fas fa-chess-board text-2xl mb-2 opacity-30"></i>
                    <p>No strategies created yet</p>
                </div>`;
            return;
        }
        
        container.innerHTML = adminStrategies.map(s => {
            const riskColor = { low: 'green', medium: 'yellow', high: 'red' }[s.risk_level] || 'muted';
            return `
                <div class="flex items-center justify-between p-3 rounded-lg bg-[rgba(0,0,0,0.3)] border border-[var(--color-border)] hover:border-[var(--neon-purple)] transition-all" data-strategy-id="${s.id}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center ${s.is_active ? 'bg-purple/20' : 'bg-muted/10'}">
                            <i class="fas fa-chess-knight ${s.is_active ? 'text-purple' : 'text-muted'}"></i>
                        </div>
                        <div>
                            <div class="font-display font-semibold ${s.is_active ? 'text-bright' : 'text-muted'}">${s.name}</div>
                            <div class="text-xxs text-muted">${s.description || 'No description'}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="badge badge-${riskColor}">${s.risk_level.toUpperCase()}</span>
                        <span class="text-xs text-muted">${s.subscriber_count || 0} users</span>
                        <div class="flex items-center gap-1">
                            <button onclick="editStrategy(${s.id})" class="cyber-btn cyber-btn-sm cyber-btn-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleStrategy(${s.id}, ${!s.is_active})" class="cyber-btn cyber-btn-sm ${s.is_active ? 'cyber-btn-warning' : 'cyber-btn-gradient-green'}" title="${s.is_active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${s.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            ${s.name !== 'Main' ? `<button onclick="deleteStrategy(${s.id}, '${s.name}')" class="cyber-btn cyber-btn-sm cyber-btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function openCreateStrategyModal() {
        const modalHtml = `
            <div id="strategyModal" class="modal-overlay" style="display: flex;" onclick="if(event.target===this)closeStrategyModal()">
                <div class="modal-card">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-chess-knight text-purple"></i>
                            <span>Create Strategy</span>
                        </div>
                        <button onclick="closeStrategyModal()" class="modal-close"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <form id="strategy-form" onsubmit="submitStrategy(event)" class="space-y-4">
                            <input type="hidden" id="strategy-id" value="">
                            <div class="space-y-1">
                                <label class="text-xs text-muted">Name *</label>
                                <input type="text" id="strategy-name" class="input" placeholder="e.g., Aggressive BTC" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-muted">Description</label>
                                <textarea id="strategy-description" class="input" rows="2" placeholder="Strategy description..."></textarea>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-muted">Risk Level</label>
                                <select id="strategy-risk-level" class="input">
                                    <option value="low">Low Risk</option>
                                    <option value="medium" selected>Medium Risk</option>
                                    <option value="high">High Risk</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted">Risk % Override</label>
                                    <input type="number" id="strategy-risk-perc" class="input" placeholder="Use global" step="0.1" min="0.1" max="100">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted">Leverage Override</label>
                                    <input type="number" id="strategy-leverage" class="input" placeholder="Use global" min="1" max="125">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted">Max Positions</label>
                                    <input type="number" id="strategy-max-pos" class="input" placeholder="Use global" min="1" max="50">
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="strategy-active" class="cyber-checkbox" checked>
                                    <span class="text-sm">Active</span>
                                </label>
                            </div>
                            <button type="submit" class="cyber-btn w-full" id="strategy-submit-btn">
                                <i class="fas fa-save"></i>
                                <span>Create Strategy</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function closeStrategyModal() {
        const modal = document.getElementById('strategyModal');
        if (modal) modal.remove();
    }
    
    function editStrategy(strategyId) {
        const strategy = adminStrategies.find(s => s.id === strategyId);
        if (!strategy) return;
        
        openCreateStrategyModal();
        
        // Wait for modal to be added to DOM
        setTimeout(() => {
            document.getElementById('strategy-id').value = strategyId;
            document.getElementById('strategy-name').value = strategy.name;
            document.getElementById('strategy-description').value = strategy.description || '';
            document.getElementById('strategy-risk-level').value = strategy.risk_level;
            document.getElementById('strategy-risk-perc').value = strategy.default_risk_perc || '';
            document.getElementById('strategy-leverage').value = strategy.default_leverage || '';
            document.getElementById('strategy-max-pos').value = strategy.max_positions || '';
            document.getElementById('strategy-active').checked = strategy.is_active;
            
            document.querySelector('#strategyModal .modal-title span').textContent = 'Edit Strategy';
            document.querySelector('#strategy-submit-btn span').textContent = 'Update Strategy';
        }, 50);
    }
    
    async function submitStrategy(event) {
        event.preventDefault();
        
        const strategyId = document.getElementById('strategy-id').value;
        const isEdit = !!strategyId;
        
        const data = {
            name: document.getElementById('strategy-name').value.trim(),
            description: document.getElementById('strategy-description').value.trim(),
            risk_level: document.getElementById('strategy-risk-level').value,
            default_risk_perc: parseFloat(document.getElementById('strategy-risk-perc').value) || null,
            default_leverage: parseInt(document.getElementById('strategy-leverage').value) || null,
            max_positions: parseInt(document.getElementById('strategy-max-pos').value) || null,
            is_active: document.getElementById('strategy-active').checked
        };
        
        const btn = document.getElementById('strategy-submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const url = isEdit ? `/api/admin/strategies/${strategyId}` : '/api/admin/strategies';
            const response = await fetch(url, {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || `Strategy ${isEdit ? 'updated' : 'created'}!`, 'success');
                closeStrategyModal();
                loadAdminStrategies();
            } else {
                showToast(result.error || 'Failed to save strategy', 'error');
            }
        } catch (err) {
            console.error('Error saving strategy:', err);
            showToast('Network error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save"></i> <span>${isEdit ? 'Update' : 'Create'} Strategy</span>`;
        }
    }
    
    async function toggleStrategy(strategyId, activate) {
        try {
            const response = await fetch(`/api/admin/strategies/${strategyId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: activate })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`Strategy ${activate ? 'activated' : 'deactivated'}`, 'success');
                loadAdminStrategies();
            } else {
                showToast(result.error || 'Failed to update strategy', 'error');
            }
        } catch (err) {
            console.error('Error toggling strategy:', err);
            showToast('Network error', 'error');
        }
    }
    
    async function deleteStrategy(strategyId, strategyName) {
        if (!confirm(`Delete strategy "${strategyName}"?\n\nThis cannot be undone.`)) return;
        
        try {
            const response = await fetch(`/api/admin/strategies/${strategyId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'Strategy deleted', 'success');
                loadAdminStrategies();
            } else {
                showToast(result.error || 'Failed to delete strategy', 'error');
            }
        } catch (err) {
            console.error('Error deleting strategy:', err);
            showToast('Network error', 'error');
        }
    }
    
    // ==================== SERVICE CONFIGURATION ====================
    
    let servicesData = null;
    
    async function refreshServiceStatus() {
        const icon = document.getElementById('service-refresh-icon');
        if (icon) icon.classList.add('fa-spin');
        
        try {
            const response = await fetch('/api/admin/system-settings/service-status');
            const result = await response.json();
            
            if (result.success) {
                renderServicesGrid(result.services);
            } else {
                showToast('Failed to load services', 'error');
            }
        } catch (err) {
            console.error('Error loading services:', err);
            showToast('Network error', 'error');
        } finally {
            if (icon) icon.classList.remove('fa-spin');
        }
    }
    
    function renderServicesGrid(services) {
        const container = document.getElementById('services-grid');
        if (!services || services.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-6 text-muted">
                    <i class="fas fa-plug text-3xl opacity-30 mb-2"></i>
                    <p class="text-sm">No services configured</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = services.map(service => {
            const statusColors = {
                active: 'var(--neon-green)',
                configured: 'var(--neon-yellow)',
                unconfigured: 'var(--text-muted)'
            };
            const statusColor = statusColors[service.status] || statusColors.unconfigured;
            const statusLabel = service.status === 'active' ? 'Active' : 
                              service.status === 'configured' ? 'Ready' : 'Not Set';
            
            return `
                <div class="p-3 bg-[var(--color-surface-2)] border rounded-lg cursor-pointer transition-all duration-200 hover:border-[var(--neon-cyan)] hover:scale-[1.02]"
                     style="border-color: ${service.is_enabled ? service.color + '40' : 'var(--color-border)'};"
                     onclick="openServiceEdit('${service.category}')">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center justify-center" 
                             style="width: 36px; height: 36px; background: ${service.color}15; border: 1px solid ${service.color}30; border-radius: var(--radius-sm);">
                            <i class="${service.icon}" style="color: ${service.color};"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-sm text-bright truncate">${service.name}</div>
                            <div class="flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full" style="background: ${statusColor};"></span>
                                <span class="text-xxs" style="color: ${statusColor};">${statusLabel}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function openServiceConfigModal() {
        document.getElementById('serviceConfigModal').style.display = 'flex';
        loadAllServicesConfig();
    }
    
    function closeServiceConfigModal() {
        document.getElementById('serviceConfigModal').style.display = 'none';
    }
    
    async function loadAllServicesConfig() {
        const content = document.getElementById('serviceConfigContent');
        content.innerHTML = `<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-muted"></i></div>`;
        
        try {
            const response = await fetch('/api/admin/system-settings');
            const result = await response.json();
            
            if (!result.success) {
                content.innerHTML = `<div class="text-center py-6 text-red"><i class="fas fa-exclamation-circle"></i> ${result.error || 'Failed to load'}</div>`;
                return;
            }
            
            servicesData = result.categories;
            renderAllServicesConfig(result.categories);
        } catch (err) {
            console.error('Error loading services config:', err);
            content.innerHTML = `<div class="text-center py-6 text-red"><i class="fas fa-exclamation-circle"></i> Network error</div>`;
        }
    }
    
    function renderAllServicesConfig(categories) {
        const content = document.getElementById('serviceConfigContent');
        
        const serviceOrder = ['telegram', 'email', 'payment', 'binance', 'webhook', 'twitter', 'openai', 'webpush', 'compliance', 'proxy', 'panic', 'general'];
        const sortedCategories = serviceOrder
            .filter(cat => categories[cat])
            .map(cat => ({ key: cat, ...categories[cat] }));
        
        content.innerHTML = `
            <div class="space-y-4">
                ${sortedCategories.map(cat => {
                    const meta = cat.meta || {};
                    const settings = cat.settings || [];
                    const enabledSetting = settings.find(s => s.key === 'enabled');
                    const isEnabled = enabledSetting && enabledSetting.value && enabledSetting.value.toLowerCase() === 'true';
                    
                    // Check if configured
                    const requiredFields = {
                        telegram: ['bot_token'],
                        email: ['smtp_server', 'smtp_username', 'smtp_password'],
                        payment: ['api_key'],
                        twitter: ['api_key', 'api_secret'],
                        openai: ['api_key'],
                        binance: ['api_key', 'api_secret'],
                        webhook: ['passphrase'],
                    };
                    const required = requiredFields[cat.key] || [];
                    const isConfigured = required.every(field => {
                        const setting = settings.find(s => s.key === field);
                        return setting && setting.has_value;
                    });
                    
                    const statusColor = isEnabled && isConfigured ? 'var(--neon-green)' : 
                                       isConfigured ? 'var(--neon-yellow)' : 'var(--text-muted)';
                    const statusText = isEnabled && isConfigured ? 'Active' : 
                                      isConfigured ? 'Configured (off)' : 'Not Configured';
                    
                    return `
                        <div class="p-4 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center justify-center" 
                                         style="width: 40px; height: 40px; background: ${meta.color || '#666'}15; border: 1px solid ${meta.color || '#666'}30; border-radius: var(--radius-sm);">
                                        <i class="${meta.icon || 'fas fa-cog'}" style="color: ${meta.color || '#666'};"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-bright">${meta.name || cat.key}</div>
                                        <div class="text-xs text-muted">${meta.description || ''}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full" style="background: ${statusColor};"></span>
                                        <span class="text-xs" style="color: ${statusColor};">${statusText}</span>
                                    </div>
                                    <button onclick="openServiceEdit('${cat.key}')" class="cyber-btn cyber-btn-sm cyber-btn-outline">
                                        <i class="fas fa-edit"></i>
                                        Configure
                                    </button>
                                </div>
                            </div>
                            
                            ${meta.docs_url ? `
                            <div class="text-xs text-muted mt-2">
                                <a href="${meta.docs_url}" target="_blank" class="text-cyan hover:underline">
                                    <i class="fas fa-external-link-alt"></i> Documentation
                                </a>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function openServiceEdit(category) {
        currentEditingCategory = category;
        document.getElementById('serviceEditModal').style.display = 'flex';
        loadServiceSettings(category);
    }
    
    function closeServiceEditModal() {
        document.getElementById('serviceEditModal').style.display = 'none';
        currentEditingCategory = null;
    }
    
    async function loadServiceSettings(category) {
        const content = document.getElementById('serviceEditContent');
        const titleEl = document.getElementById('service-edit-title');
        const iconEl = document.getElementById('service-edit-icon');
        
        content.innerHTML = `<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-muted"></i></div>`;
        
        try {
            const response = await fetch(`/api/admin/system-settings/${category}`);
            const result = await response.json();
            
            if (!result.success) {
                content.innerHTML = `<div class="text-center py-6 text-red"><i class="fas fa-exclamation-circle"></i> ${result.error || 'Failed to load'}</div>`;
                return;
            }
            
            const meta = result.meta || {};
            titleEl.textContent = `Configure ${meta.name || category}`;
            iconEl.className = meta.icon || 'fas fa-cog';
            iconEl.style.color = meta.color || 'var(--neon-cyan)';
            
            renderServiceEditForm(category, result.settings, result.is_enabled, meta);
        } catch (err) {
            console.error('Error loading service settings:', err);
            content.innerHTML = `<div class="text-center py-6 text-red"><i class="fas fa-exclamation-circle"></i> Network error</div>`;
        }
    }
    
    function renderServiceEditForm(category, settings, isEnabled, meta) {
        const content = document.getElementById('serviceEditContent');
        
        // Group settings: enabled toggle, then other settings
        const enabledSetting = settings.find(s => s.key === 'enabled');
        const otherSettings = settings.filter(s => s.key !== 'enabled');
        
        content.innerHTML = `
            <form id="service-edit-form" onsubmit="saveServiceSettings(event, '${category}')" class="space-y-4">
                <!-- Enable/Disable Toggle -->
                ${enabledSetting ? `
                <div class="p-4 bg-[var(--color-surface-2)] border border-[var(--color-border)] rounded-lg mb-4">
                    <label class="flex items-center justify-between cursor-pointer">
                        <div>
                            <div class="font-semibold text-bright">Enable ${meta.name || category}</div>
                            <div class="text-xs text-muted">${enabledSetting.description || 'Toggle this service on/off'}</div>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="setting-enabled" class="sr-only" ${isEnabled ? 'checked' : ''}>
                            <div class="toggle-bg w-12 h-6 bg-[var(--color-surface-3)] rounded-full peer-focus:ring-2 ring-[var(--neon-cyan)] transition-all cursor-pointer" onclick="this.previousElementSibling.click();">
                                <div class="toggle-dot absolute top-1 left-1 w-4 h-4 bg-[var(--text-muted)] rounded-full transition-all ${isEnabled ? 'translate-x-6 bg-[var(--neon-green)]' : ''}"></div>
                            </div>
                        </div>
                    </label>
                </div>
                ` : ''}
                
                <!-- Settings Fields -->
                <div class="space-y-3">
                    ${otherSettings.map(setting => renderSettingField(setting)).join('')}
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 border-t border-[var(--color-border)]">
                    <button type="button" onclick="testService('${category}')" class="cyber-btn cyber-btn-outline flex-1" id="test-service-btn">
                        <i class="fas fa-plug"></i>
                        <span>Test Connection</span>
                    </button>
                    <button type="submit" class="cyber-btn flex-1" id="save-service-btn">
                        <i class="fas fa-save"></i>
                        <span>Save Changes</span>
                    </button>
                </div>
                
                <!-- Test Result -->
                <div id="test-result" class="hidden p-3 rounded-lg text-sm"></div>
            </form>
            
            <style>
                .toggle-bg:has(+ .toggle-dot) { cursor: pointer; }
                #setting-enabled:checked + .toggle-bg .toggle-dot { transform: translateX(1.5rem); background: var(--neon-green); }
            </style>
        `;
        
        // Add toggle functionality
        const toggleInput = document.getElementById('setting-enabled');
        if (toggleInput) {
            toggleInput.addEventListener('change', function() {
                const dot = this.parentElement.querySelector('.toggle-dot');
                if (this.checked) {
                    dot.classList.add('translate-x-6');
                    dot.style.background = 'var(--neon-green)';
                } else {
                    dot.classList.remove('translate-x-6');
                    dot.style.background = 'var(--text-muted)';
                }
            });
        }
    }
    
    function renderSettingField(setting) {
        const inputId = `setting-${setting.key}`;
        const value = setting.value || '';
        const placeholder = setting.is_sensitive ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
        const inputType = setting.is_sensitive ? 'password' : 
                         (setting.key.includes('port') || setting.key.includes('threshold') || 
                          setting.key.includes('size') || setting.key.includes('overlap')) ? 'number' : 'text';
        
        return `
            <div class="space-y-1">
                <label for="${inputId}" class="text-xs text-muted flex items-center gap-2">
                    ${setting.description || setting.key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
                    ${setting.is_sensitive ? '<i class="fas fa-lock text-yellow" title="Sensitive - stored encrypted"></i>' : ''}
                </label>
                <div class="relative">
                    <input type="${inputType}" 
                           id="${inputId}" 
                           name="${setting.key}"
                           value="${setting.value_masked ? '' : escapeHtml(value)}"
                           placeholder="${setting.value_masked ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢  (leave empty to keep current)' : placeholder}"
                           class="input w-full ${setting.is_sensitive ? 'pr-10' : ''}"
                           ${inputType === 'number' ? 'step="0.01"' : ''}>
                    ${setting.is_sensitive ? `
                    <button type="button" onclick="togglePasswordVisibility('${inputId}')" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-muted hover:text-cyan transition-colors">
                        <i class="fas fa-eye" id="${inputId}-eye"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eye = document.getElementById(inputId + '-eye');
        if (input.type === 'password') {
            input.type = 'text';
            eye.classList.remove('fa-eye');
            eye.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            eye.classList.remove('fa-eye-slash');
            eye.classList.add('fa-eye');
        }
    }
    
    async function saveServiceSettings(event, category) {
        event.preventDefault();
        
        const form = event.target;
        const btn = document.getElementById('save-service-btn');
        const originalHtml = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Collect form data
        const settings = {};
        const inputs = form.querySelectorAll('input[name], select[name], textarea[name]');
        inputs.forEach(input => {
            // Skip empty password fields (keep existing value)
            if (input.type === 'password' && !input.value) return;
            settings[input.name] = input.value;
        });
        
        // Handle enabled toggle
        const enabledCheckbox = document.getElementById('setting-enabled');
        if (enabledCheckbox) {
            settings['enabled'] = enabledCheckbox.checked ? 'true' : 'false';
        }
        
        try {
            const response = await fetch(`/api/admin/system-settings/${category}/bulk`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`${category} settings saved!`, 'success');
                refreshServiceStatus(); // Update the grid
                
                // Update the main modal if open
                if (servicesData) {
                    loadAllServicesConfig();
                }
            } else {
                showToast(result.error || 'Failed to save settings', 'error');
            }
        } catch (err) {
            console.error('Error saving settings:', err);
            showToast('Network error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    async function testService(category) {
        const btn = document.getElementById('test-service-btn');
        const resultDiv = document.getElementById('test-result');
        const originalHtml = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        resultDiv.className = 'hidden';
        
        try {
            const response = await fetch(`/api/admin/system-settings/${category}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            resultDiv.classList.remove('hidden');
            
            if (result.success) {
                resultDiv.className = 'p-3 rounded-lg text-sm bg-[rgba(0,255,100,0.1)] border border-[rgba(0,255,100,0.3)] text-green';
                resultDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        <span>${result.message}</span>
                    </div>
                    ${result.details ? `<div class="text-xs text-muted mt-1">${JSON.stringify(result.details)}</div>` : ''}
                `;
            } else {
                resultDiv.className = 'p-3 rounded-lg text-sm bg-[rgba(255,68,68,0.1)] border border-[rgba(255,68,68,0.3)] text-red';
                resultDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${result.error || 'Test failed'}</span>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error testing service:', err);
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'p-3 rounded-lg text-sm bg-[rgba(255,68,68,0.1)] border border-[rgba(255,68,68,0.3)] text-red';
            resultDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Network error`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    // Load service status on page load when in settings section
    document.addEventListener('DOMContentLoaded', function() {
        // Load service status if on settings section
        setTimeout(() => {
            if (document.querySelector('[data-section="settings"].active')) {
                refreshServiceStatus();
            }
        }, 500);
    });
    
    // Also refresh when switching to settings section
    const originalShowSection = window.showSection;
    if (originalShowSection) {
        window.showSection = function(section) {
            originalShowSection(section);
            if (section === 'settings') {
                refreshServiceStatus();
                loadSubscriptionSettings();
                loadPendingPayments();
            }
        };
    }
    
    // ==================== SUBSCRIPTION MANAGEMENT ====================
    let subscriptionSettings = null;
    
    async function loadSubscriptionSettings() {
        try {
            const response = await fetch('/api/admin/subscription-settings');
            const data = await response.json();
            
            if (!data.success) {
                console.error('Failed to load subscription settings');
                return;
            }
            
            subscriptionSettings = data;
            
            // Update toggle
            const toggle = document.getElementById('subscription-enabled-toggle');
            const label = document.getElementById('sub-toggle-label');
            if (toggle) {
                toggle.checked = data.subscription.enabled;
                if (label) label.textContent = data.subscription.enabled ? 'ON' : 'OFF';
            }
            
            // Update wallet addresses grid
            renderWalletAddresses(data.wallets);
            
            // Update insurance fund display
            const insWallet = document.getElementById('insurance-wallet-display');
            const insNetwork = document.getElementById('insurance-network-display');
            const insRate = document.getElementById('insurance-rate-display');
            
            if (insWallet) {
                insWallet.textContent = data.insurance_fund.wallet_address || 'Not configured';
            }
            if (insNetwork) {
                insNetwork.textContent = data.insurance_fund.wallet_network || '-';
            }
            if (insRate) {
                insRate.textContent = `${data.insurance_fund.contribution_rate}%`;
            }
            
            // Load insurance fund balance
            loadInsuranceFundBalance();
            
        } catch (err) {
            console.error('Error loading subscription settings:', err);
        }
    }
    
    function renderWalletAddresses(wallets) {
        const grid = document.getElementById('wallet-addresses-grid');
        if (!grid) return;
        
        const networkNames = {
            'usdt_trc20': { name: 'USDT (TRC20)', icon: 'fas fa-coins', color: 'text-green' },
            'usdt_erc20': { name: 'USDT (ERC20)', icon: 'fab fa-ethereum', color: 'text-blue-400' },
            'usdt_bep20': { name: 'USDT (BEP20)', icon: 'fas fa-coins', color: 'text-yellow' },
            'btc': { name: 'Bitcoin', icon: 'fab fa-bitcoin', color: 'text-orange-500' },
            'eth': { name: 'Ethereum', icon: 'fab fa-ethereum', color: 'text-purple' },
            'ltc': { name: 'Litecoin', icon: 'fas fa-coins', color: 'text-gray-400' },
            'sol': { name: 'Solana', icon: 'fas fa-sun', color: 'text-purple-400' }
        };
        
        let html = '';
        for (const [key, info] of Object.entries(networkNames)) {
            const address = wallets[key] || '';
            const hasAddress = address && address.length > 0;
            
            html += `
                <div class="p-3 rounded-lg flex items-center gap-3" style="background: ${hasAddress ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.02)'}; border: 1px solid ${hasAddress ? 'rgba(16, 185, 129, 0.2)' : 'var(--color-border)'};">
                    <i class="${info.icon} ${info.color}"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-muted">${info.name}</div>
                        <div class="font-mono text-xs ${hasAddress ? 'text-bright' : 'text-muted'} truncate">
                            ${hasAddress ? address.substring(0, 12) + '...' + address.slice(-6) : 'Not set'}
                        </div>
                    </div>
                    <span class="w-2 h-2 rounded-full ${hasAddress ? 'bg-green-500' : 'bg-gray-600'}"></span>
                </div>
            `;
        }
        grid.innerHTML = html;
    }
    
    async function loadInsuranceFundBalance() {
        try {
            const response = await fetch('/api/insurance-fund');
            const data = await response.json();
            
            if (data.success) {
                const el = document.getElementById('admin-insurance-fund');
                if (el) el.textContent = data.insurance_fund.formatted_balance || '$0.00';
            }
        } catch (err) {
            console.error('Error loading insurance fund:', err);
        }
    }
    
    async function loadPendingPayments() {
        try {
            const response = await fetch('/api/admin/subscription-payments?status=awaiting_confirmation');
            const data = await response.json();
            
            if (!data.success) return;
            
            // Update pending count
            const pendingCountEl = document.getElementById('admin-pending-payments');
            if (pendingCountEl) pendingCountEl.textContent = data.payments.length;
            
            // Render list
            renderPendingPaymentsList(data.payments);
            
            // Calculate total revenue from completed payments
            loadTotalRevenue();
            
        } catch (err) {
            console.error('Error loading pending payments:', err);
        }
    }
    
    async function loadTotalRevenue() {
        try {
            const response = await fetch('/api/admin/subscription-payments?status=completed');
            const data = await response.json();
            
            if (data.success) {
                const total = data.payments.reduce((sum, p) => sum + (p.amount_usd || 0), 0);
                const el = document.getElementById('admin-total-revenue');
                if (el) el.textContent = `$${total.toFixed(2)}`;
            }
        } catch (err) {
            console.error('Error loading revenue:', err);
        }
    }
    
    function renderPendingPaymentsList(payments) {
        const container = document.getElementById('pending-payments-list');
        if (!container) return;
        
        if (!payments || payments.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 text-muted">
                    <i class="fas fa-check-circle text-2xl mb-2 text-green"></i>
                    <p>No pending payments</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        payments.forEach(p => {
            const createdAt = new Date(p.created_at);
            html += `
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2);">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-yellow-500/20">
                            <i class="fas fa-clock text-yellow"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-bright">${p.username}</div>
                            <div class="text-xs text-muted">${p.plan.toUpperCase()} - ${p.currency}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono font-bold text-yellow">$${p.amount_usd.toFixed(2)}</div>
                        <div class="text-xs text-muted">${createdAt.toLocaleDateString()}</div>
                    </div>
                    <div class="flex gap-2 ml-3">
                        <button onclick="confirmPayment(${p.id})" class="cyber-btn cyber-btn-sm cyber-btn-success" title="Confirm">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectPayment(${p.id})" class="cyber-btn cyber-btn-sm cyber-btn-danger" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    async function toggleSubscriptionSystem(checkbox) {
        const enabled = checkbox.checked;
        const label = document.getElementById('sub-toggle-label');
        
        try {
            const response = await fetch('/api/admin/subscription-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscription: { enabled: enabled }
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (label) label.textContent = enabled ? 'ON' : 'OFF';
                showToast(enabled ? 'Subscription system enabled' : 'Free access mode enabled', 'success');
            } else {
                checkbox.checked = !enabled;
                showToast(data.error || 'Failed to update', 'error');
            }
        } catch (err) {
            checkbox.checked = !enabled;
            showToast('Network error', 'error');
        }
    }
    
    async function confirmPayment(paymentId) {
        if (!confirm('Confirm this payment and activate user subscription?')) return;
        
        try {
            const response = await fetch(`/api/admin/confirm-payment/${paymentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Payment confirmed!', 'success');
                loadPendingPayments();
                loadTotalRevenue();
            } else {
                showToast(data.error || 'Failed to confirm', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        }
    }
    
    async function rejectPayment(paymentId) {
        const reason = prompt('Enter rejection reason (optional):');
        if (reason === null) return; // Cancelled
        
        try {
            const response = await fetch(`/api/admin/reject-payment/${paymentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason || 'Payment not verified' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Payment rejected', 'info');
                loadPendingPayments();
            } else {
                showToast(data.error || 'Failed to reject', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        }
    }
    
    function refreshSubscriptionSettings() {
        const icon = document.getElementById('sub-refresh-icon');
        if (icon) icon.classList.add('fa-spin');
        
        Promise.all([
            loadSubscriptionSettings(),
            loadPendingPayments()
        ]).finally(() => {
            if (icon) icon.classList.remove('fa-spin');
        });
    }
    
    function openWalletSettingsModal() {
        const modal = document.getElementById('walletSettingsModal');
        if (modal) {
            modal.style.display = 'flex';
            populateWalletForm();
        }
    }
    
    function closeWalletSettingsModal() {
        const modal = document.getElementById('walletSettingsModal');
        if (modal) modal.style.display = 'none';
    }
    
    function populateWalletForm() {
        if (!subscriptionSettings) return;
        
        const wallets = subscriptionSettings.wallets || {};
        const insurance = subscriptionSettings.insurance_fund || {};
        
        // Payment wallets
        document.getElementById('wallet-usdt-trc20').value = wallets.usdt_trc20 || '';
        document.getElementById('wallet-usdt-erc20').value = wallets.usdt_erc20 || '';
        document.getElementById('wallet-usdt-bep20').value = wallets.usdt_bep20 || '';
        document.getElementById('wallet-btc').value = wallets.btc || '';
        document.getElementById('wallet-eth').value = wallets.eth || '';
        document.getElementById('wallet-ltc').value = wallets.ltc || '';
        document.getElementById('wallet-sol').value = wallets.sol || '';
        
        // Insurance fund
        document.getElementById('insurance-wallet').value = insurance.wallet_address || '';
        document.getElementById('insurance-network').value = insurance.wallet_network || 'USDT_TRC20';
        document.getElementById('insurance-rate').value = insurance.contribution_rate || 5;
        
        // Auto confirm
        const autoConfirm = document.getElementById('auto-confirm-toggle');
        if (autoConfirm) {
            autoConfirm.checked = subscriptionSettings.subscription?.auto_confirm || false;
        }
    }
    
    async function saveWalletSettings() {
        const btn = document.querySelector('#walletSettingsModal button[onclick="saveWalletSettings()"]');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const payload = {
                wallets: {
                    usdt_trc20: document.getElementById('wallet-usdt-trc20').value.trim(),
                    usdt_erc20: document.getElementById('wallet-usdt-erc20').value.trim(),
                    usdt_bep20: document.getElementById('wallet-usdt-bep20').value.trim(),
                    btc: document.getElementById('wallet-btc').value.trim(),
                    eth: document.getElementById('wallet-eth').value.trim(),
                    ltc: document.getElementById('wallet-ltc').value.trim(),
                    sol: document.getElementById('wallet-sol').value.trim()
                },
                insurance_fund: {
                    wallet_address: document.getElementById('insurance-wallet').value.trim(),
                    wallet_network: document.getElementById('insurance-network').value,
                    contribution_rate: parseFloat(document.getElementById('insurance-rate').value) || 5
                },
                subscription: {
                    auto_confirm: document.getElementById('auto-confirm-toggle')?.checked || false
                }
            };
            
            const response = await fetch('/api/admin/subscription-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Settings saved successfully!', 'success');
                closeWalletSettingsModal();
                loadSubscriptionSettings();
            } else {
                showToast(data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    // ==================== TASK MANAGEMENT ====================
    
    let adminTasks = [];
    let pendingReviews = [];
    let taskTypes = {};
    let rewardTypes = {};
    
    async function loadAdminTasks() {
        const status = document.getElementById('admin-task-status-filter')?.value || 'active';
        
        try {
            const response = await fetch(`/api/admin/tasks?status=${status}`);
            const data = await response.json();
            
            if (data.success) {
                adminTasks = data.tasks;
                taskTypes = data.task_types || {};
                rewardTypes = data.reward_types || {};
                renderAdminTasks();
                updateTaskStats();
            }
        } catch (err) {
            console.error('Error loading tasks:', err);
        }
    }
    
    async function loadPendingReviews() {
        try {
            const response = await fetch('/api/admin/tasks/pending-reviews');
            const data = await response.json();
            
            if (data.success) {
                pendingReviews = data.submissions;
                document.getElementById('admin-pending-reviews').textContent = data.pending_count;
                document.getElementById('pending-reviews-badge').textContent = data.pending_count;
                
                const section = document.getElementById('pending-reviews-section');
                if (data.pending_count > 0) {
                    section.style.display = 'block';
                    renderPendingReviews();
                } else {
                    section.style.display = 'none';
                }
            }
        } catch (err) {
            console.error('Error loading pending reviews:', err);
        }
    }
    
    function updateTaskStats() {
        const activeTasks = adminTasks.filter(t => t.status === 'active').length;
        const totalCompletions = adminTasks.reduce((sum, t) => sum + (t.total_completions || 0), 0);
        const totalRewards = adminTasks.reduce((sum, t) => sum + (t.total_rewards_given || 0), 0);
        
        document.getElementById('admin-active-tasks').textContent = activeTasks;
        document.getElementById('admin-total-completions').textContent = totalCompletions;
        document.getElementById('admin-rewards-given').textContent = '$' + totalRewards.toFixed(2);
    }
    
    function renderAdminTasks() {
        const container = document.getElementById('admin-tasks-list');
        
        if (adminTasks.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-muted">
                    <i class="fas fa-tasks text-3xl mb-3 opacity-50"></i>
                    <p>No tasks found</p>
                    <button onclick="openCreateTaskModal()" class="cyber-btn cyber-btn-primary cyber-btn-sm mt-3">
                        <i class="fas fa-plus"></i> Create First Task
                    </button>
                </div>
            `;
            return;
        }
        
        let html = '';
        adminTasks.forEach(task => {
            const typeInfo = taskTypes[task.task_type] || { name: task.task_type, icon: 'fa-tasks', color: '#888' };
            const rewardInfo = rewardTypes[task.reward_type] || { name: task.reward_type, icon: 'fa-gift', color: '#888' };
            const statusColors = {
                'active': 'text-green',
                'draft': 'text-muted',
                'paused': 'text-yellow',
                'completed': 'text-purple'
            };
            
            html += `
                <div class="flex items-center justify-between p-4 rounded-xl" style="background: var(--color-surface-2); border: 1px solid ${task.is_featured ? 'rgba(234, 179, 8, 0.3)' : 'var(--color-border)'};">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: ${task.color}20; border: 1px solid ${task.color}40;">
                            <i class="fas ${task.icon}" style="color: ${task.color}; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold">${task.title}</span>
                                ${task.is_featured ? '<span class="badge badge-yellow" style="font-size: 0.6rem;">FEATURED</span>' : ''}
                                <span class="badge ${statusColors[task.status] || 'text-muted'}" style="font-size: 0.6rem; text-transform: uppercase;">${task.status}</span>
                            </div>
                            <div class="flex items-center gap-3 text-xs text-muted mt-1">
                                <span><i class="fas ${typeInfo.icon} mr-1"></i>${typeInfo.name}</span>
                                <span><i class="fas ${rewardInfo.icon} mr-1"></i>${task.reward_type === 'money' ? '$' + task.reward_amount : task.reward_amount + ' ' + rewardInfo.name}</span>
                                <span><i class="fas fa-users mr-1"></i>${task.total_participants} participants</span>
                                <span><i class="fas fa-check-circle mr-1"></i>${task.total_completions} completed</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="viewTaskParticipations(${task.id})" class="cyber-btn cyber-btn-outline cyber-btn-sm" title="View Participations">
                            <i class="fas fa-users"></i>
                        </button>
                        <button onclick="editTask(${task.id})" class="cyber-btn cyber-btn-outline cyber-btn-sm" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTask(${task.id}, '${task.title.replace(/'/g, "\\'")}')" class="cyber-btn cyber-btn-danger cyber-btn-sm" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderPendingReviews() {
        const container = document.getElementById('pending-reviews-list');
        
        if (pendingReviews.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted">No pending reviews</div>';
            return;
        }
        
        let html = '';
        pendingReviews.forEach(p => {
            const submittedAt = new Date(p.submitted_at);
            html += `
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2);">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-yellow-500/20">
                            <i class="fas fa-clipboard-check text-yellow"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-bright">${p.username}</div>
                            <div class="text-xs text-muted">${p.task?.title || 'Task #' + p.task_id}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-muted">${submittedAt.toLocaleDateString()}</div>
                        <div class="text-xs text-muted">${submittedAt.toLocaleTimeString()}</div>
                    </div>
                    <button onclick="openReviewModal(${p.id})" class="cyber-btn cyber-btn-primary cyber-btn-sm ml-3">
                        <i class="fas fa-eye"></i> Review
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function openCreateTaskModal() {
        document.getElementById('task-edit-id').value = '';
        document.getElementById('task-modal-title').textContent = 'Create New Task';
        document.getElementById('save-task-btn').innerHTML = '<i class="fas fa-save"></i> Create Task';
        
        // Reset form
        document.getElementById('task-title').value = '';
        document.getElementById('task-description').value = '';
        document.getElementById('task-instructions').value = '';
        document.getElementById('task-type').value = 'custom';
        document.getElementById('task-category').value = '';
        document.getElementById('task-reward-type').value = 'money';
        document.getElementById('task-reward-amount').value = '0';
        document.getElementById('task-reward-description').value = '';
        document.getElementById('task-max-participants').value = '';
        document.getElementById('task-max-completions').value = '1';
        document.getElementById('task-icon').value = 'fa-tasks';
        document.getElementById('task-color').value = '#00f5ff';
        document.getElementById('task-status').value = 'active';
        document.getElementById('task-requires-approval').checked = true;
        document.getElementById('task-is-featured').checked = false;
        document.getElementById('task-start-date').value = '';
        document.getElementById('task-end-date').value = '';
        
        updateRewardAmountLabel();
        document.getElementById('createTaskModal').style.display = 'flex';
    }
    
    function closeCreateTaskModal() {
        document.getElementById('createTaskModal').style.display = 'none';
    }
    
    function editTask(taskId) {
        const task = adminTasks.find(t => t.id === taskId);
        if (!task) return;
        
        document.getElementById('task-edit-id').value = task.id;
        document.getElementById('task-modal-title').textContent = 'Edit Task';
        document.getElementById('save-task-btn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
        
        document.getElementById('task-title').value = task.title || '';
        document.getElementById('task-description').value = task.description || '';
        document.getElementById('task-instructions').value = task.instructions || '';
        document.getElementById('task-type').value = task.task_type || 'custom';
        document.getElementById('task-category').value = task.category || '';
        document.getElementById('task-reward-type').value = task.reward_type || 'money';
        document.getElementById('task-reward-amount').value = task.reward_amount || 0;
        document.getElementById('task-reward-description').value = task.reward_description || '';
        document.getElementById('task-max-participants').value = task.max_participants || '';
        document.getElementById('task-max-completions').value = task.max_completions_per_user || 1;
        document.getElementById('task-icon').value = task.icon || 'fa-tasks';
        document.getElementById('task-color').value = task.color || '#00f5ff';
        document.getElementById('task-status').value = task.status || 'active';
        document.getElementById('task-requires-approval').checked = task.requires_approval !== false;
        document.getElementById('task-is-featured').checked = task.is_featured === true;
        
        if (task.start_date) {
            document.getElementById('task-start-date').value = task.start_date.slice(0, 16);
        } else {
            document.getElementById('task-start-date').value = '';
        }
        if (task.end_date) {
            document.getElementById('task-end-date').value = task.end_date.slice(0, 16);
        } else {
            document.getElementById('task-end-date').value = '';
        }
        
        updateRewardAmountLabel();
        document.getElementById('createTaskModal').style.display = 'flex';
    }
    
    function updateRewardAmountLabel() {
        const rewardType = document.getElementById('task-reward-type').value;
        const label = document.getElementById('reward-amount-label');
        
        switch(rewardType) {
            case 'money': label.textContent = 'Amount ($)'; break;
            case 'xp': label.textContent = 'XP Points'; break;
            case 'subscription': label.textContent = 'Days'; break;
            case 'goods': label.textContent = 'Value ($)'; break;
            default: label.textContent = 'Amount';
        }
    }
    
    async function saveTask() {
        const btn = document.getElementById('save-task-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        const taskId = document.getElementById('task-edit-id').value;
        const isEdit = !!taskId;
        
        const payload = {
            title: document.getElementById('task-title').value.trim(),
            description: document.getElementById('task-description').value.trim(),
            instructions: document.getElementById('task-instructions').value.trim(),
            task_type: document.getElementById('task-type').value,
            category: document.getElementById('task-category').value.trim() || null,
            reward_type: document.getElementById('task-reward-type').value,
            reward_amount: parseFloat(document.getElementById('task-reward-amount').value) || 0,
            reward_description: document.getElementById('task-reward-description').value.trim(),
            max_participants: document.getElementById('task-max-participants').value ? parseInt(document.getElementById('task-max-participants').value) : null,
            max_completions_per_user: parseInt(document.getElementById('task-max-completions').value) || 1,
            icon: document.getElementById('task-icon').value.trim() || 'fa-tasks',
            color: document.getElementById('task-color').value,
            status: document.getElementById('task-status').value,
            requires_approval: document.getElementById('task-requires-approval').checked,
            is_featured: document.getElementById('task-is-featured').checked,
            start_date: document.getElementById('task-start-date').value || null,
            end_date: document.getElementById('task-end-date').value || null
        };
        
        if (!payload.title) {
            showToast('Title is required', 'error');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            return;
        }
        
        try {
            const url = isEdit ? `/api/admin/tasks/${taskId}` : '/api/admin/tasks';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message || 'Task saved successfully!', 'success');
                closeCreateTaskModal();
                loadAdminTasks();
            } else {
                showToast(data.error || 'Failed to save task', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    async function deleteTask(taskId, taskTitle) {
        if (!confirm(`Are you sure you want to delete the task "${taskTitle}"? This will also delete all participations.`)) return;
        
        try {
            const response = await fetch(`/api/admin/tasks/${taskId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message || 'Task deleted', 'success');
                loadAdminTasks();
            } else {
                showToast(data.error || 'Failed to delete', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        }
    }
    
    async function viewTaskParticipations(taskId) {
        // For now, just show an alert. Could be expanded to a modal.
        try {
            const response = await fetch(`/api/admin/tasks/${taskId}/participations`);
            const data = await response.json();
            
            if (data.success) {
                const task = data.task;
                const parts = data.participations;
                
                let msg = `Task: ${task.title}\nParticipants: ${parts.length}\n\n`;
                parts.slice(0, 10).forEach(p => {
                    msg += `‚Ä¢ ${p.username}: ${p.status}\n`;
                });
                if (parts.length > 10) msg += `... and ${parts.length - 10} more`;
                
                alert(msg);
            }
        } catch (err) {
            showToast('Error loading participations', 'error');
        }
    }
    
    function openReviewModal(participationId) {
        const participation = pendingReviews.find(p => p.id === participationId);
        if (!participation) return;
        
        document.getElementById('review-participation-id').value = participationId;
        
        const detailsHtml = `
            <div class="p-4 rounded-lg" style="background: var(--color-surface-3); border: 1px solid var(--color-border);">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(0, 245, 255, 0.1);">
                        <i class="fas fa-user text-cyan"></i>
                    </div>
                    <div>
                        <div class="font-semibold">${participation.username}</div>
                        <div class="text-xs text-muted">Submitted: ${new Date(participation.submitted_at).toLocaleString()}</div>
                    </div>
                </div>
                <div class="text-sm mb-2">
                    <strong>Task:</strong> ${participation.task?.title || 'Task #' + participation.task_id}
                </div>
                <div class="text-sm mb-2">
                    <strong>Reward:</strong> ${participation.task?.reward_type === 'money' ? '$' + participation.task?.reward_amount : participation.task?.reward_amount + ' ' + participation.task?.reward_type}
                </div>
                ${participation.submission_text ? `<div class="text-sm mb-2"><strong>Submission:</strong> ${participation.submission_text}</div>` : ''}
                ${participation.submission_url ? `<div class="text-sm"><strong>Proof URL:</strong> <a href="${participation.submission_url}" target="_blank" class="text-cyan hover:underline">${participation.submission_url}</a></div>` : ''}
            </div>
        `;
        
        document.getElementById('review-submission-details').innerHTML = detailsHtml;
        document.getElementById('review-notes').value = '';
        document.getElementById('review-rejection-reason').value = '';
        document.getElementById('rejection-reason-field').style.display = 'none';
        
        document.getElementById('reviewSubmissionModal').style.display = 'flex';
    }
    
    function closeReviewModal() {
        document.getElementById('reviewSubmissionModal').style.display = 'none';
    }
    
    async function approveSubmission() {
        const participationId = document.getElementById('review-participation-id').value;
        const notes = document.getElementById('review-notes').value.trim();
        
        try {
            const response = await fetch(`/api/admin/tasks/participation/${participationId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message || 'Submission approved!', 'success');
                closeReviewModal();
                loadPendingReviews();
                loadAdminTasks();
            } else {
                showToast(data.error || 'Failed to approve', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        }
    }
    
    async function rejectSubmission() {
        const reasonField = document.getElementById('rejection-reason-field');
        if (reasonField.style.display === 'none') {
            reasonField.style.display = 'block';
            return;
        }
        
        const participationId = document.getElementById('review-participation-id').value;
        const notes = document.getElementById('review-notes').value.trim();
        const reason = document.getElementById('review-rejection-reason').value.trim() || 'Submission did not meet requirements';
        
        try {
            const response = await fetch(`/api/admin/tasks/participation/${participationId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes, reason })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Submission rejected', 'info');
                closeReviewModal();
                loadPendingReviews();
            } else {
                showToast(data.error || 'Failed to reject', 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        }
    }
    
    function refreshTasks() {
        const icon = document.getElementById('tasks-refresh-icon');
        if (icon) icon.classList.add('fa-spin');
        
        Promise.all([
            loadAdminTasks(),
            loadPendingReviews()
        ]).finally(() => {
            if (icon) icon.classList.remove('fa-spin');
        });
    }
    
    // Load tasks when switching to tasks section
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on tasks section initially
        if (document.querySelector('[data-section="tasks"].active')) {
            loadAdminTasks();
            loadPendingReviews();
        }
    });
    
    // Override showSection to load tasks when switching
    (function() {
        const prevShowSection = window.showSection;
        window.showSection = function(section) {
            if (typeof prevShowSection === 'function') {
                prevShowSection(section);
            }
            if (section === 'tasks') {
                loadAdminTasks();
                loadPendingReviews();
            }
        };
    })();
</script>
{% endblock %}
