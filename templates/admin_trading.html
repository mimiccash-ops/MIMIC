{% extends "base.html" %}

{% block title %}Trading & Settings{% endblock %}

{% block extra_styles %}
<style>
    .command-terminal { background: linear-gradient(165deg, rgba(12, 12, 24, 0.98), rgba(8, 8, 16, 0.99)); border: 1px solid rgba(0, 245, 255, 0.15); }
    .terminal-header { background: linear-gradient(90deg, var(--neon-red), var(--neon-yellow), var(--neon-green)); height: 2px; }
    .log-entry { transition: all 0.15s ease; border-radius: 6px; margin: 3px 0; border-left: 2px solid transparent; }
    .log-entry:hover { background: rgba(0, 245, 255, 0.04); transform: translateX(3px); border-left-color: var(--neon-cyan); }
    .log-error { border-left-color: var(--neon-red); background: rgba(255, 0, 68, 0.04); }
    .log-info { border-left-color: var(--neon-cyan); background: rgba(0, 245, 255, 0.02); }
    .period-pills { display: flex; gap: 6px; }
    .period-pill { padding: 6px 10px; font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text-muted); background: var(--bg-element); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.15s ease; text-transform: uppercase; }
    .period-pill:hover { color: var(--neon-magenta); border-color: var(--neon-magenta); }
    .period-pill.active { color: #000; background: linear-gradient(135deg, var(--neon-magenta), var(--neon-cyan)); border-color: transparent; }
    .stat-number { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: clamp(0.85rem, 3vw, 1.2rem); letter-spacing: -0.3px; }
    .position-card { transition: all 0.15s ease; }
    .position-card:hover { transform: translateX(2px); }
    .trade-row:hover { background: rgba(0, 245, 255, 0.04); }
    .trade-history-table .trade-label { display: none; }
    .trade-history-table .trade-value { display: inline-flex; align-items: center; gap: 4px; }
    .cyber-checkbox { width: 14px; height: 14px; accent-color: var(--neon-cyan); cursor: pointer; }
    .strategy-header { flex-wrap: wrap; gap: 12px; }
    .strategy-new-btn { white-space: normal; text-align: center; max-width: 100%; }
    .strategy-row { align-items: center; }
    .strategy-right { margin-left: auto; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .strategy-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .strategy-actions { display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; }

    @media (max-width: 640px) {
        .strategy-new-btn { width: 100%; justify-content: center; }
    }
    @media (max-width: 420px) {
        .strategy-right { width: 100%; justify-content: space-between; }
        .strategy-actions { margin-left: auto; }
    }

    /* Modal Overlay Styles */
    .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        min-width: 100vw !important;
        min-height: 100vh !important;
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
        padding: 20px !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Ensure modal is visible when display is set via inline style */
    .modal-overlay[style*="display: flex"],
    .modal-overlay[style*="display:flex"],
    .modal-overlay[style*="display: flex !important"],
    .modal-overlay[style*="display:flex !important"] {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface-2);
    }

    .modal-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 1rem;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-card {
        width: 100%;
        max-width: 500px;
        background: var(--color-surface-2, #15151e);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        animation: modalIn 0.3s ease;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 245, 255, 0.1);
    }

    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.95) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
</style>
<style>
    @media (max-width: 400px) {
        .admin-trading-page h1.font-display {
            font-size: 1rem;
        }

        .admin-trading-page h2.font-display,
        .admin-trading-page .font-display {
            font-size: 0.9rem;
        }

        .admin-trading-page .text-sm {
            font-size: 0.7rem;
        }

        .admin-trading-page .text-xs {
            font-size: 0.6rem;
        }

        .admin-trading-page .text-xxs {
            font-size: 0.55rem;
        }

        .admin-trading-page .cyber-btn {
            font-size: 0.7rem;
            padding: 10px 12px;
        }

        .admin-trading-page .cyber-btn .text-xs {
            font-size: 0.6rem;
        }

        .admin-trading-page .input {
            font-size: 0.8rem;
            padding: 10px 12px;
        }

        .admin-trading-page .strategy-new-btn {
            font-size: 0.7rem;
        }

        .admin-trading-page .strategy-new-btn span {
            line-height: 1.2;
        }

        .admin-trading-page .trade-history-table thead {
            display: none;
        }

        .admin-trading-page .trade-history-table,
        .admin-trading-page .trade-history-table tbody,
        .admin-trading-page .trade-history-table tr,
        .admin-trading-page .trade-history-table td {
            display: block;
            width: 100%;
        }

        .admin-trading-page .trade-history-table tr.trade-row {
            border-bottom: 0 !important;
            background: var(--color-surface-2);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .admin-trading-page .trade-history-table td.trade-cell {
            padding: 4px 0;
        }

        .admin-trading-page .trade-history-table .trade-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .admin-trading-page .trade-history-table .trade-label {
            display: block;
            font-size: 0.5rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .admin-trading-page .trade-history-table .trade-value {
            font-size: 0.7rem;
            text-align: right;
        }

        .admin-trading-page .trade-history-table .badge {
            font-size: 0.45rem;
            padding: 2px 6px;
        }
    }

    @media (max-width: 360px) {
        .admin-trading-page h1.font-display {
            font-size: 0.95rem;
        }

        .admin-trading-page h2.font-display,
        .admin-trading-page .font-display {
            font-size: 0.85rem;
        }

        .admin-trading-page .text-sm {
            font-size: 0.65rem;
        }

        .admin-trading-page .text-xs {
            font-size: 0.55rem;
        }

        .admin-trading-page .text-xxs {
            font-size: 0.5rem;
        }

        .admin-trading-page .cyber-btn {
            font-size: 0.65rem;
            padding: 8px 10px;
        }

        .admin-trading-page .input {
            font-size: 0.75rem;
            padding: 8px 10px;
        }

        .admin-trading-page .trade-history-table tr.trade-row {
            padding: 6px 8px;
            margin-bottom: 8px;
        }

        .admin-trading-page .trade-history-table .trade-label {
            font-size: 0.45rem;
        }

        .admin-trading-page .trade-history-table .trade-value {
            font-size: 0.65rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-8 admin-trading-page">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="font-display text-xl font-semibold flex items-center gap-3">
                    <i class="fas fa-sliders-h text-magenta"></i>
                    <span data-i18n="nav.tradingSettings">Trading & Settings</span>
                </h1>
                <p class="text-muted text-sm mt-1" data-i18n="admin.tradingSubtitle">Centralized controls, configuration, and live trading monitoring.</p>
            </div>
        </div>

        <!-- Control Terminal -->
        <div class="command-terminal rounded-xl overflow-hidden mb-6">
            <div class="terminal-header"></div>
            <div class="p-3">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-cyber text-xs tracking-widest text-bright" data-i18n="admin.controlTerminal">Control Terminal</span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <form method="POST" action="{{ url_for('actions', action_type='resume') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-green py-4 flex-col gap-2">
                            <i class="fas fa-play text-xl"></i>
                            <span class="text-xs font-display font-semibold" data-i18n="admin.controlStart">Start</span>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('actions', action_type='pause') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-yellow py-4 flex-col gap-2">
                            <i class="fas fa-pause text-xl"></i>
                            <span class="text-xs font-display font-semibold" data-i18n="admin.controlPause">Pause</span>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('actions', action_type='reload') }}" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="cyber-btn cyber-btn-gradient-blue py-4 flex-col gap-2">
                            <i class="fas fa-sync text-xl"></i>
                            <span class="text-xs font-display font-semibold" data-i18n="admin.controlReload">Reload</span>
                        </button>
                    </form>
                    <button onclick="confirmPanic()" class="cyber-btn cyber-btn-danger py-4 flex-col gap-2">
                        <i class="fas fa-radiation text-xl"></i>
                        <span class="text-xs font-display font-semibold" data-i18n="admin.controlPanic">Panic</span>
                    </button>
                </div>
                
                {% if engine_paused %}
                <div class="mt-3 p-2 bg-[rgba(255,240,0,0.08)] border border-[rgba(255,240,0,0.25)] rounded-xl flex items-center gap-2 animate-pulse">
                    <i class="fas fa-pause-circle text-lg text-yellow"></i>
                    <span class="text-yellow font-cyber text-xs tracking-wider" data-i18n="admin.tradingPaused">Trading Paused</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Global Settings -->
        <div class="card mb-6">
            <h2 class="font-display font-semibold flex items-center gap-2 mb-4">
                <i class="fas fa-sliders-h text-magenta"></i>
                <span data-i18n="admin.globalSettings">Global Settings</span>
            </h2>
            <form method="POST" action="{{ url_for('admin_update_global_settings') }}" class="grid grid-cols-3 sm:grid-cols-7 gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-percentage text-cyan"></i>
                        <span data-i18n="admin.riskLabel">Risk%</span>
                    </label>
                    <input type="number" name="global_risk" value="{{ global_settings.risk_perc }}" step="0.01" class="input" min="0.01" max="100">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-bolt text-magenta"></i>
                        <span data-i18n="admin.leverageLabel">Lever</span>
                    </label>
                    <input type="number" name="global_leverage" value="{{ global_settings.leverage }}" class="input" min="1" max="125">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-arrow-up text-green"></i>
                        <span data-i18n="admin.tpLabel">TP%</span>
                    </label>
                    <input type="number" name="global_tp" value="{{ global_settings.tp_perc }}" step="0.1" min="0.1" max="100" class="input" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-arrow-down text-red"></i>
                        <span data-i18n="admin.slLabel">SL%</span>
                    </label>
                    <input type="number" name="global_sl" value="{{ global_settings.sl_perc }}" step="0.1" min="0.1" max="100" class="input" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-layer-group text-yellow"></i>
                        <span data-i18n="admin.maxPositionsLabel">Max</span>
                    </label>
                    <input type="number" name="global_max_pos" value="{{ global_settings.max_positions }}" class="input" min="1" max="50">
                </div>
                <div class="space-y-1">
                    <label class="text-xxs text-muted flex items-center gap-1">
                        <i class="fas fa-wallet text-purple"></i>
                        <span data-i18n="admin.minBalanceLabel">Min$</span>
                    </label>
                    <input type="number" name="global_min_balance" value="{{ global_settings.min_balance }}" step="0.01" class="input" min="0" max="100000" title="Minimum balance required to trade. Users with less balance cannot trade." data-i18n-title="admin.minBalanceTitle">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="cyber-btn w-full">
                        <span data-i18n="btn.save">Save</span>
                    </button>
                </div>
            </form>
            <p class="text-xxs text-muted mt-2" data-i18n="admin.minBalanceHint"><i class="fas fa-info-circle text-cyan"></i> Min$: Users with balance below this cannot trade (default: $1)</p>
        </div>
        
        <!-- Strategies Management -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4 strategy-header">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-chess-knight text-purple"></i>
                    <span data-i18n="admin.tradingStrategies">Trading Strategies</span>
                </h2>
                <button onclick="openCreateStrategyModal()" class="cyber-btn cyber-btn-sm strategy-new-btn">
                    <i class="fas fa-plus"></i>
                    <span data-i18n="admin.newStrategy">New Strategy</span>
                </button>
            </div>
            
            <div id="admin-strategies-container" class="space-y-3">
                <div class="flex items-center justify-center py-6">
                    <i class="fas fa-spinner fa-spin text-2xl text-muted"></i>
                </div>
            </div>
        </div>

        <!-- Master Positions -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-layer-group text-cyan"></i>
                    <span data-i18n="admin.masterPositions">Master Positions</span>
                    <span id="master-positions-count" class="badge badge-primary">{{ master_positions|length }}</span>
                </h2>
                <div class="flex items-center gap-2">
                    <span class="live-dot"></span>
                    <span class="text-sm text-muted" data-i18n="dash.live">Live</span>
                </div>
            </div>
            <div id="master-positions-container" class="flex flex-col gap-3">
                {% if master_positions_loaded %}
                    {% if master_positions %}
                        {% for pos in master_positions %}
                        <div class="position-card p-2 bg-[var(--bg-element)] rounded-lg" style="border-left: 2px solid {{ 'var(--neon-green)' if pos.side == 'LONG' else 'var(--neon-red)' }};">
                            <div class="flex justify-between items-start gap-3">
                                <div class="flex items-start gap-2">
                                    <span class="badge text-xxs {{ 'badge-success' if pos.side == 'LONG' else 'badge-danger' }}">{{ pos.side }}</span>
                                    <div>
                                        <div class="font-mono font-bold text-xs text-bright">{{ pos.symbol }}</div>
                                        <div class="text-xxs text-muted">x{{ pos.leverage }} ¬∑ {{ pos.margin_mode|upper if pos.margin_mode else '‚Äî' }} ¬∑ <span class="text-cyan">{{ pos.exchange or 'Binance' }}</span></div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-xs font-mono {{ 'text-green' if pos.unrealized_pnl >= 0 else 'text-red' }}">
                                        {{ '+' if pos.unrealized_pnl >= 0 else '' }}${{ "%.2f"|format(pos.unrealized_pnl) }}
                                    </div>
                                    <div class="text-xxs {{ 'text-green' if pos.unrealized_pnl >= 0 else 'text-red' }}">
                                        {% if pos.pnl_pct is not none %}
                                            {{ '+' if pos.pnl_pct >= 0 else '' }}{{ "%.2f"|format(pos.pnl_pct) }}%
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 mt-1 justify-end">
                                        <button class="cyber-btn cyber-btn-sm" onclick="requestClosePosition('{{ pos.symbol }}','master')"><span data-i18n="admin.close">Close</span></button>
                                        <button class="cyber-btn cyber-btn-sm" onclick="requestClosePosition('{{ pos.symbol }}','all')"><span data-i18n="admin.closeAll">Close All</span></button>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-3 gap-y-1 text-xxs text-muted mt-2">
                                <div><span data-i18n="admin.entryLabel">Entry</span> <span class="font-mono text-bright">{% if pos.entry_price %}${{ "%.4f"|format(pos.entry_price) }}{% else %}‚Äî{% endif %}</span></div>
                                <div><span data-i18n="admin.markLabel">Mark</span> <span class="font-mono text-bright">{% if pos.mark_price %}${{ "%.4f"|format(pos.mark_price) }}{% else %}‚Äî{% endif %}</span></div>
                                <div><span data-i18n="admin.liqLabel">Liq</span> <span class="font-mono text-bright">{% if pos.liquidation_price %}${{ "%.4f"|format(pos.liquidation_price) }}{% else %}‚Äî{% endif %}</span></div>
                                <div><span data-i18n="admin.qtyLabel">Qty</span> <span class="font-mono text-bright">{% if pos.qty %}{{ "%.6f"|format(pos.qty) }}{% else %}‚Äî{% endif %}</span></div>
                                <div><span data-i18n="admin.notionalLabel">Notional</span> <span class="font-mono text-bright">{% if pos.notional %}${{ "%.2f"|format(pos.notional) }}{% else %}‚Äî{% endif %}</span></div>
                                <div><span data-i18n="admin.marginLabel">Margin</span> <span class="font-mono text-bright">{% if pos.margin %}${{ "%.2f"|format(pos.margin) }}{% else %}‚Äî{% endif %}</span></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="padding: 20px;">
                            <i class="fas fa-inbox"></i>
                            <p data-i18n="dash.noOpenPositions">No open positions</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p data-i18n="common.loading">Loading...</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Trade History -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-history text-magenta"></i>
                    <span data-i18n="admin.closedTrades">Closed Trades</span>
                </h2>
                <span class="text-sm text-muted">{{ closed_trades|length }} <span data-i18n="dash.trades">trades</span></span>
            </div>
        
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table class="table trade-history-table">
                    <thead>
                        <tr>
                            <th data-i18n="admin.tableTime">Time</th>
                            <th data-i18n="admin.tableNode">Node</th>
                            <th data-i18n="admin.tableSymbol">Symbol</th>
                            <th style="text-align: center;" data-i18n="admin.tableSide">Side</th>
                            <th style="text-align: right;" data-i18n="admin.tablePnl">PnL</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        {% for trade in closed_trades %}
                        <tr class="trade-row border-b border-[var(--border-color)] border-opacity-30">
                            <td class="trade-cell py-2 px-2 text-muted">
                                <span class="trade-label" data-i18n="admin.tableTime">Time</span>
                                <span class="trade-value">{{ trade.time }}</span>
                            </td>
                            <td class="trade-cell py-2 px-2">
                                <span class="trade-label" data-i18n="admin.tableNode">Node</span>
                                <span class="trade-value font-bold text-bright">{{ trade.node }}</span>
                            </td>
                            <td class="trade-cell py-2 px-2">
                                <span class="trade-label" data-i18n="admin.tableSymbol">Symbol</span>
                                <span class="trade-value font-mono text-bright">{{ trade.symbol }}</span>
                            </td>
                            <td class="trade-cell py-2 px-1 text-center">
                                <span class="trade-label" data-i18n="admin.tableSide">Side</span>
                                <span class="trade-value">
                                    <span class="badge {{ 'badge-success' if trade.side == 'LONG' else 'badge-danger' }}">{{ trade.side }}</span>
                                </span>
                            </td>
                            <td class="trade-cell py-2 px-2 text-right">
                                <span class="trade-label" data-i18n="admin.tablePnl">PnL</span>
                                <span class="trade-value font-mono font-bold {{ 'text-green' if trade.pnl >= 0 else 'text-red' }}">
                                    {{ '+' if trade.pnl >= 0 else '' }}{{ "%.2f"|format(trade.pnl) }}$
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let socket = null;
    let masterChart = null;
    let currentPeriod = '24h';
    const riskLevelKeyMap = {
        low: 'admin.riskLow',
        medium: 'admin.riskMedium',
        high: 'admin.riskHigh'
    };
    const scopeLabelMap = {
        all: 'admin.scopeAll',
        master: 'admin.scopeMaster'
    };

    function getRiskLabel(level) {
        const key = riskLevelKeyMap[level];
        return key ? t(key) : String(level || '').toUpperCase();
    }

    function getScopeLabel(scope) {
        const key = scopeLabelMap[scope];
        return key ? t(key) : scope;
    }

    function initSocket() {
        if (typeof io === 'undefined') {
            setTimeout(initSocket, 100);
            return;
        }

        socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 2000,
            reconnectionDelayMax: 60000,
            randomizationFactor: 0.5,
            timeout: 20000,
            transports: ['websocket', 'polling'],
            forceNew: false,
            autoConnect: true
        });
        
        socket.on('connect', () => { 
            console.log('‚úÖ Admin connected to WebSocket');
            showToast(t('admin.connected'), 'success', 2000); 
        });
        
        socket.on('connect_error', (err) => { 
            if (!socket.reconnecting) {
                console.warn('‚ö†Ô∏è Socket connection error:', err.message);
            }
        });
        
        socket.on('disconnect', (reason) => { 
            console.log('üîå Disconnected:', reason);
            if (reason === 'io server disconnect') {
                setTimeout(() => {
                    if (!socket.connected) {
                        socket.connect();
                    }
                }, 2000);
            }
        });
        
        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log(`üîÑ Reconnection attempt ${attemptNumber}`);
        });
        
        socket.on('reconnect', (attemptNumber) => {
            console.log(`‚úÖ Reconnected after ${attemptNumber} attempts`);
        });
        
        socket.on('reconnect_failed', () => {
            console.warn('‚ùå Reconnection failed, will retry later');
        });
        
        socket.on('master_data', (data) => {
            if (data.positions) renderMasterPositions(data.positions);
        });
        
        socket.on('new_log', (entry) => {
            const container = document.getElementById('log-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = `p-1.5 bg-[var(--bg-element)] rounded log-entry ${entry.is_error ? 'log-error' : 'log-info'}`;
            div.innerHTML = `<span class="text-muted">[${entry.time}]</span><span class="text-cyan ml-1">${entry.symbol}</span><span class="ml-1 text-bright">${entry.message}</span>`;
            container.insertBefore(div, container.firstChild);
            if (container.children.length > 30) container.removeChild(container.lastChild);
        });

        socket.on('trade_closed', (trade) => {
            const tbody = document.getElementById('trades-body');
            if (!tbody) return;
            const tr = document.createElement('tr');
            tr.className = 'trade-row border-b border-[var(--border-color)] border-opacity-30';
            tr.innerHTML = `
                <td class="trade-cell py-2 px-2 text-muted">
                    <span class="trade-label" data-i18n="admin.tableTime">Time</span>
                    <span class="trade-value">${trade.time}</span>
                </td>
                <td class="trade-cell py-2 px-2">
                    <span class="trade-label" data-i18n="admin.tableNode">Node</span>
                    <span class="trade-value font-bold text-bright">${trade.node}</span>
                </td>
                <td class="trade-cell py-2 px-2">
                    <span class="trade-label" data-i18n="admin.tableSymbol">Symbol</span>
                    <span class="trade-value font-mono text-bright">${trade.symbol}</span>
                </td>
                <td class="trade-cell py-2 px-1 text-center">
                    <span class="trade-label" data-i18n="admin.tableSide">Side</span>
                    <span class="trade-value">
                        <span class="badge ${trade.side === 'LONG' ? 'badge-success' : 'badge-danger'}">${trade.side}</span>
                    </span>
                </td>
                <td class="trade-cell py-2 px-2 text-right">
                    <span class="trade-label" data-i18n="admin.tablePnl">PnL</span>
                    <span class="trade-value font-mono font-bold ${trade.pnl >= 0 ? 'text-green' : 'text-red'}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}$</span>
                </td>`;
            tbody.insertBefore(tr, tbody.firstChild);
            if (window.reapplyTranslations) window.reapplyTranslations();
            const pnlText = `${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}`;
            const toastText = t('admin.tradePnlToast')
                .replace('{pnl}', pnlText)
                .replace('{symbol}', trade.symbol);
            if (trade.pnl >= 0) { 
                showToast(toastText, 'success'); 
                if (typeof celebrateSuccess === 'function') celebrateSuccess(); 
            } else { 
                showToast(toastText, 'warning'); 
            }
        });
        
        socket.on('new_message', (msg) => { 
            if (!msg.is_from_admin) { 
                showToast(t('admin.newMessageFromUser').replace('{name}', msg.sender_name), 'info'); 
            } 
        });
    }

    async function refreshMasterPositions() {
        try {
            const response = await fetch('/api/master/positions');
            const data = await response.json();
            if (data.success) {
                renderMasterPositions(data.positions || []);
            }
        } catch (err) {
            console.warn('Failed to refresh master positions:', err);
        }
    }

    // Periodic refresh in case socket is delayed or the page was reloaded
    setTimeout(refreshMasterPositions, 800);
    setInterval(refreshMasterPositions, 15000);
    
    function formatNumber(value, digits = 2, emptyIfZero = false) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '‚Äî';
        if (emptyIfZero && num === 0) return '‚Äî';
        return num.toFixed(digits);
    }

    function formatMoney(value, digits = 2, signed = false, emptyIfZero = false) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '‚Äî';
        if (emptyIfZero && num === 0) return '‚Äî';
        const sign = signed && num > 0 ? '+' : '';
        return `${sign}$${num.toFixed(digits)}`;
    }

    function formatPrice(value, digits = 4, emptyIfZero = false) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '‚Äî';
        if (emptyIfZero && num === 0) return '‚Äî';
        return `$${num.toFixed(digits)}`;
    }

    function formatPercent(value, digits = 2) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '‚Äî';
        const sign = num > 0 ? '+' : '';
        return `${sign}${num.toFixed(digits)}%`;
    }

    function escapeText(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function renderMasterPositions(positions) {
        const container = document.getElementById('master-positions-container');
        const countEl = document.getElementById('master-positions-count');
        if (!container) return;
        if (countEl) countEl.textContent = positions?.length || 0;
        if (!positions || positions.length === 0) {
            container.innerHTML = `<div class="text-center py-6 text-muted"><i class="fas fa-inbox text-2xl mb-1 opacity-30"></i><p class="text-xs">${t('admin.noPositions')}</p></div>`;
            return;
        }
        container.innerHTML = positions.map(pos => `
            <div class="position-card p-2 bg-[var(--bg-element)] rounded-lg" style="border-left: 2px solid ${pos.side === 'LONG' ? 'var(--neon-green)' : 'var(--neon-red)'};">
                <div class="flex justify-between items-start gap-3">
                    <div class="flex items-start gap-2">
                        <span class="badge text-xxs ${pos.side === 'LONG' ? 'badge-success' : 'badge-danger'}">${escapeText(pos.side)}</span>
                        <div>
                            <div class="font-mono font-bold text-xs text-bright">${escapeText(pos.symbol)}</div>
                            <div class="text-xxs text-muted">x${formatNumber(pos.leverage, 0)} ¬∑ ${(pos.margin_mode || '').toString().toUpperCase() || '‚Äî'} ¬∑ <span class="text-cyan">${escapeText(pos.exchange || 'Binance')}</span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-xs font-mono ${pos.unrealized_pnl >= 0 ? 'text-green' : 'text-red'}">${formatMoney(pos.unrealized_pnl, 2, true)}</div>
                        <div class="text-xxs ${pos.unrealized_pnl >= 0 ? 'text-green' : 'text-red'}">${formatPercent(pos.pnl_pct, 2)}</div>
                        <div class="flex items-center gap-2 mt-1 justify-end">
                            <button class="cyber-btn cyber-btn-sm" onclick="requestClosePosition('${pos.symbol}','master')"><span data-i18n="admin.close">${t('admin.close')}</span></button>
                            <button class="cyber-btn cyber-btn-sm" onclick="requestClosePosition('${pos.symbol}','all')"><span data-i18n="admin.closeAll">${t('admin.closeAll')}</span></button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-3 gap-y-1 text-xxs text-muted mt-2">
                    <div><span data-i18n="admin.entryLabel">${t('admin.entryLabel')}</span> <span class="font-mono text-bright">${formatPrice(pos.entry_price, 4, true)}</span></div>
                    <div><span data-i18n="admin.markLabel">${t('admin.markLabel')}</span> <span class="font-mono text-bright">${formatPrice(pos.mark_price, 4, true)}</span></div>
                    <div><span data-i18n="admin.liqLabel">${t('admin.liqLabel')}</span> <span class="font-mono text-bright">${formatPrice(pos.liquidation_price, 4, true)}</span></div>
                    <div><span data-i18n="admin.qtyLabel">${t('admin.qtyLabel')}</span> <span class="font-mono text-bright">${formatNumber(pos.qty, 6, true)}</span></div>
                    <div><span data-i18n="admin.notionalLabel">${t('admin.notionalLabel')}</span> <span class="font-mono text-bright">${formatMoney(pos.notional, 2, false, true)}</span></div>
                    <div><span data-i18n="admin.marginLabel">${t('admin.marginLabel')}</span> <span class="font-mono text-bright">${formatMoney(pos.margin, 2, false, true)}</span></div>
                </div>
            </div>
        `).join('');
    }

    async function requestClosePosition(symbol, scope) {
        if (!symbol) return;
        const warn = scope === 'all'
            ? t('admin.closeAllConfirm').replace('{symbol}', symbol)
            : t('admin.closeMasterConfirm').replace('{symbol}', symbol);
        if (!confirm(warn)) return;
        try {
            const response = await fetch('/api/admin/positions/close', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol, scope })
            });
            const data = await response.json();
            if (data.success) {
                const scopeLabel = getScopeLabel(scope);
                showToast(t('admin.closeQueued').replace('{symbol}', symbol).replace('{scope}', scopeLabel), scope === 'all' ? 'error' : 'warning');
                setTimeout(refreshMasterPositions, 1500);
            } else {
                showToast(data.error || t('admin.closeFailed'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }

    function confirmPanic() {
        if (confirm(t('admin.panicConfirm'))) {
            showToast(t('admin.panicExecuting'), 'error');
            fetch('/api/admin/panic', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(r => r.json())
                .then(data => { 
                    if (data.success) { 
                        showToast(t('admin.panicClosed')
                            .replace('{master}', data.master_closed)
                            .replace('{slaves}', data.slaves_closed), 'success'); 
                        setTimeout(() => location.reload(), 2000); 
                    } else { 
                        showToast(t('admin.errorWithMessage').replace('{error}', data.error || t('admin.unknownError')), 'error'); 
                    } 
                })
                .catch(() => showToast(t('dash.networkError'), 'error'));
        }
    }

    function clearLogs() {
        const container = document.getElementById('log-container');
        if (!container) return;
        container.innerHTML = `<div class="p-1.5 bg-[var(--bg-element)] rounded log-entry log-info"><span class="text-cyan">[SYSTEM]</span><span class="text-muted ml-1" data-i18n="admin.logsCleared">${t('admin.logsCleared')}</span></div>`;
    }

    function setChartPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-pill').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
        loadMasterChart();
        loadMasterStats();
    }

    function loadMasterStats() {
        const resultEl = document.getElementById('stats-result');
        const tradesEl = document.getElementById('stats-trades');
        const winEl = document.getElementById('stats-winrate');
        const avgEl = document.getElementById('stats-avgroi');
        if (!resultEl || !tradesEl || !winEl || !avgEl) return;

        fetch(`/api/master_stats?period=${currentPeriod}`).then(r => r.json()).then(data => {
            const pnl = data.total_pnl;
            resultEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(0)}`;
            resultEl.className = `text-xs font-bold font-mono ${pnl >= 0 ? 'text-green' : 'text-red'}`;
            tradesEl.textContent = data.total_trades;
            winEl.textContent = `${data.win_rate}%`;
            avgEl.textContent = `${data.avg_roi >= 0 ? '+' : ''}${data.avg_roi.toFixed(0)}%`;
        }).catch(console.error);
    }

    function loadMasterChart() {
        const chartEl = document.getElementById('masterChart');
        if (!chartEl) return;
        if (typeof Chart === 'undefined') {
            setTimeout(loadMasterChart, 200);
            return;
        }
        fetch(`/api/balance_history?user_id=master&period=${currentPeriod}`).then(r => r.json()).then(data => {
            const ctx = chartEl.getContext('2d');
            if (masterChart) masterChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, 130);
            gradient.addColorStop(0, 'rgba(255, 0, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 0, 255, 0)');
            masterChart = new Chart(ctx, { type: 'line', data: { labels: data.map(d => d.time), datasets: [{ data: data.map(d => d.balance), borderColor: '#ff00ff', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true, grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#555', font: { size: 8 } } } }, animation: { duration: 500 } } });
        }).catch(console.error);
    }

    // ==================== STRATEGY MANAGEMENT ====================
    let adminStrategies = [];
    
    function loadAdminStrategies() {
        const container = document.getElementById('admin-strategies-container');
        if (!container) return;
        
        fetch('/api/admin/strategies')
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || t('admin.loadStrategiesFailed'));
                }
                
                adminStrategies = data.strategies;
                renderAdminStrategies();
            })
            .catch(err => {
                console.error('Error loading strategies:', err);
                container.innerHTML = `
                    <div class="text-center py-6 text-red">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>${t('admin.loadStrategiesFailed')}</p>
                        <button onclick="loadAdminStrategies()" class="cyber-btn cyber-btn-sm mt-3">
                            <i class="fas fa-sync"></i> ${t('btn.retry')}
                        </button>
                    </div>`;
            });
    }
    
    function renderAdminStrategies() {
        const container = document.getElementById('admin-strategies-container');
        if (!container) return;
        
        if (!adminStrategies.length) {
            container.innerHTML = `
                <div class="text-center py-6 text-muted">
                    <i class="fas fa-chess-board text-2xl mb-2 opacity-30"></i>
                    <p data-i18n="admin.noStrategies">–°—Ç—Ä–∞—Ç–µ–≥—ñ—ó —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω—ñ</p>
                </div>`;
            return;
        }
        
        container.innerHTML = adminStrategies.map(s => {
            const riskColor = { low: 'green', medium: 'yellow', high: 'red' }[s.risk_level] || 'muted';
            return `
                <div class="flex flex-wrap items-center gap-3 p-3 rounded-lg bg-[rgba(0,0,0,0.3)] border border-[var(--color-border)] hover:border-[var(--neon-purple)] transition-all strategy-row" data-strategy-id="${s.id}">
                    <div class="flex items-center gap-3 strategy-info">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center ${s.is_active ? 'bg-purple/20' : 'bg-muted/10'}">
                            <i class="fas fa-chess-knight ${s.is_active ? 'text-purple' : 'text-muted'}"></i>
                        </div>
                        <div>
                            <div class="font-display font-semibold ${s.is_active ? 'text-bright' : 'text-muted'}">${s.name}</div>
                            <div class="text-xxs text-muted">${s.description || t('admin.noDescription')}</div>
                        </div>
                    </div>
                    <div class="strategy-right">
                        <div class="strategy-meta">
                            <span class="badge badge-${riskColor}" data-i18n="${riskLevelKeyMap[s.risk_level] || ''}">${getRiskLabel(s.risk_level)}</span>
                            <span class="text-xs text-muted">${s.subscriber_count || 0} ${t('admin.users')}</span>
                        </div>
                        <div class="strategy-actions">
                            <button onclick="editStrategy(${s.id})" class="cyber-btn cyber-btn-sm cyber-btn-secondary" title="${t('admin.edit')}" data-i18n-title="admin.edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleStrategy(${s.id}, ${!s.is_active})" class="cyber-btn cyber-btn-sm ${s.is_active ? 'cyber-btn-warning' : 'cyber-btn-gradient-green'}" title="${s.is_active ? t('admin.deactivate') : t('admin.activate')}" data-i18n-title="${s.is_active ? 'admin.deactivate' : 'admin.activate'}">
                                <i class="fas fa-${s.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            ${s.name !== 'Main' ? `<button onclick="deleteStrategy(${s.id}, '${s.name}')" class="cyber-btn cyber-btn-sm cyber-btn-danger" title="${t('admin.delete')}" data-i18n-title="admin.delete">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function openCreateStrategyModal() {
        const modalHtml = `
            <div id="strategyModal" class="modal-overlay" style="display: flex;" onclick="if(event.target===this)closeStrategyModal()">
                <div class="modal-card">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-chess-knight text-purple"></i>
                            <span data-i18n="admin.createStrategy">${t('admin.createStrategy')}</span>
                        </div>
                        <button onclick="closeStrategyModal()" class="modal-close"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <form id="strategy-form" onsubmit="submitStrategy(event)" class="space-y-4">
                            <input type="hidden" id="strategy-id" value="">
                            <div class="space-y-1">
                                <label class="text-xs text-muted" data-i18n="admin.strategyNameLabel">${t('admin.strategyNameLabel')}</label>
                                <input type="text" id="strategy-name" class="input" data-i18n-placeholder="admin.strategyNamePlaceholder" placeholder="${t('admin.strategyNamePlaceholder')}" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-muted" data-i18n="admin.strategyDescriptionLabel">${t('admin.strategyDescriptionLabel')}</label>
                                <textarea id="strategy-description" class="input" rows="2" data-i18n-placeholder="admin.strategyDescriptionPlaceholder" placeholder="${t('admin.strategyDescriptionPlaceholder')}"></textarea>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-muted" data-i18n="admin.strategyRiskLevelLabel">${t('admin.strategyRiskLevelLabel')}</label>
                                <select id="strategy-risk-level" class="input">
                                    <option value="low" data-i18n="admin.riskLow">${t('admin.riskLow')}</option>
                                    <option value="medium" selected data-i18n="admin.riskMedium">${t('admin.riskMedium')}</option>
                                    <option value="high" data-i18n="admin.riskHigh">${t('admin.riskHigh')}</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted" data-i18n="admin.strategyRiskOverrideLabel">${t('admin.strategyRiskOverrideLabel')}</label>
                                    <input type="number" id="strategy-risk-perc" class="input" data-i18n-placeholder="admin.globalPlaceholder" placeholder="${t('admin.globalPlaceholder')}" step="0.1" min="0.1" max="100">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted" data-i18n="admin.strategyLeverageOverrideLabel">${t('admin.strategyLeverageOverrideLabel')}</label>
                                    <input type="number" id="strategy-leverage" class="input" data-i18n-placeholder="admin.globalPlaceholder" placeholder="${t('admin.globalPlaceholder')}" min="1" max="125">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xxs text-muted" data-i18n="admin.strategyMaxPositionsLabel">${t('admin.strategyMaxPositionsLabel')}</label>
                                    <input type="number" id="strategy-max-pos" class="input" data-i18n-placeholder="admin.globalPlaceholder" placeholder="${t('admin.globalPlaceholder')}" min="1" max="50">
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="strategy-active" class="cyber-checkbox" checked>
                                    <span class="text-sm" data-i18n="admin.statusActive">${t('admin.statusActive')}</span>
                                </label>
                            </div>
                            <button type="submit" class="cyber-btn w-full" id="strategy-submit-btn">
                                <i class="fas fa-save"></i>
                                <span data-i18n="admin.createStrategy">${t('admin.createStrategy')}</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function closeStrategyModal() {
        const modal = document.getElementById('strategyModal');
        if (modal) modal.remove();
    }
    
    function editStrategy(strategyId) {
        const strategy = adminStrategies.find(s => s.id === strategyId);
        if (!strategy) return;
        
        openCreateStrategyModal();
        
        setTimeout(() => {
            document.getElementById('strategy-id').value = strategyId;
            document.getElementById('strategy-name').value = strategy.name;
            document.getElementById('strategy-description').value = strategy.description || '';
            document.getElementById('strategy-risk-level').value = strategy.risk_level;
            document.getElementById('strategy-risk-perc').value = strategy.default_risk_perc || '';
            document.getElementById('strategy-leverage').value = strategy.default_leverage || '';
            document.getElementById('strategy-max-pos').value = strategy.max_positions || '';
            document.getElementById('strategy-active').checked = strategy.is_active;
            
            const titleEl = document.querySelector('#strategyModal .modal-title span');
            const submitEl = document.querySelector('#strategy-submit-btn span');
            if (titleEl) {
                titleEl.textContent = t('admin.editStrategy');
                titleEl.setAttribute('data-i18n', 'admin.editStrategy');
            }
            if (submitEl) {
                submitEl.textContent = t('admin.updateStrategy');
                submitEl.setAttribute('data-i18n', 'admin.updateStrategy');
            }
        }, 50);
    }
    
    async function submitStrategy(event) {
        event.preventDefault();
        
        const strategyId = document.getElementById('strategy-id').value;
        const isEdit = !!strategyId;
        
        const data = {
            name: document.getElementById('strategy-name').value.trim(),
            description: document.getElementById('strategy-description').value.trim(),
            risk_level: document.getElementById('strategy-risk-level').value,
            default_risk_perc: parseFloat(document.getElementById('strategy-risk-perc').value) || null,
            default_leverage: parseInt(document.getElementById('strategy-leverage').value) || null,
            max_positions: parseInt(document.getElementById('strategy-max-pos').value) || null,
            is_active: document.getElementById('strategy-active').checked
        };
        
        const btn = document.getElementById('strategy-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span data-i18n="admin.saving">${t('admin.saving')}</span>`;
        
        try {
            const url = isEdit ? `/api/admin/strategies/${strategyId}` : '/api/admin/strategies';
            const response = await fetch(url, {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                const msgKey = isEdit ? 'admin.strategyUpdated' : 'admin.strategyCreated';
                showToast(result.message || t(msgKey), 'success');
                closeStrategyModal();
                loadAdminStrategies();
            } else {
                showToast(result.error || t('admin.failedToSaveStrategy'), 'error');
            }
        } catch (err) {
            console.error('Error saving strategy:', err);
            showToast(t('dash.networkError'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save"></i> <span data-i18n="${isEdit ? 'admin.updateStrategy' : 'admin.createStrategy'}">${t(isEdit ? 'admin.updateStrategy' : 'admin.createStrategy')}</span>`;
        }
    }
    
    async function toggleStrategy(strategyId, activate) {
        try {
            const response = await fetch(`/api/admin/strategies/${strategyId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: activate })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(t(activate ? 'admin.strategyActivated' : 'admin.strategyDeactivated'), 'success');
                loadAdminStrategies();
            } else {
                showToast(result.error || t('admin.failedToUpdateStrategy'), 'error');
            }
        } catch (err) {
            console.error('Error toggling strategy:', err);
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    async function deleteStrategy(strategyId, strategyName) {
        if (!confirm(t('admin.confirmDeleteStrategy').replace('{name}', strategyName))) return;
        
        try {
            const response = await fetch(`/api/admin/strategies/${strategyId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || t('admin.strategyDeleted'), 'success');
                loadAdminStrategies();
            } else {
                showToast(result.error || t('admin.failedToDeleteStrategy'), 'error');
            }
        } catch (err) {
            console.error('Error deleting strategy:', err);
            showToast(t('dash.networkError'), 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSocket();
        loadMasterChart();
        loadMasterStats();
        loadAdminStrategies();
        setTimeout(refreshMasterPositions, 800);
    });
</script>
{% endblock %}
