{% extends "base.html" %}

{% block title %}Підписка{% endblock %}

{% block extra_styles %}
<style>
    .modal-overlay {
        position: fixed !important;
        inset: 0 !important;
        z-index: 9999 !important;
        display: none;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px;
        background: rgba(0, 0, 0, 0.85) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
    }
    
    .modal-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--text-bright);
    }
    
    .modal-body {
        padding: 20px;
    }

    .admin-subscription-page .subscription-card,
    .admin-subscription-page .subscription-main-card,
    .admin-subscription-page .subscription-hero-card {
        box-sizing: border-box;
    }

    @media (max-width: 420px) {
        .admin-subscription-page {
            padding-top: 12px !important;
            padding-bottom: 16px !important;
        }

        .admin-subscription-page .subscription-container {
            padding-left: 12px !important;
            padding-right: 12px !important;
        }

        .admin-subscription-page .subscription-hero-card {
            padding: 14px !important;
            border-radius: 16px !important;
            margin-bottom: 16px !important;
        }

        .admin-subscription-page .subscription-hero-icon {
            width: 42px !important;
            height: 42px !important;
            border-radius: 12px !important;
        }

        .admin-subscription-page .subscription-hero-icon i {
            font-size: 0.95rem !important;
        }

        .admin-subscription-page .subscription-hero-title {
            font-size: 1.5rem !important;
            margin-bottom: 6px !important;
        }

        .admin-subscription-page .subscription-hero-subtitle {
            font-size: 0.85rem !important;
        }

        .admin-subscription-page .subscription-main-card {
            padding: 12px !important;
            border-radius: 14px !important;
        }

        .admin-subscription-page .subscription-card {
            padding: 12px !important;
            border-radius: 12px !important;
            margin-bottom: 12px !important;
        }

        .admin-subscription-page .subscription-section-header {
            gap: 8px !important;
            margin-bottom: 12px !important;
        }

        .admin-subscription-page .subscription-section-header h2,
        .admin-subscription-page .subscription-section-header h3,
        .admin-subscription-page .subscription-section-title {
            font-size: 0.95rem !important;
        }

        .admin-subscription-page .subscription-toggle-row {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 10px !important;
        }

        .admin-subscription-page .subscription-toggle-icon {
            width: 36px !important;
            height: 36px !important;
            border-radius: 10px !important;
        }

        .admin-subscription-page .subscription-toggle-icon i {
            font-size: 0.9rem !important;
        }

        .admin-subscription-page .subscription-toggle-meta {
            width: 100% !important;
        }

        .admin-subscription-page .subscription-stats-grid,
        .admin-subscription-page .subscription-referral-stats,
        .admin-subscription-page .subscription-filter-grid,
        .admin-subscription-page .subscription-plan-grid,
        .admin-subscription-page .subscription-bonus-grid {
            gap: 10px !important;
        }

        .admin-subscription-page .subscription-stat-card {
            padding: 8px !important;
            border-radius: 10px !important;
        }

        .admin-subscription-page .subscription-stat-value {
            font-size: 1.1rem !important;
        }

        .admin-subscription-page .subscription-plan-card,
        .admin-subscription-page .subscription-method-card,
        .admin-subscription-page .subscription-row-card {
            padding: 10px !important;
            border-radius: 10px !important;
        }

        .admin-subscription-page .subscription-row-card {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 10px !important;
        }

        .admin-subscription-page .subscription-row-details {
            text-align: left !important;
            width: 100% !important;
        }

        .admin-subscription-page .subscription-row-actions {
            width: 100% !important;
            justify-content: flex-start !important;
            flex-direction: column !important;
        }

        .admin-subscription-page .subscription-row-action {
            width: 100% !important;
        }

        .admin-subscription-page .subscription-search-row {
            gap: 8px !important;
        }

        .admin-subscription-page .subscription-search-row .input {
            width: 100% !important;
        }

        .admin-subscription-page .subscription-filter-card {
            padding: 8px !important;
            border-radius: 10px !important;
            font-size: 0.7rem !important;
        }

        .admin-subscription-page .input,
        .admin-subscription-page textarea.input {
            padding: 8px 10px !important;
            font-size: 0.82rem !important;
        }

        .admin-subscription-page .cyber-btn {
            padding: 6px 10px !important;
            font-size: 0.72rem !important;
        }

        .admin-subscription-page .badge {
            font-size: 0.6rem !important;
        }

        .admin-subscription-page table {
            font-size: 0.75rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-8 admin-subscription-page">
    <div class="max-w-6xl mx-auto px-4 subscription-container">
        <!-- Header -->
        <div class="p-6 rounded-2xl border mb-8 subscription-hero-card" style="background: linear-gradient(135deg, rgba(17, 17, 26, 0.95), rgba(10, 10, 18, 0.98)); border-color: rgba(234, 179, 8, 0.2);">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center subscription-hero-icon" style="background: rgba(234, 179, 8, 0.12); border: 1px solid rgba(234, 179, 8, 0.3);">
                        <i class="fas fa-crown text-xl text-yellow-300"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-display font-bold text-white mb-2 subscription-hero-title" data-i18n="admin.subscriptionTitle">Підписка</h1>
                        <p class="text-white/60 subscription-hero-subtitle" data-i18n="admin.subscriptionSubtitle">Налаштування підписок, гаманців та платежів</p>
                    </div>
                </div>
                <a href="{{ url_for('dashboard') }}" class="cyber-btn cyber-btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    <span data-i18n="nav.backToDashboard">Назад до панелі</span>
                </a>
            </div>
        </div>

        <!-- ==================== SUBSCRIPTION MANAGEMENT ==================== -->
        <div class="card mb-6 subscription-main-card" id="admin-subscription-management">
            <div class="flex items-center justify-between mb-4 subscription-section-header">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-crown text-yellow"></i>
                    <span data-i18n="admin.subscriptionManagement">Subscription Management</span>
                </h2>
                <button onclick="refreshSubscriptionSettings()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                    <i class="fas fa-sync" id="sub-refresh-icon"></i>
                    <span data-i18n="btn.refresh">Refresh</span>
                </button>
            </div>
            
            <!-- Subscription Toggle -->
            <div class="p-4 rounded-xl mb-4 subscription-card subscription-toggle-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between subscription-toggle-row">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center subscription-toggle-icon" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));">
                            <i class="fas fa-toggle-on text-yellow text-xl"></i>
                        </div>
                        <div class="subscription-toggle-meta">
                            <div class="font-display font-semibold text-bright" data-i18n="admin.subscriptionSystem">Subscription System</div>
                            <div class="text-xs text-muted" data-i18n="admin.subscriptionSystemHint">When OFF, all users have FREE access (no payment required)</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-muted" id="sub-toggle-label" data-i18n="admin.subscriptionOff">OFF</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="subscription-enabled-toggle" class="sr-only peer" onchange="toggleSubscriptionSystem(this)">
                            <div class="w-14 h-8 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-yellow-500 peer-checked:to-orange-500"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4 subscription-stats-grid">
                <div class="p-3 rounded-xl text-center subscription-stat-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1" data-i18n="admin.totalUsers">Total Users</div>
                    <div class="font-mono text-2xl font-bold text-cyan subscription-stat-value" id="admin-total-users">0</div>
                </div>
                <div class="p-3 rounded-xl text-center subscription-stat-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1" data-i18n="admin.activeSubscribers">Active Subscribers</div>
                    <div class="font-mono text-2xl font-bold text-green subscription-stat-value" id="admin-active-subscribers">0</div>
                </div>
                <div class="p-3 rounded-xl text-center subscription-stat-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1" data-i18n="admin.expiredSubscribers">Expired</div>
                    <div class="font-mono text-2xl font-bold text-yellow subscription-stat-value" id="admin-expired-subscribers">0</div>
                </div>
                <div class="p-3 rounded-xl text-center subscription-stat-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                    <div class="text-xs text-muted mb-1" data-i18n="admin.totalRevenue">Total Revenue</div>
                    <div class="font-mono text-2xl font-bold text-magenta subscription-stat-value" id="admin-total-revenue">$0</div>
                </div>
            </div>
            
            <!-- Subscription Plans -->
            <div id="subscription-plans" class="p-4 rounded-xl mb-4 subscription-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between mb-4 subscription-section-header">
                    <h3 class="font-display font-semibold flex items-center gap-2">
                        <i class="fas fa-tags text-cyan"></i>
                        <span data-i18n="admin.subscriptionPlans">Subscription Plans</span>
                    </h3>
                    <button onclick="savePlanSettings()" class="cyber-btn cyber-btn-gradient-purple cyber-btn-sm">
                        <i class="fas fa-save"></i>
                        <span data-i18n="admin.savePlans">Save Plans</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 subscription-plan-grid" id="plan-settings-grid"></div>
                <p class="text-xs text-muted mt-3" data-i18n="admin.subscriptionPlansHint">These prices are shown to users in their subscription section.</p>
            </div>
            
            <!-- Payment Methods -->
            <div id="payment-methods-section" class="p-4 rounded-xl mb-4 subscription-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between mb-4 subscription-section-header">
                    <h3 class="font-display font-semibold flex items-center gap-2">
                        <i class="fas fa-wallet text-purple"></i>
                        <span data-i18n="admin.paymentMethods">Payment Methods</span>
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="addPaymentMethodRow()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                            <i class="fas fa-plus"></i>
                            <span data-i18n="btn.add">Add</span>
                        </button>
                        <button onclick="savePaymentMethods()" class="cyber-btn cyber-btn-gradient-purple cyber-btn-sm">
                            <i class="fas fa-save"></i>
                            <span data-i18n="btn.save">Save</span>
                        </button>
                    </div>
                </div>
                <div id="payment-methods-list" class="space-y-3 subscription-methods-list"></div>
                <p class="text-xs text-muted mt-3" data-i18n="admin.paymentMethodsHint">Add bank/card details or wallet addresses for user payments.</p>
            </div>
            
            <!-- Bonus / Manual Extension -->
            <div id="subscription-bonus" class="p-4 rounded-xl mb-4 subscription-card" style="background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.2);">
                <h3 class="font-display font-semibold flex items-center gap-2 mb-4 subscription-section-title">
                    <i class="fas fa-gift text-green"></i>
                    <span data-i18n="admin.bonusManualExtension">Bonus & Manual Extension</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 subscription-bonus-grid">
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.bonusUser">User</label>
                        <select id="bonus-user-select" class="input"></select>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.bonusPlan">Plan</label>
                        <select id="bonus-plan-select" class="input"></select>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.bonusDays">Days to Add</label>
                        <input type="number" id="bonus-days-input" class="input" min="1" value="30">
                    </div>
                    <div class="flex items-end">
                        <button onclick="grantSubscription()" class="cyber-btn cyber-btn-success w-full">
                            <i class="fas fa-check"></i>
                            <span data-i18n="admin.applyBonus">Apply Bonus</span>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-muted mt-3" data-i18n="admin.bonusHint">Use for free bonus access or manual month extensions.</p>
            </div>
            
            <!-- Subscribers List -->
            <div id="subscribers-list-section" class="p-4 rounded-xl mb-4 subscription-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4 subscription-section-header">
                    <h3 class="font-display font-semibold flex items-center gap-2">
                        <i class="fas fa-users text-cyan"></i>
                        <span data-i18n="admin.subscribers">Subscribers</span>
                    </h3>
                    <div class="flex flex-col sm:flex-row gap-2 subscription-search-row">
                        <input type="text" id="subscribers-search" class="input" data-i18n-placeholder="admin.searchUser" placeholder="Search user..." oninput="loadSubscribers()">
                        <select id="subscribers-filter" class="input" onchange="loadSubscribers()">
                            <option value="all" data-i18n="admin.filterAll">All</option>
                            <option value="active" data-i18n="admin.filterActive">Active</option>
                            <option value="expired" data-i18n="admin.filterExpired">Expired</option>
                            <option value="free" data-i18n="admin.filterFree">Free</option>
                        </select>
                        <button onclick="loadSubscribers()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                            <i class="fas fa-sync"></i>
                            <span data-i18n="btn.refresh">Refresh</span>
                        </button>
                    </div>
                </div>
                <div id="subscribers-list" class="space-y-2 max-h-72 overflow-y-auto subscription-list"></div>
            </div>

            <!-- Referral Payouts -->
            <div id="referral-payouts" class="p-4 rounded-xl mb-4 subscription-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <div class="flex items-center justify-between mb-4 subscription-section-header">
                    <h3 class="font-display font-semibold flex items-center gap-2">
                        <i class="fas fa-hand-holding-usd text-green"></i>
                        <span data-i18n="admin.referralPayouts">Referral Payouts</span>
                    </h3>
                    <span class="text-xs text-muted" data-i18n="payouts.filterByStatus">Filter by status</span>
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-4 subscription-referral-stats">
                    <div class="p-3 rounded-lg text-center subscription-stat-card" style="background: rgba(255,255,255,0.02); border: 1px solid var(--color-border);">
                        <div class="text-xs text-muted mb-1" data-i18n="admin.totalReferrals">Total Referrals</div>
                        <div class="font-mono text-lg font-bold text-cyan subscription-stat-value" id="admin-total-referrals">0</div>
                    </div>
                    <div class="p-3 rounded-lg text-center subscription-stat-card" style="background: rgba(255,255,255,0.02); border: 1px solid var(--color-border);">
                        <div class="text-xs text-muted mb-1" data-i18n="admin.pendingPayouts">Pending Payouts</div>
                        <div class="font-mono text-lg font-bold text-yellow subscription-stat-value" id="admin-pending-payout-amount">$0.00</div>
                    </div>
                    <div class="p-3 rounded-lg text-center subscription-stat-card" style="background: rgba(255,255,255,0.02); border: 1px solid var(--color-border);">
                        <div class="text-xs text-muted mb-1" data-i18n="admin.pendingRequests">Pending Requests</div>
                        <div class="font-mono text-lg font-bold text-green subscription-stat-value" id="admin-pending-payout-requests">0</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4 subscription-filter-grid">
                    <a href="{{ url_for('admin_subscription', payout_status='pending') }}#referral-payouts"
                       class="p-3 rounded-lg border text-xs subscription-filter-card {{ 'bg-yellow-500/10 border-yellow-500/40 text-yellow-300' if payout_status_filter == 'pending' else 'bg-white/5 border-white/10 text-white/60 hover:border-white/20' }}">
                        <div class="flex items-center justify-between">
                            <span data-i18n="payouts.pending">Pending</span>
                            <span class="badge badge-yellow">{{ payout_counts.pending }}</span>
                        </div>
                    </a>
                    <a href="{{ url_for('admin_subscription', payout_status='approved') }}#referral-payouts"
                       class="p-3 rounded-lg border text-xs subscription-filter-card {{ 'bg-blue-500/10 border-blue-500/40 text-blue-300' if payout_status_filter == 'approved' else 'bg-white/5 border-white/10 text-white/60 hover:border-white/20' }}">
                        <div class="flex items-center justify-between">
                            <span data-i18n="payouts.approved">Approved</span>
                            <span class="badge badge-blue">{{ payout_counts.approved }}</span>
                        </div>
                    </a>
                    <a href="{{ url_for('admin_subscription', payout_status='paid') }}#referral-payouts"
                       class="p-3 rounded-lg border text-xs subscription-filter-card {{ 'bg-green-500/10 border-green-500/40 text-green-300' if payout_status_filter == 'paid' else 'bg-white/5 border-white/10 text-white/60 hover:border-white/20' }}">
                        <div class="flex items-center justify-between">
                            <span data-i18n="payouts.paid">Paid</span>
                            <span class="badge badge-green">{{ payout_counts.paid }}</span>
                        </div>
                    </a>
                    <a href="{{ url_for('admin_subscription', payout_status='rejected') }}#referral-payouts"
                       class="p-3 rounded-lg border text-xs subscription-filter-card {{ 'bg-red-500/10 border-red-500/40 text-red-300' if payout_status_filter == 'rejected' else 'bg-white/5 border-white/10 text-white/60 hover:border-white/20' }}">
                        <div class="flex items-center justify-between">
                            <span data-i18n="payouts.rejected">Rejected</span>
                            <span class="badge badge-red">{{ payout_counts.rejected }}</span>
                        </div>
                    </a>
                    <a href="{{ url_for('admin_subscription', payout_status='all') }}#referral-payouts"
                       class="p-3 rounded-lg border text-xs subscription-filter-card {{ 'bg-cyan-500/10 border-cyan-500/40 text-cyan-300' if payout_status_filter == 'all' else 'bg-white/5 border-white/10 text-white/60 hover:border-white/20' }}">
                        <div class="flex items-center justify-between">
                            <span data-i18n="payouts.all">All</span>
                            <span class="badge badge-cyan">{{ payout_counts.pending + payout_counts.approved + payout_counts.paid + payout_counts.rejected }}</span>
                        </div>
                    </a>
                </div>
                
                <div class="overflow-x-auto">
                    {% if payouts %}
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs text-white/40 border-b border-white/10">
                                <th class="pb-2" data-i18n="payouts.user">User</th>
                                <th class="pb-2" data-i18n="payouts.amount">Amount</th>
                                <th class="pb-2" data-i18n="payouts.method">Method</th>
                                <th class="pb-2" data-i18n="payouts.address">Address</th>
                                <th class="pb-2" data-i18n="payouts.status">Status</th>
                                <th class="pb-2" data-i18n="payouts.date">Date</th>
                                <th class="pb-2 text-right" data-i18n="payouts.actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {% for payout in payouts %}
                            <tr class="hover:bg-white/5">
                                <td class="py-3">
                                    <div class="font-semibold text-white">{{ payout.user.username }}</div>
                                    <div class="text-xs text-white/40">{{ payout.user.email or '—' }}</div>
                                </td>
                                <td class="py-3 font-mono font-semibold text-green-400">${{ "%.2f"|format(payout.amount) }}</td>
                                <td class="py-3 text-white/60">
                                    {{ payout.PAYMENT_METHODS.get(payout.payment_method, payout.payment_method) }}
                                </td>
                                <td class="py-3">
                                    {% set address = payout.payment_address or '' %}
                                    <div class="max-w-xs truncate font-mono text-xs text-white/60" title="{{ address }}">
                                        {{ address[:30] }}{% if address|length > 30 %}...{% endif %}
                                    </div>
                                    <button onclick="copyPayoutAddress('{{ address }}')" class="text-xs text-cyan-400 hover:text-cyan-300">
                                        <i class="fas fa-copy"></i> <span data-i18n="payouts.copy">Copy</span>
                                    </button>
                                </td>
                                <td class="py-3">
                                    {% if payout.status == 'paid' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-500/10 text-green-400">
                                        <i class="fas fa-check"></i> <span data-i18n="payouts.paid">Paid</span>
                                    </span>
                                    {% elif payout.status == 'approved' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-blue-500/10 text-blue-400">
                                        <i class="fas fa-thumbs-up"></i> <span data-i18n="payouts.approved">Approved</span>
                                    </span>
                                    {% elif payout.status == 'pending' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-500/10 text-yellow-400">
                                        <i class="fas fa-clock"></i> <span data-i18n="payouts.pending">Pending</span>
                                    </span>
                                    {% elif payout.status == 'rejected' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-red-500/10 text-red-400">
                                        <i class="fas fa-times"></i> <span data-i18n="payouts.rejected">Rejected</span>
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="py-3 text-xs text-white/40">
                                    {{ payout.created_at.strftime('%d %b %Y') if payout.created_at else '-' }}
                                </td>
                                <td class="py-3 text-right">
                                    {% if payout.status == 'pending' %}
                                    <div class="flex gap-2 justify-end">
                                        <button onclick="openPayoutApproveModal('{{ payout.id }}')" class="cyber-btn cyber-btn-success cyber-btn-sm">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="openPayoutRejectModal('{{ payout.id }}')" class="cyber-btn cyber-btn-danger cyber-btn-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    {% elif payout.status == 'approved' %}
                                    <button onclick="openPayoutPayModal('{{ payout.id }}')" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                                        <i class="fas fa-money-bill"></i>
                                    </button>
                                    {% else %}
                                    <button onclick="viewPayoutDetails('{{ payout.id }}')" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div class="text-center py-6 text-muted">
                            <i class="fas fa-inbox text-2xl mb-2 opacity-50"></i>
                            <div data-i18n="payouts.noRequests">No payout requests</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Pending Payments List -->
            <div id="subscription-pending-payments" class="p-4 rounded-xl subscription-card" style="background: var(--color-surface-2); border: 1px solid var(--color-border);">
                <h3 class="font-display font-semibold flex items-center gap-2 mb-4 subscription-section-title">
                    <i class="fas fa-clock text-yellow"></i>
                    <span data-i18n="admin.pendingPayments">Pending Payments</span>
                    <span class="badge badge-yellow ml-2" id="admin-pending-payments">0</span>
                </h3>
                <div id="pending-payments-list" class="space-y-3 max-h-64 overflow-y-auto subscription-list">
                    <div class="text-center py-4 text-muted text-sm">
                        <i class="fas fa-spinner fa-spin"></i> <span data-i18n="payouts.loading">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payout Approve Modal -->
<div id="payoutApproveModal" class="modal-overlay" onclick="if(event.target===this)closePayoutModal('payoutApproveModal')">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="background: var(--color-surface-2);">
            <div class="modal-title">
                <i class="fas fa-check-circle text-green"></i>
                <span data-i18n="payouts.approvePayout">Approve Payout</span>
            </div>
            <button onclick="closePayoutModal('payoutApproveModal')" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="payoutApproveForm" method="POST" action="javascript:void(0)" onsubmit="return validatePayoutForm(this)">
            <div class="modal-body">
                <p class="text-sm text-muted mb-3" data-i18n="payouts.approveConfirm">Approve this payout request?</p>
                <label class="text-xs text-muted mb-2 block" data-i18n="payouts.notes">Notes (optional)</label>
                <textarea name="notes" class="input" rows="2" data-i18n-placeholder="payouts.notesPlaceholder" placeholder="Add notes for reference..."></textarea>
            </div>
            <div class="p-4 border-t border-[var(--color-border)] flex gap-3 justify-end">
                <button type="button" onclick="closePayoutModal('payoutApproveModal')" class="cyber-btn cyber-btn-outline" data-i18n="btn.cancel">Cancel</button>
                <button type="submit" class="cyber-btn cyber-btn-success">
                    <i class="fas fa-check"></i>
                    <span data-i18n="payouts.approve">Approve</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payout Reject Modal -->
<div id="payoutRejectModal" class="modal-overlay" onclick="if(event.target===this)closePayoutModal('payoutRejectModal')">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="background: var(--color-surface-2);">
            <div class="modal-title">
                <i class="fas fa-times-circle text-red"></i>
                <span data-i18n="payouts.rejectPayout">Reject Payout</span>
            </div>
            <button onclick="closePayoutModal('payoutRejectModal')" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="payoutRejectForm" method="POST" action="javascript:void(0)" onsubmit="return validatePayoutForm(this)">
            <div class="modal-body">
                <p class="text-sm text-muted mb-3" data-i18n="payouts.provideReason">Please provide a reason for rejection.</p>
                <label class="text-xs text-muted mb-2 block" data-i18n="payouts.reason">Reason</label>
                <textarea name="reason" class="input" rows="3" data-i18n-placeholder="payouts.reasonPlaceholder" placeholder="Reason for rejection..." required></textarea>
            </div>
            <div class="p-4 border-t border-[var(--color-border)] flex gap-3 justify-end">
                <button type="button" onclick="closePayoutModal('payoutRejectModal')" class="cyber-btn cyber-btn-outline" data-i18n="btn.cancel">Cancel</button>
                <button type="submit" class="cyber-btn cyber-btn-danger">
                    <i class="fas fa-times"></i>
                    <span data-i18n="payouts.reject">Reject</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payout Mark Paid Modal -->
<div id="payoutPayModal" class="modal-overlay" onclick="if(event.target===this)closePayoutModal('payoutPayModal')">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="background: var(--color-surface-2);">
            <div class="modal-title">
                <i class="fas fa-money-bill-wave text-cyan"></i>
                <span data-i18n="payouts.markAsPaid">Mark as Paid</span>
            </div>
            <button onclick="closePayoutModal('payoutPayModal')" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="payoutPayForm" method="POST" action="javascript:void(0)" onsubmit="return validatePayoutForm(this)">
            <div class="modal-body">
                <p class="text-sm text-muted mb-3" data-i18n="payouts.confirmPayment">Confirm the payout was sent.</p>
                <label class="text-xs text-muted mb-2 block" data-i18n="payouts.transactionId">Transaction ID</label>
                <input type="text" name="txn_id" class="input" data-i18n-placeholder="payouts.transactionPlaceholder" placeholder="Transaction reference (optional)">
                <label class="text-xs text-muted mb-2 block mt-3" data-i18n="payouts.notes">Notes (optional)</label>
                <textarea name="notes" class="input" rows="2" data-i18n-placeholder="payouts.notesPlaceholder" placeholder="Add notes for reference..."></textarea>
            </div>
            <div class="p-4 border-t border-[var(--color-border)] flex gap-3 justify-end">
                <button type="button" onclick="closePayoutModal('payoutPayModal')" class="cyber-btn cyber-btn-outline" data-i18n="btn.cancel">Cancel</button>
                <button type="submit" class="cyber-btn cyber-btn-success">
                    <i class="fas fa-check"></i>
                    <span data-i18n="payouts.confirmPaid">Confirm Paid</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payout Details Modal -->
<div id="payoutDetailsModal" class="modal-overlay" onclick="if(event.target===this)closePayoutModal('payoutDetailsModal')">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 620px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="background: var(--color-surface-2);">
            <div class="modal-title">
                <i class="fas fa-info-circle text-purple"></i>
                <span data-i18n="payouts.payoutDetails">Payout Details</span>
            </div>
            <button onclick="closePayoutModal('payoutDetailsModal')" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="payout-details-content">
            <div class="text-center py-6 text-muted">
                <i class="fas fa-spinner fa-spin"></i> <span data-i18n="payouts.loading">Loading...</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let subscriptionSettings = null;
    let paymentMethods = [];
    
    async function loadSubscriptionStats() {
        try {
            const response = await fetch('/api/admin/subscription-stats');
            const data = await response.json();
            if (data.success) {
                const totalEl = document.getElementById('admin-total-users');
                const activeEl = document.getElementById('admin-active-subscribers');
                const expiredEl = document.getElementById('admin-expired-subscribers');
                const revenueEl = document.getElementById('admin-total-revenue');
                
                if (totalEl) totalEl.textContent = data.total_users || 0;
                if (activeEl) activeEl.textContent = data.premium_count || 0;
                if (expiredEl) expiredEl.textContent = data.expired_count || 0;
                if (revenueEl) revenueEl.textContent = `$${(data.total_revenue || 0).toFixed(2)}`;
            }
        } catch (err) {
            const totalEl = document.getElementById('admin-total-users');
            const activeEl = document.getElementById('admin-active-subscribers');
            const expiredEl = document.getElementById('admin-expired-subscribers');
            const revenueEl = document.getElementById('admin-total-revenue');
            
            if (totalEl) totalEl.textContent = '0';
            if (activeEl) activeEl.textContent = '0';
            if (expiredEl) expiredEl.textContent = '0';
            if (revenueEl) revenueEl.textContent = '$0.00';
        }
    }

    async function loadReferralStats() {
        try {
            const response = await fetch('/api/admin/referral-stats');
            const data = await response.json();
            if (data.success) {
                const totalRefEl = document.getElementById('admin-total-referrals');
                const pendingAmountEl = document.getElementById('admin-pending-payout-amount');
                const pendingReqEl = document.getElementById('admin-pending-payout-requests');
                
                if (totalRefEl) totalRefEl.textContent = data.total_referrals || 0;
                if (pendingAmountEl) pendingAmountEl.textContent = `$${(data.pending_payouts || 0).toFixed(2)}`;
                if (pendingReqEl) pendingReqEl.textContent = data.pending_requests || 0;
            }
        } catch (err) {
            const totalRefEl = document.getElementById('admin-total-referrals');
            const pendingAmountEl = document.getElementById('admin-pending-payout-amount');
            const pendingReqEl = document.getElementById('admin-pending-payout-requests');
            
            if (totalRefEl) totalRefEl.textContent = '0';
            if (pendingAmountEl) pendingAmountEl.textContent = '$0.00';
            if (pendingReqEl) pendingReqEl.textContent = '0';
        }
    }
    
    async function loadSubscriptionSettings() {
        try {
            const response = await fetch('/api/admin/subscription-settings');
            const data = await response.json();
            
            if (!data.success) {
                console.error('Failed to load subscription settings');
                return;
            }
            
            subscriptionSettings = data;
            
            // Update toggle
            const toggle = document.getElementById('subscription-enabled-toggle');
            const label = document.getElementById('sub-toggle-label');
            if (toggle) {
                toggle.checked = data.subscription.enabled;
                if (label) {
                    const stateKey = data.subscription.enabled ? 'admin.subscriptionOn' : 'admin.subscriptionOff';
                    label.textContent = t(stateKey);
                    label.setAttribute('data-i18n', stateKey);
                }
            }
            renderPlanSettings(data.plans || []);
            renderPaymentMethods(data.payment_methods || []);
            populateBonusPlans(data.plans || []);
            
        } catch (err) {
            console.error('Error loading subscription settings:', err);
        }
    }

    function renderPlanSettings(plans) {
        const grid = document.getElementById('plan-settings-grid');
        if (!grid) return;
        
        if (!plans || plans.length === 0) {
            grid.innerHTML = `<div class="text-center py-4 text-muted" data-i18n="admin.noPlansConfigured">${t('admin.noPlansConfigured')}</div>`;
            return;
        }
        
        let html = '';
        plans.forEach(plan => {
            html += `
                <div class="p-3 rounded-lg border subscription-plan-card" data-plan-id="${plan.id}" style="background: rgba(255,255,255,0.02); border-color: var(--color-border);">
                    <div class="flex items-center justify-between mb-2">
                        <input type="text" class="input text-sm font-semibold" data-field="name" value="${plan.name || ''}" data-i18n-placeholder="admin.planNamePlaceholder" placeholder="${t('admin.planNamePlaceholder')}">
                        <label class="flex items-center gap-2 text-xs text-muted">
                            <input type="checkbox" data-field="enabled" ${plan.enabled ? 'checked' : ''} class="cyber-checkbox">
                            <span data-i18n="admin.enabled">${t('admin.enabled')}</span>
                        </label>
                    </div>
                    <div class="text-xs text-muted mb-3">${plan.id.toUpperCase()}</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-muted mb-1 block" data-i18n="admin.priceLabel">${t('admin.priceLabel')}</label>
                            <input type="number" step="0.01" min="0" class="input" data-field="price" value="${plan.price}">
                        </div>
                        <div>
                            <label class="text-xs text-muted mb-1 block" data-i18n="admin.daysLabel">${t('admin.daysLabel')}</label>
                            <input type="number" step="1" min="1" class="input" data-field="days" value="${plan.days}">
                        </div>
                    </div>
                </div>
            `;
        });
        grid.innerHTML = html;
    }
    
    async function savePlanSettings() {
        const cards = document.querySelectorAll('[data-plan-id]');
        const plans = Array.from(cards).map(card => {
            const id = card.dataset.planId;
            return {
                id,
                name: card.querySelector('[data-field="name"]').value.trim(),
                price: parseFloat(card.querySelector('[data-field="price"]').value) || 0,
                days: parseInt(card.querySelector('[data-field="days"]').value) || 1,
                enabled: card.querySelector('[data-field="enabled"]').checked
            };
        });
        
        try {
            const response = await fetch('/api/admin/subscription-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plans })
            });
            const data = await response.json();
            if (data.success) {
                showToast(t('admin.plansUpdated'), 'success');
                loadSubscriptionSettings();
                loadSubscriptionStats();
            } else {
                showToast(data.error || t('admin.failedToUpdatePlans'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    function renderPaymentMethods(methods) {
        const container = document.getElementById('payment-methods-list');
        if (!container) return;
        
        paymentMethods = methods || [];
        
        if (!methods || methods.length === 0) {
            container.innerHTML = `<div class="text-center py-4 text-muted" data-i18n="admin.noPaymentMethodsConfigured">${t('admin.noPaymentMethodsConfigured')}</div>`;
            return;
        }
        
        let html = '';
        methods.forEach(method => {
            html += buildPaymentMethodRow(method);
        });
        container.innerHTML = html;
    }
    
    function buildPaymentMethodRow(method = {}) {
        const id = method.id || '';
        const label = method.label || '';
        const type = method.type || 'wallet';
        const details = method.details || '';
        const enabled = method.enabled !== false;
        
        return `
            <div class="p-3 rounded-lg border payment-method-row subscription-method-card" style="background: rgba(255,255,255,0.02); border-color: var(--color-border);">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.paymentMethodLabel">${t('admin.paymentMethodLabel')}</label>
                        <input type="text" class="input" data-field="label" value="${label}" data-i18n-placeholder="admin.paymentMethodLabelPlaceholder" placeholder="${t('admin.paymentMethodLabelPlaceholder')}">
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.paymentMethodId">${t('admin.paymentMethodId')}</label>
                        <input type="text" class="input" data-field="id" value="${id}" data-i18n-placeholder="admin.paymentMethodIdPlaceholder" placeholder="${t('admin.paymentMethodIdPlaceholder')}">
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.paymentMethodType">${t('admin.paymentMethodType')}</label>
                        <select class="input" data-field="type">
                            <option value="wallet" ${type === 'wallet' ? 'selected' : ''} data-i18n="admin.paymentMethodTypeWallet">${t('admin.paymentMethodTypeWallet')}</option>
                            <option value="bank" ${type === 'bank' ? 'selected' : ''} data-i18n="admin.paymentMethodTypeBank">${t('admin.paymentMethodTypeBank')}</option>
                            <option value="card" ${type === 'card' ? 'selected' : ''} data-i18n="admin.paymentMethodTypeCard">${t('admin.paymentMethodTypeCard')}</option>
                            <option value="exchange" ${type === 'exchange' ? 'selected' : ''} data-i18n="admin.paymentMethodTypeExchange">${t('admin.paymentMethodTypeExchange')}</option>
                            <option value="other" ${type === 'other' ? 'selected' : ''} data-i18n="admin.paymentMethodTypeOther">${t('admin.paymentMethodTypeOther')}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block" data-i18n="admin.paymentMethodDetails">${t('admin.paymentMethodDetails')}</label>
                        <textarea class="input" data-field="details" rows="2" data-i18n-placeholder="admin.paymentMethodDetailsPlaceholder" placeholder="${t('admin.paymentMethodDetailsPlaceholder')}">${details}</textarea>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-2">
                    <label class="flex items-center gap-2 text-xs text-muted">
                        <input type="checkbox" data-field="enabled" ${enabled ? 'checked' : ''} class="cyber-checkbox">
                        <span data-i18n="admin.enabled">${t('admin.enabled')}</span>
                    </label>
                    <button onclick="removePaymentMethodRow(this)" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                        <i class="fas fa-trash"></i>
                        <span data-i18n="btn.remove">${t('btn.remove')}</span>
                    </button>
                </div>
            </div>
        `;
    }
    
    function addPaymentMethodRow() {
        const container = document.getElementById('payment-methods-list');
        if (!container) return;
        container.insertAdjacentHTML('beforeend', buildPaymentMethodRow());
    }
    
    function removePaymentMethodRow(btn) {
        const row = btn.closest('.payment-method-row');
        if (row) row.remove();
    }
    
    async function savePaymentMethods() {
        const rows = document.querySelectorAll('.payment-method-row');
        const methods = Array.from(rows).map(row => {
            return {
                label: row.querySelector('[data-field="label"]').value.trim(),
                id: row.querySelector('[data-field="id"]').value.trim(),
                type: row.querySelector('[data-field="type"]').value,
                details: row.querySelector('[data-field="details"]').value.trim(),
                enabled: row.querySelector('[data-field="enabled"]').checked
            };
        }).filter(m => m.id && m.label);
        
        try {
            const response = await fetch('/api/admin/subscription-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payment_methods: methods })
            });
            const data = await response.json();
            if (data.success) {
                showToast(t('admin.paymentMethodsUpdated'), 'success');
                loadSubscriptionSettings();
            } else {
                showToast(data.error || t('admin.failedToUpdatePaymentMethods'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    function populateBonusPlans(plans) {
        const select = document.getElementById('bonus-plan-select');
        if (!select) return;
        if (!plans || plans.length === 0) {
            select.innerHTML = `<option value="" data-i18n="admin.noPlans">${t('admin.noPlans')}</option>`;
            return;
        }
        select.innerHTML = plans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    
    async function loadSubscribers() {
        const search = document.getElementById('subscribers-search')?.value.trim() || '';
        const status = document.getElementById('subscribers-filter')?.value || 'all';
        const url = `/api/admin/subscribers?status=${encodeURIComponent(status)}&q=${encodeURIComponent(search)}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.success) {
                renderSubscribers(data.users || []);
                populateBonusUsers(data.users || []);
            } else {
                showToast(data.error || t('admin.failedToLoadSubscribers'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    function populateBonusUsers(users) {
        const select = document.getElementById('bonus-user-select');
        if (!select) return;
        if (!users || users.length === 0) {
            select.innerHTML = `<option value="" data-i18n="admin.noUsers">${t('admin.noUsers')}</option>`;
            return;
        }
        select.innerHTML = users.map(u => `<option value="${u.id}">${u.username} (${u.plan})</option>`).join('');
    }
    
    function renderSubscribers(users) {
        const container = document.getElementById('subscribers-list');
        if (!container) return;
        
        if (!users || users.length === 0) {
            container.innerHTML = `<div class="text-center py-4 text-muted" data-i18n="admin.noSubscribersFound">${t('admin.noSubscribersFound')}</div>`;
            return;
        }
        
        const rows = users.map(u => {
            const statusKey = u.has_active_subscription
                ? 'admin.subscriberStatusActive'
                : (u.plan === 'free' ? 'admin.subscriberStatusFree' : 'admin.subscriberStatusExpired');
            const statusLabel = t(statusKey);
            const expires = u.expires_at ? new Date(u.expires_at).toLocaleDateString() : '—';
            return `
                <div class="subscription-row-card flex items-center justify-between gap-3 p-3 rounded-lg" style="background: rgba(255,255,255,0.02); border: 1px solid var(--color-border);">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-cyan-500/10">
                            <i class="fas fa-user text-cyan"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-bright">${u.username}</div>
                            <div class="text-xs text-muted">${u.email || '—'}</div>
                        </div>
                    </div>
                    <div class="subscription-row-details text-right text-xs text-muted">
                        <div>${u.plan.toUpperCase()} • <span data-i18n="${statusKey}">${statusLabel}</span></div>
                        <div><span data-i18n="admin.expiresLabel">${t('admin.expiresLabel')}</span>: ${expires}</div>
                        <div><span data-i18n="admin.daysLabel">${t('admin.daysLabel')}</span>: ${u.days_remaining}</div>
                    </div>
                    <div class="subscription-row-actions flex gap-2 justify-end">
                        <button onclick="setBonusUser(${u.id})" class="cyber-btn cyber-btn-outline cyber-btn-sm subscription-row-action">
                            <i class="fas fa-gift"></i>
                            <span data-i18n="admin.bonusAction">${t('admin.bonusAction')}</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = rows;
    }
    
    function setBonusUser(userId) {
        const select = document.getElementById('bonus-user-select');
        if (select) select.value = String(userId);
        select?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    async function grantSubscription() {
        const userId = document.getElementById('bonus-user-select')?.value;
        const plan = document.getElementById('bonus-plan-select')?.value;
        const days = parseInt(document.getElementById('bonus-days-input')?.value || '0');
        
        if (!userId || !plan || !days) {
            showToast(t('admin.selectUserPlanDays'), 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/activate-subscription/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plan, days })
            });
            const data = await response.json();
            if (data.success) {
                showToast(data.message || t('admin.subscriptionUpdated'), 'success');
                loadSubscribers();
                loadSubscriptionStats();
            } else {
                showToast(data.error || t('admin.failedToUpdateSubscription'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }

    function copyPayoutAddress(address) {
        if (!address) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(address).then(() => {
                showToast(t('admin.addressCopied'), 'success');
            }).catch(() => {
                showToast(t('admin.failedToCopy'), 'error');
            });
        } else {
            const temp = document.createElement('input');
            temp.value = address;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast(t('admin.addressCopied'), 'success');
        }
    }
    
    function openPayoutApproveModal(payoutId) {
        const form = document.getElementById('payoutApproveForm');
        if (form) form.action = `/admin/payout/${payoutId}/approve`;
        openPayoutModal('payoutApproveModal');
    }
    
    function openPayoutRejectModal(payoutId) {
        const form = document.getElementById('payoutRejectForm');
        if (form) form.action = `/admin/payout/${payoutId}/reject`;
        openPayoutModal('payoutRejectModal');
    }
    
    function openPayoutPayModal(payoutId) {
        const form = document.getElementById('payoutPayForm');
        if (form) form.action = `/admin/payout/${payoutId}/pay`;
        openPayoutModal('payoutPayModal');
    }
    
    function openPayoutModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closePayoutModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    function validatePayoutForm(form) {
        const action = form.getAttribute('action');
        if (!action || action === 'javascript:void(0)') {
            showToast(t('admin.actionNotSet'), 'error');
            return false;
        }
        return true;
    }
    
    function viewPayoutDetails(payoutId) {
        const content = document.getElementById('payout-details-content');
        if (content) {
            content.innerHTML = `<div class="text-center py-6 text-muted"><i class="fas fa-spinner fa-spin"></i> <span data-i18n="payouts.loading">${t('payouts.loading')}</span></div>`;
        }
        openPayoutModal('payoutDetailsModal');
        
        fetch(`/api/admin/payout/${payoutId}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    if (content) content.innerHTML = `<div class="text-center text-red-400" data-i18n="admin.failedToLoadDetails">${t('admin.failedToLoadDetails')}</div>`;
                    return;
                }
                const p = data.payout;
                const u = data.user;
                const created = p.created_at ? new Date(p.created_at).toLocaleString() : 'N/A';
                const processed = p.paid_at || p.reviewed_at;
                const processedLabel = processed ? new Date(processed).toLocaleString() : 'N/A';
                
                if (content) {
                    content.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="payouts.user">${t('payouts.user')}</div>
                                <div class="font-semibold">${u.username}</div>
                                <div class="text-xs text-white/40">${u.email || '—'}</div>
                            </div>
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="payouts.amount">${t('payouts.amount')}</div>
                                <div class="font-mono font-semibold text-green-400">$${p.amount.toFixed(2)}</div>
                            </div>
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="payouts.status">${t('payouts.status')}</div>
                                <div class="font-semibold">${p.status}</div>
                            </div>
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="payouts.method">${t('payouts.method')}</div>
                                <div class="font-semibold">${p.payment_method_label}</div>
                            </div>
                            <div class="p-3 rounded-lg border border-white/10 md:col-span-2">
                                <div class="text-xs text-muted" data-i18n="admin.addressDetails">${t('admin.addressDetails')}</div>
                                <div class="font-mono text-sm break-all">${p.payment_address || '—'}</div>
                            </div>
                            ${p.txn_id ? `
                            <div class="p-3 rounded-lg border border-white/10 md:col-span-2">
                                <div class="text-xs text-muted" data-i18n="payouts.transactionId">${t('payouts.transactionId')}</div>
                                <div class="font-mono text-sm break-all">${p.txn_id}</div>
                            </div>` : ''}
                            ${p.admin_notes ? `
                            <div class="p-3 rounded-lg border border-white/10 md:col-span-2">
                                <div class="text-xs text-muted" data-i18n="admin.adminNotes">${t('admin.adminNotes')}</div>
                                <div class="text-sm">${p.admin_notes}</div>
                            </div>` : ''}
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="admin.createdLabel">${t('admin.createdLabel')}</div>
                                <div class="text-sm">${created}</div>
                            </div>
                            <div class="p-3 rounded-lg border border-white/10">
                                <div class="text-xs text-muted" data-i18n="admin.processedLabel">${t('admin.processedLabel')}</div>
                                <div class="text-sm">${processedLabel}</div>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(() => {
                if (content) content.innerHTML = `<div class="text-center text-red-400" data-i18n="admin.failedToLoadDetails">${t('admin.failedToLoadDetails')}</div>`;
            });
    }
    
    async function loadPendingPayments() {
        try {
            const response = await fetch('/api/admin/subscription-payments?status=awaiting_confirmation');
            const data = await response.json();
            
            if (!data.success) return;
            
            // Update pending count
            const pendingCountEl = document.getElementById('admin-pending-payments');
            if (pendingCountEl) pendingCountEl.textContent = data.payments.length;
            
            // Render list
            renderPendingPaymentsList(data.payments);
        } catch (err) {
            console.error('Error loading pending payments:', err);
        }
    }
    
    function renderPendingPaymentsList(payments) {
        const container = document.getElementById('pending-payments-list');
        if (!container) return;
        
        if (!payments || payments.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 text-muted">
                    <i class="fas fa-check-circle text-2xl mb-2 text-green"></i>
                    <p data-i18n="admin.noPendingPayments">${t('admin.noPendingPayments')}</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        payments.forEach(p => {
            const createdAt = new Date(p.created_at);
            const currencyKey = (p.currency || '').toLowerCase();
            const methodLabel = paymentMethods.find(m => m.id === p.currency || m.id === currencyKey)?.label || p.currency;
            html += `
                <div class="subscription-row-card flex items-center justify-between gap-3 p-3 rounded-lg" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2);">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-yellow-500/20">
                            <i class="fas fa-clock text-yellow"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-bright">${p.username}</div>
                            <div class="text-xs text-muted">${p.plan.toUpperCase()} - ${methodLabel}</div>
                        </div>
                    </div>
                    <div class="subscription-row-details text-right">
                        <div class="font-mono font-bold text-yellow">$${p.amount_usd.toFixed(2)}</div>
                        <div class="text-xs text-muted">${createdAt.toLocaleDateString()}</div>
                    </div>
                    <div class="subscription-row-actions flex gap-2 justify-end">
                        <button onclick="confirmPayment(${p.id})" class="cyber-btn cyber-btn-sm cyber-btn-success subscription-row-action" title="${t('payouts.approve')}" data-i18n-title="payouts.approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectPayment(${p.id})" class="cyber-btn cyber-btn-sm cyber-btn-danger subscription-row-action" title="${t('payouts.reject')}" data-i18n-title="payouts.reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    async function toggleSubscriptionSystem(checkbox) {
        const enabled = checkbox.checked;
        const label = document.getElementById('sub-toggle-label');
        
        try {
            const response = await fetch('/api/admin/subscription-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscription: { enabled: enabled }
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (label) {
                    const stateKey = enabled ? 'admin.subscriptionOn' : 'admin.subscriptionOff';
                    label.textContent = t(stateKey);
                    label.setAttribute('data-i18n', stateKey);
                }
                showToast(enabled ? t('admin.subscriptionEnabled') : t('admin.freeAccessEnabled'), 'success');
            } else {
                checkbox.checked = !enabled;
                showToast(data.error || t('admin.failedToUpdate'), 'error');
            }
        } catch (err) {
            checkbox.checked = !enabled;
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    async function confirmPayment(paymentId) {
        if (!confirm(t('admin.confirmPaymentPrompt'))) return;
        
        try {
            const response = await fetch(`/api/admin/confirm-payment/${paymentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(t('admin.paymentConfirmed'), 'success');
                loadPendingPayments();
                loadTotalRevenue();
            } else {
                showToast(data.error || t('admin.failedToConfirm'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    async function rejectPayment(paymentId) {
        const reason = prompt(t('admin.rejectPaymentPrompt'));
        if (reason === null) return;
        
        try {
            const response = await fetch(`/api/admin/reject-payment/${paymentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason || t('admin.paymentNotVerified') })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(t('admin.paymentRejected'), 'info');
                loadPendingPayments();
            } else {
                showToast(data.error || t('admin.failedToReject'), 'error');
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        }
    }
    
    function refreshSubscriptionSettings() {
        const icon = document.getElementById('sub-refresh-icon');
        if (icon) icon.classList.add('fa-spin');
        
        Promise.all([
            loadSubscriptionSettings(),
            loadPendingPayments(),
            loadSubscriptionStats(),
            loadSubscribers(),
            loadReferralStats()
        ]).finally(() => {
            if (icon) icon.classList.remove('fa-spin');
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadSubscriptionStats();
        loadSubscriptionSettings();
        loadPendingPayments();
        loadSubscribers();
        loadReferralStats();
    });
</script>
{% endblock %}
