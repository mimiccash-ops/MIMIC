{% extends "base.html" %}

{% block title %}Exchange{% endblock %}

{% block extra_styles %}
<style>
    .command-terminal { background: linear-gradient(165deg, rgba(12, 12, 24, 0.98), rgba(8, 8, 16, 0.99)); border: 1px solid rgba(0, 245, 255, 0.15); }
    .terminal-header { background: linear-gradient(90deg, var(--neon-red), var(--neon-yellow), var(--neon-green)); height: 2px; }
    .log-entry { transition: all 0.15s ease; border-radius: 6px; margin: 3px 0; border-left: 2px solid transparent; }
    .log-entry:hover { background: rgba(0, 245, 255, 0.04); transform: translateX(3px); border-left-color: var(--neon-cyan); }
    .log-error { border-left-color: var(--neon-red); background: rgba(255, 0, 68, 0.04); }
    .log-info { border-left-color: var(--neon-cyan); background: rgba(0, 245, 255, 0.02); }
    .master-balance { font-size: clamp(1.2rem, 5vw, 1.6rem); font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 12px rgba(0, 245, 255, 0.25)); letter-spacing: -0.5px; line-height: 1; }
    .master-balance-card {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding: 12px 16px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(0, 245, 255, 0.08), rgba(255, 0, 212, 0.08));
        border: 1px solid rgba(0, 245, 255, 0.32);
        box-shadow: 0 12px 28px rgba(0, 245, 255, 0.15), inset 0 0 12px rgba(0, 245, 255, 0.08);
    }
    .master-balance-label {
        font-size: 0.55rem;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    .master-balance-value {
        font-size: clamp(1.4rem, 5vw, 1.9rem);
        font-weight: 800;
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 16px rgba(0, 245, 255, 0.25));
        letter-spacing: -0.6px;
        line-height: 1;
    }
    .exchange-balance-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .exchange-balance-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(10, 20, 28, 0.6);
        border: 1px solid rgba(0, 245, 255, 0.18);
        box-shadow: inset 0 0 10px rgba(0, 245, 255, 0.06);
        min-width: 120px;
    }
    .exchange-balance-pill.is-error {
        border-color: rgba(255, 0, 85, 0.3);
        box-shadow: inset 0 0 10px rgba(255, 0, 85, 0.08);
    }
    .exchange-balance-pill .name {
        font-size: 0.62rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--text-muted);
    }
    .exchange-balance-pill .value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        font-weight: 700;
    }
    .stat-number { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: clamp(0.85rem, 3vw, 1.2rem); letter-spacing: -0.3px; }
    .node-card { transition: all 0.15s ease; border-left: 2px solid transparent; }
    .node-card:hover { transform: translateX(3px); background: rgba(0, 245, 255, 0.02); border-left-color: var(--neon-cyan); }
    .control-btn { position: relative; overflow: hidden; transition: all 0.15s ease; }
    .control-btn:hover { transform: translateY(-1px); }
    .period-btn { padding: 3px 8px; font-size: 0.5rem; font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--text-muted); background: var(--bg-element); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; transition: all 0.15s ease; text-transform: uppercase; }
    .period-btn:hover { color: var(--neon-magenta); border-color: var(--neon-magenta); }
    .period-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-magenta), var(--neon-cyan)); border-color: transparent; }
    .stats-mode-btn { padding: 3px 8px; font-size: 0.5rem; color: var(--text-muted); background: transparent; border: none; border-radius: 4px; cursor: pointer; transition: all 0.15s ease; }
    .stats-mode-btn:hover { color: var(--neon-cyan); }
    .stats-mode-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); }
    #admin-exchange-dropdown-icon.rotate-180, #user-exchange-filter-icon.rotate-180 { transform: rotate(180deg); }
    .cyber-checkbox { width: 14px; height: 14px; accent-color: var(--neon-cyan); cursor: pointer; }
    .position-card { transition: all 0.15s ease; }
    .position-card:hover { transform: translateX(2px); }
    .trade-row:hover { background: rgba(0, 245, 255, 0.04); }
    
    /* Toggle Switch */
    .toggle-bg { position: relative; cursor: pointer; }
    .toggle-dot { transition: all 0.2s ease; }
    .translate-x-6 { transform: translateX(1.5rem); }
    
    /* Balance cell styles */
    .balance-cell { min-width: 90px; }
    .balance-cell .bg-green { background: var(--neon-green); box-shadow: 0 0 4px var(--neon-green); }
    .balance-cell .bg-yellow { background: var(--neon-yellow); box-shadow: 0 0 4px var(--neon-yellow); }
    .balance-cell .bg-red { background: var(--neon-red); box-shadow: 0 0 4px var(--neon-red); }
    
    /* Modal Overlay Styles */
    .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        min-width: 100vw !important;
        min-height: 100vh !important;
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
        padding: 20px !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-overlay.show {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure modal is visible when display is set via inline style */
    .modal-overlay[style*="display: flex"],
    .modal-overlay[style*="display:flex"],
    .modal-overlay[style*="display: flex !important"],
    .modal-overlay[style*="display:flex !important"] {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface-2);
    }
    
    .modal-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 1rem;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-card {
        width: 100%;
        max-width: 500px;
        background: var(--color-surface-2, #15151e);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        animation: modalIn 0.3s ease;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 245, 255, 0.1);
    }
    
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.95) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    /* Select dropdown styling for modal */
    .modal-body select,
    .modal-body select.input {
        background: var(--color-surface-3, #1a1a25) !important;
        color: var(--text-primary);
        border: 2px solid var(--color-border);
        padding: 14px 44px 14px 18px;
        font-size: 0.9375rem;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f5ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 16px center !important;
    }
    
    .modal-body select:focus {
        outline: none;
        border-color: var(--neon-cyan);
        box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.15);
    }
    
    .modal-body select option {
        background: var(--color-surface-2, #15151e);
        color: var(--text-primary);
        padding: 12px;
    }

    @media (max-width: 420px) {
        .admin-exchange-page .card {
            padding: 12px;
            border-radius: 14px;
            margin-bottom: 12px;
        }

        .admin-exchange-page .card > .flex.items-center.justify-between {
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .admin-exchange-page .card > .flex.items-center.justify-between h2 {
            font-size: 0.95rem;
            gap: 8px;
        }

        .admin-exchange-page .card > .flex.items-center.justify-between .badge {
            font-size: 0.5rem;
            padding: 2px 6px;
        }

        .admin-exchange-page .card > .flex.items-center.justify-between .cyber-btn {
            padding: 6px 10px;
            font-size: 0.7rem;
        }

        .admin-exchange-page .card > .flex.items-center.justify-between .cyber-btn.cyber-btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
        }

        .admin-exchange-page .text-sm {
            font-size: 0.8rem;
        }

        .admin-exchange-page .grid.grid-4 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .admin-exchange-page #user-exchanges-container,
        .admin-exchange-page #pending-exchanges-container {
            gap: 8px;
        }

        .admin-exchange-page #user-exchanges-container > div,
        .admin-exchange-page #pending-exchanges-container > div {
            padding: 6px;
            border-radius: 10px;
        }

        .admin-exchange-page #user-exchanges-container .cyber-checkbox,
        .admin-exchange-page #pending-exchanges-container .cyber-checkbox {
            width: 12px;
            height: 12px;
        }

        .admin-exchange-page #user-exchanges-container .text-xs,
        .admin-exchange-page #pending-exchanges-container .text-xs {
            font-size: 0.72rem;
        }

        .admin-exchange-page #user-exchanges-container .text-xxs,
        .admin-exchange-page #pending-exchanges-container .text-xxs {
            font-size: 0.62rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-container admin-exchange-page">
    <div class="section-content active">
        <!-- Connect New Exchange -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-2">
                    <i class="fas fa-plug text-magenta"></i>
                    <span data-i18n="admin.exchangeConfig">Exchange Configuration</span>
                </h2>
                <button onclick="openAdminExchangeModal()" class="cyber-btn cyber-btn-sm">
                    <i class="fas fa-plus"></i>
                    <span data-i18n="btn.add">Add</span>
                </button>
                </div>
            <p class="text-sm text-muted mb-4" data-i18n="admin.connectExchangeHint">Connect exchanges with your admin API keys first. Then users can add their own keys.</p>
            <div id="all-exchanges-container" class="grid grid-4">
                <div class="empty-state col-span-full">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Verified Exchange Config -->
        <div class="card mb-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-cogs text-cyan"></i>
                    <span data-i18n="admin.verifiedExchanges">Verified Exchanges</span>
                    <span id="verified-exchanges-count" class="badge badge-success">-</span>
                </h2>
                <button onclick="loadExchangeConfigs()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="exchange-configs-container" class="grid grid-4">
                <div class="empty-state col-span-full">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- User Exchanges -->
        <div class="card mb-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-users-cog text-green"></i>
                    <span data-i18n="admin.userExchanges">User Exchanges</span>
                    <span id="active-trading-count" class="badge badge-success">-</span>
                </h2>
                <button onclick="loadAllUserExchanges()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
                </div>
            <div id="user-exchanges-container" class="flex flex-col gap-3" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>
                
        <!-- Pending Exchanges -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display font-semibold flex items-center gap-3">
                    <i class="fas fa-user-check text-yellow"></i>
                    <span data-i18n="admin.pendingExchanges">Pending Exchanges</span>
                    <span id="pending-exchanges-count" class="badge badge-warning">-</span>
                </h2>
                <button onclick="loadPendingExchanges()" class="cyber-btn cyber-btn-outline cyber-btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="pending-exchanges-container" class="flex flex-col gap-3" style="max-height: 300px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <p data-i18n="common.loading">Loading...</p>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Exchange Config - ALL exchanges (for connecting)
    let allExchangeConfigs = [];
    let isLoadingExchangeConfigs = false;
    let lastLoadTime = 0;
    
    function loadAllExchangeConfigs() {
        const now = Date.now();
        if (isLoadingExchangeConfigs || (now - lastLoadTime < 500)) {
            return;
        }
        isLoadingExchangeConfigs = true;
        lastLoadTime = now;
        
        const container = document.getElementById('all-exchanges-container');
        const select = document.getElementById('admin-exchange-select');
        const modal = document.getElementById('adminExchangeModal');
        const isModalOpen = modal && modal.style.display === 'flex';
        
        const selectedValue = select && isModalOpen ? select.value : null;
        
        fetch('/api/admin/exchange-configs').then(r => r.json()).then(configs => {
            allExchangeConfigs = configs;
            
            if (select && (!isModalOpen || !selectedValue)) {
                select.innerHTML = `<option value="" data-i18n="admin.selectExchangePlaceholder">${t('admin.selectExchangePlaceholder')}</option>` + configs.map(c => 
                    `<option value="${c.exchange_name}" data-verified="${c.is_verified}" data-passphrase="${c.requires_passphrase}">${c.display_name} ${c.is_verified ? 'âœ“' : ''}</option>`
                ).join('');
                
                if (isModalOpen && selectedValue) {
                    select.value = selectedValue;
                    if (selectedValue) {
                        handleAdminExchangeChange(select);
                    }
                }
            }
            
            if (!configs || configs.length === 0) { 
                container.innerHTML = `<div class="text-center py-3 text-muted col-span-full"><p class="text-xxs" data-i18n="admin.noExchangesConfigured">${t('admin.noExchangesConfigured')}</p></div>`; 
                return; 
            }
            
            container.innerHTML = configs.map(c => {
                const statusClass = c.is_verified ? (c.is_enabled ? 'bg-[rgba(0,255,136,0.08)] border-[rgba(0,255,136,0.25)]' : 'bg-[rgba(0,245,255,0.08)] border-[rgba(0,245,255,0.25)]') : 'bg-[rgba(255,200,0,0.04)] border-[rgba(255,200,0,0.15)]';
                const iconClass = c.is_verified ? (c.is_enabled ? 'text-green' : 'text-cyan') : 'text-yellow';
                const statusKey = c.is_verified ? (c.is_enabled ? 'admin.exchangeStatusActive' : 'admin.exchangeStatusVerified') : 'admin.exchangeStatusNotConnected';
                const statusText = t(statusKey);
                const statusBadge = c.is_verified ? 
                    `<span class="badge badge-success" style="font-size: 0.35rem;">âœ“</span>` : 
                    `<button onclick="selectExchangeForConnect('${c.exchange_name}')" class="cyber-btn cyber-btn-xs" style="font-size: 0.35rem; padding: 2px 4px;" title="${t('admin.connectExchange')}" data-i18n-title="admin.connectExchange"><i class="fas fa-plug"></i></button>`;
                
                return `<div class="p-2 rounded-lg border ${statusClass} transition-all hover:scale-[1.02]">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 bg-[var(--bg-element)] rounded-lg flex items-center justify-center">
                            <i class="fas fa-building ${iconClass}" style="font-size: 0.6rem;"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-xxs text-bright truncate">${c.display_name}</p>
                            <p class="text-xxs text-muted" data-i18n="${statusKey}">${statusText}</p>
                        </div>
                        ${statusBadge}
                    </div>
                </div>`;
            }).join('');
        }).catch(() => {
            container.innerHTML = `<div class="text-center py-3 text-red col-span-full"><p class="text-xxs" data-i18n="admin.errorLoadingExchanges">${t('admin.errorLoadingExchanges')}</p></div>`;
        }).finally(() => {
            isLoadingExchangeConfigs = false;
        });
    }
    
    function selectExchangeForConnect(exchangeName) {
        openAdminExchangeModal();
        setTimeout(() => {
            const select = document.getElementById('admin-exchange-select');
            if (select) {
                select.value = exchangeName;
                handleAdminExchangeChange(select);
            }
        }, 100);
    }
    
    // Exchange Config - Verified only (for enabling/disabling)
    let exchangeConfigs = [];
    function loadExchangeConfigs() {
        const container = document.getElementById('exchange-configs-container');
        fetch('/api/admin/exchange-configs').then(r => r.json()).then(configs => {
                exchangeConfigs = configs;
                const verified = configs.filter(c => c.is_verified).length;
            document.getElementById('verified-exchanges-count').textContent = `${verified}`;
            
            const verifiedConfigs = configs.filter(c => c.is_verified);
            if (verifiedConfigs.length === 0) { 
                container.innerHTML = `<div class="text-center py-3 text-muted col-span-full"><i class="fas fa-check-circle text-lg mb-1 opacity-30"></i><p class="text-xxs" data-i18n="admin.noVerifiedExchanges">${t('admin.noVerifiedExchanges')}</p></div>`; 
                    return;
                }
                
            container.innerHTML = verifiedConfigs.map(c => {
                const statusKey = c.is_enabled ? 'admin.exchangeEnabledForUsers' : 'admin.exchangeDisabledForUsers';
                const statusText = t(statusKey);
                return `<div class="p-2 rounded-lg border ${c.is_enabled ? 'bg-[rgba(0,255,136,0.08)] border-[rgba(0,255,136,0.25)]' : 'bg-[rgba(0,245,255,0.04)] border-[rgba(0,245,255,0.15)]'} transition-all">
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 ${c.is_enabled ? 'bg-[rgba(0,255,136,0.15)]' : 'bg-[rgba(0,245,255,0.15)]'} rounded-lg flex items-center justify-center">
                        <i class="fas fa-building ${c.is_enabled ? 'text-green' : 'text-cyan'}" style="font-size: 0.6rem;"></i>
                                    </div>
                                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-xxs text-bright truncate">${c.display_name}</p>
                        <p class="text-xxs text-muted" data-i18n="${statusKey}">${statusText}</p>
                                    </div>
                    <div class="flex items-center gap-1">
                        <label class="cursor-pointer" title="${t('admin.enableForUsers')}" data-i18n-title="admin.enableForUsers">
                            <input type="checkbox" class="cyber-checkbox" ${c.is_enabled ? 'checked' : ''} onchange="toggleExchangeConfig('${c.exchange_name}', this.checked)">
                                    </label>
                        <button onclick="disconnectExchange('${c.exchange_name}')" class="w-5 h-5 rounded flex items-center justify-center text-red hover:bg-[rgba(255,0,68,0.08)]" title="${t('admin.disconnect')}" data-i18n-title="admin.disconnect">
                            <i class="fas fa-unlink" style="font-size: 0.5rem;"></i>
                        </button>
                                </div>
                            </div>
            </div>`;
            }).join('');
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red col-span-full"><p class="text-xxs" data-i18n="admin.errorLoadingExchanges">${t('admin.errorLoadingExchanges')}</p></div>`);
    }
    
    function toggleExchangeConfig(name, isEnabled) { 
        fetch(`/api/admin/exchange-configs/${name}/toggle`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_enabled: isEnabled })
        }).then(r => r.json()).then(result => { 
            if (result.success) showToast(result.message, 'success'); 
            else showToast(result.error || t('admin.genericError'), 'error'); 
                loadExchangeConfigs();
            loadAllExchangeConfigs();
        }).catch(() => { showToast(t('dash.networkError'), 'error'); loadExchangeConfigs(); }); 
    }
    
    function disconnectExchange(name) {
        if (!confirm(t('admin.disconnectExchangeConfirm').replace('{name}', name.toUpperCase()))) return;
        fetch(`/api/admin/exchange-configs/${name}/disconnect`, { 
            method: 'POST' 
        }).then(r => r.json()).then(result => { 
            if (result.success) showToast(result.message || t('admin.exchangeDisconnected'), 'success'); 
            else showToast(result.error || t('admin.genericError'), 'error'); 
            loadExchangeConfigs();
            loadAllExchangeConfigs();
        }).catch(() => showToast(t('dash.networkError'), 'error')); 
    }
    
    // Admin Exchange Modal
    function openAdminExchangeModal() {
        let modal = document.getElementById('adminExchangeModal');
        
        if (!modal) {
            const modalHtml = `
                <div id="adminExchangeModal" class="modal-overlay" style="display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this)closeAdminExchangeModal()">
                    <div class="modal-card" style="max-width: 480px;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-plug text-gradient"></i>
                                <span data-i18n="admin.addExchange">${t('admin.addExchange')}</span>
                            </div>
                            <button class="modal-close" onclick="closeAdminExchangeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p class="text-sm text-muted mb-4" data-i18n="admin.addExchangeHint">${t('admin.addExchangeHint')}</p>
                            
                            <form id="admin-exchange-form" onsubmit="submitAdminExchange(event)" class="flex flex-col gap-4">
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm text-muted" data-i18n="admin.exchangeLabel">${t('admin.exchangeLabel')}</label>
                                    <select id="admin-exchange-select" name="exchange_name" class="cyber-select" required onchange="handleAdminExchangeChange(this)">
                                        <option value="" data-i18n="admin.loadingExchanges">${t('admin.loadingExchanges')}</option>
                                    </select>
                                </div>
                                
                                <div id="admin-exchange-status" class="hidden p-3 rounded-lg border text-sm"></div>
                                
                                <div id="admin-exchange-fields" class="flex flex-col gap-4 hidden">
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm text-muted" data-i18n="admin.adminApiKeyLabel">${t('admin.adminApiKeyLabel')}</label>
                                        <input type="text" id="admin-api-key" name="api_key" class="input font-mono" data-i18n-placeholder="admin.adminApiKeyPlaceholder" placeholder="${t('admin.adminApiKeyPlaceholder')}" required minlength="10">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm text-muted" data-i18n="admin.adminApiSecretLabel">${t('admin.adminApiSecretLabel')}</label>
                                        <input type="password" id="admin-api-secret" name="api_secret" class="input font-mono" data-i18n-placeholder="admin.adminApiSecretPlaceholder" placeholder="${t('admin.adminApiSecretPlaceholder')}" required minlength="10">
                                    </div>
                                    <div id="admin-passphrase-field" class="flex flex-col gap-2 hidden">
                                        <label class="text-sm text-muted" data-i18n="admin.passphraseLabel">${t('admin.passphraseLabel')}</label>
                                        <input type="password" id="admin-passphrase" name="passphrase" class="input font-mono" data-i18n-placeholder="admin.passphrasePlaceholder" placeholder="${t('admin.passphrasePlaceholder')}">
                                    </div>
                                    
                                    <button type="submit" class="cyber-btn w-full" id="admin-exchange-submit-btn">
                                        <i class="fas fa-plug"></i>
                                        <span data-i18n="admin.verifyAndConnect">${t('admin.verifyAndConnect')}</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modal = document.getElementById('adminExchangeModal');
        } else {
            modal.style.display = 'flex';
        }
        
        const form = document.getElementById('admin-exchange-form');
        const fields = document.getElementById('admin-exchange-fields');
        const status = document.getElementById('admin-exchange-status');
        const select = document.getElementById('admin-exchange-select');
        
        if (form) form.reset();
        if (fields) fields.classList.add('hidden');
        if (status) status.classList.add('hidden');
        
        fetch('/api/admin/exchange-configs')
            .then(r => {
                if (!r.ok) throw new Error('API error: ' + r.status);
                return r.json();
            })
            .then(configs => {
                if (select) {
                    select.innerHTML = '';
                    
                    if (!configs || configs.length === 0) {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = t('admin.noExchangesAvailable');
                        opt.setAttribute('data-i18n', 'admin.noExchangesAvailable');
                        select.appendChild(opt);
                        showToast(t('admin.noExchangesConfigured'), 'warning');
                        return;
                    }
                    
                    const defaultOpt = document.createElement('option');
                    defaultOpt.value = '';
                    defaultOpt.textContent = t('admin.selectExchangePlaceholder');
                    defaultOpt.setAttribute('data-i18n', 'admin.selectExchangePlaceholder');
                    select.appendChild(defaultOpt);
                    
                    configs.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.exchange_name;
                        opt.dataset.verified = c.is_verified;
                        opt.dataset.passphrase = c.requires_passphrase;
                        opt.textContent = c.display_name + (c.is_verified ? ' âœ“' : '');
                        select.appendChild(opt);
                    });
                }
            })
            .catch(err => {
                console.error('Error loading exchanges:', err);
                if (select) {
                    select.innerHTML = `<option value="" data-i18n="admin.errorLoadingExchanges">${t('admin.errorLoadingExchanges')}</option>`;
                }
                showToast(`${t('admin.errorLoadingExchanges')}: ${err.message}`, 'error');
            });
        
        document.body.style.overflow = 'hidden';
    }
    
    function closeAdminExchangeModal() {
        const modal = document.getElementById('adminExchangeModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    function handleAdminExchangeChange(select) {
        const exchangeName = select.value;
        const fieldsContainer = document.getElementById('admin-exchange-fields');
        const statusContainer = document.getElementById('admin-exchange-status');
        const passphraseField = document.getElementById('admin-passphrase-field');
        const passphraseInput = document.getElementById('admin-passphrase');
        
        if (!exchangeName) {
            fieldsContainer.classList.add('hidden');
            statusContainer.classList.add('hidden');
            return;
        }
        
        const option = select.options[select.selectedIndex];
        const isVerified = option.dataset.verified === 'true';
        const needsPassphrase = option.dataset.passphrase === 'true';
        
        if (isVerified) {
            statusContainer.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-check-circle text-green"></i><span class="text-green" data-i18n="admin.exchangeAlreadyVerified">${t('admin.exchangeAlreadyVerified')}</span></div><p class="text-muted mt-1" data-i18n="admin.exchangeReverifyHint">${t('admin.exchangeReverifyHint')}</p>`;
            statusContainer.className = 'p-2 rounded-lg border border-[rgba(0,255,136,0.25)] bg-[rgba(0,255,136,0.05)] text-xxs';
            statusContainer.classList.remove('hidden');
        } else {
            statusContainer.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-info-circle text-yellow"></i><span class="text-yellow" data-i18n="admin.notConnectedYet">${t('admin.notConnectedYet')}</span></div><p class="text-muted mt-1" data-i18n="admin.enterAdminKeys">${t('admin.enterAdminKeys')}</p>`;
            statusContainer.className = 'p-2 rounded-lg border border-[rgba(255,200,0,0.25)] bg-[rgba(255,200,0,0.05)] text-xxs';
            statusContainer.classList.remove('hidden');
        }
        
        if (needsPassphrase) {
            passphraseField.classList.remove('hidden');
            passphraseInput.required = true;
        } else {
            passphraseField.classList.add('hidden');
            passphraseInput.required = false;
        }
        
        fieldsContainer.classList.remove('hidden');
    }
    
    function submitAdminExchange(event) {
        event.preventDefault();
        const form = document.getElementById('admin-exchange-form');
        const btn = document.getElementById('admin-exchange-submit-btn');
        const exchangeSelect = document.getElementById('admin-exchange-select');
        const apiKeyInput = document.getElementById('admin-api-key');
        const apiSecretInput = document.getElementById('admin-api-secret');
        const passphraseInput = document.getElementById('admin-passphrase');
        
        if (!exchangeSelect.value) {
            showToast(t('admin.selectExchangeError'), 'error');
            return;
        }
        
        if (!apiKeyInput.value || !apiSecretInput.value) {
            showToast(t('admin.apiKeySecretRequired'), 'error');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span data-i18n="admin.connecting">${t('admin.connecting')}</span>`;
        
        fetch('/api/admin/exchange-configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exchange_name: exchangeSelect.value,
                api_key: apiKeyInput.value,
                api_secret: apiSecretInput.value,
                passphrase: passphraseInput.value
            })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showToast(result.message || t('admin.exchangeVerified'), 'success');
                closeAdminExchangeModal();
                setTimeout(() => {
                    loadExchangeConfigs();
                    loadAllExchangeConfigs();
                }, 500);
            } else {
                showToast(result.error || t('admin.exchangeVerificationFailed'), 'error');
            }
        })
        .catch((error) => {
            console.error('Error submitting exchange:', error);
            const errorMsg = error.error || error.message || t('admin.networkErrorRetry');
            showToast(errorMsg, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-plug"></i> <span data-i18n="admin.verifyAndConnect">${t('admin.verifyAndConnect')}</span>`;
        });
    }
    
    // User Exchanges
    let allUserExchanges = [];
    function loadAllUserExchanges() {
        const container = document.getElementById('user-exchanges-container');
        const countEl = document.getElementById('active-trading-count');
        fetch('/api/admin/exchanges/all').then(r => r.json()).then(exchanges => {
            allUserExchanges = exchanges;
            const tradingCount = exchanges.filter(ex => ex.trading_enabled && ex.status === 'APPROVED').length;
            countEl.textContent = tradingCount;
            if (!exchanges || exchanges.length === 0) { 
                container.innerHTML = `<div class="text-center py-4 text-muted"><p class="text-xxs" data-i18n="admin.noUserExchanges">${t('admin.noUserExchanges')}</p></div>`; 
                return; 
            }
            container.innerHTML = exchanges.map(ex => `
                <div class="p-2 bg-[var(--bg-element)] rounded-lg border border-[var(--border-color)]" id="admin-ex-${ex.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 min-w-0">
                            <div class="w-6 h-6 bg-[rgba(0,255,136,0.12)] border border-[rgba(0,255,136,0.25)] rounded-lg flex items-center justify-center">
                                <i class="fas fa-user text-xxs text-green"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-bold text-xxs text-bright truncate">${ex.username}</p>
                                <p class="text-xxs text-muted truncate">${ex.display_name}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="admin-ex-bal-${ex.id}" class="font-mono text-xs text-muted">...</span>
                            <span class="text-xxs ${ex.trading_enabled ? 'text-green' : 'text-yellow'}">${ex.trading_enabled ? 'ðŸŸ¢' : 'ðŸŸ¡'}</span>
                            <input type="checkbox" class="cyber-checkbox" ${ex.trading_enabled ? 'checked' : ''} onchange="toggleUserExchangeTrading(${ex.id}, this.checked)">
                        </div>
                    </div>
                </div>
            `).join('');
            loadAllUserBalances();
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red"><p class="text-xxs" data-i18n="admin.errorLoadingUserExchanges">${t('admin.errorLoadingUserExchanges')}</p></div>`);
    }
    
    function loadAllUserBalances() {
        fetch('/api/admin/users/balances').then(r => r.json()).then(data => {
            if (data.success && data.users) {
                const balanceMap = {};
                data.users.forEach(user => {
                    if (user.exchanges) {
                        user.exchanges.forEach(ex => {
                            balanceMap[ex.id] = ex;
                        });
                    }
                });
                allUserExchanges.forEach(ex => {
                    const balanceEl = document.getElementById(`admin-ex-bal-${ex.id}`);
                    if (balanceEl && balanceMap[ex.id]) {
                        const b = balanceMap[ex.id];
                        if (b.balance !== null && b.balance !== undefined) {
                            balanceEl.className = 'font-mono text-xs font-bold text-green';
                            balanceEl.textContent = '$' + b.balance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                        } else if (b.error) {
                            balanceEl.className = 'text-xxs text-red';
                            balanceEl.textContent = 'âš ï¸';
                            balanceEl.title = b.error;
                        } else {
                            balanceEl.textContent = 'â€”';
                        }
                    }
                });
            }
        }).catch(err => console.error('Error loading balances:', err));
    }
    function toggleUserExchangeTrading(id, enabled) { fetch(`/api/admin/exchanges/${id}/trading`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trading_enabled: enabled }) }).then(r => r.json()).then(result => { if (result.success) showToast(result.message, 'success'); else showToast(result.error, 'error'); loadAllUserExchanges(); }).catch(() => { showToast(t('admin.genericError'), 'error'); loadAllUserExchanges(); }); }

    // Pending Exchanges
    function loadPendingExchanges() {
        const container = document.getElementById('pending-exchanges-container');
        const countEl = document.getElementById('pending-exchanges-count');
        fetch('/api/admin/exchanges/pending').then(r => r.json()).then(exchanges => {
                countEl.textContent = exchanges.length;
            if (!exchanges || exchanges.length === 0) { container.innerHTML = `<div class="text-center py-4 text-muted"><i class="fas fa-check-circle text-lg mb-1 text-green opacity-50"></i><p class="text-xxs" data-i18n="admin.noPending">${t('admin.noPending')}</p></div>`; return; }
            container.innerHTML = exchanges.map(ex => `<div class="p-2 bg-[var(--bg-element)] rounded-lg border border-[rgba(255,200,0,0.25)]"><div class="flex items-center justify-between"><div class="flex items-center gap-2 min-w-0"><div class="min-w-0"><p class="font-bold text-xxs text-bright truncate">${ex.username}</p><p class="text-xxs text-muted truncate">${ex.display_name}</p></div></div><div class="flex items-center gap-1"><button onclick="approveExchange(${ex.id})" class="cyber-btn cyber-btn-xs cyber-btn-success" title="${t('admin.approve')}" data-i18n-title="admin.approve"><i class="fas fa-check"></i></button><button onclick="rejectExchange(${ex.id})" class="cyber-btn cyber-btn-xs cyber-btn-danger" title="${t('admin.reject')}" data-i18n-title="admin.reject"><i class="fas fa-times"></i></button></div></div></div>`).join('');
        }).catch(() => container.innerHTML = `<div class="text-center py-3 text-red"><p class="text-xxs" data-i18n="admin.genericError">${t('admin.genericError')}</p></div>`);
    }
    function approveExchange(id) { fetch(`/api/admin/exchanges/${id}/approve`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) }).then(r => r.json()).then(result => { if (result.success) showToast(t('admin.exchangeApproved'), 'success'); else showToast(result.error, 'error'); loadPendingExchanges(); loadAllUserExchanges(); }).catch(() => showToast(t('admin.genericError'), 'error')); }
    function rejectExchange(id) { if (!confirm(t('admin.rejectExchangeConfirm'))) return; fetch(`/api/admin/exchanges/${id}/reject`, { method: 'POST' }).then(r => r.json()).then(result => { if (result.success) showToast(t('admin.exchangeRejected'), 'warning'); else showToast(result.error, 'error'); loadPendingExchanges(); }).catch(() => showToast(t('admin.genericError'), 'error')); }

    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape') { 
            closeAdminExchangeModal(); 
            closeAdminAvatarModal();
        } 
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadAllExchangeConfigs();
        loadExchangeConfigs();
        loadPendingExchanges();
        loadAllUserExchanges();
    });
</script>
{% endblock %}
