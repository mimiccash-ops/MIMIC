{% extends "base.html" %}

{% block title %}Overview{% endblock %}

{% block extra_styles %}
<style>
    .command-terminal { background: linear-gradient(165deg, rgba(12, 12, 24, 0.98), rgba(8, 8, 16, 0.99)); border: 1px solid rgba(0, 245, 255, 0.15); }
    .terminal-header { background: linear-gradient(90deg, var(--neon-red), var(--neon-yellow), var(--neon-green)); height: 2px; }
    .log-entry { transition: all 0.15s ease; border-radius: 6px; margin: 3px 0; border-left: 2px solid transparent; }
    .log-entry:hover { background: rgba(0, 245, 255, 0.04); transform: translateX(3px); border-left-color: var(--neon-cyan); }
    .log-error { border-left-color: var(--neon-red); background: rgba(255, 0, 68, 0.04); }
    .log-info { border-left-color: var(--neon-cyan); background: rgba(0, 245, 255, 0.02); }
    .master-balance { font-size: clamp(1.2rem, 5vw, 1.6rem); font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 12px rgba(0, 245, 255, 0.25)); letter-spacing: -0.5px; line-height: 1; }
    .master-balance-card {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding: 12px 16px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(0, 245, 255, 0.08), rgba(255, 0, 212, 0.08));
        border: 1px solid rgba(0, 245, 255, 0.32);
        box-shadow: 0 12px 28px rgba(0, 245, 255, 0.15), inset 0 0 12px rgba(0, 245, 255, 0.08);
    }
    .master-balance-label {
        font-size: 0.55rem;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    .master-balance-value {
        font-size: clamp(1.4rem, 5vw, 1.9rem);
        font-weight: 800;
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 16px rgba(0, 245, 255, 0.25));
        letter-spacing: -0.6px;
        line-height: 1;
    }
    .exchange-balance-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .exchange-balance-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(10, 20, 28, 0.6);
        border: 1px solid rgba(0, 245, 255, 0.18);
        box-shadow: inset 0 0 10px rgba(0, 245, 255, 0.06);
        min-width: 120px;
    }
    .exchange-balance-pill.is-error {
        border-color: rgba(255, 0, 85, 0.3);
        box-shadow: inset 0 0 10px rgba(255, 0, 85, 0.08);
    }
    .exchange-balance-pill .name {
        font-size: 0.62rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--text-muted);
    }
    .exchange-balance-pill .value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        font-weight: 700;
    }
    @media (max-width: 360px) {
        .user-dropdown .dropdown-item,
        .user-dropdown .dropdown-item span,
        .user-dropdown .dropdown-name,
        .user-dropdown .dropdown-role {
            font-size: clamp(0.5rem, 3.2vw, 0.875rem);
            line-height: 1.2;
        }
        .user-dropdown .dropdown-item i {
            font-size: clamp(0.65rem, 3.6vw, 0.9rem);
        }
        .mobile-nav-item {
            font-size: clamp(0.5rem, 3.1vw, 0.875rem);
            padding: 8px 10px;
            min-height: 40px;
        }
        .mobile-nav-label {
            font-size: clamp(0.5rem, 2.4vw, 0.75rem);
            margin: 6px 12px 2px;
        }
        .mobile-user-name {
            font-size: clamp(0.6rem, 3vw, 0.9rem);
        }
        .mobile-user-role {
            font-size: clamp(0.5rem, 2.6vw, 0.7rem);
        }
    }
    .stat-number { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: clamp(0.85rem, 3vw, 1.2rem); letter-spacing: -0.3px; }
    .overview-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 16px;
    }
    .overview-stat-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
    }
    .overview-stat-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
    }
    .overview-stat-body {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
    }
    .overview-stat-label {
        font-size: 0.55rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    .overview-stat-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        font-size: 1.05rem;
        line-height: 1.1;
    }
    @media (max-width: 768px) {
        .overview-stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
    }
    @media (max-width: 400px) {
        .overview-stats-grid {
            gap: 10px;
        }
        .overview-stat-card {
            padding: 10px 12px;
            gap: 10px;
        }
        .overview-stat-icon {
            width: 30px;
            height: 30px;
            font-size: 0.8rem;
        }
        .overview-stat-label {
            font-size: 0.5rem;
            letter-spacing: 0.12em;
        }
        .overview-stat-value {
            font-size: 0.95rem;
        }
    }
    @media (max-width: 360px) {
        .overview-stat-card {
            padding: 8px 10px;
        }
        .overview-stat-value {
            font-size: 0.9rem;
        }
    }
    .node-card { transition: all 0.15s ease; border-left: 2px solid transparent; }
    .node-card:hover { transform: translateX(3px); background: rgba(0, 245, 255, 0.02); border-left-color: var(--neon-cyan); }
    .control-btn { position: relative; overflow: hidden; transition: all 0.15s ease; }
    .control-btn:hover { transform: translateY(-1px); }
    .period-btn { padding: 3px 8px; font-size: 0.5rem; font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--text-muted); background: var(--bg-element); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; transition: all 0.15s ease; text-transform: uppercase; }
    .period-btn:hover { color: var(--neon-magenta); border-color: var(--neon-magenta); }
    .period-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-magenta), var(--neon-cyan)); border-color: transparent; }
    .stats-mode-btn { padding: 3px 8px; font-size: 0.5rem; color: var(--text-muted); background: transparent; border: none; border-radius: 4px; cursor: pointer; transition: all 0.15s ease; }
    .stats-mode-btn:hover { color: var(--neon-cyan); }
    .stats-mode-btn.active { color: #000; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); }
    #admin-exchange-dropdown-icon.rotate-180, #user-exchange-filter-icon.rotate-180 { transform: rotate(180deg); }
    .cyber-checkbox { width: 14px; height: 14px; accent-color: var(--neon-cyan); cursor: pointer; }
    .position-card { transition: all 0.15s ease; }
    .position-card:hover { transform: translateX(2px); }
    .trade-row:hover { background: rgba(0, 245, 255, 0.04); }
    
    /* Toggle Switch */
    .toggle-bg { position: relative; cursor: pointer; }
    .toggle-dot { transition: all 0.2s ease; }
    .translate-x-6 { transform: translateX(1.5rem); }
    
    /* Balance cell styles */
    .balance-cell { min-width: 90px; }
    .balance-cell .bg-green { background: var(--neon-green); box-shadow: 0 0 4px var(--neon-green); }
    .balance-cell .bg-yellow { background: var(--neon-yellow); box-shadow: 0 0 4px var(--neon-yellow); }
    .balance-cell .bg-red { background: var(--neon-red); box-shadow: 0 0 4px var(--neon-red); }
</style>
{% endblock %}

{% block content %}
<div class="app-container admin-overview-page">
    <div class="section-content active">
        <!-- Hero Card -->
        <div class="hero-card mb-6">
            <div class="hero-glow"></div>
            <div class="flex flex-col md:flex-row items-center gap-6" style="position: relative; z-index: 1;">
                <!-- Master Icon -->
                <div class="user-avatar-lg" style="flex-shrink: 0; background: linear-gradient(135deg, rgba(255, 0, 212, 0.2), rgba(0, 212, 255, 0.2)); border-color: var(--neon-magenta);">
                    <i class="fas fa-crown" style="font-size: 1.75rem; color: var(--neon-magenta);"></i>
            </div>
            
                <!-- Info -->
                <div class="flex-grow text-center md:text-left">
                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 mb-2">
                        <h1 class="font-display text-xl font-semibold" data-i18n="dash.master">MASTER</h1>
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span class="live-text" data-i18n="dash.live">LIVE</span>
                    </div>
                    </div>
                    <div class="master-balance-card">
                        <div class="master-balance-label" data-i18n="admin.totalBalance">Total Balance</div>
                        <div id="master-balance" class="master-balance-value">
                            {% if master_balance and master_balance not in ['Connecting...', 'Error', 'N/A', 'No exchanges configured', 'Master exchanges not connected', '–ü–æ–º–∏–ª–∫–∞', 'Error fetching balances'] %}
                                ${{ master_balance }}
                            {% else %}
                                {% set balance_status_key = None %}
                                {% if not master_balance %}
                                    {% set balance_status_key = 'admin.connecting' %}
                                {% elif master_balance == 'Connecting...' %}
                                    {% set balance_status_key = 'admin.connecting' %}
                                {% elif master_balance in ['Error', '–ü–æ–º–∏–ª–∫–∞'] %}
                                    {% set balance_status_key = 'dash.error' %}
                                {% elif master_balance == 'Error fetching balances' %}
                                    {% set balance_status_key = 'admin.errorFetchingBalances' %}
                                {% elif master_balance == 'No exchanges configured' %}
                                    {% set balance_status_key = 'admin.noExchangesConfigured' %}
                                {% elif master_balance == 'Master exchanges not connected' %}
                                    {% set balance_status_key = 'admin.masterExchangesNotConnected' %}
                                {% elif master_balance == 'N/A' %}
                                    {% set balance_status_key = 'common.notAvailable' %}
                                {% endif %}
                                <span class="text-muted"{% if balance_status_key %} data-i18n="{{ balance_status_key }}"{% endif %}>{{ master_balance or 'Connecting...' }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Exchange Balances -->
                    <div id="exchange-balances-container" class="flex flex-wrap gap-2 mt-2 exchange-balance-list">
                        {% if master_balances_loaded %}
                            {% if master_exchange_balances %}
                                {% for ex in master_exchange_balances %}
                                <div class="exchange-balance-pill {{ 'is-error' if ex.error }}" {% if ex.error %}title="{{ ex.error }}"{% endif %}>
                                    <span class="name">{{ ex.exchange }}</span>
                                    <span class="value {{ 'text-red' if ex.error else ('text-green' if ex.balance and ex.balance > 0 else 'text-muted') }}">
                                        {% if ex.balance is not none %}${{ "{:,.2f}".format(ex.balance) }}{% elif ex.error %}‚ö†Ô∏è{% else %}...{% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <a href="{{ url_for('admin_exchange') }}" class="text-cyan text-xs hover:underline" style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-plus-circle"></i>
                                    <span data-i18n="admin.configureExchanges">Configure Master Exchanges</span>
                                </a>
                            {% endif %}
                        {% else %}
                            <span class="text-muted text-xs" data-i18n="common.loading">Loading...</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="overview-stats-grid mb-6">
            <div class="stat-card overview-stat-card">
                <div class="stat-icon cyan overview-stat-icon"><i class="fas fa-network-wired"></i></div>
                <div class="overview-stat-body">
                    <div class="overview-stat-label" data-i18n="dash.nodes">Nodes</div>
                    <div class="overview-stat-value text-cyan">{{ users|selectattr('is_paused', 'equalto', false)|selectattr('role', 'ne', 'admin')|list|length }}</div>
                </div>
            </div>
            <div class="stat-card overview-stat-card">
                <div class="stat-icon magenta overview-stat-icon"><i class="fas fa-exchange-alt"></i></div>
                <div class="overview-stat-body">
                    <div class="overview-stat-label" data-i18n="dash.trades">Trades</div>
                    <div class="overview-stat-value text-magenta">{{ closed_trades|length }}</div>
                </div>
            </div>
            <div class="stat-card overview-stat-card">
                <div class="stat-icon green overview-stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="overview-stat-body">
                    <div class="overview-stat-label" data-i18n="dash.result">Result</div>
                    <div class="overview-stat-value {{ 'text-green' if overview_total_pnl >= 0 else 'text-red' }}" id="overview-result">
                        {{ '+' if overview_total_pnl >= 0 else '-' }}${{ "{:,.2f}".format(overview_total_pnl|abs) }}
                    </div>
                </div>
            </div>
            <div class="stat-card overview-stat-card">
                <div class="stat-icon yellow overview-stat-icon"><i class="fas fa-percentage"></i></div>
                <div class="overview-stat-body">
                    <div class="overview-stat-label" data-i18n="dash.winRate">Win Rate</div>
                    <div class="overview-stat-value text-yellow" id="overview-winrate">{{ "{:.1f}".format(overview_winrate) }}%</div>
                </div>
            </div>
        </div>

        <!-- Insurance Fund / Safety Pool Card -->
        <div class="card mb-6" style="background: linear-gradient(135deg, rgba(57, 255, 20, 0.03), rgba(0, 240, 255, 0.02)); border-color: rgba(57, 255, 20, 0.2);">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center" style="width: 48px; height: 48px; background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); border-radius: var(--radius-md);">
                        <i class="fas fa-shield-alt text-xl" style="color: #39ff14;"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-muted text-xs uppercase tracking-wider" data-i18n="admin.insuranceFund">Insurance Fund</span>
                            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 100px; font-size: 0.65rem; font-weight: 600; background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid rgba(57, 255, 20, 0.3);">
                                <i class="fas fa-check-circle"></i> <span data-i18n="admin.verified">Verified</span>
                            </span>
                        </div>
                        <div class="font-mono font-bold text-2xl" id="admin-safety-pool" style="color: #39ff14;">$10,000.00</div>
                    </div>
                </div>
                <div class="text-right hidden md:block">
                    <div class="text-muted text-xs mb-1" data-i18n="admin.safetyPool">Safety Pool</div>
                    <div class="text-xs" style="color: rgba(255,255,255,0.4);" data-i18n="admin.feesToFund">5% of fees ‚Üí fund</div>
                    <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);" title="Covers slippage in extreme markets" data-i18n-title="admin.slippageHint">
                        <i class="fas fa-info-circle"></i> <span data-i18n="admin.slippageProtection">Slippage protection</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Nodes (Users) -->
        {% set non_admin_users = users|selectattr('role', 'ne', 'admin')|list %}
        {% set total_users = non_admin_users|length %}
        {% set active_users = non_admin_users|selectattr('is_active', 'equalto', True)|selectattr('is_paused', 'equalto', False)|list|length %}
        {% set paused_users = non_admin_users|selectattr('is_paused', 'equalto', True)|list|length %}
        {% set inactive_users = non_admin_users|selectattr('is_active', 'equalto', False)|selectattr('is_paused', 'equalto', False)|list|length %}
        <div class="card">
            <div class="flex flex-col gap-3 mb-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-[rgba(124,77,255,0.12)] border border-[rgba(124,77,255,0.35)]">
                            <i class="fas fa-network-wired text-purple"></i>
                        </div>
                        <div>
                            <h2 class="font-display font-semibold flex items-center gap-2">
                                <span data-i18n="admin.networkNodes">Network Nodes</span>
                            </h2>
                            <div class="text-xxs text-muted" data-i18n="admin.nodesSubtitle">Admin overview of user nodes and balances</div>
                        </div>
                    </div>
                    <button onclick="refreshAllBalances()" class="cyber-btn cyber-btn-outline cyber-btn-sm flex items-center gap-2" id="refresh-balances-btn" data-user-count="{{ total_users }}">
                        <i class="fas fa-sync-alt"></i>
                        <span data-i18n="admin.refreshBalances">Refresh balances</span>
                    </button>
                </div>
                <div class="flex flex-wrap items-center gap-2 text-xxs">
                    <span class="badge badge-primary">
                        <span data-i18n="admin.totalUsers">Total users</span>
                        <span class="ml-1">{{ total_users }}</span>
                    </span>
                    <span class="badge badge-success">
                        <span data-i18n="admin.activeUsers">Active users</span>
                        <span class="ml-1">{{ active_users }}</span>
                    </span>
                    <span class="badge badge-warning">
                        <span data-i18n="admin.pausedUsers">Paused users</span>
                        <span class="ml-1">{{ paused_users }}</span>
                    </span>
                    <span class="badge badge-danger">
                        <span data-i18n="admin.inactiveUsers">Inactive users</span>
                        <span class="ml-1">{{ inactive_users }}</span>
                    </span>
                </div>
            </div>
        
            <div class="table-container" style="max-height: 420px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-i18n="admin.tableUser">User</th>
                            <th style="text-align: center;" data-i18n="admin.tableStatus">Status</th>
                            <th style="text-align: center;" data-i18n="admin.tableBalance">Balance</th>
                            <th style="text-align: right;" data-i18n="admin.tableActions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="nodes-body">
                        {% for user in non_admin_users %}
                        <tr class="node-card border-b border-[var(--border-color)] border-opacity-30 cursor-pointer hover:bg-[rgba(0,245,255,0.04)]" data-user-id="{{ user.id }}" onclick="openUserDetailsModal({{ user.id }})">
                            <td class="py-3 px-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-9 h-9 bg-gradient-to-br from-[rgba(0,245,255,0.15)] to-[rgba(255,0,255,0.15)] border border-[rgba(0,245,255,0.25)] rounded-lg flex items-center justify-center overflow-hidden">
                                        {% if user.avatar_type == 'image' and user.avatar %}
                                        <img src="{{ url_for('static', filename='avatars/' + user.avatar) }}" alt="Avatar" class="w-full h-full object-cover">
                                        {% else %}
                                        <span class="text-base">{{ user.avatar or 'üßë‚Äçüíª' }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0">
                                        <div class="flex flex-wrap items-center gap-2">
                                            <p class="font-bold text-bright text-sm truncate">{{ user.first_name or user.username }}</p>
                                            <span class="text-xxs text-muted">@{{ user.username }}</span>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-3 text-xxs text-muted mt-1">
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-envelope text-purple"></i>
                                                {% if user.email %}
                                                <span class="truncate" style="max-width: 160px;" title="{{ user.email }}">{{ user.email }}</span>
                                                {% else %}
                                                <span>‚Äî</span>
                                                {% endif %}
                                            </span>
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-calendar text-cyan"></i>
                                                {% if user.created_at %}
                                                {{ user.created_at.strftime('%d.%m.%Y') }}
                                                {% else %}
                                                ‚Äî
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center py-3 px-2">
                                {% if user.is_paused %}
                                <span class="badge badge-warning" title="Paused" data-i18n-title="admin.userStatusPaused"><i class="fas fa-pause"></i></span>
                                {% elif user.is_active %}
                                <span class="badge badge-success" title="Active" data-i18n-title="admin.userStatusActive"><span class="status-dot online" style="width: 4px; height: 4px;"></span></span>
                                {% else %}
                                <span class="badge badge-danger" title="Inactive" data-i18n-title="admin.userStatusInactive"><i class="fas fa-times"></i></span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-2 balance-cell">
                                {% if user_exchange_details and user_exchange_details.get(user.id) %}
                                <div class="flex flex-col gap-1">
                                    {% for ex in user_exchange_details.get(user.id, []) %}
                                    <div class="flex items-center gap-1 text-xs">
                                        <span class="w-2 h-2 rounded-full {{ 'bg-green' if ex.trading_enabled else 'bg-yellow' }}" title="{{ 'Trading enabled' if ex.trading_enabled else 'Trading disabled' }}" data-i18n-title="{{ 'admin.tradingEnabled' if ex.trading_enabled else 'admin.tradingDisabled' }}"></span>
                                        <span class="text-muted truncate" style="max-width: 60px;" title="{{ ex.label }}">{{ ex.exchange_name[:3]|upper }}</span>
                                        {% if ex.balance is not none %}
                                        <span class="text-green font-bold font-mono">${{ "{:,.0f}".format(ex.balance) }}</span>
                                        {% elif ex.error %}
                                        <span class="text-red text-xs" title="{{ ex.error }}">‚ö†Ô∏è</span>
                                        {% elif ex.status == 'PENDING' %}
                                        <span class="text-yellow text-xs">‚è≥</span>
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% if user_exchange_details.get(user.id)|length > 1 %}
                                    <div class="border-t border-[var(--color-border)] pt-1 mt-1">
                                        <span class="text-cyan font-bold font-mono text-xs">Œ£ ${{ "{:,.0f}".format(user_balances.get(user.id, 0) or 0) }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% elif user_balances.get(user.id) is not none %}
                                <span class="text-green font-bold font-mono">${{ "{:,.0f}".format(user_balances[user.id]) }}</span>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td class="text-right py-3 px-2" onclick="event.stopPropagation();">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openUserDetailsModal({{ user.id }})" class="action-btn cyber-btn-icon" title="View Details" data-i18n-title="admin.viewDetails">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% if user.is_paused %}
                                    <form method="POST" action="{{ url_for('approve_user', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="action-btn cyber-btn-success cyber-btn-icon" title="Activate" data-i18n-title="admin.activate">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="POST" action="{{ url_for('disconnect_user', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="action-btn cyber-btn-gradient-yellow cyber-btn-icon" title="Pause" data-i18n-title="admin.pause">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal-overlay" onclick="if(event.target===this)closeUserDetailsModal()">
    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); width: 100%; max-width: 520px; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-user text-cyan"></i>
                <span data-i18n="admin.userDetails">User Details</span>
            </div>
            <button onclick="closeUserDetailsModal()" class="modal-close" style="width: 32px; height: 32px; border: none; background: var(--color-surface-2); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="userDetailsContent">
            <div class="empty-state">
                <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                <p data-i18n="dash.loadingData">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let socket = null;

    function formatT(key, params) {
        let text = t(key);
        if (!params) return text;
        Object.keys(params).forEach((param) => {
            text = text.split(`{${param}}`).join(params[param]);
        });
        return text;
    }

    function initSocket() {
        if (typeof io === 'undefined') {
            setTimeout(initSocket, 100);
            return;
        }
        socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 2000,
            reconnectionDelayMax: 60000,
            randomizationFactor: 0.5,
            timeout: 20000,
            transports: ['websocket', 'polling'],
            forceNew: false,
            autoConnect: true
        });
        
        socket.on('master_data', (data) => {
            const balanceEl = document.getElementById('master-balance');
            let totalBalance = null;
            if (balanceEl) {
                if (data.balance && data.balance !== '0.00' && !data.balance.includes('Error')) {
                    balanceEl.innerHTML = '$' + data.balance;
                    balanceEl.classList.remove('text-muted');
                    const parsed = parseFloat(String(data.balance).replace(/,/g, ''));
                    if (Number.isFinite(parsed)) {
                        totalBalance = parsed;
                    }
                } else if (data.exchange_balances && data.exchange_balances.length > 0) {
                    const total = data.exchange_balances.reduce((sum, ex) => sum + (ex.balance || 0), 0);
                    balanceEl.innerHTML = total > 0
                        ? '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                        : `<span class="text-muted" data-i18n="admin.noBalance">${t('admin.noBalance')}</span>`;
                    totalBalance = total;
                } else {
                    balanceEl.innerHTML = `<span class="text-muted" data-i18n="admin.noExchangesConfigured">${t('admin.noExchangesConfigured')}</span>`;
                }
            }
            if (totalBalance !== null) {
                updateSafetyPoolDisplay(totalBalance);
            }
            if (data.exchange_balances) {
                renderExchangeBalances(data.exchange_balances);
            }
        });
    }

    function formatUsd(value) {
        return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text ?? '';
        return div.innerHTML;
    }

    function updateSafetyPoolDisplay(balanceValue) {
        if (!Number.isFinite(balanceValue)) return;
        const formatted = formatUsd(balanceValue);
        const poolEl = document.getElementById('admin-safety-pool');
        if (poolEl) {
            poolEl.textContent = formatted;
        }
        const fundEl = document.getElementById('admin-insurance-fund');
        if (fundEl) {
            fundEl.textContent = formatted;
        }
    }

    function parseBalanceValue(rawText) {
        if (!rawText) return null;
        const parsed = parseFloat(String(rawText).replace(/[^0-9.-]/g, ''));
        return Number.isFinite(parsed) ? parsed : null;
    }

    function syncSafetyPoolFromMasterBalance() {
        const balanceEl = document.getElementById('master-balance');
        if (!balanceEl) return;
        const parsed = parseBalanceValue(balanceEl.textContent);
        if (parsed !== null) {
            updateSafetyPoolDisplay(parsed);
        }
    }

    function loadAdminSafetyPool() {
        syncSafetyPoolFromMasterBalance();
    }

    if (window.createVisibilityInterval) {
        window.createVisibilityInterval(loadAdminSafetyPool, 5 * 60 * 1000, { immediate: false });
    } else {
        setInterval(loadAdminSafetyPool, 5 * 60 * 1000);
    }

    async function refreshMasterBalances() {
        try {
            const res = await fetch('/api/master/exchange_balances');
            const data = await res.json();
            if (!data.success) {
                throw new Error(data.error || t('admin.failedLoadBalances'));
            }
            const balanceEl = document.getElementById('master-balance');
            if (balanceEl) {
                balanceEl.innerHTML = data.total_balance > 0
                    ? '$' + data.total_balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                    : `<span class="text-muted" data-i18n="admin.noBalance">${t('admin.noBalance')}</span>`;
            }
            if (Number.isFinite(data.total_balance)) {
                updateSafetyPoolDisplay(data.total_balance);
            }
            renderExchangeBalances(data.exchanges || []);
        } catch (err) {
            console.warn('Failed to refresh master balances:', err);
            const balanceEl = document.getElementById('master-balance');
            if (balanceEl) {
                balanceEl.innerHTML = `<span class="text-muted" data-i18n="admin.errorFetchingBalances">${t('admin.errorFetchingBalances')}</span>`;
            }
        }
    }
    
    function renderExchangeBalances(balances) {
        const container = document.getElementById('exchange-balances-container');
        if (!container) return;
        
        if (!balances || balances.length === 0) {
            container.innerHTML = `<a href="{{ url_for('admin_exchange') }}" class="text-cyan text-xs hover:underline" style="display: flex; align-items: center; gap: 6px;"><i class="fas fa-plus-circle"></i><span data-i18n="admin.configureExchanges">${t('admin.configureExchanges')}</span></a>`;
            return;
        }
        
        container.innerHTML = balances.map(ex => {
            const errorTitle = ex.error ? ` title="${escapeHtml(ex.error)}"` : '';
            const errorClass = ex.error ? 'is-error' : '';
            const balanceClass = ex.balance !== null ? (ex.balance > 0 ? 'text-green' : 'text-muted') : (ex.error ? 'text-red' : 'text-muted');
            const balanceText = ex.balance !== null ? '$' + ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : (ex.error ? '‚ö†Ô∏è' : '...');
            return `
            <div class="exchange-balance-pill ${errorClass}"${errorTitle}>
                <span class="name">${ex.exchange}</span>
                <span class="value ${balanceClass}">${balanceText}</span>
            </div>
        `;
        }).join('');
    }

    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape') { 
            closeUserDetailsModal();
            closeAdminAvatarModal();
        } 
    });

    // User Details Modal Functions
    function openUserDetailsModal(userId) {
        const modal = document.getElementById('userDetailsModal');
        const content = document.getElementById('userDetailsContent');
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        content.innerHTML = `<div class="empty-state"><div class="loading-spinner" style="margin: 0 auto 16px;"></div><p data-i18n="dash.loadingData">${t('dash.loadingData')}</p></div>`;
        
        fetch(`/api/admin/user/${userId}/details`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const u = data.user;
                    const avatarHtml = u.avatar_type === 'image' && u.avatar 
                        ? `<img src="/static/avatars/${u.avatar}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                        : `<span style="font-size: 2rem;">${u.avatar || 'üßë‚Äçüíª'}</span>`;
                    
                    const growthColor = u.balance_growth_30d >= 0 ? 'text-green' : 'text-red';
                    const growthSign = u.balance_growth_30d >= 0 ? '+' : '';
                    
                    content.innerHTML = `
                        <div class="flex items-center gap-4 mb-4">
                            <div class="user-avatar-lg" style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 212, 0.2)); border: 3px solid var(--neon-cyan); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer;" onclick="openUserAvatarUpload(${u.id})">
                                ${avatarHtml}
                                <div style="position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-camera" style="font-size: 0.45rem; color: #000;"></i>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-display font-semibold text-lg">${u.first_name || ''} ${u.last_name || ''}</h3>
                                <p class="text-sm text-muted">@${u.username}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="badge ${u.is_paused ? 'badge-warning' : (u.is_active ? 'badge-success' : 'badge-danger')}" style="font-size: 0.45rem;">
                                        ${u.is_paused
                                            ? '‚è∏Ô∏è <span data-i18n="admin.userStatusPaused">' + t('admin.userStatusPaused') + '</span>'
                                            : (u.is_active
                                                ? 'üü¢ <span data-i18n="admin.userStatusActive">' + t('admin.userStatusActive') + '</span>'
                                                : 'üî¥ <span data-i18n="admin.userStatusInactive">' + t('admin.userStatusInactive') + '</span>')}
                                    </span>
                                    ${u.telegram_enabled ? '<span class="badge badge-primary" style="font-size: 0.45rem;"><i class="fab fa-telegram"></i> TG</span>' : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3 mb-4 rounded-lg border" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 0, 212, 0.1)); border-color: rgba(0, 212, 255, 0.3);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xxs text-muted" data-i18n="admin.currentBalance">${t('admin.currentBalance')}</div>
                                    <div class="text-xl font-mono font-bold text-cyan">$${u.current_balance?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xxs text-muted" data-i18n="admin.growth30d">${t('admin.growth30d')}</div>
                                    <div class="text-sm font-bold ${growthColor}">${growthSign}${u.balance_growth_30d || 0}%</div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-[rgba(0,212,255,0.2)]">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-muted" data-i18n="admin.targetLabel">${t('admin.targetLabel')}</span>
                                    <span class="text-cyan font-mono">$${u.target_balance?.toLocaleString() || '1,000'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-envelope text-purple"></i> <span data-i18n="admin.email">${t('admin.email')}</span></div>
                                <div class="text-sm font-mono truncate" title="${u.email || ''}">${u.email || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-phone text-cyan"></i> <span data-i18n="admin.phone">${t('admin.phone')}</span></div>
                                <div class="text-sm font-mono">${u.phone || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-calendar text-green"></i> <span data-i18n="admin.registered">${t('admin.registered')}</span></div>
                                <div class="text-sm">${u.created_at || '‚Äî'}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg">
                                <div class="text-xxs text-muted mb-1"><i class="fas fa-clock text-yellow"></i> <span data-i18n="admin.daysActive">${t('admin.daysActive')}</span></div>
                                <div class="text-sm font-bold">${u.days_registered || 0} <span data-i18n="admin.days">${t('admin.days')}</span></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1" data-i18n="admin.risk">${t('admin.risk')}</div>
                                <div class="text-sm font-bold">${u.custom_risk > 0 ? u.custom_risk + '%' : t('common.auto')}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1" data-i18n="admin.leverage">${t('admin.leverage')}</div>
                                <div class="text-sm font-bold">${u.custom_leverage > 0 ? 'x' + u.custom_leverage : t('common.auto')}</div>
                            </div>
                            <div class="p-3 bg-[var(--color-surface-2)] rounded-lg text-center">
                                <div class="text-xxs text-muted mb-1" data-i18n="admin.maxPositionsShort">${t('admin.maxPositionsShort')}</div>
                                <div class="text-sm font-bold">${u.max_positions}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <div class="p-2 bg-[rgba(0,245,255,0.08)] border border-[rgba(0,245,255,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-cyan">${u.total_trades}</div>
                                <div class="text-xxs text-muted" data-i18n="dash.trades">${t('dash.trades')}</div>
                            </div>
                            <div class="p-2 bg-[rgba(0,255,136,0.08)] border border-[rgba(0,255,136,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-green">${u.winning_trades}</div>
                                <div class="text-xxs text-muted" data-i18n="admin.wins">${t('admin.wins')}</div>
                            </div>
                            <div class="p-2 bg-[rgba(255,51,102,0.08)] border border-[rgba(255,51,102,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-red">${u.losing_trades || 0}</div>
                                <div class="text-xxs text-muted" data-i18n="admin.losses">${t('admin.losses')}</div>
                            </div>
                            <div class="p-2 bg-[rgba(255,0,212,0.08)] border border-[rgba(255,0,212,0.2)] rounded-lg text-center">
                                <div class="text-lg font-bold text-magenta">${u.win_rate}%</div>
                                <div class="text-xxs text-muted" data-i18n="dash.winRate">${t('dash.winRate')}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 bg-[${u.total_pnl >= 0 ? 'rgba(0,255,136,0.08)' : 'rgba(255,51,102,0.08)'}] border border-[${u.total_pnl >= 0 ? 'rgba(0,255,136,0.2)' : 'rgba(255,51,102,0.2)'}] rounded-lg text-center">
                                <div class="text-xl font-bold font-mono ${u.total_pnl >= 0 ? 'text-green' : 'text-red'}">${u.total_pnl >= 0 ? '+' : ''}$${u.total_pnl?.toLocaleString() || '0'}</div>
                                <div class="text-xxs text-muted" data-i18n="admin.totalPnl">${t('admin.totalPnl')}</div>
                            </div>
                            <div class="p-3 bg-[rgba(255,208,0,0.08)] border border-[rgba(255,208,0,0.2)] rounded-lg text-center">
                                <div class="text-xl font-bold font-mono text-yellow">${u.avg_roi >= 0 ? '+' : ''}${u.avg_roi || 0}%</div>
                                <div class="text-xxs text-muted" data-i18n="admin.avgRoi">${t('admin.avgRoi')}</div>
                            </div>
                        </div>
                        
                        ${u.last_trade ? `
                        <div class="p-3 mb-4 bg-[var(--color-surface-2)] rounded-lg">
                            <div class="text-xxs text-muted mb-2"><i class="fas fa-history"></i> <span data-i18n="admin.lastTrade">${t('admin.lastTrade')}</span></div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="badge ${u.last_trade.side === 'LONG' ? 'badge-success' : 'badge-danger'}" style="font-size: 0.45rem;">${u.last_trade.side}</span>
                                    <span class="font-mono font-semibold">${u.last_trade.symbol}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-mono font-bold ${u.last_trade.pnl >= 0 ? 'text-green' : 'text-red'}">${u.last_trade.pnl >= 0 ? '+' : ''}$${u.last_trade.pnl}</span>
                                    <span class="text-xxs text-muted ml-2">${u.last_trade.time}</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${u.exchanges && u.exchanges.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-xs text-muted mb-2"><i class="fas fa-plug"></i> <span data-i18n="admin.connectedExchanges">${t('admin.connectedExchanges')}</span> (${u.exchanges.length})</div>
                            <div class="flex flex-col gap-2">
                                ${u.exchanges.map(ex => `
                                    <div class="p-2 bg-[var(--color-surface-2)] rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-building text-yellow"></i>
                                                <div>
                                                    <span class="text-sm font-semibold">${ex.label || ex.display_name || ex.exchange_name}</span>
                                                    <div class="text-xxs text-muted">${ex.display_name || ex.exchange_name.toUpperCase()}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="badge ${ex.status === 'APPROVED' ? (ex.trading_enabled ? 'badge-success' : 'badge-primary') : 'badge-warning'}" style="font-size: 0.5rem;">
                                                    ${ex.trading_enabled
                                                        ? 'üü¢ <span data-i18n="admin.tradingLabel">' + t('admin.tradingLabel') + '</span>'
                                                        : ex.status}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-[var(--color-border)] flex items-center justify-between">
                                            <span class="text-xxs text-muted" data-i18n="admin.balanceLabel">${t('admin.balanceLabel')}</span>
                                            ${ex.balance !== null && ex.balance !== undefined 
                                                ? `<span class="font-mono font-bold ${ex.balance > 0 ? 'text-green' : 'text-muted'}">$${ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>` 
                                                : (ex.balance_error 
                                                    ? `<span class="text-red text-xs" title="${ex.balance_error}">‚ö†Ô∏è ${ex.balance_error.substring(0, 20)}</span>` 
                                                    : (ex.status === 'PENDING' 
                                                        ? '<span class="text-yellow text-xs" data-i18n="admin.pendingApproval">‚è≥ ' + t('admin.pendingApproval') + '</span>' 
                                                        : '<span class="text-muted">‚Äî</span>'))}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : '<div class="p-3 mb-4 bg-[rgba(255,200,0,0.08)] border border-[rgba(255,200,0,0.2)] rounded-lg text-center text-yellow text-sm"><i class="fas fa-exclamation-triangle"></i> <span data-i18n="admin.noExchangesConnected">' + t('admin.noExchangesConnected') + '</span></div>'}
                        
                        <div class="p-2 mb-4 bg-[var(--color-surface-2)] rounded-lg flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fab fa-telegram" style="color: ${u.telegram_enabled ? '#0088cc' : 'var(--text-muted)'}; font-size: 1.25rem;"></i>
                                <div>
                                    <div class="text-sm" data-i18n="admin.telegramNotifications">${t('admin.telegramNotifications')}</div>
                                    <div class="text-xxs text-muted">${u.telegram_chat_id ? formatT('admin.telegramId', { id: u.telegram_chat_id }) : t('admin.notConfigured')}</div>
                                </div>
                            </div>
                            <span class="badge ${u.telegram_enabled ? 'badge-success' : 'badge-warning'}" style="font-size: 0.5rem;">
                                ${u.telegram_enabled
                                    ? '<span data-i18n="admin.enabled">' + t('admin.enabled') + '</span>'
                                    : '<span data-i18n="admin.disabled">' + t('admin.disabled') + '</span>'}
                            </span>
                        </div>
                        
                        <div class="pt-4 border-t border-[var(--color-border)] flex flex-col gap-2">
                            <input type="file" id="userAvatarUpload-${u.id}" accept="image/png,image/jpeg,image/gif,image/webp" style="display: none;" onchange="uploadUserAvatar(${u.id}, this)">
                            <button onclick="document.getElementById('userAvatarUpload-${u.id}').click()" class="cyber-btn cyber-btn-outline cyber-btn-sm w-full">
                                <i class="fas fa-camera"></i>
                                <span data-i18n="admin.uploadUserAvatar">${t('admin.uploadUserAvatar')}</span>
                            </button>
                            <button onclick="confirmDeleteUser(${u.id}, '${u.username}')" class="cyber-btn cyber-btn-danger cyber-btn-sm w-full">
                                <i class="fas fa-trash"></i>
                                <span data-i18n="admin.deleteUser">${t('admin.deleteUser')}</span>
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div class="text-center text-red py-4">${t('dash.error')}: ${data.error}</div>`;
                }
            })
            .catch(err => {
                console.error(err);
                content.innerHTML = `<div class="text-center text-red py-4" data-i18n="admin.failedLoadUserDetails">${t('admin.failedLoadUserDetails')}</div>`;
            });
    }
    
    function closeUserDetailsModal() {
        const modal = document.getElementById('userDetailsModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    function openUserAvatarUpload(userId) {
        document.getElementById(`userAvatarUpload-${userId}`).click();
    }
    
    function uploadUserAvatar(userId, input) {
        if (!input.files || !input.files[0]) return;
        
        const formData = new FormData();
        formData.append('avatar_file', input.files[0]);
        formData.append('avatar_type', 'image');
        
        showToast(t('admin.uploadingAvatar'), 'info');
        
        fetch(`/admin/update_user_avatar/${userId}`, {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showToast(t('admin.avatarUpdated'), 'success');
                openUserDetailsModal(userId);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.error || t('dash.error'), 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast(t('dash.error'), 'error');
        });
    }
    
    // Refresh all user balances
    function refreshAllBalances() {
        const btn = document.getElementById('refresh-balances-btn');
        if (!btn) return;
        const icon = btn.querySelector('i');
        
        btn.disabled = true;
        if (icon) icon.classList.add('fa-spin');
        
        fetch('/api/admin/users/balances')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.users) {
                    data.users.forEach(user => {
                        const row = document.querySelector(`tr[data-user-id="${user.user_id}"]`);
                        if (!row) return;
                        
                        const balanceCell = row.querySelector('.balance-cell');
                        if (!balanceCell) return;
                        
                        if (user.exchanges && user.exchanges.length > 0) {
                            let html = '<div class="flex flex-col gap-1">';
                            user.exchanges.forEach(ex => {
                                const statusClass = ex.trading_enabled ? 'bg-green' : 'bg-yellow';
                                const statusTitle = ex.trading_enabled ? t('admin.tradingEnabled') : t('admin.tradingDisabled');
                                let balanceHtml = '';
                                
                                if (ex.balance !== null) {
                                    balanceHtml = `<span class="text-green font-bold font-mono">$${Math.round(ex.balance).toLocaleString()}</span>`;
                                } else if (ex.error) {
                                    balanceHtml = `<span class="text-red text-xs" title="${ex.error}">‚ö†Ô∏è</span>`;
                                } else if (ex.status === 'PENDING') {
                                    balanceHtml = '<span class="text-yellow text-xs">‚è≥</span>';
                                } else {
                                    balanceHtml = '<span class="text-muted">‚Äî</span>';
                                }
                                
                                html += `<div class="flex items-center gap-1 text-xs">
                                    <span class="w-2 h-2 rounded-full ${statusClass}" title="${statusTitle}" data-i18n-title="${ex.trading_enabled ? 'admin.tradingEnabled' : 'admin.tradingDisabled'}"></span>
                                    <span class="text-muted truncate" style="max-width: 60px;" title="${ex.label}">${ex.exchange_name.substring(0, 3).toUpperCase()}</span>
                                    ${balanceHtml}
                                </div>`;
                            });
                            
                            if (user.exchanges.length > 1) {
                                html += `<div class="border-t border-[var(--color-border)] pt-1 mt-1">
                                    <span class="text-cyan font-bold font-mono text-xs">Œ£ $${Math.round(user.total_balance).toLocaleString()}</span>
                                </div>`;
                            }
                            html += '</div>';
                            balanceCell.innerHTML = html;
                        } else if (user.total_balance > 0) {
                            balanceCell.innerHTML = `<span class="text-green font-bold font-mono">$${Math.round(user.total_balance).toLocaleString()}</span>`;
                        } else {
                            balanceCell.innerHTML = '<span class="text-muted">‚Äî</span>';
                        }
                    });
                    
                    showToast(t('admin.balancesRefreshed'), 'success');
                } else {
                    showToast(t('admin.failedRefreshBalances'), 'error');
                }
            })
            .catch(err => {
                console.error('Error refreshing balances:', err);
                showToast(t('dash.networkError'), 'error');
            })
            .finally(() => {
                btn.disabled = false;
                if (icon) icon.classList.remove('fa-spin');
            });
    }
    
    // Delete User Functions
    function confirmDeleteUser(userId, username) {
        if (!confirm(formatT('admin.confirmDeleteUser', { username }))) {
            return;
        }

        const confirmText = prompt(formatT('admin.confirmDeletePrompt', { username }));
        if (confirmText !== username) {
            showToast(t('admin.deletionCancelled'), 'warning');
            return;
        }
        
        deleteUser(userId, username);
    }
    
    function deleteUser(userId, username) {
        showToast(t('admin.deletingUser'), 'info');
        
        fetch(`/api/admin/user/${userId}/delete`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showToast(result.message || formatT('admin.userDeleted', { username }), 'success');
                closeUserDetailsModal();
                const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                if (row) {
                    row.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => row.remove(), 300);
                }
            } else {
                showToast(result.error || t('admin.failedDeleteUser'), 'error');
            }
        })
        .catch(err => {
            console.error('Error deleting user:', err);
            showToast(t('admin.networkErrorDeleteUser'), 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSocket();
        loadAdminSafetyPool();
        setTimeout(refreshMasterBalances, 800);

        const balanceBtn = document.getElementById('refresh-balances-btn');
        const userCount = parseInt(balanceBtn?.dataset.userCount || '0', 10);
        if (userCount > 0 && userCount <= 50) {
            setTimeout(refreshAllBalances, 1200);
        }
    });
</script>
{% endblock %}
