{% extends "base.html" %}
{% block title %}{{ _('Terminal') if _ else 'Terminal' }}{% endblock %}

{% block mobile_sections %}
<div class="mobile-divider"></div>
<div class="mobile-nav-label" data-i18n="section.dashboard">Dashboard Sections</div>
<a href="{{ url_for('dashboard') }}#overview" class="mobile-nav-item mobile-section-link" data-section="overview" onclick="closeMobileMenu(); if(typeof showSection === 'function') { showSection('overview'); }">
    <i class="fas fa-tachometer-alt"></i>
    <span data-i18n="section.overview">Overview</span>
</a>
<a href="{{ url_for('dashboard') }}#trading" class="mobile-nav-item mobile-section-link" data-section="trading" onclick="closeMobileMenu(); if(typeof showSection === 'function') { showSection('trading'); }">
    <i class="fas fa-layer-group"></i>
    <span data-i18n="section.tradingHub">Trading / Exchange / Settings</span>
</a>
<a href="{{ url_for('dashboard') }}#tasks" class="mobile-nav-item mobile-section-link" data-section="tasks" onclick="closeMobileMenu(); if(typeof showSection === 'function') { showSection('tasks'); }">
    <i class="fas fa-tasks"></i>
    <span data-i18n="section.tasks">Tasks</span>
</a>
<a href="{{ url_for('dashboard') }}#subscription" class="mobile-nav-item mobile-section-link" data-section="subscription" onclick="closeMobileMenu(); if(typeof showSection === 'function') { showSection('subscription'); }">
    <i class="fas fa-crown"></i>
    <span data-i18n="nav.subscription">Subscription</span>
</a>
{% endblock %}

{% block extra_styles %}
<!-- HTMX for real-time updates -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
    /* ============= CYBERPUNK TERMINAL OVERRIDE ============= */
    :root {
        --cyber-black: #0a0a0f;
        --cyber-dark: #0d0d14;
        --cyber-surface: #12121a;
        --cyber-border: #1a1a24;
        --neon-green: #00ff88;
        --neon-red: #ff0055;
        --neon-cyan: #00f0ff;
        --neon-yellow: #ffee00;
        --grid-color: rgba(0, 255, 136, 0.03);
    }

    /* Scanline overlay */
    .terminal-scanlines {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9999;
        background: repeating-linear-gradient(
            0deg,
            transparent 0px,
            transparent 2px,
            rgba(0, 0, 0, 0.1) 2px,
            rgba(0, 0, 0, 0.1) 4px
        );
        opacity: 0.4;
    }

    /* Terminal grid background */
    .terminal-grid {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -1;
        background-image: 
            linear-gradient(var(--grid-color) 1px, transparent 1px),
            linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
        animation: gridScroll 60s linear infinite;
    }

    @keyframes gridScroll {
        0% { background-position: 0 0; }
        100% { background-position: 0 400px; }
    }

    /* Glowing border effect */
    .glow-border {
        position: relative;
    }
    .glow-border::before {
        content: '';
        position: absolute;
        inset: -1px;
        background: linear-gradient(135deg, var(--neon-green), transparent, var(--neon-cyan));
        border-radius: inherit;
        z-index: -1;
        opacity: 0.5;
    }

    /* ============= HERO BALANCE CARD ============= */
    .hero-terminal {
        background: linear-gradient(135deg, rgba(10, 10, 15, 0.98), rgba(18, 18, 26, 0.95));
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 16px;
        padding: 32px;
        position: relative;
        overflow: hidden;
        box-shadow: 
            0 0 60px rgba(0, 255, 136, 0.1),
            inset 0 1px 0 rgba(0, 255, 136, 0.1);
    }

    .hero-terminal::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan), var(--neon-green));
        animation: borderGlow 3s ease-in-out infinite;
    }

    @keyframes borderGlow {
        0%, 100% { opacity: 0.5; filter: blur(0); }
        50% { opacity: 1; filter: blur(1px); }
    }

    .hero-terminal .cyber-orb {
        position: absolute;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(0, 255, 136, 0.15) 0%, transparent 60%);
        top: -250px;
        right: -150px;
        pointer-events: none;
        animation: orbPulse 8s ease-in-out infinite;
    }

    @keyframes orbPulse {
        0%, 100% { transform: scale(1); opacity: 0.3; }
        50% { transform: scale(1.1); opacity: 0.5; }
    }

    /* Balance display */
    .balance-display {
        font-family: 'Orbitron', monospace;
        font-size: clamp(2.8rem, 10vw, 5rem);
        font-weight: 800;
        letter-spacing: -0.02em;
        line-height: 1;
        position: relative;
        display: inline-block;
    }

    .balance-display .value {
        background: linear-gradient(135deg, var(--neon-green) 0%, #00ff88 50%, var(--neon-cyan) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: none;
        filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.5));
        animation: balancePulse 4s ease-in-out infinite;
    }

    @keyframes balancePulse {
        0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.5)); }
        50% { filter: drop-shadow(0 0 40px rgba(0, 255, 136, 0.8)); }
    }

    /* Profit indicator with animation */
    .profit-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 100px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .profit-indicator.positive {
        background: rgba(0, 255, 136, 0.1);
        color: var(--neon-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
    }

    .profit-indicator.negative {
        background: rgba(255, 0, 85, 0.1);
        color: var(--neon-red);
        border: 1px solid rgba(255, 0, 85, 0.3);
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.2);
    }

    /* Flash animation for profit changes */
    @keyframes profitFlash {
        0% { transform: scale(1); }
        25% { transform: scale(1.15); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .profit-flash {
        animation: profitFlash 0.5s ease-out;
    }

    /* Glow pulse for positive profits */
    @keyframes glowPulse {
        0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }
        50% { box-shadow: 0 0 40px rgba(0, 255, 136, 0.5), 0 0 60px rgba(0, 255, 136, 0.3); }
    }

    .profit-glow {
        animation: glowPulse 1s ease-out;
    }

    /* ============= STAT CARDS ============= */
    .stat-card-cyber {
        background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95));
        border: 1px solid rgba(0, 255, 136, 0.1);
        border-radius: 12px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card-cyber:hover {
        border-color: rgba(0, 255, 136, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 255, 136, 0.1);
    }

    .stat-card-cyber .stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        margin-bottom: 12px;
    }

    .stat-card-cyber .stat-icon.green {
        background: rgba(0, 255, 136, 0.1);
        color: var(--neon-green);
        border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .stat-card-cyber .stat-icon.red {
        background: rgba(255, 0, 85, 0.1);
        color: var(--neon-red);
        border: 1px solid rgba(255, 0, 85, 0.2);
    }

    .stat-card-cyber .stat-icon.cyan {
        background: rgba(0, 240, 255, 0.1);
        color: var(--neon-cyan);
        border: 1px solid rgba(0, 240, 255, 0.2);
    }

    .stat-card-cyber .stat-icon.yellow {
        background: rgba(255, 238, 0, 0.1);
        color: var(--neon-yellow);
        border: 1px solid rgba(255, 238, 0, 0.2);
    }

    .stat-card-cyber .stat-label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 4px;
    }

    .stat-card-cyber .stat-value {
        font-family: 'Orbitron', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
    }

    /* ============= CHART CONTAINER ============= */
    .chart-terminal {
        background: linear-gradient(135deg, rgba(10, 10, 15, 0.98), rgba(18, 18, 26, 0.95));
        border: 1px solid rgba(0, 255, 136, 0.15);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
    }

    .chart-terminal .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        background: rgba(0, 0, 0, 0.3);
    }

    .chart-terminal .chart-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--neon-green);
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .chart-terminal .period-selector {
        display: flex;
        gap: 4px;
        background: rgba(0, 0, 0, 0.4);
        padding: 4px;
        border-radius: 8px;
    }

    .chart-terminal .period-btn {
        padding: 6px 14px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .chart-terminal .period-btn:hover {
        color: var(--neon-green);
    }

    .chart-terminal .period-btn.active {
        background: rgba(0, 255, 136, 0.15);
        color: var(--neon-green);
    }

    .chart-container {
        height: 300px;
        padding: 0;
    }

    /* ============= POSITIONS PANEL ============= */
    .positions-panel {
        background: linear-gradient(135deg, rgba(10, 10, 15, 0.98), rgba(18, 18, 26, 0.95));
        border: 1px solid rgba(0, 255, 136, 0.15);
        border-radius: 16px;
        overflow: hidden;
    }

    .positions-panel .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        background: rgba(0, 0, 0, 0.3);
    }

    .positions-panel .panel-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
    }

    .positions-panel .live-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 100px;
        font-size: 0.7rem;
        color: var(--neon-green);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .positions-panel .live-badge .pulse-dot {
        width: 6px;
        height: 6px;
        background: var(--neon-green);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }

    .positions-list {
        padding: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Position card */
    .position-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }

    .position-card:hover {
        border-color: rgba(0, 255, 136, 0.2);
        background: rgba(0, 255, 136, 0.02);
    }

    .position-card:last-child {
        margin-bottom: 0;
    }

    .position-card .position-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .position-card .side-badge {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .position-card .side-badge.long {
        background: rgba(0, 255, 136, 0.1);
        color: var(--neon-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .position-card .side-badge.short {
        background: rgba(255, 0, 85, 0.1);
        color: var(--neon-red);
        border: 1px solid rgba(255, 0, 85, 0.3);
    }

    .position-card .symbol {
        font-family: 'Orbitron', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
    }

    .position-card .details {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .position-card .pnl {
        text-align: right;
    }

    .position-card .pnl-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.1rem;
        font-weight: 700;
    }

    .position-card .pnl-value.positive { color: var(--neon-green); }
    .position-card .pnl-value.negative { color: var(--neon-red); }

    .position-card .entry-price {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
    }

    /* Empty state */
    .empty-positions {
        padding: 48px 24px;
        text-align: center;
    }

    .empty-positions .icon {
        font-size: 3rem;
        opacity: 0.2;
        margin-bottom: 16px;
    }

    .empty-positions .text {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.9rem;
    }

    /* ============= TRADE HISTORY ============= */
    .history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        margin-bottom: 6px;
        transition: all 0.2s ease;
    }

    .history-item:hover {
        background: rgba(0, 255, 136, 0.02);
        border-color: rgba(0, 255, 136, 0.1);
    }

    .history-item .side-tag {
        padding: 4px 10px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .history-item .side-tag.long {
        background: rgba(0, 255, 136, 0.15);
        color: var(--neon-green);
    }

    .history-item .side-tag.short {
        background: rgba(255, 0, 85, 0.15);
        color: var(--neon-red);
    }

    /* ============= EXCHANGE CARDS ============= */
    .exchange-card-cyber {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 18px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .exchange-card-cyber:hover {
        border-color: rgba(0, 255, 136, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    .exchange-card-cyber .exchange-logo {
        width: 48px;
        height: 48px;
        background: rgba(255, 238, 0, 0.1);
        border: 1px solid rgba(255, 238, 0, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--neon-yellow);
        font-size: 1.2rem;
    }

    .exchange-card-cyber .status-pill {
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .exchange-card-cyber .status-pill.pending {
        background: rgba(255, 238, 0, 0.1);
        color: var(--neon-yellow);
        border: 1px solid rgba(255, 238, 0, 0.3);
    }

    .exchange-card-cyber .status-pill.approved {
        background: rgba(0, 240, 255, 0.1);
        color: var(--neon-cyan);
        border: 1px solid rgba(0, 240, 255, 0.3);
    }

    .exchange-card-cyber .status-pill.trading {
        background: rgba(0, 255, 136, 0.1);
        color: var(--neon-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }

    /* ============= PANIC BUTTON ============= */
    .panic-button {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 24px;
        background: linear-gradient(135deg, var(--neon-red), #ff0066);
        border: none;
        border-radius: 10px;
        color: #fff;
        font-family: 'Orbitron', monospace;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 0 30px rgba(255, 0, 85, 0.3);
    }

    .panic-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 50px rgba(255, 0, 85, 0.5);
    }

    /* ============= PROGRESS RING ============= */
    .target-ring {
        position: relative;
        width: 90px;
        height: 90px;
    }

    .target-ring svg {
        transform: rotate(-90deg);
    }

    .target-ring .ring-bg {
        fill: none;
        stroke: rgba(0, 255, 136, 0.1);
        stroke-width: 6;
    }

    .target-ring .ring-progress {
        fill: none;
        stroke: url(#ringGradient);
        stroke-width: 6;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.8s ease;
    }

    .target-ring .ring-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Orbitron', monospace;
        font-size: 1rem;
        font-weight: 700;
        color: var(--neon-green);
    }

    /* ============= USER AVATAR ============= */
    .user-avatar-xl {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 240, 255, 0.1));
        border: 2px solid var(--neon-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 40px rgba(0, 255, 136, 0.2);
    }

    .user-avatar-xl img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ============= MODAL STYLES ============= */
    .modal-cyber {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(12px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 500;
        padding: 20px;
    }

    .modal-cyber.active {
        display: flex;
    }

    .modal-cyber .modal-content {
        width: 100%;
        max-width: 450px;
        background: linear-gradient(135deg, rgba(18, 18, 26, 0.98), rgba(10, 10, 15, 0.98));
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 16px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8), 0 0 60px rgba(0, 255, 136, 0.1);
        animation: modalSlide 0.3s ease;
        overflow: hidden;
    }

    @keyframes modalSlide {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-cyber .modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        background: rgba(0, 0, 0, 0.4);
        border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    }

    .modal-cyber .modal-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--neon-green);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-cyber .modal-body {
        padding: 24px;
    }

    .modal-cyber .modal-close {
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .modal-cyber .modal-close:hover {
        background: rgba(255, 0, 85, 0.1);
        border-color: rgba(255, 0, 85, 0.3);
        color: var(--neon-red);
    }

    /* ============= INPUTS ============= */
    .input-cyber {
        width: 100%;
        padding: 14px 18px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(0, 255, 136, 0.15);
        border-radius: 10px;
        color: #fff;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .input-cyber:focus {
        outline: none;
        border-color: var(--neon-green);
        box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
    }

    .input-cyber::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    /* ============= BUTTONS ============= */
    .btn-cyber {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--neon-green) 0%, #00cc6a 100%);
        border: none;
        border-radius: 10px;
        color: #000;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    .btn-cyber:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 40px rgba(0, 255, 136, 0.5);
    }

    .btn-cyber-outline {
        background: transparent;
        border: 1px solid rgba(0, 255, 136, 0.3);
        color: var(--neon-green);
        box-shadow: none;
    }

    .btn-cyber-outline:hover {
        background: rgba(0, 255, 136, 0.1);
        border-color: var(--neon-green);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
    }

    .btn-cyber-sm {
        padding: 8px 16px;
        font-size: 0.75rem;
    }

    /* ============= HTMX LOADING INDICATOR ============= */
    .htmx-indicator {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .htmx-request .htmx-indicator {
        opacity: 1;
    }

    /* ============= SCROLLBAR ============= */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(0, 255, 136, 0.3);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 255, 136, 0.5);
    }

    /* ============= SECTION CARDS ============= */
    .section-card {
        background: linear-gradient(135deg, rgba(10, 10, 15, 0.98), rgba(18, 18, 26, 0.95));
        border: 1px solid rgba(0, 255, 136, 0.1);
        border-radius: 16px;
        overflow: hidden;
    }

    .section-card .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0, 255, 136, 0.08);
        background: rgba(0, 0, 0, 0.3);
    }

    .section-card .section-body {
        padding: 20px;
    }

    /* Quick stats in header */
    .quick-stats {
        display: flex;
        gap: 24px;
        margin-left: auto;
    }

    .quick-stat {
        text-align: center;
    }

    .quick-stat .label {
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .quick-stat .value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Scanlines overlay -->
<div class="terminal-scanlines"></div>
<div class="terminal-grid"></div>

<!-- ==================== OVERVIEW SECTION ==================== -->
<div class="section-content active" data-section="overview" id="overview">
    <!-- Hero Terminal Card -->
    <div class="hero-terminal mb-8">
        <div class="cyber-orb"></div>
        <div class="flex flex-col lg:flex-row items-center gap-8" style="position: relative; z-index: 1;">
            <!-- Avatar -->
            <div class="user-avatar-xl flex-shrink-0">
                {% if user_settings.avatar_type == 'image' and user_settings.avatar %}
                <img src="{{ url_for('static', filename='avatars/' + user_settings.avatar) }}" alt="Avatar">
                {% else %}
                <span>{{ user_settings.avatar or 'üßë‚Äçüíª' }}</span>
                {% endif %}
            </div>
            
            <!-- Balance Section -->
            <div class="flex-grow text-center lg:text-left">
                <div class="flex flex-wrap items-center justify-center lg:justify-start gap-3 mb-3">
                    <h1 class="font-display text-xl font-semibold text-white">{{ username }}</h1>
                    {% if is_active %}
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold bg-green-500/10 text-green-400 border border-green-500/30">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span data-i18n="dash.active">ACTIVE</span>
                    </span>
                    {% else %}
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-500/10 text-yellow-400 border border-yellow-500/30">
                        <i class="fas fa-clock text-xs"></i>
                        <span data-i18n="dash.pending">PENDING</span>
                    </span>
                    {% endif %}
                </div>
                
                <div class="balance-display mb-4">
                    <span class="value" id="balance-display">$<span id="balance-value">{{ balance }}</span></span>
                </div>
                
                <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4">
                    <div class="profit-indicator positive" id="profit-indicator">
                        <i class="fas fa-arrow-trend-up"></i>
                        <span id="profit-display">+$0.00</span>
                        <span id="profit-percent">(0.0%)</span>
                    </div>
                    <div class="text-xs text-white/40">
                        <span data-i18n="dash.todaysProfit">Today's P&L</span>
                    </div>
                </div>
            </div>
            
            <!-- Target Progress Ring -->
            <div class="target-ring flex-shrink-0">
                <svg viewBox="0 0 90 90">
                    <defs>
                        <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00ff88"/>
                            <stop offset="100%" style="stop-color:#00f0ff"/>
                        </linearGradient>
                    </defs>
                    <circle class="ring-bg" cx="45" cy="45" r="38"/>
                    <circle class="ring-progress" id="progress-ring" cx="45" cy="45" r="38" 
                            stroke-dasharray="238.76" stroke-dashoffset="238.76"/>
                </svg>
                <div class="ring-text">
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            
            <!-- Panic Button -->
            <a href="{{ url_for('user_panic') }}" onclick="return confirm('‚ö†Ô∏è –ê–í–ê–†–Ü–Ø: –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ –ø–æ–∑–∏—Ü—ñ—ó –Ω–µ–≥–∞–π–Ω–æ?')" class="panic-button flex-shrink-0">
                <i class="fas fa-power-off"></i>
                <span data-i18n="dash.emergencyExit">EXIT ALL</span>
            </a>
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="stat-card-cyber">
            <div class="stat-icon cyan"><i class="fas fa-bullseye"></i></div>
            <div class="stat-label">Target</div>
            <div class="stat-value">$<span id="target-value">{{ target }}</span></div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon yellow"><i class="fas fa-percentage"></i></div>
            <div class="stat-label">Risk</div>
            <div class="stat-value">{% if user_settings.custom_risk > 0 %}{{ user_settings.custom_risk }}%{% else %}AUTO{% endif %}</div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon red"><i class="fas fa-bolt"></i></div>
            <div class="stat-label">Leverage</div>
            <div class="stat-value">{% if user_settings.custom_leverage > 0 %}x{{ user_settings.custom_leverage }}{% else %}AUTO{% endif %}</div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon green"><i class="fas fa-exchange-alt"></i></div>
            <div class="stat-label">Total Trades</div>
            <div class="stat-value">{{ history|length }}</div>
        </div>
    </div>
    
    <!-- Safety Pool / Insurance Fund Badge -->
    <div id="safety-pool-badge" class="mb-8 p-4 rounded-xl border transition-all duration-300" 
         style="background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95)); border-color: rgba(57, 255, 20, 0.2);">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" 
                     style="background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3);">
                    <i class="fas fa-shield-alt text-xl" style="color: #39ff14;"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-white/50 uppercase tracking-wider">Insurance Fund</span>
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                              style="background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid rgba(57, 255, 20, 0.3);">
                            <i class="fas fa-check-circle text-xs"></i>
                            <span>Verified</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-4 mt-2">
                        <div class="font-display text-2xl font-bold" id="dashboard-safety-pool" style="color: #39ff14;">$10,000.00</div>
                        <div class="text-xs text-white/40">Safety Pool</div>
                    </div>
                </div>
            </div>
            <div class="text-right hidden md:block">
                <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg cursor-help" 
                     style="background: rgba(57, 255, 20, 0.05); border: 1px solid rgba(57, 255, 20, 0.1);"
                     title="This fund is used to cover slippage losses in extreme market conditions">
                    <i class="fas fa-info-circle text-green-400 text-sm"></i>
                    <div class="text-xs text-white/50">
                        <span>5% of platform fees</span><br>
                        <span>go to this Safety Pool</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile tooltip -->
        <div class="mt-3 pt-3 border-t border-white/5 md:hidden">
            <div class="flex items-start gap-2 text-xs text-white/40">
                <i class="fas fa-info-circle text-green-400 mt-0.5"></i>
                <span>This fund is used to cover slippage losses in extreme market conditions. 5% of platform fees go to this Safety Pool.</span>
            </div>
        </div>
    </div>
    
    <!-- Gamification: Level & Badges -->
    <div id="gamification-panel" class="mb-8 p-4 rounded-xl border transition-all duration-300" 
         style="background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95)); border-color: rgba(147, 51, 234, 0.2);">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <!-- Level Info -->
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl flex items-center justify-center" 
                     id="level-icon-container"
                     style="background: rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.3);">
                    <i class="fas fa-seedling text-2xl" id="level-icon" style="color: #888888;"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-white/50 uppercase tracking-wider">Trader Level</span>
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                              id="level-badge"
                              style="background: rgba(147, 51, 234, 0.1); color: #9333ea; border: 1px solid rgba(147, 51, 234, 0.3);">
                            <span id="level-name">Novice</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-3 mt-2">
                        <div class="font-display text-lg font-bold text-white">
                            <span id="user-xp">0</span> <span class="text-sm text-white/50">XP</span>
                        </div>
                        <div class="text-xs text-white/40" id="xp-to-next">--</div>
                    </div>
                </div>
            </div>
            
            <!-- XP Progress Bar -->
            <div class="flex-1 max-w-md">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs text-white/50" id="current-level-label">Novice</span>
                    <span class="text-xs text-white/50" id="next-level-label">Amateur</span>
                </div>
                <div class="h-3 rounded-full overflow-hidden" style="background: rgba(255,255,255,0.1);">
                    <div id="xp-progress-bar" class="h-full rounded-full transition-all duration-500" 
                         style="width: 0%; background: linear-gradient(90deg, #9333ea 0%, #c084fc 100%);"></div>
                </div>
                <div class="text-xs text-white/40 mt-1 text-center" id="progress-text">0% to next level</div>
            </div>
            
            <!-- Commission Discount -->
            <div class="text-center lg:text-right">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl" 
                     id="discount-badge"
                     style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
                    <i class="fas fa-tag text-green-400"></i>
                    <div>
                        <div class="text-xs text-green-300 font-medium">Commission Discount</div>
                        <div class="text-lg text-green-400 font-bold" id="discount-percent">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Unlocked Badges -->
        <div class="mt-4 pt-4 border-t border-white/5">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <i class="fas fa-trophy text-yellow-400"></i>
                    <span class="text-sm text-white/70 font-medium">Achievements</span>
                    <span class="text-xs text-white/40" id="badge-count">(0 unlocked)</span>
                </div>
                <button onclick="showAllAchievements()" 
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-300 group"
                        style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(59, 130, 246, 0.2)); border: 1px solid rgba(147, 51, 234, 0.4); color: #c084fc;">
                    <i class="fas fa-medal group-hover:scale-110 transition-transform"></i>
                    <span>All</span>
                    <i class="fas fa-chevron-right text-xs opacity-60 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
            <div id="badges-container" class="flex flex-wrap gap-2">
                <div class="text-xs text-white/30 italic">Complete trades to unlock achievements!</div>
            </div>
        </div>
    </div>

    <!-- Referral Program Panel -->
    <div id="referral-panel" class="mb-8 p-4 rounded-xl border transition-all duration-300" 
         style="background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95)); border-color: rgba(251, 146, 60, 0.2);">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <!-- Referral Info -->
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl flex items-center justify-center" 
                     style="background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3);">
                    <i class="fas fa-user-plus text-2xl" style="color: #fb923c;"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-white/50 uppercase tracking-wider">Referral Program</span>
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                              style="background: rgba(251, 146, 60, 0.1); color: #fb923c; border: 1px solid rgba(251, 146, 60, 0.3);">
                            <i class="fas fa-gift text-xs"></i>
                            <span>Earn 5%</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-3 mt-2">
                        <div class="font-display text-lg font-bold text-white">
                            <span id="referral-count">{{ referral_stats.referral_count }}</span> <span class="text-sm text-white/50">Referrals</span>
                        </div>
                        <div class="text-white/40">|</div>
                        <div class="font-display text-lg font-bold" style="color: #22c55e;">
                            $<span id="referral-earned">{{ "%.2f"|format(referral_stats.total_commission) }}</span> <span class="text-sm text-white/50">Earned</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Referral Link -->
            <div class="flex-1 max-w-lg">
                <label class="text-xs text-white/50 mb-1 block">Your Referral Link</label>
                <div class="flex items-center gap-2">
                    <div class="flex-1 px-3 py-2 rounded-lg text-sm font-mono truncate"
                         style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fb923c;">
                        <span id="referral-link">{{ referral_link }}</span>
                    </div>
                    <button onclick="copyReferralLink()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all"
                            style="background: rgba(251, 146, 60, 0.2); color: #fb923c; border: 1px solid rgba(251, 146, 60, 0.3);"
                            onmouseover="this.style.background='rgba(251, 146, 60, 0.3)'"
                            onmouseout="this.style.background='rgba(251, 146, 60, 0.2)'">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                </div>
                <div class="text-xs text-white/40 mt-1">
                    Share this link and earn 5% commission from your referrals' trading profits!
                </div>
            </div>
            
            <!-- Pending Payout -->
            <div class="text-center lg:text-right">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl" 
                     style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
                    <i class="fas fa-wallet text-green-400"></i>
                    <div>
                        <div class="text-xs text-green-300 font-medium">Pending Payout</div>
                        <div class="text-lg text-green-400 font-bold">$<span id="referral-pending">{{ "%.2f"|format(referral_stats.pending_commission) }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Status Panel -->
    <div id="subscription-panel" class="mb-8 p-4 rounded-xl border transition-all duration-300" 
         style="background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95)); border-color: rgba(59, 130, 246, 0.2);">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <!-- Subscription Info -->
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl flex items-center justify-center" 
                     id="subscription-icon"
                     style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <i class="fas fa-crown text-2xl" style="color: #3b82f6;"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-white/50 uppercase tracking-wider">Subscription</span>
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                              id="subscription-badge"
                              style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <span id="subscription-plan">{{ user_settings.subscription_plan|default('Free')|capitalize }}</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-3 mt-2">
                        {% if user_settings.subscription_expires_at %}
                        <div class="text-sm text-white/70">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            Expires: <span id="subscription-expires">{{ user_settings.subscription_expires_at.strftime('%d %b %Y') }}</span>
                        </div>
                        {% else %}
                        <div class="text-sm text-white/50">
                            <i class="fas fa-info-circle mr-1"></i>
                            Upgrade to unlock premium features
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Features -->
            <div class="flex flex-wrap gap-2">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs"
                      style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                    <i class="fas fa-check"></i> Copy Trading
                </span>
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs"
                      id="feature-api"
                      style="background: rgba(255, 255, 255, 0.05); color: rgba(255,255,255,0.3);">
                    <i class="fas fa-lock"></i> API Access
                </span>
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs"
                      id="feature-chat"
                      style="background: rgba(255, 255, 255, 0.05); color: rgba(255,255,255,0.3);">
                    <i class="fas fa-lock"></i> Live Chat
                </span>
            </div>
            
            <!-- Upgrade Button -->
            <div>
                {% if user_settings.subscription_plan == 'free' or not user_settings.subscription_plan %}
                <button onclick="showUpgradeModal()" class="px-6 py-2 rounded-lg text-sm font-semibold transition-all"
                        style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(59, 130, 246, 0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <i class="fas fa-rocket mr-1"></i> Upgrade
                </button>
                {% else %}
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl" 
                     style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
                    <i class="fas fa-star text-purple-400"></i>
                    <span class="text-sm text-purple-400 font-semibold">Premium Active</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Links: Polls -->
    <div class="grid grid-cols-1 md:grid-cols-1 gap-4 mb-8">
        <!-- Polls Card -->
        <a href="{{ url_for('polls_page') }}" class="block p-4 rounded-xl border transition-all duration-300 hover:scale-[1.02]" 
           style="background: linear-gradient(135deg, rgba(18, 18, 26, 0.9), rgba(12, 12, 18, 0.95)); border-color: rgba(168, 85, 247, 0.2);">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" 
                     style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3);">
                    <i class="fas fa-vote-yea text-xl" style="color: #a855f7;"></i>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-semibold text-white">Polls</div>
                    <div class="text-xs text-white/50">Vote on proposals & changes</div>
                </div>
                <i class="fas fa-chevron-right text-white/30"></i>
            </div>
        </a>
    </div>

    <!-- Payment Management Menu -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="font-display font-semibold flex items-center gap-2">
                <i class="fas fa-credit-card text-purple-400"></i>
                <span>Payment Management</span>
            </h2>
            <span class="text-xs text-white/40">Subscription & billing</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button type="button" onclick="openSectionAndScroll('subscription', 'subscription-status-card')" 
                    class="block p-4 rounded-xl border transition-all duration-300 hover:scale-[1.02] text-left"
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(37, 99, 235, 0.08)); border-color: rgba(59, 130, 246, 0.2);">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" 
                         style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3);">
                        <i class="fas fa-crown text-xl" style="color: #60a5fa;"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-white">Subscription</div>
                        <div class="text-xs text-white/50">Status & access</div>
                    </div>
                    <i class="fas fa-chevron-right text-white/30"></i>
                </div>
            </button>
            <button type="button" onclick="openSectionAndScroll('subscription', 'upgrade-section')" 
                    class="block p-4 rounded-xl border transition-all duration-300 hover:scale-[1.02] text-left"
                    style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(99, 102, 241, 0.08)); border-color: rgba(139, 92, 246, 0.2);">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" 
                         style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3);">
                        <i class="fas fa-wallet text-xl" style="color: #a78bfa;"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-white">Make a Payment</div>
                        <div class="text-xs text-white/50">Upgrade your plan</div>
                    </div>
                    <i class="fas fa-chevron-right text-white/30"></i>
                </div>
            </button>
            <button type="button" onclick="openSectionAndScroll('subscription', 'payment-history-section')" 
                    class="block p-4 rounded-xl border transition-all duration-300 hover:scale-[1.02] text-left"
                    style="background: linear-gradient(135deg, rgba(34, 211, 238, 0.12), rgba(14, 165, 233, 0.08)); border-color: rgba(34, 211, 238, 0.2);">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" 
                         style="background: rgba(34, 211, 238, 0.15); border: 1px solid rgba(34, 211, 238, 0.3);">
                        <i class="fas fa-history text-xl" style="color: #22d3ee;"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-white">Payment History</div>
                        <div class="text-xs text-white/50">Track your payments</div>
                    </div>
                    <i class="fas fa-chevron-right text-white/30"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- Open Positions Panel with HTMX polling -->
    <div class="positions-panel">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-layer-group text-green-400"></i>
                <span data-i18n="dash.openPositions">Open Positions</span>
                <span id="positions-count" class="ml-2 px-2 py-0.5 text-xs font-bold bg-green-500/20 text-green-400 rounded-full">0</span>
            </div>
            <div class="live-badge">
                <span class="pulse-dot"></span>
                <span>LIVE</span>
            </div>
        </div>
        
        <!-- HTMX polling container - updates every 2 seconds -->
        <div id="positions-container" 
             class="positions-list"
             hx-get="/api/positions"
             hx-trigger="load, every 5s, refresh"
             hx-swap="innerHTML">
            <div class="empty-positions">
                <div class="icon"><i class="fas fa-satellite-dish"></i></div>
                <div class="text" data-i18n="dash.scanningPositions">Scanning for positions...</div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TRADING/ANALYTICS SECTION ==================== -->
<div class="section-content" data-section="trading" id="trading">
    <!-- TradingView Chart -->
    <div class="chart-terminal mb-8">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                <span data-i18n="dash.balanceChart">EQUITY CURVE</span>
            </div>
            <div class="period-selector">
                <button onclick="setChartPeriod('24h')" class="period-btn active" data-period="24h">24H</button>
                <button onclick="setChartPeriod('week')" class="period-btn" data-period="week">7D</button>
                <button onclick="setChartPeriod('month')" class="period-btn" data-period="month">30D</button>
                <button onclick="setChartPeriod('year')" class="period-btn" data-period="year">1Y</button>
            </div>
        </div>
        <div class="chart-container" id="tv-chart-container"></div>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="stat-card-cyber">
            <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-label" data-i18n="dash.periodPnl">Period P&L</div>
            <div class="stat-value text-green-400" id="stats-pnl">+$0</div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon cyan"><i class="fas fa-chart-bar"></i></div>
            <div class="stat-label" data-i18n="dash.trades">Trades</div>
            <div class="stat-value text-cyan-400" id="stats-trades">0</div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon yellow"><i class="fas fa-trophy"></i></div>
            <div class="stat-label" data-i18n="dash.winRate">Win Rate</div>
            <div class="stat-value text-yellow-400" id="stats-winrate">0%</div>
        </div>
        <div class="stat-card-cyber">
            <div class="stat-icon red"><i class="fas fa-percent"></i></div>
            <div class="stat-label" data-i18n="dash.avgRoi">Avg ROI</div>
            <div class="stat-value" id="stats-avgroi">0%</div>
        </div>
    </div>

    <!-- Trade History -->
    <div class="section-card">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-history text-pink-400"></i>
                <span class="font-display font-semibold" data-i18n="dash.tradeHistory">Trade History</span>
            </div>
            <span class="text-xs text-white/40">{{ history|length }} trades</span>
        </div>
        <div class="section-body max-h-96 overflow-y-auto" id="history-container">
            {% for trade in history %}
            <div class="history-item">
                <div class="flex items-center gap-3">
                    <span class="side-tag {{ 'long' if trade.side == 'LONG' else 'short' }}">{{ trade.side }}</span>
                    <span class="font-display font-semibold text-white">{{ trade.symbol }}</span>
                </div>
                <div class="text-right">
                    <span class="font-mono font-bold {{ 'text-green-400' if trade.pnl >= 0 else 'text-red-400' }}">
                        {{ '+' if trade.pnl >= 0 else '' }}{{ "%.2f"|format(trade.pnl) }}$
                    </span>
                    <span class="text-xs text-white/40 ml-2">({{ "%.1f"|format(trade.roi) }}%)</span>
                </div>
            </div>
            {% else %}
            <div class="empty-positions">
                <div class="icon"><i class="fas fa-chart-line"></i></div>
                <div class="text" data-i18n="dash.noHistory">No trade history yet</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ==================== EXCHANGE/CONNECTIONS SECTION ==================== -->
<div class="section-content" data-section="trading" id="exchange">
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-link text-yellow-400"></i>
                <span class="font-display font-semibold" data-i18n="dash.connectedExchanges">Connected Exchanges</span>
            </div>
            <button onclick="openAddExchangeModal()" class="btn-cyber btn-cyber-sm">
                <i class="fas fa-plus"></i>
                <span>Add</span>
            </button>
        </div>
        <div class="section-body" id="exchanges-container">
            <div class="empty-positions" id="exchanges-loading">
                <div class="icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="text" data-i18n="dash.loadingConnections">Loading connections...</div>
            </div>
        </div>
    </div>
    
    <!-- Telegram Section -->
    <div class="section-card">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fab fa-telegram" style="color: #0088cc;"></i>
                <span class="font-display font-semibold" data-i18n="dash.telegramNotifications">Telegram</span>
            </div>
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold {{ 'bg-green-500/10 text-green-400' if user_settings.telegram_enabled else 'bg-yellow-500/10 text-yellow-400' }}">
                {% if user_settings.telegram_enabled %}‚úì ON{% else %}‚óã OFF{% endif %}
            </span>
        </div>
        <div class="section-body">
            <!-- Connection Instructions -->
            {% if not user_settings.telegram_enabled %}
            <div class="mb-5 p-5 rounded-xl" style="background: linear-gradient(135deg, rgba(0, 136, 204, 0.08), rgba(0, 136, 204, 0.02)); border: 1px solid rgba(0, 136, 204, 0.25);">
                <p class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-400"></i>
                    <span data-i18n="dash.telegramHowToConnect">How to connect Telegram:</span>
                </p>
                <div class="space-y-3">
                    <!-- Step 1: Open Bot -->
                    <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold" style="background: rgba(0, 136, 204, 0.2); color: #0088cc;">1</div>
                        <div class="flex-1">
                            <p class="text-sm text-white/80" data-i18n="dash.telegramStep1">Open our bot and press START:</p>
                            {% if telegram_bot_username %}
                            <a href="https://t.me/{{ telegram_bot_username }}" target="_blank" rel="noopener noreferrer"
                               class="inline-flex items-center gap-2 mt-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all"
                               style="background: linear-gradient(135deg, rgba(0, 136, 204, 0.2), rgba(0, 136, 204, 0.1)); border: 1px solid rgba(0, 136, 204, 0.4); color: #0088cc;">
                                <i class="fab fa-telegram"></i>
                                <span>@{{ telegram_bot_username }}</span>
                                <i class="fas fa-external-link-alt text-xs opacity-60"></i>
                            </a>
                            {% else %}
                            <p class="text-xs text-yellow-400 mt-1"><i class="fas fa-exclamation-triangle"></i> Bot not configured. Contact administrator.</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Step 2: Get Chat ID -->
                    <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold" style="background: rgba(0, 136, 204, 0.2); color: #0088cc;">2</div>
                        <div class="flex-1">
                            <p class="text-sm text-white/80" data-i18n="dash.telegramStep2">Get your Chat ID:</p>
                            <a href="https://t.me/userinfobot" target="_blank" rel="noopener noreferrer"
                               class="inline-flex items-center gap-2 mt-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all"
                               style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(147, 51, 234, 0.1)); border: 1px solid rgba(147, 51, 234, 0.4); color: #c084fc;">
                                <i class="fas fa-id-card"></i>
                                <span>@userinfobot</span>
                                <i class="fas fa-external-link-alt text-xs opacity-60"></i>
                            </a>
                            <p class="text-xs text-white/50 mt-2" data-i18n="dash.telegramStep2Hint">Send /start to this bot and it will show your ID</p>
                        </div>
                    </div>
                    
                    <!-- Step 3: Enter ID -->
                    <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold" style="background: rgba(0, 136, 204, 0.2); color: #0088cc;">3</div>
                        <div class="flex-1">
                            <p class="text-sm text-white/80" data-i18n="dash.telegramStep3">Enter your Chat ID below and enable notifications</p>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Already connected - show bot link for reference -->
            <div class="mb-4 p-4 rounded-lg flex items-center justify-between" style="background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.25);">
                <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-green-400"></i>
                    <span class="text-sm text-green-400 font-medium" data-i18n="dash.telegramConnected">Telegram connected successfully!</span>
                </div>
                {% if telegram_bot_username %}
                <a href="https://t.me/{{ telegram_bot_username }}" target="_blank" rel="noopener noreferrer"
                   class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                    <i class="fab fa-telegram"></i> @{{ telegram_bot_username }}
                </a>
                {% endif %}
            </div>
            {% endif %}
            
            <form method="POST" action="{{ url_for('update_telegram') }}" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <label class="text-xs text-white/50 mb-2 block flex items-center gap-2">
                        <i class="fas fa-hashtag"></i>
                        <span data-i18n="dash.yourChatId">Your Chat ID</span>
                    </label>
                    <input type="text" name="telegram_chat_id" value="{{ user_settings.telegram_chat_id or '' }}" 
                           class="input-cyber font-mono" 
                           placeholder="123456789"
                           pattern="[0-9\-]+"
                           title="Chat ID should be numbers only">
                    <p class="text-xs text-white/40 mt-1">
                        <i class="fas fa-question-circle"></i>
                        <span data-i18n="dash.chatIdHelp">Example: 123456789 (numbers only)</span>
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex-1 flex items-center gap-3 p-3 bg-black/30 border border-white/5 rounded-lg cursor-pointer hover:border-green-500/30 transition-all">
                        <input type="checkbox" name="telegram_enabled" {{ 'checked' if user_settings.telegram_enabled else '' }} class="w-5 h-5 accent-green-400">
                        <span class="text-sm text-white/70" data-i18n="dash.enableNotifications">Enable notifications</span>
                    </label>
                    <button type="submit" class="btn-cyber btn-cyber-sm">
                        <i class="fas fa-save"></i>
                        Save
                    </button>
                </div>
            </form>
            
            <!-- Help link -->
            <div class="mt-4 pt-4 border-t border-white/5 flex items-center justify-between">
                <a href="https://t.me/userinfobot" target="_blank" rel="noopener noreferrer"
                   class="text-xs text-white/40 hover:text-cyan-400 transition-colors flex items-center gap-1">
                    <i class="fas fa-question-circle"></i>
                    <span data-i18n="dash.dontKnowChatId">Don't know your Chat ID?</span>
                </a>
                {% if telegram_bot_username %}
                <a href="https://t.me/{{ telegram_bot_username }}" target="_blank" rel="noopener noreferrer"
                   class="text-xs text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1">
                    <i class="fab fa-telegram"></i>
                    <span data-i18n="dash.openBot">Open Bot</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ==================== SUBSCRIPTION SECTION ==================== -->
<div class="section-content" data-section="subscription" id="subscription">
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-crown text-yellow-400"></i>
                <span class="font-display font-semibold">My Subscription</span>
            </div>
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold" id="sub-status-badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <i class="fas fa-circle text-xs"></i>
                <span id="sub-status-text" data-i18n="dash.loadingData">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
            </span>
        </div>
        <div class="section-body">
            <!-- Subscription Status Card -->
            <div id="subscription-status-card" class="mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Current Plan -->
                    <div class="p-5 rounded-xl border transition-all" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-color: rgba(59, 130, 246, 0.2);">
                        <div class="text-xs text-white/50 mb-2 uppercase tracking-wider">Current Plan</div>
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3);">
                                <i class="fas fa-crown text-xl text-blue-400"></i>
                            </div>
                            <div>
                                <div class="font-display font-bold text-xl text-white" id="sub-current-plan">Free</div>
                                <div class="text-xs text-white/50" id="sub-plan-description">Basic access</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expiration -->
                    <div class="p-5 rounded-xl border" style="background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.05);">
                        <div class="text-xs text-white/50 mb-2 uppercase tracking-wider">Expires</div>
                        <div class="font-mono text-2xl font-bold" id="sub-expires-at" style="color: var(--neon-cyan);">Never</div>
                        <div class="text-xs text-white/40 mt-1" id="sub-days-remaining">-</div>
                    </div>
                    
                    <!-- Trading Status -->
                    <div class="p-5 rounded-xl border" style="background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.05);">
                        <div class="text-xs text-white/50 mb-2 uppercase tracking-wider">Trading Status</div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full animate-pulse" id="sub-trading-dot" style="background: var(--neon-green);"></span>
                            <span class="font-display font-bold text-xl" id="sub-trading-status" style="color: var(--neon-green);">ENABLED</span>
                        </div>
                        <div class="text-xs text-white/40 mt-1" id="sub-trading-note">Full access to copy trading</div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Payments Alert -->
            <div id="pending-payments-alert" class="hidden mb-6 p-4 rounded-xl border" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clock text-yellow-400 text-xl"></i>
                    <div class="flex-1">
                        <div class="font-semibold text-yellow-400">Payment Pending Confirmation</div>
                        <div class="text-sm text-white/60" id="pending-payment-details">Your payment is being verified by admin.</div>
                    </div>
                </div>
            </div>
            
            <!-- Free Mode Banner (shown when subscriptions disabled) -->
            <div id="free-mode-banner" class="hidden mb-6 p-4 rounded-xl border" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 240, 255, 0.1)); border-color: rgba(0, 255, 136, 0.3);">
                <div class="flex items-center gap-3">
                    <i class="fas fa-gift text-green-400 text-2xl"></i>
                    <div>
                        <div class="font-display font-bold text-green-400">Free Access Mode</div>
                        <div class="text-sm text-white/60">Paid subscriptions are currently disabled. Enjoy free access to all features!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upgrade/Payment Section -->
    <div class="section-card mb-8" id="upgrade-section">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-rocket text-purple-400"></i>
                <span class="font-display font-semibold">Upgrade Plan</span>
            </div>
        </div>
        <div class="section-body">
            <!-- Available Plans -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="plans-container">
                <!-- Plans will be loaded dynamically -->
                <div class="col-span-3 flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-white/30"></i>
                </div>
            </div>
            
            <!-- Payment Form (shown when plan selected) -->
            <div id="payment-form" class="hidden">
                <div class="p-6 rounded-xl border mb-4" style="background: rgba(139, 92, 246, 0.05); border-color: rgba(139, 92, 246, 0.2);">
                    <h4 class="font-display font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-wallet text-purple-400"></i>
                        <span>Complete Payment</span>
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-white/50 mb-2">Selected Plan</label>
                            <div class="p-3 rounded-lg bg-black/30 border border-white/10">
                                <span id="selected-plan-name" class="font-semibold text-white">-</span>
                                <span id="selected-plan-price" class="ml-2 text-purple-400">$0</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-white/50 mb-2">Payment Method</label>
                            <select id="payment-network" class="w-full p-3 rounded-lg bg-black/30 border border-white/10 text-white focus:border-purple-500 focus:outline-none">
                                <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–µ—Ä–µ–∂...</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Wallet Address Display -->
                    <div id="wallet-display" class="hidden mb-4">
                        <label class="block text-xs text-white/50 mb-2">Payment Details</label>
                        <div class="p-4 rounded-lg bg-black/50 border border-purple-500/30">
                            <div class="flex items-center justify-between">
                                <code class="text-sm text-purple-300 break-all" id="payment-wallet-address">-</code>
                                <button onclick="copyWalletAddress()" class="ml-2 p-2 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 transition-all">
                                    <i class="fas fa-copy text-purple-400"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5"></i>
                                <div class="text-xs text-yellow-200/80" id="payment-help-text">
                                    <strong>Important:</strong> Follow the payment instructions and send exactly <span id="payment-amount-display" class="font-mono text-yellow-400">$0.00</span>.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TX Hash Input -->
                    <div id="tx-hash-section" class="hidden mb-4">
                        <label class="block text-xs text-white/50 mb-2">Payment Reference (Optional)</label>
                        <input type="text" id="tx-hash-input" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å/–ø—Ä–∏–º—ñ—Ç–∫—É –¥–ª—è —à–≤–∏–¥—à–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏" 
                               class="w-full p-3 rounded-lg bg-black/30 border border-white/10 text-white focus:border-purple-500 focus:outline-none font-mono text-sm">
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="btn-create-payment" onclick="createPayment()" 
                                class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2"
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                            <i class="fas fa-qrcode"></i>
                            <span>Get Payment Address</span>
                        </button>
                        <button id="btn-mark-paid" onclick="markAsPaid()" 
                                class="hidden flex-1 py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2"
                                style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <i class="fas fa-check-circle"></i>
                            <span>I've Sent Payment</span>
                        </button>
                        <button onclick="cancelPayment()" 
                                class="py-3 px-6 rounded-xl font-semibold transition-all border border-white/20 text-white/60 hover:text-white hover:border-white/40">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment History -->
    <div class="section-card" id="payment-history-section">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-history text-cyan-400"></i>
                <span class="font-display font-semibold">Payment History</span>
            </div>
        </div>
        <div class="section-body">
            <div id="payment-history-container">
                <div class="text-center py-8 text-white/40">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p data-i18n="dash.loadingData">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø–ª–∞—Ç–µ–∂—ñ–≤...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TASKS/CHALLENGES SECTION ==================== -->
<div class="section-content" data-section="tasks" id="tasks">
    <!-- Tasks Header -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="font-display text-xl font-semibold flex items-center gap-3" style="color: var(--neon-green);">
                <i class="fas fa-trophy"></i>
                <span data-i18n="user.tasksAndChallenges">Tasks & Challenges</span>
            </h1>
            <p class="text-white/50 text-sm mt-1">Complete tasks to earn rewards!</p>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="refreshUserTasks()" class="cyber-btn cyber-btn-outline cyber-btn-sm">
                <i class="fas fa-sync-alt" id="user-tasks-refresh-icon"></i>
                <span>Refresh</span>
            </button>
        </div>
    </div>

    <!-- User Task Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="p-4 bg-black/30 border border-cyan-500/20 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-cyan-500/20">
                    <i class="fas fa-tasks text-cyan-400"></i>
                </div>
                <div>
                    <div class="text-xs text-white/50">Available Tasks</div>
                    <div class="font-mono font-bold text-lg text-cyan-400" id="user-available-tasks">0</div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-black/30 border border-yellow-500/20 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-yellow-500/20">
                    <i class="fas fa-hourglass-half text-yellow-400"></i>
                </div>
                <div>
                    <div class="text-xs text-white/50">In Progress</div>
                    <div class="font-mono font-bold text-lg text-yellow-400" id="user-in-progress-tasks">0</div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-black/30 border border-green-500/20 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-green-500/20">
                    <i class="fas fa-check-circle text-green-400"></i>
                </div>
                <div>
                    <div class="text-xs text-white/50">Completed</div>
                    <div class="font-mono font-bold text-lg text-green-400" id="user-completed-tasks">0</div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-black/30 border border-pink-500/20 rounded-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-pink-500/20">
                    <i class="fas fa-gift text-pink-400"></i>
                </div>
                <div>
                    <div class="text-xs text-white/50">Total Rewards</div>
                    <div class="font-mono font-bold text-lg text-pink-400" id="user-total-rewards">$0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Participations (In Progress / Pending) -->
    <div class="section-card mb-6" id="my-participations-section" style="display: none;">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-clock text-yellow-400"></i>
                <span class="font-display font-semibold">My Active Tasks</span>
                <span class="badge bg-yellow-500/20 text-yellow-400" id="active-tasks-badge">0</span>
            </div>
        </div>
        <div class="section-body">
            <div id="my-participations-list" class="space-y-3">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Available Tasks -->
    <div class="section-card">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-list text-cyan-400"></i>
                <span class="font-display font-semibold">Available Tasks</span>
            </div>
            <div class="flex items-center gap-2">
                <select id="user-task-type-filter" class="input text-sm" style="width: auto; padding: 6px 12px;" onchange="loadUserTasks()">
                    <option value="">All Types</option>
                    <option value="social">Social Media</option>
                    <option value="trading">Trading</option>
                    <option value="referral">Referral</option>
                    <option value="community">Community</option>
                    <option value="custom">Special</option>
                </select>
            </div>
        </div>
        <div class="section-body">
            <div id="available-tasks-list" class="space-y-4">
                <div class="text-center py-8 text-white/40">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p data-i18n="dash.loadingData">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Completed Tasks History -->
    <div class="section-card mt-6">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-history text-green-400"></i>
                <span class="font-display font-semibold">Completed Tasks</span>
            </div>
        </div>
        <div class="section-body">
            <div id="completed-tasks-list" class="space-y-3">
                <div class="text-center py-4 text-white/40">
                    <p data-i18n="dash.noCompletedTasks">–í–∏–∫–æ–Ω–∞–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å —â–µ –Ω–µ–º–∞—î</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details/Submit Modal -->
<div id="taskDetailsModal" class="modal-overlay" onclick="if(event.target===this)closeTaskDetailsModal()" style="display: none;">
    <div class="modal-card" style="max-width: 550px; background: var(--cyber-dark, #0d0d14); border: 1px solid rgba(0, 255, 136, 0.2);">
        <div class="modal-header" style="border-bottom: 1px solid rgba(0, 255, 136, 0.1);">
            <div class="modal-title">
                <i class="fas fa-trophy" id="task-modal-icon" style="color: var(--neon-green);"></i>
                <span id="task-details-title">Task Details</span>
            </div>
            <button onclick="closeTaskDetailsModal()" style="width: 32px; height: 32px; border: none; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; color: rgba(255,255,255,0.5);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="modal-task-id" value="">
            
            <div id="task-details-content">
                <!-- Populated by JS -->
            </div>
            
            <!-- Submission Form (shown when in progress) -->
            <div id="task-submission-form" style="display: none;">
                <div class="mb-4">
                    <label class="text-xs text-white/50 mb-1 block">Proof / Notes (optional)</label>
                    <textarea id="task-submission-text" class="input" rows="3" placeholder="–î–æ–¥–∞–π—Ç–µ –ø—Ä–∏–º—ñ—Ç–∫–∏ –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è"></textarea>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-white/50 mb-1 block">Proof URL (optional)</label>
                    <input type="url" id="task-submission-url" class="input" placeholder="https://...">
                </div>
                <div id="task-payout-section">
                    <div class="mb-4">
                        <label class="text-xs text-white/50 mb-1 block">Reward Method (optional)</label>
                        <select id="task-payout-method" class="input">
                            <option value="">Select method</option>
                            <option value="usdt_trc20">USDT (TRC20)</option>
                            <option value="usdt_erc20">USDT (ERC20)</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="card">Card</option>
                            <option value="gift">Gift</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-white/50 mb-1 block">Reward Details (wallet / IBAN / address)</label>
                        <textarea id="task-payout-details" class="input" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: USDT TRC20 –∞–¥—Ä–µ—Å–∞ –∞–±–æ –±–∞–Ω–∫—ñ–≤—Å—å–∫—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-white/50 mb-1 block">Contact (optional)</label>
                        <input type="text" id="task-payout-contact" class="input" placeholder="Telegram / Email / Phone">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 pt-4 border-t" style="border-color: rgba(255,255,255,0.1);">
                <button onclick="closeTaskDetailsModal()" class="cyber-btn cyber-btn-outline flex-1">
                    Close
                </button>
                <button onclick="handleTaskAction()" class="cyber-btn cyber-btn-success flex-1" id="task-action-btn" style="display: none;">
                    <i class="fas fa-play"></i>
                    <span>Join Task</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SETTINGS/CONFIG SECTION ==================== -->
<div class="section-content" data-section="trading" id="settings">
    <!-- Trading Parameters (Read-only) -->
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-sliders text-pink-400"></i>
                <span class="font-display font-semibold">Trading Config</span>
            </div>
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-cyan-500/10 text-cyan-400">
                <i class="fas fa-lock text-xs"></i> Admin Set
            </span>
        </div>
        <div class="section-body">
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Risk %</div>
                    <div class="font-mono text-xl font-bold text-cyan-400">{{ global_settings.risk_perc }}%</div>
                </div>
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Leverage</div>
                    <div class="font-mono text-xl font-bold text-pink-400">x{{ global_settings.leverage }}</div>
                </div>
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Max Positions</div>
                    <div class="font-mono text-xl font-bold text-yellow-400">{{ global_settings.max_positions }}</div>
                </div>
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Take Profit</div>
                    <div class="font-mono text-xl font-bold text-green-400">{{ global_settings.tp_perc }}%</div>
                </div>
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Stop Loss</div>
                    <div class="font-mono text-xl font-bold text-red-400">{{ global_settings.sl_perc }}%</div>
                </div>
                <div class="p-4 bg-black/30 border border-white/5 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Min Balance</div>
                    <div class="font-mono text-xl font-bold text-white">${{ global_settings.min_balance }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Strategies -->
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-chess-knight text-purple-400"></i>
                <span class="font-display font-semibold">Trading Strategies</span>
            </div>
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold" id="allocation-badge">
                <span id="total-allocation">0</span>% allocated
            </span>
        </div>
        <div class="section-body">
            <p class="text-sm text-white/50 mb-4">Subscribe to trading strategies. Your total allocation must equal 100%.</p>
            
            <!-- Strategy Cards Container -->
            <div id="strategies-container" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-white/30"></i>
                </div>
            </div>
            
            <!-- Allocation Warning -->
            <div id="allocation-warning" class="hidden mt-4 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                <div class="flex items-center gap-2 text-yellow-400 text-sm">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="allocation-warning-text">Total allocation must equal 100%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Target Goal -->
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-bullseye text-cyan-400"></i>
                <span class="font-display font-semibold">Target Goal</span>
            </div>
        </div>
        <div class="section-body">
            <form method="POST" action="{{ url_for('update_target') }}" class="flex gap-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="number" name="target_amount" value="{{ target }}" class="input-cyber flex-1" placeholder="–¶—ñ–ª—å–æ–≤–∞ —Å—É–º–∞" step="100" min="100">
                <button type="submit" class="btn-cyber btn-cyber-sm">
                    <i class="fas fa-save"></i>
                    Set
                </button>
            </form>
        </div>
    </div>
    
    <!-- Avatar -->
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-user-circle text-pink-400"></i>
                <span class="font-display font-semibold">Avatar</span>
            </div>
        </div>
        <div class="section-body">
            <div class="flex items-center gap-6">
                <div class="user-avatar-xl cursor-pointer" onclick="openAvatarModal()">
                    {% if user_settings.avatar_type == 'image' and user_settings.avatar %}
                    <img src="{{ url_for('static', filename='avatars/' + user_settings.avatar) }}" alt="Avatar">
                    {% else %}
                    <span>{{ user_settings.avatar or 'üßë‚Äçüíª' }}</span>
                    {% endif %}
                </div>
                <div>
                    <button onclick="openAvatarModal()" class="btn-cyber btn-cyber-outline btn-cyber-sm mb-2">
                        <i class="fas fa-camera"></i>
                        Change
                    </button>
                    <p class="text-xs text-white/40">Emoji or custom image</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Email -->
    <div class="section-card mb-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-envelope text-purple-400"></i>
                <span class="font-display font-semibold">Email</span>
            </div>
            {% if user_settings.email %}
            <span class="text-xs text-green-400">‚úì Set</span>
            {% else %}
            <span class="text-xs text-yellow-400">Not set</span>
            {% endif %}
        </div>
        <div class="section-body">
            <form method="POST" action="{{ url_for('update_email') }}" class="flex gap-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="email" name="email" value="{{ user_settings.email or '' }}" class="input-cyber flex-1" placeholder="your@email.com">
                <button type="submit" class="btn-cyber btn-cyber-sm">
                    <i class="fas fa-save"></i>
                    Save
                </button>
            </form>
        </div>
    </div>
    
    <!-- Security Link -->
    <a href="{{ url_for('change_password') }}" class="section-card flex items-center gap-4 p-5 hover:border-yellow-500/30 transition-all" style="text-decoration: none;">
        <div class="w-12 h-12 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center text-yellow-400 text-lg">
            <i class="fas fa-key"></i>
        </div>
        <div class="flex-1">
            <div class="font-display font-semibold text-white" data-i18n="auth.changePassword">Change Password</div>
            <div class="text-sm text-white/40" data-i18n="dash.securitySettings">Security settings</div>
        </div>
        <i class="fas fa-chevron-right text-white/30"></i>
    </a>
    
    <!-- Referral Program -->
    <div class="section-card mt-8">
        <div class="section-header">
            <div class="flex items-center gap-3">
                <i class="fas fa-gift text-gradient"></i>
                <span class="font-display font-semibold">Referral Program</span>
            </div>
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-500/10 text-green-400">
                5% Commission
            </span>
        </div>
        <div class="section-body">
            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center p-4 bg-cyan-500/5 border border-cyan-500/10 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Referrals</div>
                    <div class="font-mono text-xl font-bold text-cyan-400">{{ referral_stats.referral_count }}</div>
                </div>
                <div class="text-center p-4 bg-green-500/5 border border-green-500/10 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Earned</div>
                    <div class="font-mono text-xl font-bold text-green-400">${{ "%.2f"|format(referral_stats.total_commission) }}</div>
                </div>
                <div class="text-center p-4 bg-yellow-500/5 border border-yellow-500/10 rounded-lg">
                    <div class="text-xs text-white/40 mb-1">Pending</div>
                    <div class="font-mono text-xl font-bold text-yellow-400">${{ "%.2f"|format(referral_stats.pending_commission) }}</div>
                </div>
            </div>
            
            <!-- Referral Link -->
            <div class="mb-4">
                <label class="text-xs text-white/40 block mb-2">Your Invite Link</label>
                <div class="flex gap-2">
                    <input type="text" value="{{ referral_link }}" id="referral-link-input" class="input-cyber text-sm" readonly>
                    <button onclick="copyReferralLink()" class="btn-cyber btn-cyber-sm" id="copy-referral-btn">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
            
            <!-- Referral Code -->
            <div class="p-4 bg-purple-500/5 border border-purple-500/20 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-white/40 mb-1">Your Code</div>
                        <div class="font-mono text-xl font-bold text-gradient">{{ referral_code }}</div>
                    </div>
                    <div class="text-xs text-white/30 text-right">
                        Earn 5% on referral profits!
                    </div>
                </div>
            </div>
            
            <!-- Influencer Dashboard Link -->
            <div class="mt-4">
                <a href="/influencer" class="btn-cyber w-full text-center">
                    <i class="fas fa-rocket mr-2"></i>
                    Open Influencer Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Add Exchange Modal -->
<div id="addExchangeModal" class="modal-cyber" onclick="if(event.target===this)closeAddExchangeModal()">
    <div class="modal-content">
        <div class="modal-head">
            <div class="modal-title">
                <i class="fas fa-link"></i>
                Add Exchange
            </div>
            <button onclick="closeAddExchangeModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="add-exchange-form" onsubmit="submitAddExchange(event)" class="space-y-4">
                <select id="exchange-select" name="exchange_name" class="input-cyber" required>
                    <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
                </select>
                <input type="text" id="exchange-label" name="label" class="input-cyber" placeholder="–ù–∞–∑–≤–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
                <input type="text" id="exchange-api-key" name="api_key" class="input-cyber" placeholder="API –ö–ª—é—á" required>
                <input type="password" id="exchange-api-secret" name="api_secret" class="input-cyber" placeholder="API –°–µ–∫—Ä–µ—Ç" required autocomplete="off">
                <div id="passphrase-field" class="hidden">
                    <input type="password" id="exchange-passphrase" name="passphrase" class="input-cyber" placeholder="–ü–∞—Ä–æ–ª—å–Ω–∞ —Ñ—Ä–∞–∑–∞" autocomplete="off">
                </div>
                <button type="submit" class="btn-cyber w-full" id="submit-exchange-btn">
                    <i class="fas fa-paper-plane"></i>
                    Submit Request
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Avatar Modal -->
<div id="avatarModal" class="modal-cyber" onclick="if(event.target===this)closeAvatarModal()">
    <div class="modal-content">
        <div class="modal-head">
            <div class="modal-title">
                <i class="fas fa-user-circle"></i>
                Change Avatar
            </div>
            <button onclick="closeAvatarModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="avatar-form" action="{{ url_for('update_avatar') }}" method="POST" enctype="multipart/form-data">
                <div class="mb-4">
                    <label class="text-xs text-white/40 block mb-2">Choose Emoji</label>
                    <div id="user-emoji-grid" class="grid grid-cols-5 gap-2">
                        {% for emoji in ['üßë‚Äçüíª', 'ü§ñ', 'üëΩ', 'ü•∑', 'ü¶∏', 'üßô', 'üëë', 'üöÄ', 'üî•', 'üíé', 'ü¶Å', 'üêØ', 'ü¶ä', 'üê∫', 'ü¶Ñ', 'üêâ', 'üé≠', 'üîÆ', 'üí∞', 'üèÜ'] %}
                        <button type="button" onclick="selectUserEmoji('{{ emoji }}')" class="p-3 bg-black/30 border border-white/10 rounded-lg text-2xl hover:border-green-500/50 transition-all {{ 'border-green-500/50 bg-green-500/10' if user_settings.avatar == emoji else '' }}" data-emoji="{{ emoji }}">
                            {{ emoji }}
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="emoji" id="selected-user-emoji" value="{{ user_settings.avatar or 'üßë‚Äçüíª' }}">
                    <input type="hidden" name="avatar_type" id="user-avatar-type" value="emoji">
                </div>
                
                <div class="mb-4">
                    <label class="text-xs text-white/40 block mb-2">Or Upload Image</label>
                    <input type="file" name="avatar_file" accept="image/png,image/jpeg,image/gif,image/webp" class="input-cyber" onchange="setUserAvatarType('image')">
                    <p class="text-xs text-white/30 mt-1">Max 2MB. PNG, JPG, GIF, WEBP</p>
                </div>
                
                <button type="submit" class="btn-cyber w-full">
                    <i class="fas fa-save"></i>
                    Save Avatar
                </button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // ==================== GLOBALS ====================
    let socket = null;
    let tvChart = null;
    let currentPeriod = '24h';
    let lastBalance = parseFloat('{{ balance }}'.replace(/,/g, '')) || 0;
    let todayStartBalance = lastBalance; // Will be updated from API

    // ==================== TRADINGVIEW LIGHTWEIGHT CHARTS ====================
    function initTVChart() {
        const container = document.getElementById('tv-chart-container');
        if (!container || typeof LightweightCharts === 'undefined') {
            setTimeout(initTVChart, 200);
            return;
        }

        tvChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 300,
            layout: {
                background: { type: 'solid', color: 'transparent' },
                textColor: 'rgba(255, 255, 255, 0.5)',
            },
            grid: {
                vertLines: { color: 'rgba(0, 255, 136, 0.05)' },
                horzLines: { color: 'rgba(0, 255, 136, 0.05)' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: { color: 'rgba(0, 255, 136, 0.3)', width: 1, style: 2 },
                horzLine: { color: 'rgba(0, 255, 136, 0.3)', width: 1, style: 2 },
            },
            rightPriceScale: {
                borderColor: 'rgba(0, 255, 136, 0.1)',
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
                borderColor: 'rgba(0, 255, 136, 0.1)',
                timeVisible: true,
                secondsVisible: false,
            },
            handleScale: { mouseWheel: true, pinch: true },
            handleScroll: { mouseWheel: true, pressedMouseMove: true },
        });

        window.tvAreaSeries = tvChart.addAreaSeries({
            lineColor: '#00ff88',
            topColor: 'rgba(0, 255, 136, 0.4)',
            bottomColor: 'rgba(0, 255, 136, 0.02)',
            lineWidth: 2,
            priceLineVisible: false,
            lastValueVisible: true,
            crosshairMarkerVisible: true,
            crosshairMarkerRadius: 4,
            crosshairMarkerBackgroundColor: '#00ff88',
            crosshairMarkerBorderColor: '#000',
        });

        // Handle resize (throttled)
        const handleResize = window.throttleRaf ? window.throttleRaf(() => {
            if (tvChart && container) {
                tvChart.applyOptions({ width: container.clientWidth });
            }
        }) : () => {
            if (tvChart && container) {
                tvChart.applyOptions({ width: container.clientWidth });
            }
        };

        if ('ResizeObserver' in window) {
            const ro = new ResizeObserver(handleResize);
            ro.observe(container);
        } else {
            window.addEventListener('resize', handleResize);
        }

        loadChartData();
    }

    function loadChartData() {
        fetch(`/api/balance_history?period=${currentPeriod}`)
            .then(r => r.json())
            .then(data => {
                if (!data || data.length === 0) {
                    console.log('No chart data available');
                    return;
                }

                const chartData = data.map(d => ({
                    time: Math.floor(new Date(d.time).getTime() / 1000),
                    value: parseFloat(d.balance)
                })).sort((a, b) => a.time - b.time);

                if (window.tvAreaSeries && chartData.length > 0) {
                    window.tvAreaSeries.setData(chartData);
                    tvChart.timeScale().fitContent();
                }
            })
            .catch(err => console.error('Chart data error:', err));
    }

    function setChartPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.period === period);
        });
        loadChartData();
        loadStats();
    }

    // ==================== STATS ====================
    function loadStats() {
        fetch(`/api/user_stats?period=${currentPeriod}`)
            .then(r => r.json())
            .then(data => {
                const pnlEl = document.getElementById('stats-pnl');
                const tradesEl = document.getElementById('stats-trades');
                const winrateEl = document.getElementById('stats-winrate');
                const avgroiEl = document.getElementById('stats-avgroi');

                if (pnlEl) {
                    pnlEl.textContent = `${data.total_pnl >= 0 ? '+' : ''}$${Math.abs(data.total_pnl).toFixed(0)}`;
                    pnlEl.className = `stat-value ${data.total_pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
                if (tradesEl) tradesEl.textContent = data.total_trades;
                if (winrateEl) winrateEl.textContent = `${data.win_rate}%`;
                if (avgroiEl) {
                    avgroiEl.textContent = `${data.avg_roi >= 0 ? '+' : ''}${data.avg_roi.toFixed(1)}%`;
                    avgroiEl.className = `stat-value ${data.avg_roi >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
            })
            .catch(console.error);
    }

    function setupPositionsPolling() {
        const positionsContainer = document.getElementById('positions-container');
        if (!positionsContainer || !window.htmx) return;

        const activeTrigger = 'load, every 5s, refresh';
        const pausedTrigger = 'load, refresh';

        positionsContainer.setAttribute('hx-trigger', activeTrigger);

        const togglePolling = () => {
            if (document.hidden) {
                positionsContainer.setAttribute('hx-trigger', pausedTrigger);
            } else {
                positionsContainer.setAttribute('hx-trigger', activeTrigger);
                try {
                    htmx.trigger(positionsContainer, 'refresh');
                } catch (err) {
                    console.debug('HTMX refresh skipped:', err);
                }
            }
        };

        document.addEventListener('visibilitychange', togglePolling);
    }

    // ==================== ANIMATED PROFIT COUNTER ====================
    function animateValue(element, start, end, duration, prefix = '', suffix = '') {
        const startTime = performance.now();
        const diff = end - start;

        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const current = start + diff * easeOut;

            element.textContent = prefix + current.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + suffix;

            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }

        requestAnimationFrame(update);
    }

    function updateProfitDisplay(newBalance) {
        const profitIndicator = document.getElementById('profit-indicator');
        const profitDisplay = document.getElementById('profit-display');
        const profitPercent = document.getElementById('profit-percent');
        
        const profit = newBalance - todayStartBalance;
        const profitPct = todayStartBalance > 0 ? (profit / todayStartBalance) * 100 : 0;

        // Update classes based on profit
        profitIndicator.classList.remove('positive', 'negative');
        profitIndicator.classList.add(profit >= 0 ? 'positive' : 'negative');

        // Update icon
        profitIndicator.querySelector('i').className = profit >= 0 ? 'fas fa-arrow-trend-up' : 'fas fa-arrow-trend-down';

        // Animate the profit display
        profitDisplay.textContent = `${profit >= 0 ? '+' : ''}$${Math.abs(profit).toFixed(2)}`;
        profitPercent.textContent = `(${profit >= 0 ? '+' : ''}${profitPct.toFixed(1)}%)`;

        // Flash animation on change
        if (profit > 0) {
            profitIndicator.classList.add('profit-flash', 'profit-glow');
            setTimeout(() => {
                profitIndicator.classList.remove('profit-flash', 'profit-glow');
            }, 1000);
        }
    }

    function formatUsdValue(value) {
        return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function updateSafetyPoolFromBalance(balanceValue) {
        if (!Number.isFinite(balanceValue)) return;
        const poolEl = document.getElementById('dashboard-safety-pool');
        if (!poolEl) return;
        poolEl.textContent = formatUsdValue(balanceValue);

        // Add subtle pulse animation on update
        const badge = document.getElementById('safety-pool-badge');
        if (badge) {
            badge.style.borderColor = 'rgba(57, 255, 20, 0.4)';
            badge.style.boxShadow = '0 0 20px rgba(57, 255, 20, 0.1)';
            setTimeout(() => {
                badge.style.borderColor = 'rgba(57, 255, 20, 0.2)';
                badge.style.boxShadow = 'none';
            }, 1000);
        }
    }

    function getCurrentBalanceValue() {
        const balanceEl = document.getElementById('balance-value');
        if (!balanceEl) return null;
        const parsed = parseFloat(balanceEl.textContent.replace(/[$,]/g, ''));
        return Number.isFinite(parsed) ? parsed : null;
    }

    function updateBalance(newBalance) {
        const balanceEl = document.getElementById('balance-value');
        const oldBalance = parseFloat(balanceEl.textContent.replace(/[$,]/g, '')) || 0;

        if (Math.abs(oldBalance - newBalance) > 0.01) {
            animateValue(balanceEl, oldBalance, newBalance, 800);
            updateProfitDisplay(newBalance);
            updateProgressRing(newBalance);
            updateSafetyPoolFromBalance(newBalance);
        }
    }

    function updateProgressRing(balance) {
        const target = parseFloat(document.getElementById('target-value').textContent) || 1000;
        const progress = Math.min((balance / target) * 100, 100);
        
        document.getElementById('progress-percent').textContent = progress.toFixed(0) + '%';
        
        const circle = document.getElementById('progress-ring');
        const circumference = 2 * Math.PI * 38;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = circumference - (progress / 100) * circumference;
    }

    // ==================== SOCKET.IO ====================
    function initSocket() {
        if (typeof io === 'undefined') {
            setTimeout(initSocket, 100);
            return;
        }

        // Configure Socket.IO with reconnection throttling to prevent spam
        socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,      // Start with 1 second
            reconnectionDelayMax: 30000,  // Max 30 seconds between attempts
            randomizationFactor: 0.5,     // Add randomness to prevent thundering herd
            timeout: 20000,               // Connection timeout
            transports: ['websocket', 'polling']  // Prefer WebSocket
        });

        socket.on('connect', () => {
            console.log('üîå Connected to trading server');
            showToast(t('dash.connectedToFeed'), 'success', 2000);
        });

        socket.on('connect_error', (error) => {
            console.warn('Socket connection error:', error.message);
        });

        socket.on('disconnect', (reason) => {
            console.log('üîå Disconnected:', reason);
            if (reason === 'io server disconnect') {
                // Server disconnected, try to reconnect
                setTimeout(() => socket.connect(), 1000);
            }
        });

        socket.on('update_data', (data) => {
            const newBalance = parseFloat(data.balance.replace(/,/g, '')) || 0;
            updateBalance(newBalance);
            
            // Update positions count
            const count = data.positions?.length || 0;
            document.getElementById('positions-count').textContent = count;
        });

        socket.on('trade_closed', (trade) => {
            // Add to history
            const container = document.getElementById('history-container');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.animation = 'fadeIn 0.3s ease';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="side-tag ${trade.side === 'LONG' ? 'long' : 'short'}">${trade.side}</span>
                    <span class="font-display font-semibold text-white">${trade.symbol}</span>
                </div>
                <div class="text-right">
                    <span class="font-mono font-bold ${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}$
                    </span>
                </div>
            `;
            container.insertBefore(item, container.firstChild);

            // Toast notification
            if (trade.pnl >= 0) {
                showToast(`+$${trade.pnl.toFixed(2)} (${trade.symbol})`, 'success');
                celebrateSuccess();
            } else {
                showToast(`-$${Math.abs(trade.pnl).toFixed(2)} (${trade.symbol})`, 'warning');
            }
        });
    }

    // ==================== EXCHANGES ====================
    let supportedExchanges = [];

    function loadExchanges() {
        const container = document.getElementById('exchanges-container');
        if (!container) return;

        fetch('/api/exchanges')
            .then(r => r.ok ? r.json() : Promise.reject(r))
            .then(exchanges => {
                if (!exchanges || !Array.isArray(exchanges) || exchanges.length === 0) {
                    container.innerHTML = `
                        <div class="empty-positions">
                            <div class="icon"><i class="fas fa-link"></i></div>
                            <div class="text" data-i18n="dash.noExchangesConnected">–ë—ñ—Ä–∂—ñ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω—ñ</div>
                            <button onclick="openAddExchangeModal()" class="btn-cyber btn-cyber-sm mt-4">
                                <i class="fas fa-plus"></i> Connect
                            </button>
                        </div>`;
                    return;
                }
                renderExchanges(exchanges);
                loadExchangeBalances();
            })
            .catch(err => {
                console.error('Error loading exchanges:', err);
                container.innerHTML = `
                    <div class="empty-positions">
                        <div class="icon"><i class="fas fa-exclamation-triangle text-red-400"></i></div>
                        <div class="text text-red-400">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ—Ä–∂</div>
                        <button onclick="loadExchanges()" class="btn-cyber btn-cyber-sm mt-4">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>`;
            });
    }

    function renderExchanges(exchanges) {
        const container = document.getElementById('exchanges-container');
        container.innerHTML = exchanges.map(ex => `
            <div class="exchange-card-cyber mb-3" id="exchange-card-${ex.id}">
                <div class="exchange-logo"><i class="fas fa-building"></i></div>
                <div class="flex-1 min-w-0">
                    <div class="font-display font-semibold text-white">${ex.label || ex.display_name || (ex.exchange_name ? ex.exchange_name.toUpperCase() : 'Unknown')}</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-white/40">${ex.display_name || ex.exchange_name.toUpperCase()}</span>
                        <span id="balance-${ex.id}" class="font-mono text-sm ${ex.balance !== null && ex.balance !== undefined ? (ex.balance > 0 ? 'text-green-400 font-bold' : 'text-white/40') : 'text-white/40'}">
                            ${ex.balance !== null && ex.balance !== undefined ? '$' + ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '...'}
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    ${getStatusBadge(ex.status, ex.trading_enabled, ex.is_active)}
                    ${ex.status === 'APPROVED' && ex.trading_enabled ? `<input type="checkbox" ${ex.is_active ? 'checked' : ''} onchange="toggleExchange(${ex.id}, this.checked)" class="w-5 h-5 accent-green-400 cursor-pointer">` : ''}
                    <button onclick="deleteExchange(${ex.id})" class="modal-close" style="width: 32px; height: 32px;">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function loadExchangeBalances() {
        fetch('/api/exchanges/balances')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.exchanges) {
                    if (data.total_balance > 0) {
                        updateBalance(data.total_balance);
                    }
                    data.exchanges.forEach(ex => {
                        const balanceEl = document.getElementById(`balance-${ex.id}`);
                        if (balanceEl) {
                            if (ex.balance !== null && ex.balance !== undefined) {
                                balanceEl.className = `font-mono text-sm ${ex.balance > 0 ? 'text-green-400 font-bold' : 'text-white/40'}`;
                                balanceEl.textContent = '$' + ex.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            } else if (ex.error) {
                                balanceEl.innerHTML = `<span class="text-red-400 text-xs">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞</span>`;
                            }
                        }
                    });
                }
            })
            .catch(err => console.error('Error loading balances:', err));
    }

    function getStatusBadge(status, tradingEnabled, isActive) {
        if (status === 'PENDING') return `<span class="status-pill pending"><i class="fas fa-clock text-xs"></i> Pending</span>`;
        if (status === 'APPROVED') {
            if (tradingEnabled && isActive) return `<span class="status-pill trading"><span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Trading</span>`;
            if (tradingEnabled) return `<span class="status-pill approved"><i class="fas fa-pause text-xs"></i> Ready</span>`;
            return `<span class="status-pill pending"><i class="fas fa-hourglass-half text-xs"></i> Awaiting</span>`;
        }
        if (status === 'REJECTED') return `<span class="status-pill" style="background: rgba(255, 0, 85, 0.1); color: #ff0055; border: 1px solid rgba(255, 0, 85, 0.3);"><i class="fas fa-times text-xs"></i> Rejected</span>`;
        return `<span class="status-pill">${status}</span>`;
    }

    function loadSupportedExchanges() {
        const select = document.getElementById('exchange-select');
        if (!select) return;

        select.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';

        fetch('/api/exchanges/available')
            .then(r => r.ok ? r.json() : Promise.reject(r))
            .then(exchanges => {
                supportedExchanges = exchanges;
                select.innerHTML = '<option value="">-- Select Exchange --</option>';
                
                const availableExchanges = exchanges.filter(ex => ex.is_enabled && ex.is_verified);
                if (availableExchanges.length > 0) {
                    availableExchanges.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.exchange_name;
                        opt.dataset.passphrase = ex.requires_passphrase;
                        opt.textContent = ex.display_name;
                        select.appendChild(opt);
                    });
                } else if (exchanges.length > 0) {
                    exchanges.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.exchange_name;
                        opt.dataset.passphrase = ex.requires_passphrase;
                        opt.textContent = ex.display_name + (!ex.is_verified ? ' (pending)' : '');
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">–ë—ñ—Ä–∂—ñ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ</option>';
                }
            })
            .catch(err => {
                console.error('Error loading supported exchanges:', err);
                select.innerHTML = '<option value="">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>';
            });
    }

    document.getElementById('exchange-select')?.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const needsPassphrase = option.dataset.passphrase === 'true';
        document.getElementById('passphrase-field').classList.toggle('hidden', !needsPassphrase);
        document.getElementById('exchange-passphrase').required = needsPassphrase;
    });

    function openAddExchangeModal() {
        const modal = document.getElementById('addExchangeModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            loadSupportedExchanges();
        }
    }

    function closeAddExchangeModal() {
        const modal = document.getElementById('addExchangeModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('add-exchange-form')?.reset();
            document.getElementById('passphrase-field')?.classList.add('hidden');
        }
    }

    function submitAddExchange(event) {
        event.preventDefault();
        const form = document.getElementById('add-exchange-form');
        if (!form.exchange_name.value) {
            showToast(t('dash.selectExchange'), 'error');
            return;
        }

        const btn = document.getElementById('submit-exchange-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

        const requestData = {
            exchange_name: form.exchange_name.value.trim(),
            label: form.label ? form.label.value.trim() : '',
            api_key: form.api_key.value.trim(),
            api_secret: form.api_secret.value.trim()
        };

        const passphraseField = document.getElementById('exchange-passphrase');
        if (passphraseField && !passphraseField.closest('.hidden')) {
            requestData.passphrase = passphraseField.value.trim();
        }

        fetch('/api/exchanges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
        .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
        .then(result => {
            if (result.success) {
                showToast(result.message || t('dash.requestSent'), 'success');
                closeAddExchangeModal();
                loadExchanges();
            } else {
                showToast(result.error || t('dash.errorAddingExchange'), 'error');
            }
        })
        .catch(err => {
            showToast(err.error || err.message || t('dash.networkError'), 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Request';
        });
    }

    function toggleExchange(id, isActive) {
        fetch(`/api/exchanges/${id}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: isActive })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) showToast(result.message, 'success');
            else { showToast(result.error, 'error'); loadExchanges(); }
        })
        .catch(() => { showToast(t('dash.error'), 'error'); loadExchanges(); });
    }

    function deleteExchange(id) {
        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –±—ñ—Ä–∂—ñ?')) return;
        fetch(`/api/exchanges/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(result => {
                if (result.success) { showToast(t('dash.deleted'), 'success'); loadExchanges(); }
                else showToast(result.error, 'error');
            })
            .catch(() => showToast(t('dash.error'), 'error'));
    }

    // ==================== AVATAR ====================
    function openAvatarModal() {
        const modal = document.getElementById('avatarModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeAvatarModal() {
        const modal = document.getElementById('avatarModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    function selectUserEmoji(emoji) {
        document.getElementById('selected-user-emoji').value = emoji;
        document.getElementById('user-avatar-type').value = 'emoji';
        document.querySelectorAll('#user-emoji-grid button').forEach(btn => {
            btn.classList.remove('border-green-500/50', 'bg-green-500/10');
            btn.classList.add('border-white/10');
        });
        event.target.closest('button').classList.remove('border-white/10');
        event.target.closest('button').classList.add('border-green-500/50', 'bg-green-500/10');
    }

    function setUserAvatarType(type) {
        document.getElementById('user-avatar-type').value = type;
    }

    // ==================== REFERRAL ====================
    function copyReferralLink() {
        const linkEl = document.getElementById('referral-link');
        const link = linkEl ? linkEl.textContent : '{{ referral_link }}';

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(link).then(() => {
                showToast(t('dash.referralLinkCopied'), 'success');
            }).catch(() => {
                // Fallback
                const temp = document.createElement('input');
                temp.value = link;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                showToast(t('dash.referralLinkCopied'), 'success');
            });
        } else {
            // Fallback for older browsers
            const temp = document.createElement('input');
            temp.value = link;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast(t('dash.referralLinkCopied'), 'success');
        }
    }
    
    // ==================== SUBSCRIPTION ====================
    let subscriptionData = null;
    let selectedPlan = null;
    let currentPaymentId = null;
    let paymentMethods = [];

    function openSectionAndScroll(section, targetId) {
        if (typeof window.showSection === 'function') {
            window.showSection(section);
        }
        if (targetId) {
            setTimeout(() => {
                const el = document.getElementById(targetId);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 150);
        }
    }

    function showUpgradeModal() {
        // Navigate to subscription section
        openSectionAndScroll('subscription', 'upgrade-section');
    }
    
    function loadSubscriptionStatus() {
        console.log('Loading subscription status...');
        fetch('/api/subscription/status')
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('Subscription status data:', data);
                if (!data.success) {
                    console.error('Failed to load subscription status:', data.error);
                    showToast('Failed to load subscription status: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }
                
                subscriptionData = data;
                updateSubscriptionDisplay(data);
                loadPaymentHistory(data.payment_history || []);
                showPendingPayments(data.pending_payments || []);
            })
            .catch(err => {
                console.error('Error loading subscription:', err);
                showToast('Error loading subscription: ' + err.message, 'error');
            });
    }
    
    function updateSubscriptionDisplay(data) {
        const statusBadge = document.getElementById('sub-status-badge');
        const statusText = document.getElementById('sub-status-text');
        const planEl = document.getElementById('sub-current-plan');
        const descEl = document.getElementById('sub-plan-description');
        const expiresEl = document.getElementById('sub-expires-at');
        const daysEl = document.getElementById('sub-days-remaining');
        const tradingDot = document.getElementById('sub-trading-dot');
        const tradingStatus = document.getElementById('sub-trading-status');
        const tradingNote = document.getElementById('sub-trading-note');
        const freeBanner = document.getElementById('free-mode-banner');
        const upgradeSection = document.getElementById('upgrade-section');
        
        // Check if subscriptions are disabled (free mode)
        if (!data.subscription_enabled) {
            freeBanner.classList.remove('hidden');
            upgradeSection.classList.add('hidden');
            statusBadge.style.background = 'rgba(16, 185, 129, 0.1)';
            statusBadge.style.color = '#10b981';
            statusText.textContent = 'FREE ACCESS';
            tradingDot.style.background = 'var(--neon-green)';
            tradingStatus.textContent = 'ENABLED';
            tradingStatus.style.color = 'var(--neon-green)';
            tradingNote.textContent = 'Full access - Subscriptions disabled';
            return;
        }
        
        freeBanner.classList.add('hidden');
        upgradeSection.classList.remove('hidden');
        
        // Plan info
        const planNames = {
            'free': 'Free',
            'basic': 'Basic',
            'pro': 'Pro',
            'enterprise': 'Enterprise',
            'basic_annual': 'Basic Annual',
            'pro_annual': 'Pro Annual'
        };
        
        planEl.textContent = planNames[data.plan] || data.plan || 'Free';
        
        // Status badge
        if (data.is_active) {
            statusBadge.style.background = 'rgba(16, 185, 129, 0.1)';
            statusBadge.style.color = '#10b981';
            statusBadge.style.borderColor = 'rgba(16, 185, 129, 0.3)';
            statusText.textContent = 'ACTIVE';
        } else {
            statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
            statusBadge.style.color = '#ef4444';
            statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            statusText.textContent = 'EXPIRED';
        }
        
        // Expiration
        if (data.expires_at) {
            const expires = new Date(data.expires_at);
            expiresEl.textContent = expires.toLocaleDateString('en-US', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
            daysEl.textContent = `${data.days_remaining} days remaining`;
            
            if (data.days_remaining <= 7) {
                expiresEl.style.color = 'var(--neon-red)';
            } else if (data.days_remaining <= 30) {
                expiresEl.style.color = 'var(--neon-yellow)';
            }
        } else {
            expiresEl.textContent = data.plan === 'free' ? 'N/A' : 'Never';
            daysEl.textContent = '';
        }
        
        // Trading status
        if (data.can_trade) {
            tradingDot.style.background = 'var(--neon-green)';
            tradingStatus.textContent = 'ENABLED';
            tradingStatus.style.color = 'var(--neon-green)';
            tradingNote.textContent = 'Full access to copy trading';
        } else {
            tradingDot.style.background = 'var(--neon-red)';
            tradingStatus.textContent = 'DISABLED';
            tradingStatus.style.color = 'var(--neon-red)';
            tradingNote.textContent = 'Upgrade to enable trading';
        }
        
        // Update feature badges
        updateSubscriptionUI();
    }
    
    function showPendingPayments(pendingPayments) {
        const alert = document.getElementById('pending-payments-alert');
        const details = document.getElementById('pending-payment-details');
        
        if (pendingPayments && pendingPayments.length > 0) {
            alert.classList.remove('hidden');
            const p = pendingPayments[0];
            const methodLabel = getPaymentMethodLabel(p.currency);
            details.textContent = `${p.plan.toUpperCase()} plan - $${p.amount_usd.toFixed(2)} (${methodLabel}) - ${p.status === 'awaiting_confirmation' ? 'Awaiting admin confirmation' : 'Waiting for payment'}`;
        } else {
            alert.classList.add('hidden');
        }
    }
    
    function loadPaymentHistory(history) {
        const container = document.getElementById('payment-history-container');
        
        if (!history || history.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-white/40">
                    <i class="fas fa-receipt text-3xl mb-2"></i>
                    <p data-i18n="dash.noPaymentHistory">–Ü—Å—Ç–æ—Ä—ñ—ó –ø–ª–∞—Ç–µ–∂—ñ–≤ —â–µ –Ω–µ–º–∞—î</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="space-y-3">';
        history.forEach(p => {
            const date = new Date(p.completed_at);
            html += `
                <div class="flex items-center justify-between p-4 rounded-xl bg-black/30 border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-green-500/10">
                            <i class="fas fa-check-circle text-green-400"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-white">${p.plan.toUpperCase()} - ${p.days} days</div>
                            <div class="text-xs text-white/50">${date.toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono font-bold text-green-400">$${p.amount_usd.toFixed(2)}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }
    
    function loadAvailablePlans() {
        console.log('Loading available plans...');
        fetch('/api/subscription/available-networks')
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('Available plans data:', data);
                if (!data.success) {
                    console.error('Failed to load plans:', data.error);
                    showToast('Failed to load plans: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }
                
                paymentMethods = data.payment_methods || data.networks || [];
                renderPlans(data.plans || []);
                updateNetworkSelect(paymentMethods);
            })
            .catch(err => {
                console.error('Error loading plans:', err);
                showToast('Error loading plans: ' + err.message, 'error');
            });
    }
    
    function renderPlans(plans) {
        const container = document.getElementById('plans-container');
        
        if (!plans || plans.length === 0) {
            container.innerHTML = '<div class="col-span-3 text-center text-white/50">' + t('dash.noPlansAvailable') + '</div>';
            return;
        }
        
        // Filter to show main plans
        const mainPlans = plans.filter(p => ['basic', 'pro', 'enterprise'].includes(p.id));
        
        let html = '';
        mainPlans.forEach((plan, idx) => {
            const isPopular = plan.id === 'pro';
            const colors = {
                'basic': { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', accent: '#3b82f6' },
                'pro': { bg: 'rgba(139, 92, 246, 0.1)', border: 'rgba(139, 92, 246, 0.3)', accent: '#8b5cf6' },
                'enterprise': { bg: 'rgba(236, 72, 153, 0.1)', border: 'rgba(236, 72, 153, 0.3)', accent: '#ec4899' }
            };
            const c = colors[plan.id] || colors.basic;
            
            html += `
                <div class="relative p-5 rounded-xl border cursor-pointer transition-all hover:scale-[1.02] ${selectedPlan?.id === plan.id ? 'ring-2 ring-purple-500' : ''}"
                     style="background: ${c.bg}; border-color: ${c.border};"
                     onclick="selectPlan('${plan.id}', '${plan.name}', ${plan.price}, ${plan.days})">
                    ${isPopular ? '<span class="absolute -top-2 left-1/2 -translate-x-1/2 px-3 py-1 rounded-full text-xs font-bold" style="background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white;">POPULAR</span>' : ''}
                    <div class="text-center">
                        <div class="text-sm text-white/50 mb-1">${plan.id.toUpperCase()}</div>
                        <div class="text-3xl font-bold mb-1" style="color: ${c.accent};">$${plan.price}</div>
                        <div class="text-xs text-white/40 mb-4">${plan.days} days</div>
                        <div class="text-sm font-semibold text-white">${plan.name}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    function selectPlan(id, name, price, days) {
        selectedPlan = { id, name, price, days };
        document.getElementById('payment-form').classList.remove('hidden');
        document.getElementById('selected-plan-name').textContent = name;
        document.getElementById('selected-plan-price').textContent = `$${price}`;
        document.getElementById('payment-amount-display').textContent = `$${price.toFixed(2)}`;
        
        // Re-render plans to show selection
        loadAvailablePlans();
    }
    
    function updateNetworkSelect(networks) {
        const select = document.getElementById('payment-network');
        
        if (!networks || networks.length === 0) {
            select.innerHTML = '<option value="">' + t('dash.noPaymentMethods') + '</option>';
            return;
        }
        
        let html = '<option value="">Select payment method...</option>';
        networks.forEach(n => {
            const label = n.label || n.name || n.id;
            html += `<option value="${n.id}">${label}</option>`;
        });
        select.innerHTML = html;
    }
    
    function getPaymentMethodLabel(methodId) {
        const key = (methodId || '').toLowerCase();
        const method = paymentMethods.find(m => m.id === methodId || m.id === key);
        return method ? method.label : methodId;
    }
    
    function createPayment() {
        if (!selectedPlan) {
            showToast(t('dash.selectPlanFirst'), 'warning');
            return;
        }
        
        const methodId = document.getElementById('payment-network').value;
        if (!methodId) {
            showToast(t('dash.selectPaymentNetwork'), 'warning');
            return;
        }
        
        const btn = document.getElementById('btn-create-payment');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
        fetch('/api/subscription/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plan: selectedPlan.id,
                payment_method_id: methodId
            })
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showToast(data.error || 'Failed to create payment', 'error');
                return;
            }
            
            currentPaymentId = data.payment.id;
            
            // Show wallet address
            document.getElementById('wallet-display').classList.remove('hidden');
            document.getElementById('tx-hash-section').classList.remove('hidden');
            const paymentDetails = data.payment.payment_details || data.payment.wallet_address || '-';
            document.getElementById('payment-wallet-address').textContent = paymentDetails;
            document.getElementById('payment-amount-display').textContent = `$${data.payment.amount_usd.toFixed(2)}`;
            
            const helpText = document.getElementById('payment-help-text');
            if (helpText) {
                if (data.payment.payment_method_type === 'wallet') {
                    helpText.innerHTML = `<strong>Important:</strong> Send exactly <span class="font-mono text-yellow-400">$${data.payment.amount_usd.toFixed(2)}</span> to this address.`;
                } else {
                    helpText.innerHTML = `<strong>Important:</strong> Use the details above and send exactly <span class="font-mono text-yellow-400">$${data.payment.amount_usd.toFixed(2)}</span>.`;
                }
            }
            
            // Toggle buttons
            btn.classList.add('hidden');
            document.getElementById('btn-mark-paid').classList.remove('hidden');
            
            showToast(t('dash.paymentAddressGenerated'), 'success');
        })
        .catch(err => {
            showToast(t('dash.errorCreatingPayment'), 'error');
            console.error(err);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    }
    
    function markAsPaid() {
        if (!currentPaymentId) {
            showToast(t('dash.noActivePayment'), 'error');
            return;
        }
        
        const txHash = document.getElementById('tx-hash-input').value.trim();
        const btn = document.getElementById('btn-mark-paid');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        fetch(`/api/subscription/mark-paid/${currentPaymentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tx_hash: txHash })
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showToast(data.error || 'Failed to mark payment', 'error');
                return;
            }
            
            if (data.auto_confirmed) {
                showToast(t('dash.paymentConfirmed'), 'success');
            } else {
                showToast(t('dash.paymentMarkedSent'), 'info');
            }
            
            // Reset form and reload status
            cancelPayment();
            loadSubscriptionStatus();
        })
        .catch(err => {
            showToast(t('dash.error'), 'error');
            console.error(err);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    }
    
    function cancelPayment() {
        document.getElementById('payment-form').classList.add('hidden');
        document.getElementById('wallet-display').classList.add('hidden');
        document.getElementById('tx-hash-section').classList.add('hidden');
        document.getElementById('btn-create-payment').classList.remove('hidden');
        document.getElementById('btn-mark-paid').classList.add('hidden');
        document.getElementById('tx-hash-input').value = '';
        const helpText = document.getElementById('payment-help-text');
        if (helpText) {
            helpText.innerHTML = '<strong>Important:</strong> Follow the payment instructions and send exactly <span class="font-mono text-yellow-400">$0.00</span>.';
        }
        const detailsEl = document.getElementById('payment-wallet-address');
        if (detailsEl) detailsEl.textContent = '-';
        selectedPlan = null;
        currentPaymentId = null;
        loadAvailablePlans();
    }
    
    function copyWalletAddress() {
        const address = document.getElementById('payment-wallet-address').textContent;
        navigator.clipboard.writeText(address).then(() => {
            showToast(t('dash.walletCopied'), 'success');
        }).catch(() => {
            showToast(t('dash.failedToCopy'), 'error');
        });
    }
    
    // Update subscription UI based on plan
    function updateSubscriptionUI() {
        const plan = '{{ user_settings.subscription_plan|default("free") }}';
        const featureApi = document.getElementById('feature-api');
        const featureChat = document.getElementById('feature-chat');
        
        if (plan !== 'free') {
            if (featureApi) {
                featureApi.style.background = 'rgba(34, 197, 94, 0.1)';
                featureApi.style.color = '#22c55e';
                featureApi.innerHTML = '<i class="fas fa-check"></i> API Access';
            }
            if (featureChat) {
                featureChat.style.background = 'rgba(34, 197, 94, 0.1)';
                featureChat.style.color = '#22c55e';
                featureChat.innerHTML = '<i class="fas fa-check"></i> Live Chat';
            }
        }
    }
    
    // Initialize subscription when section is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Load subscription data when subscription section becomes active
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.classList.contains('active') && 
                    mutation.target.getAttribute('data-section') === 'subscription') {
                    loadSubscriptionStatus();
                    loadAvailablePlans();
                }
            });
        });
        
        const subSection = document.querySelector('[data-section="subscription"]');
        if (subSection) {
            observer.observe(subSection, { attributes: true, attributeFilter: ['class'] });
        }
    });
    
    // Initialize subscription UI
    updateSubscriptionUI();

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            closeAddExchangeModal();
            closeAvatarModal();
        }
    });

    // ==================== STRATEGY SUBSCRIPTIONS ====================
    let userSubscriptions = [];
    let availableStrategies = [];

    function loadStrategies() {
        const container = document.getElementById('strategies-container');
        if (!container) return;

        // Load both available strategies and user's subscriptions
        Promise.all([
            fetch('/api/strategies').then(r => r.json()),
            fetch('/api/subscriptions').then(r => r.json())
        ])
        .then(([strategiesData, subscriptionsData]) => {
            if (!strategiesData.success || !subscriptionsData.success) {
                throw new Error('Failed to load data');
            }

            availableStrategies = strategiesData.strategies;
            userSubscriptions = subscriptionsData.subscriptions;
            
            renderStrategies();
            updateAllocationDisplay();
        })
        .catch(err => {
            console.error('Error loading strategies:', err);
            container.innerHTML = `
                <div class="text-center py-6 text-red-400">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Failed to load strategies</p>
                    <button onclick="loadStrategies()" class="btn-cyber btn-cyber-sm mt-3">
                        <i class="fas fa-sync"></i> Retry
                    </button>
                </div>`;
        });
    }

    function renderStrategies() {
        const container = document.getElementById('strategies-container');
        if (!container || !availableStrategies.length) {
            container.innerHTML = `
                <div class="text-center py-6 text-white/50">
                    <i class="fas fa-chess-board text-2xl mb-2 opacity-30"></i>
                    <p>${t('dash.noStrategies')}</p>
                </div>`;
            return;
        }

        container.innerHTML = availableStrategies.map(strategy => {
            const subscription = userSubscriptions.find(s => s.strategy_id === strategy.id);
            const isSubscribed = subscription && subscription.is_active;
            const allocation = subscription ? subscription.allocation_percent : 0;
            
            const riskBadgeColor = {
                'low': 'bg-green-500/10 text-green-400 border-green-500/30',
                'medium': 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30',
                'high': 'bg-red-500/10 text-red-400 border-red-500/30'
            }[strategy.risk_level] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';

            return `
                <div class="strategy-card p-4 rounded-xl border transition-all ${isSubscribed ? 'bg-purple-500/5 border-purple-500/30' : 'bg-black/30 border-white/5'}" data-strategy-id="${strategy.id}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center ${isSubscribed ? 'bg-purple-500/20 text-purple-400' : 'bg-white/5 text-white/40'}">
                                <i class="fas fa-chess-knight"></i>
                            </div>
                            <div>
                                <div class="font-display font-semibold text-white">${strategy.name}</div>
                                <div class="text-xs text-white/50">${strategy.description || 'No description'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold border ${riskBadgeColor}">
                                ${strategy.risk_level.toUpperCase()}
                            </span>
                            <span class="text-xs text-white/40">${strategy.subscriber_count || 0} users</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <!-- Toggle Switch -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer strategy-toggle" 
                                   data-strategy-id="${strategy.id}"
                                   data-subscription-id="${subscription ? subscription.id : ''}"
                                   ${isSubscribed ? 'checked' : ''}
                                   onchange="toggleStrategySubscription(this, ${strategy.id})">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                        </label>
                        
                        <!-- Allocation Slider -->
                        <div class="flex-1 ${isSubscribed ? '' : 'opacity-30 pointer-events-none'}">
                            <div class="flex items-center gap-3">
                                <input type="range" min="5" max="100" step="5" value="${allocation}"
                                       class="flex-1 h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500 strategy-allocation"
                                       data-strategy-id="${strategy.id}"
                                       data-subscription-id="${subscription ? subscription.id : ''}"
                                       onchange="updateStrategyAllocation(this, ${strategy.id})"
                                       oninput="previewAllocation(this)">
                                <span class="w-12 text-right font-mono text-sm text-purple-400 allocation-value">${allocation}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateAllocationDisplay() {
        const totalAllocation = userSubscriptions
            .filter(s => s.is_active)
            .reduce((sum, s) => sum + s.allocation_percent, 0);
        
        const badge = document.getElementById('allocation-badge');
        const warning = document.getElementById('allocation-warning');
        const warningText = document.getElementById('allocation-warning-text');
        const totalEl = document.getElementById('total-allocation');

        if (totalEl) totalEl.textContent = totalAllocation.toFixed(0);

        if (badge) {
            if (totalAllocation === 100) {
                badge.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-500/10 text-green-400';
            } else if (totalAllocation > 100) {
                badge.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-red-500/10 text-red-400';
            } else {
                badge.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-500/10 text-yellow-400';
            }
        }

        if (warning && warningText) {
            if (totalAllocation !== 100) {
                warning.classList.remove('hidden');
                if (totalAllocation > 100) {
                    warningText.textContent = `Total allocation is ${totalAllocation}% - exceeds 100%!`;
                    warning.className = 'mt-4 p-3 rounded-lg bg-red-500/10 border border-red-500/30';
                } else {
                    warningText.textContent = `Total allocation is ${totalAllocation}% - ${100 - totalAllocation}% unallocated`;
                    warning.className = 'mt-4 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30';
                }
            } else {
                warning.classList.add('hidden');
            }
        }
    }

    function previewAllocation(input) {
        const valueEl = input.parentElement.querySelector('.allocation-value');
        if (valueEl) valueEl.textContent = input.value + '%';
    }

    async function toggleStrategySubscription(checkbox, strategyId) {
        const isSubscribed = checkbox.checked;
        const subscriptionId = checkbox.dataset.subscriptionId;
        const card = checkbox.closest('.strategy-card');
        const slider = card.querySelector('.strategy-allocation');
        const sliderContainer = slider.parentElement.parentElement;

        try {
            if (isSubscribed) {
                // Subscribe with default 100% or remaining allocation
                const currentTotal = userSubscriptions
                    .filter(s => s.is_active && s.strategy_id !== strategyId)
                    .reduce((sum, s) => sum + s.allocation_percent, 0);
                const defaultAllocation = Math.min(100 - currentTotal, 100);

                const response = await fetch('/api/subscriptions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy_id: strategyId,
                        allocation_percent: defaultAllocation
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showToast(`Subscribed to strategy`, 'success');
                    loadStrategies(); // Reload to get updated data
                } else {
                    checkbox.checked = false;
                    showToast(result.error || 'Failed to subscribe', 'error');
                }
            } else {
                // Unsubscribe
                if (subscriptionId) {
                    const response = await fetch(`/api/subscriptions/${subscriptionId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (result.success) {
                        showToast(t('dash.unsubscribedFromStrategy'), 'success');
                        loadStrategies();
                    } else {
                        checkbox.checked = true;
                        showToast(result.error || 'Failed to unsubscribe', 'error');
                    }
                }
            }
        } catch (err) {
            console.error('Error toggling subscription:', err);
            checkbox.checked = !isSubscribed;
            showToast(t('dash.networkError'), 'error');
        }

        // Toggle slider visibility
        sliderContainer.classList.toggle('opacity-30', !isSubscribed);
        sliderContainer.classList.toggle('pointer-events-none', !isSubscribed);
    }

    async function updateStrategyAllocation(input, strategyId) {
        const subscriptionId = input.dataset.subscriptionId;
        const newAllocation = parseFloat(input.value);

        if (!subscriptionId) {
            showToast(t('dash.pleaseSubscribeFirst'), 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/subscriptions/${subscriptionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ allocation_percent: newAllocation })
            });
            const result = await response.json();

            if (result.success) {
                // Update local data
                const sub = userSubscriptions.find(s => s.id === parseInt(subscriptionId));
                if (sub) sub.allocation_percent = newAllocation;
                updateAllocationDisplay();
                showToast(`Allocation updated to ${newAllocation}%`, 'success', 1500);
            } else {
                showToast(result.error || 'Failed to update', 'error');
                loadStrategies(); // Reload to restore correct value
            }
        } catch (err) {
            console.error('Error updating allocation:', err);
            showToast(t('dash.networkError'), 'error');
            loadStrategies();
        }
    }

    // ==================== SAFETY POOL / INSURANCE FUND ====================
    function loadSafetyPool() {
        const balanceValue = getCurrentBalanceValue();
        if (balanceValue !== null) {
            updateSafetyPoolFromBalance(balanceValue);
        }
    }

    // ==================== GAMIFICATION ====================
    let gamificationData = null;
    
    function loadGamification() {
        fetch('/api/gamification/status')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                
                gamificationData = data;
                updateGamificationUI(data);
            })
            .catch(err => console.log('Gamification fetch error:', err));
    }
    
    function updateGamificationUI(data) {
        // Update level icon and container
        const levelIcon = document.getElementById('level-icon');
        const levelIconContainer = document.getElementById('level-icon-container');
        const levelBadge = document.getElementById('level-badge');
        const levelName = document.getElementById('level-name');
        
        const levelColor = data.level_color || '#888888';
        
        if (levelIcon) {
            levelIcon.className = `fas ${data.level_icon || 'fa-seedling'} text-2xl`;
            levelIcon.style.color = levelColor;
        }
        if (levelIconContainer) {
            levelIconContainer.style.background = `${levelColor}15`;
            levelIconContainer.style.borderColor = `${levelColor}50`;
        }
        if (levelBadge) {
            levelBadge.style.background = `${levelColor}15`;
            levelBadge.style.color = levelColor;
            levelBadge.style.borderColor = `${levelColor}50`;
        }
        if (levelName) {
            levelName.textContent = data.level_name || 'Novice';
        }
        
        // Update XP display
        const userXp = document.getElementById('user-xp');
        const xpToNext = document.getElementById('xp-to-next');
        if (userXp) {
            userXp.textContent = (data.current_xp || 0).toLocaleString();
        }
        if (xpToNext) {
            if (data.is_max_level) {
                xpToNext.textContent = 'üéâ MAX LEVEL!';
            } else {
                xpToNext.textContent = `${data.xp_to_next.toLocaleString()} XP to ${data.next_level_name || 'next level'}`;
            }
        }
        
        // Update progress bar
        const currentLevelLabel = document.getElementById('current-level-label');
        const nextLevelLabel = document.getElementById('next-level-label');
        const xpProgressBar = document.getElementById('xp-progress-bar');
        const progressText = document.getElementById('progress-text');
        
        if (currentLevelLabel) currentLevelLabel.textContent = data.level_name || 'Novice';
        if (nextLevelLabel) nextLevelLabel.textContent = data.next_level_name || (data.is_max_level ? 'üëë MAX' : 'Next');
        if (xpProgressBar) {
            xpProgressBar.style.width = `${data.progress || 0}%`;
            xpProgressBar.style.background = `linear-gradient(90deg, ${levelColor} 0%, ${levelColor}99 100%)`;
        }
        if (progressText) {
            if (data.is_max_level) {
                progressText.textContent = '‚ú® Maximum level achieved!';
            } else {
                progressText.textContent = `${data.progress || 0}% to next level`;
            }
        }
        
        // Update discount badge
        const discountPercent = document.getElementById('discount-percent');
        const discountBadge = document.getElementById('discount-badge');
        if (discountPercent) {
            discountPercent.textContent = `${data.discount_percent || 0}%`;
        }
        if (discountBadge) {
            if (data.discount_percent > 0) {
                discountBadge.style.background = 'rgba(34, 197, 94, 0.15)';
                discountBadge.style.borderColor = 'rgba(34, 197, 94, 0.4)';
            } else {
                discountBadge.style.background = 'rgba(34, 197, 94, 0.05)';
                discountBadge.style.borderColor = 'rgba(34, 197, 94, 0.2)';
            }
        }
        
        // Update badges container
        const badgesContainer = document.getElementById('badges-container');
        const badgeCount = document.getElementById('badge-count');
        
        if (badgeCount) {
            badgeCount.textContent = `(${data.total_badges || 0} unlocked)`;
        }
        
        if (badgesContainer && data.badges) {
            if (data.badges.length === 0) {
                badgesContainer.innerHTML = `
                    <div class="text-xs text-white/30 italic">Complete trades to unlock achievements!</div>
                `;
            } else {
                badgesContainer.innerHTML = data.badges.slice(0, 6).map(badge => {
                    const rarityGlow = {
                        'common': '',
                        'rare': 'box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);',
                        'epic': 'box-shadow: 0 0 15px rgba(156, 39, 176, 0.4);',
                        'legendary': 'box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);'
                    }[badge.rarity] || '';
                    
                    return `
                        <div class="badge-item inline-flex items-center gap-2 px-3 py-1.5 rounded-full cursor-pointer transition-transform hover:scale-105"
                             style="background: ${badge.color}20; border: 1px solid ${badge.color}40; ${rarityGlow}"
                             title="${badge.description}\n\nRarity: ${badge.rarity.charAt(0).toUpperCase() + badge.rarity.slice(1)}"
                             onclick="showBadgeDetails('${badge.achievement_type}')">
                            <i class="fas ${badge.icon}" style="color: ${badge.color};"></i>
                            <span class="text-xs font-medium" style="color: ${badge.color};">${badge.name}</span>
                        </div>
                    `;
                }).join('');
                
                // Add "more" indicator if there are more badges
                if (data.badges.length > 6) {
                    badgesContainer.innerHTML += `
                        <button onclick="showAllAchievements()" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs text-white/50 bg-white/5 border border-white/10 hover:bg-white/10 transition-colors">
                            +${data.badges.length - 6} more
                        </button>
                    `;
                }
            }
        }
    }
    
    function showBadgeDetails(achievementType) {
        if (!gamificationData) return;
        
        const badge = gamificationData.badges.find(b => b.achievement_type === achievementType);
        if (!badge) return;
        
        const rarityColors = {
            'common': { bg: '#888', label: 'Common' },
            'rare': { bg: '#2196F3', label: 'Rare' },
            'epic': { bg: '#9C27B0', label: 'Epic' },
            'legendary': { bg: '#FFD700', label: 'Legendary' }
        };
        const rarity = rarityColors[badge.rarity] || rarityColors.common;
        
        // Show a simple alert or toast - could be enhanced with a modal
        const unlockedDate = new Date(badge.unlocked_at).toLocaleDateString();
        alert(`üèÜ ${badge.name}\n\n${badge.description}\n\nRarity: ${rarity.label}\nUnlocked: ${unlockedDate}`);
    }
    
    function showAllAchievements() {
        fetch('/api/gamification/achievements')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                
                // Separate unlocked and locked achievements
                const unlockedAchievements = data.all_achievements.filter(a => a.unlocked);
                const lockedAchievements = data.all_achievements.filter(a => !a.unlocked);
                
                // Rarity styles
                const getRarityStyles = (rarity, isUnlocked) => {
                    const styles = {
                        'common': { border: 'rgba(156, 163, 175, 0.4)', glow: 'rgba(156, 163, 175, 0.2)', label: 'Common', color: '#9ca3af' },
                        'rare': { border: 'rgba(59, 130, 246, 0.5)', glow: 'rgba(59, 130, 246, 0.3)', label: 'Rare', color: '#3b82f6' },
                        'epic': { border: 'rgba(147, 51, 234, 0.5)', glow: 'rgba(147, 51, 234, 0.3)', label: 'Epic', color: '#9333ea' },
                        'legendary': { border: 'rgba(251, 191, 36, 0.5)', glow: 'rgba(251, 191, 36, 0.3)', label: 'Legendary', color: '#fbbf24' }
                    };
                    return styles[rarity] || styles['common'];
                };
                
                // Build achievement card
                const buildCard = (achievement, isUnlocked) => {
                    const rarity = getRarityStyles(achievement.rarity, isUnlocked);
                    const opacity = isUnlocked ? '1' : '0.5';
                    const grayscale = isUnlocked ? '' : 'filter: grayscale(60%);';
                    const statusIcon = isUnlocked 
                        ? `<div class="flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;"><i class="fas fa-check"></i> Unlocked</div>`
                        : `<div class="flex items-center gap-1 px-2 py-1 rounded-full text-xs" style="background: rgba(255, 255, 255, 0.05); color: rgba(255,255,255,0.4);"><i class="fas fa-lock"></i> Locked</div>`;
                    const glowEffect = isUnlocked ? `box-shadow: 0 0 20px ${rarity.glow};` : '';
                    
                    return `
                        <div class="flex items-start gap-3 p-4 rounded-xl transition-all duration-300" 
                             style="background: rgba(0,0,0,0.4); border: 1px solid ${rarity.border}; opacity: ${opacity}; ${grayscale} ${glowEffect}">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 relative"
                                 style="background: ${achievement.color}20; border: 1px solid ${achievement.color}40;">
                                <i class="fas ${achievement.icon} text-lg" style="color: ${achievement.color};"></i>
                                ${isUnlocked ? `<div class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-green-500 flex items-center justify-center"><i class="fas fa-check text-xs text-black"></i></div>` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-white text-sm">${achievement.name}</span>
                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background: ${rarity.color}20; color: ${rarity.color}; border: 1px solid ${rarity.color}40;">${rarity.label}</span>
                                </div>
                                <div class="text-xs text-white/60 leading-relaxed">${achievement.description}</div>
                            </div>
                            ${statusIcon}
                        </div>
                    `;
                };
                
                // Build modal content
                let content = '';
                
                // Unlocked section
                if (unlockedAchievements.length > 0) {
                    content += `
                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-white/10">
                                <i class="fas fa-trophy text-yellow-400"></i>
                                <span class="text-sm font-semibold text-white">Unlocked Achievements</span>
                                <span class="px-2 py-0.5 rounded-full text-xs font-bold" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;">${unlockedAchievements.length}</span>
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                ${unlockedAchievements.map(a => buildCard(a, true)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Locked section
                if (lockedAchievements.length > 0) {
                    content += `
                        <div>
                            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-white/10">
                                <i class="fas fa-lock text-white/40"></i>
                                <span class="text-sm font-semibold text-white/70">Available to Unlock</span>
                                <span class="px-2 py-0.5 rounded-full text-xs" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);">${lockedAchievements.length}</span>
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                ${lockedAchievements.map(a => buildCard(a, false)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Progress bar at bottom
                const progressPercent = data.total_available > 0 ? (data.total_unlocked / data.total_available) * 100 : 0;
                content += `
                    <div class="mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-white/60">Overall Progress</span>
                            <span class="text-sm font-bold" style="color: #c084fc;">${data.total_unlocked} / ${data.total_available}</span>
                        </div>
                        <div class="h-3 rounded-full overflow-hidden" style="background: rgba(255,255,255,0.1);">
                            <div class="h-full rounded-full transition-all duration-500" style="width: ${progressPercent}%; background: linear-gradient(90deg, #9333ea, #c084fc, #fbbf24);"></div>
                        </div>
                        <div class="text-center mt-2 text-xs text-white/40">Complete trades to unlock more achievements!</div>
                    </div>
                `;
                
                showAchievementsModal(content, data.total_unlocked, data.total_available);
            })
            .catch(err => console.error('Error loading achievements:', err));
    }
    
    function showAchievementsModal(content, unlocked, total) {
        // Create and show modal
        const existingModal = document.getElementById('achievements-modal');
        if (existingModal) existingModal.remove();
        
        const progressPercent = total > 0 ? Math.round((unlocked / total) * 100) : 0;
        
        const modal = document.createElement('div');
        modal.id = 'achievements-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        modal.style.cssText = 'background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);';
        modal.innerHTML = `
            <div class="max-w-2xl w-full max-h-[85vh] flex flex-col rounded-2xl overflow-hidden"
                 style="background: linear-gradient(135deg, rgba(15, 15, 25, 0.98), rgba(10, 10, 20, 0.98)); border: 1px solid rgba(147, 51, 234, 0.3); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 40px rgba(147, 51, 234, 0.15);">
                <!-- Header -->
                <div class="flex items-center justify-between p-5" style="background: linear-gradient(90deg, rgba(147, 51, 234, 0.1), rgba(59, 130, 246, 0.1)); border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 1px solid rgba(251, 191, 36, 0.4);">
                            <i class="fas fa-trophy text-xl text-yellow-400"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">All Achievements</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-sm text-white/60">${progressPercent}% Complete</span>
                                <span class="text-white/30">‚Ä¢</span>
                                <span class="text-sm font-semibold" style="color: #c084fc;">${unlocked} of ${total} unlocked</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('achievements-modal').remove()" 
                            class="w-10 h-10 rounded-lg flex items-center justify-center transition-all hover:bg-white/10"
                            style="border: 1px solid rgba(255,255,255,0.1);">
                        <i class="fas fa-times text-white/60 hover:text-white"></i>
                    </button>
                </div>
                <!-- Body -->
                <div class="flex-1 overflow-y-auto p-5" style="scrollbar-width: thin; scrollbar-color: rgba(147, 51, 234, 0.5) transparent;">
                    ${content}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add entrance animation
        const modalContent = modal.querySelector('.max-w-2xl');
        modalContent.style.transform = 'scale(0.95) translateY(20px)';
        modalContent.style.opacity = '0';
        modalContent.style.transition = 'all 0.3s ease-out';
        requestAnimationFrame(() => {
            modalContent.style.transform = 'scale(1) translateY(0)';
            modalContent.style.opacity = '1';
        });
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        // Close on Escape key
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        initSocket();
        initTVChart();
        loadStats();
        loadExchanges();
        setupPositionsPolling();
        loadStrategies();
        loadSafetyPool();
        loadGamification();
        
        // Refresh Safety Pool every 5 minutes
        if (window.createVisibilityInterval) {
            window.createVisibilityInterval(loadSafetyPool, 5 * 60 * 1000, { immediate: false });
        } else {
            setInterval(loadSafetyPool, 5 * 60 * 1000);
        }
        
        // Refresh Gamification every 5 minutes
        if (window.createVisibilityInterval) {
            window.createVisibilityInterval(loadGamification, 5 * 60 * 1000, { immediate: false });
        } else {
            setInterval(loadGamification, 5 * 60 * 1000);
        }
        
        // Initial progress ring update
        const balanceEl = document.getElementById('balance-value');
        if (balanceEl) {
            const balance = parseFloat(balanceEl.textContent.replace(/[$,]/g, '')) || 0;
            updateProgressRing(balance);
            updateProfitDisplay(balance);
        }
    });
    
    // ==================== TASKS & CHALLENGES ====================
    
    let userTasks = [];
    let myParticipations = [];
    let userTaskTypes = {};
    let userRewardTypes = {};
    let currentTaskAction = null; // 'join', 'submit'
    let currentTaskRewardType = null;
    
    async function loadUserTasks() {
        const taskType = document.getElementById('user-task-type-filter')?.value || '';
        
        try {
            const url = taskType ? `/api/tasks?type=${taskType}` : '/api/tasks';
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                userTasks = data.tasks;
                userTaskTypes = data.task_types || {};
                userRewardTypes = data.reward_types || {};
                renderAvailableTasks();
                updateUserTaskStats();
            }
        } catch (err) {
            console.error('Error loading tasks:', err);
        }
    }
    
    async function loadMyParticipations() {
        try {
            const response = await fetch('/api/tasks/my-participations');
            const data = await response.json();
            
            if (data.success) {
                myParticipations = data.participations;
                renderMyParticipations();
                updateUserTaskStats();
            }
        } catch (err) {
            console.error('Error loading participations:', err);
        }
    }
    
    function updateUserTaskStats() {
        const availableCount = userTasks.filter(t => t.can_participate).length;
        const inProgressCount = myParticipations.filter(p => ['pending', 'in_progress', 'submitted'].includes(p.status)).length;
        const completedCount = myParticipations.filter(p => p.status === 'completed').length;
        const totalRewards = myParticipations.filter(p => p.reward_given).reduce((sum, p) => sum + (p.reward_amount || 0), 0);
        
        document.getElementById('user-available-tasks').textContent = availableCount;
        document.getElementById('user-in-progress-tasks').textContent = inProgressCount;
        document.getElementById('user-completed-tasks').textContent = completedCount;
        document.getElementById('user-total-rewards').textContent = '$' + totalRewards.toFixed(2);
        document.getElementById('active-tasks-badge').textContent = inProgressCount;
    }
    
    function renderAvailableTasks() {
        const container = document.getElementById('available-tasks-list');
        
        // Filter out tasks that user is already participating in
        const availableTasks = userTasks.filter(t => !t.user_participation || t.user_participation.status === 'rejected');
        
        if (availableTasks.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-white/40">
                    <i class="fas fa-check-circle text-3xl mb-3 text-green-400"></i>
                    <p>${t('dash.noTasks')}</p>
                    <p class="text-sm mt-1">${t('dash.checkBackLater')}</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        availableTasks.forEach(task => {
            const typeInfo = userTaskTypes[task.task_type] || { name: task.task_type, icon: 'fa-tasks', color: '#888' };
            const rewardInfo = userRewardTypes[task.reward_type] || { name: task.reward_type, icon: 'fa-gift', color: '#888' };
            
            const spotsText = task.spots_remaining !== null ? 
                `<span class="text-orange-400">${task.spots_remaining} spots left</span>` : 
                '<span class="text-white/40">Unlimited spots</span>';
            
            html += `
                <div class="p-4 rounded-xl transition-all hover:scale-[1.01] cursor-pointer" 
                     style="background: linear-gradient(135deg, ${task.color}10, transparent); border: 1px solid ${task.is_featured ? 'rgba(234, 179, 8, 0.3)' : task.color + '30'};"
                     onclick="openTaskDetails(${task.id})">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0" style="background: ${task.color}20; border: 1px solid ${task.color}40;">
                            <i class="fas ${task.icon}" style="color: ${task.color}; font-size: 1.5rem;"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-semibold text-white">${task.title}</span>
                                ${task.is_featured ? '<span class="px-2 py-0.5 text-xs rounded-full bg-yellow-500/20 text-yellow-400">‚≠ê Featured</span>' : ''}
                            </div>
                            <p class="text-sm text-white/60 mt-1 line-clamp-2">${task.description || 'Complete this task to earn rewards!'}</p>
                            <div class="flex items-center gap-4 mt-3 text-xs">
                                <span class="flex items-center gap-1" style="color: ${typeInfo.color};">
                                    <i class="fas ${typeInfo.icon}"></i> ${typeInfo.name}
                                </span>
                                <span class="flex items-center gap-1" style="color: ${rewardInfo.color};">
                                    <i class="fas ${rewardInfo.icon}"></i> 
                                    ${task.reward_type === 'money' ? '$' + task.reward_amount : task.reward_amount + ' ' + rewardInfo.name}
                                </span>
                                ${spotsText}
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            ${task.can_participate ? 
                                '<button class="cyber-btn cyber-btn-success cyber-btn-sm"><i class="fas fa-play"></i></button>' :
                                '<span class="text-xs text-white/40">' + (task.participation_reason || 'Unavailable') + '</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderMyParticipations() {
        const container = document.getElementById('my-participations-list');
        const section = document.getElementById('my-participations-section');
        const completedContainer = document.getElementById('completed-tasks-list');
        
        const activeParticipations = myParticipations.filter(p => ['pending', 'in_progress', 'submitted'].includes(p.status));
        const completedParticipations = myParticipations.filter(p => p.status === 'completed');
        
        // Active participations
        if (activeParticipations.length > 0) {
            section.style.display = 'block';
            
            let html = '';
            activeParticipations.forEach(p => {
                const task = p.task || {};
                const statusColors = {
                    'pending': { bg: 'bg-gray-500/20', text: 'text-gray-400', icon: 'fa-clock' },
                    'in_progress': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', icon: 'fa-spinner fa-spin' },
                    'submitted': { bg: 'bg-blue-500/20', text: 'text-blue-400', icon: 'fa-hourglass-half' }
                };
                const status = statusColors[p.status] || statusColors.pending;
                
                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: ${task.color || '#888'}20;">
                                <i class="fas ${task.icon || 'fa-tasks'}" style="color: ${task.color || '#888'};"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-white">${task.title || 'Task'}</div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span class="${status.bg} ${status.text} px-2 py-0.5 rounded-full">
                                        <i class="fas ${status.icon} mr-1"></i>
                                        ${p.status === 'submitted' ? 'Awaiting Review' : p.status.replace('_', ' ')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        ${p.status !== 'submitted' ? `
                            <button onclick="openTaskDetails(${task.id}, true)" class="cyber-btn cyber-btn-primary cyber-btn-sm">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                        ` : `
                            <span class="text-xs text-blue-400"><i class="fas fa-clock mr-1"></i> Under Review</span>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        } else {
            section.style.display = 'none';
        }
        
        // Completed participations
        if (completedParticipations.length > 0) {
            let html = '';
            completedParticipations.slice(0, 10).forEach(p => {
                const task = p.task || {};
                const completedAt = new Date(p.completed_at);
                
                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-green-500/20">
                                <i class="fas fa-check text-green-400"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-white">${task.title || 'Task'}</div>
                                <div class="text-xs text-white/50">${completedAt.toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-green-400">
                                ${task.reward_type === 'money' ? '+$' + p.reward_amount : '+' + p.reward_amount}
                            </div>
                            <div class="text-xs text-white/40">${task.reward_type || 'reward'}</div>
                        </div>
                    </div>
                `;
            });
            
            completedContainer.innerHTML = html;
        } else {
            completedContainer.innerHTML = '<div class="text-center py-4 text-white/40"><p>' + t('dash.noCompletedTasks') + '</p></div>';
        }
    }
    
    function openTaskDetails(taskId, isSubmitting = false) {
        const task = userTasks.find(t => t.id === taskId);
        if (!task) return;
        
        document.getElementById('modal-task-id').value = taskId;
        document.getElementById('task-details-title').textContent = task.title;
        document.getElementById('task-modal-icon').className = `fas ${task.icon}`;
        document.getElementById('task-modal-icon').style.color = task.color;
        
        const typeInfo = userTaskTypes[task.task_type] || { name: task.task_type, icon: 'fa-tasks', color: '#888' };
        const rewardInfo = userRewardTypes[task.reward_type] || { name: task.reward_type, icon: 'fa-gift', color: '#888' };
        currentTaskRewardType = task.reward_type || 'money';
        
        const participation = task.user_participation;
        const isInProgress = participation && ['pending', 'in_progress'].includes(participation.status);
        
        let contentHtml = `
            <div class="mb-4">
                <p class="text-white/70">${task.description || 'Complete this task to earn rewards!'}</p>
            </div>
            
            ${task.instructions ? `
                <div class="mb-4 p-3 rounded-lg" style="background: rgba(0, 245, 255, 0.1); border: 1px solid rgba(0, 245, 255, 0.2);">
                    <h4 class="text-sm font-semibold text-cyan-400 mb-2"><i class="fas fa-info-circle mr-1"></i> Instructions</h4>
                    <p class="text-sm text-white/70 whitespace-pre-line">${task.instructions}</p>
                </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="p-3 rounded-lg" style="background: ${typeInfo.color}15; border: 1px solid ${typeInfo.color}30;">
                    <div class="text-xs text-white/50">Type</div>
                    <div class="font-semibold" style="color: ${typeInfo.color};"><i class="fas ${typeInfo.icon} mr-1"></i> ${typeInfo.name}</div>
                </div>
                <div class="p-3 rounded-lg" style="background: ${rewardInfo.color}15; border: 1px solid ${rewardInfo.color}30;">
                    <div class="text-xs text-white/50">Reward</div>
                    <div class="font-semibold" style="color: ${rewardInfo.color};"><i class="fas ${rewardInfo.icon} mr-1"></i> ${task.reward_type === 'money' ? '$' + task.reward_amount : task.reward_amount + ' ' + rewardInfo.name}</div>
                </div>
            </div>
            
            ${task.reward_description ? `<p class="text-sm text-white/60 mb-4"><i class="fas fa-gift mr-1"></i> ${task.reward_description}</p>` : ''}
        `;
        
        document.getElementById('task-details-content').innerHTML = contentHtml;
        
        const actionBtn = document.getElementById('task-action-btn');
        const submissionForm = document.getElementById('task-submission-form');
        const payoutSection = document.getElementById('task-payout-section');
        
        if (isSubmitting || isInProgress) {
            // Show submission form
            submissionForm.style.display = 'block';
            actionBtn.style.display = 'flex';
            actionBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>' + t('dash.submitCompletion') + '</span>';
            currentTaskAction = 'submit';
        } else if (task.can_participate) {
            // Show join button
            submissionForm.style.display = 'none';
            actionBtn.style.display = 'flex';
            actionBtn.innerHTML = '<i class="fas fa-play"></i> <span>Join Task</span>';
            currentTaskAction = 'join';
        } else {
            // Can't participate
            submissionForm.style.display = 'none';
            actionBtn.style.display = 'none';
            currentTaskAction = null;
        }
        
        if (payoutSection) {
            const needsPayout = ['money', 'goods', 'custom'].includes(currentTaskRewardType);
            payoutSection.style.display = needsPayout ? 'block' : 'none';
        }
        
        // Clear submission fields
        document.getElementById('task-submission-text').value = '';
        document.getElementById('task-submission-url').value = '';
        const payoutMethod = document.getElementById('task-payout-method');
        const payoutDetails = document.getElementById('task-payout-details');
        const payoutContact = document.getElementById('task-payout-contact');
        if (payoutMethod) payoutMethod.value = '';
        if (payoutDetails) payoutDetails.value = '';
        if (payoutContact) payoutContact.value = '';
        
        document.getElementById('taskDetailsModal').style.display = 'flex';
    }
    
    function closeTaskDetailsModal() {
        document.getElementById('taskDetailsModal').style.display = 'none';
    }
    
    async function handleTaskAction() {
        const taskId = document.getElementById('modal-task-id').value;
        const btn = document.getElementById('task-action-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        try {
            if (currentTaskAction === 'join') {
                const response = await fetch(`/api/tasks/${taskId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || t('dash.joinedTask'), 'success');
                    closeTaskDetailsModal();
                    refreshUserTasks();
                } else {
                    showToast(data.error || 'Failed to join task', 'error');
                }
            } else if (currentTaskAction === 'submit') {
                const submissionText = document.getElementById('task-submission-text').value.trim();
                const submissionUrl = document.getElementById('task-submission-url').value.trim();
                const payoutMethod = document.getElementById('task-payout-method')?.value.trim() || '';
                const payoutDetails = document.getElementById('task-payout-details')?.value.trim() || '';
                const payoutContact = document.getElementById('task-payout-contact')?.value.trim() || '';
                
                if (['money', 'goods', 'custom'].includes(currentTaskRewardType) && !payoutMethod && !payoutDetails) {
                    showToast('Please provide payout details for the reward.', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }
                
                const response = await fetch(`/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: submissionText,
                        url: submissionUrl,
                        payout_method: payoutMethod,
                        payout_details: payoutDetails,
                        payout_contact: payoutContact
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || t('dash.taskSubmitted'), 'success');
                    closeTaskDetailsModal();
                    refreshUserTasks();
                } else {
                    showToast(data.error || 'Failed to submit task', 'error');
                }
            }
        } catch (err) {
            showToast(t('dash.networkError'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    function refreshUserTasks() {
        const icon = document.getElementById('user-tasks-refresh-icon');
        if (icon) icon.classList.add('fa-spin');
        
        Promise.all([
            loadUserTasks(),
            loadMyParticipations()
        ]).finally(() => {
            if (icon) icon.classList.remove('fa-spin');
        });
    }
    
    // Override showSection to load tasks and subscription when switching
    const originalUserShowSection = window.showSection;
    window.showSection = function(section) {
        if (typeof originalUserShowSection === 'function') {
            originalUserShowSection(section);
        }
        if (section === 'tasks') {
            loadUserTasks();
            loadMyParticipations();
        }
        if (section === 'subscription') {
            loadSubscriptionStatus();
            loadAvailablePlans();
        }
    };
    
    // Handle URL hash for direct navigation to sections
    const dashboardSections = ['overview', 'trading', 'tasks', 'subscription'];
    const tradingAnchors = new Set(['exchange', 'settings']);
    function applySectionFromHash() {
        const hash = window.location.hash.substring(1); // Remove #
        if (!hash || typeof window.showSection !== 'function') {
            return;
        }
        if (tradingAnchors.has(hash)) {
            openSectionAndScroll('trading', hash);
            return;
        }
        if (dashboardSections.includes(hash)) {
            window.showSection(hash);
        }
    }

    if (window.location.hash) {
        setTimeout(applySectionFromHash, 300);
    }
    
    // Listen for hash changes
    window.addEventListener('hashchange', applySectionFromHash);
</script>
{% endblock %}
